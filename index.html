<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OSINT Military Tracker â€” PikeClaw âš¡</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e17;--panel:rgba(13,17,28,0.97);--border:#1a2035;--border2:#232d45;--text:#e0e8ff;--muted:#6b7a9e;--accent:#3b82f6;--red:#ef4444;--orange:#f97316;--yellow:#eab308;--purple:#8b5cf6;--green:#22c55e;--cyan:#22d3ee}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden}

/* â”€â”€ WIDGET SYSTEM â”€â”€ */
.dashboard{flex:1;display:grid;grid-template-columns:1fr 270px 270px;grid-template-rows:1fr 1fr;min-height:0;gap:0}
.widget{background:var(--panel);border:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;min-height:0}
.widget-header{flex-shrink:0;padding:7px 10px;background:rgba(0,0,0,.3);border-bottom:1px solid var(--border);font-size:11px;font-weight:700;letter-spacing:.5px;color:var(--muted);text-transform:uppercase;display:flex;align-items:center;gap:6px}
.widget-header .wh-title{flex:1}
.widget-header .wh-count{background:#111827;border:1px solid var(--border2);border-radius:10px;padding:1px 7px;font-size:10px;color:var(--text)}
.widget-body{flex:1;overflow-y:auto;overflow-x:hidden;min-height:0}
.widget-body::-webkit-scrollbar{width:3px}
.widget-body::-webkit-scrollbar-track{background:transparent}
.widget-body::-webkit-scrollbar-thumb{background:#1e2a42;border-radius:2px}
.w-map{grid-column:1;grid-row:1/3;position:relative;border:0}
.w-zones{grid-column:2;grid-row:1}
.w-stats{grid-column:3;grid-row:1}
.w-activity{grid-column:2;grid-row:2}
.w-log{grid-column:3;grid-row:2}

/* News strip */
.news-strip{flex-shrink:0;height:170px;display:flex;gap:0;border-top:1px solid var(--border);background:var(--bg);overflow:hidden}
.news-strip-inner{display:flex;gap:0;overflow-x:auto;flex:1}
.news-strip-inner::-webkit-scrollbar{height:3px}
.news-strip-inner::-webkit-scrollbar-thumb{background:#1e2a42}
.news-card{min-width:240px;max-width:240px;padding:10px 12px;border-right:1px solid var(--border);cursor:pointer;transition:background .15s;flex-shrink:0}
.news-card:hover{background:rgba(59,130,246,.06)}
.news-card .nc-src{font-size:9px;color:var(--accent);font-weight:700;margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px}
.news-card .nc-title{font-size:11px;line-height:1.4;color:var(--text);display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}
.news-card .nc-meta{font-size:9px;color:var(--muted);margin-top:4px}
.news-card.alert .nc-src{color:var(--red)}
.news-card.alert{border-left:2px solid var(--red);padding-left:10px}
.news-strip-label{flex-shrink:0;width:80px;display:flex;align-items:center;justify-content:center;border-right:1px solid var(--border);writing-mode:vertical-rl;text-orientation:mixed;font-size:10px;font-weight:700;color:var(--muted);letter-spacing:.5px;text-transform:uppercase}

/* â”€â”€ TOP BAR â”€â”€ */
.topbar{flex-shrink:0;background:var(--panel);border-bottom:1px solid var(--border);padding:7px 12px;display:flex;gap:5px;align-items:center;flex-wrap:wrap;z-index:200}
.topbar .logo{font-weight:800;font-size:13px;color:var(--accent);margin-right:6px;letter-spacing:.5px;white-space:nowrap}
.topbar .logo span{color:var(--text)}
.tb-sep{width:1px;height:18px;background:var(--border2);margin:0 3px;flex-shrink:0}
.tb-btn{background:#111827;border:1px solid var(--border2);color:var(--muted);padding:4px 9px;border-radius:4px;cursor:pointer;font-size:11px;transition:all .15s;white-space:nowrap}
.tb-btn:hover,`.tb-btn.on{background:#1e2a42;border-color:var(--accent);color:var(--text)}
.tb-btn.on{color:#93c5fd}
.tb-btn.iran-on{background:#2d1515;border-color:var(--red);color:#fca5a5}
.tb-btn.russia-on{background:#2d1a15;border-color:#dc2626;color:#fca5a5}
.tb-btn.china-on{background:#2a2610;border-color:var(--yellow);color:#fde047}
.tb-search{background:#111827;border:1px solid var(--border2);color:var(--text);padding:4px 8px;border-radius:4px;font-size:11px;width:120px;outline:none}
.tb-search:focus{border-color:var(--accent)}
.tb-search::placeholder{color:#3a4560}
.tb-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap}

/* â”€â”€ MAIN BODY â”€â”€ */
.main{flex:1;display:flex;overflow:hidden;min-height:0}

/* â”€â”€ MAP AREA â”€â”€ */
.map-wrap{flex:1;position:relative;min-width:0}
#map{position:absolute;inset:0}

/* â”€â”€ RIGHT PANEL â”€â”€ */
.rpanel{width:320px;flex-shrink:0;background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.rpanel-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0}
.rpanel-tabs .tab{flex:1;padding:8px 4px;text-align:center;font-size:11px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all .15s;user-select:none}
.rpanel-tabs .tab:hover{color:var(--text)}
.rpanel-tabs .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.rpanel-body{flex:1;overflow-y:auto;overflow-x:hidden}
.rpanel-body::-webkit-scrollbar{width:4px}
.rpanel-body::-webkit-scrollbar-track{background:#0d111c}
.rpanel-body::-webkit-scrollbar-thumb{background:#1e2a42;border-radius:2px}

/* Right panel sections */
.rp-section{padding:10px 12px 4px;font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);border-bottom:1px solid var(--border)}
.rp-section.mt{margin-top:4px}

/* News cards */
.news-card{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.news-card:hover{background:rgba(59,130,246,.06)}
.news-card .nc-src{font-size:10px;color:var(--accent);font-weight:600;margin-bottom:3px;text-transform:uppercase;letter-spacing:.4px}
.news-card .nc-title{font-size:12px;line-height:1.4;color:var(--text);margin-bottom:4px}
.news-card .nc-meta{font-size:10px;color:var(--muted)}
.news-card.alert .nc-src{color:var(--red)}
.news-card.alert{border-left:2px solid var(--red)}

/* Stats panel */
.stat-block{padding:10px 12px;border-bottom:1px solid var(--border)}
.stat-block .sb-label{font-size:10px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.country-row{display:flex;align-items:center;gap:6px;margin-bottom:5px;font-size:12px}
.country-row .cr-flag{width:18px;text-align:center}
.country-row .cr-name{flex:1;color:var(--muted)}
.country-row .cr-bar-wrap{width:80px;height:6px;background:#111827;border-radius:3px;overflow:hidden}
.country-row .cr-bar{height:100%;border-radius:3px;transition:width .3s}
.country-row .cr-count{width:24px;text-align:right;font-weight:600;color:var(--text)}
.type-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:11px}
.type-row .tr-icon{width:16px;text-align:center}
.type-row .tr-name{flex:1;color:var(--muted)}
.type-row .tr-bar-wrap{width:70px;height:5px;background:#111827;border-radius:3px;overflow:hidden}
.type-row .tr-bar{height:100%;border-radius:3px;transition:width .3s}
.type-row .tr-count{width:24px;text-align:right;font-weight:600;color:var(--text)}

/* Alerts panel */
.zone-card{padding:8px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.zone-card .zc-name{font-size:12px;color:var(--text)}
.zone-card .zc-count{font-size:14px;font-weight:700}
.zone-card.hot{border-left:2px solid var(--red)}
.zone-card.warm{border-left:2px solid var(--orange)}

/* Activity feed */
.feed-item{padding:6px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px;font-size:11px}
.feed-item .fi-flag{flex-shrink:0}
.feed-item .fi-call{font-weight:600;color:var(--text);flex-shrink:0}
.feed-item .fi-type{color:var(--muted)}
.feed-item .fi-alt{margin-left:auto;color:var(--muted);flex-shrink:0}

/* Info panel overlay */
.infopanel{position:absolute;bottom:50px;left:10px;z-index:500;background:rgba(13,17,28,0.97);border:1px solid var(--border2);border-radius:8px;padding:12px;width:260px;display:none;backdrop-filter:blur(12px)}
.infopanel.vis{display:block}
.infopanel .ip-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.infopanel h3{font-size:13px;color:#fff}
.infopanel .x{background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;line-height:1}
.infopanel .x:hover{color:#fff}
.infopanel .f{margin-bottom:3px;font-size:11px}
.infopanel .f .k{color:var(--muted)}
.infopanel .f .v{color:var(--text);font-weight:500}

/* Region quick-jump */
.region-btns{position:absolute;bottom:10px;left:10px;z-index:400;display:flex;flex-direction:column;gap:3px}
.region-btns button{background:rgba(13,17,28,0.88);border:1px solid var(--border2);color:var(--muted);padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px;text-align:left;transition:all .15s}
.region-btns button:hover{color:var(--text);border-color:var(--accent)}

/* Alert zones */
.map-legend{position:absolute;top:10px;right:10px;z-index:400;background:rgba(13,17,28,0.88);border:1px solid var(--border2);border-radius:6px;padding:8px 10px;font-size:10px}
.map-legend .ml-row{display:flex;align-items:center;gap:6px;margin-bottom:3px;color:var(--muted)}
.map-legend .ml-row .ml-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

/* â”€â”€ TICKER â”€â”€ */
.ticker{flex-shrink:0;height:30px;background:rgba(0,0,0,.7);border-top:1px solid var(--border);overflow:hidden;position:relative}
.ticker-inner{display:flex;align-items:center;height:100%;white-space:nowrap;animation:ticker-scroll 80s linear infinite}
.ticker-inner:hover{animation-play-state:paused}
.ticker-item{padding:0 32px;font-size:11px;color:var(--muted)}
.ticker-item .ti-src{color:var(--accent);font-weight:700;margin-right:6px}
.ticker-item .ti-sep{color:var(--border2);margin:0 8px}
@keyframes ticker-scroll{0%{transform:translateX(100vw)}100%{transform:translateX(-100%)}}

/* Leaflet overrides */
.leaflet-popup-content-wrapper{background:#0d111c;color:var(--text);border-radius:8px;border:1px solid var(--border2)}
.leaflet-popup-tip{background:#0d111c}
.dark-tooltip{background:rgba(13,17,28,.95)!important;color:var(--text)!important;border:1px solid var(--border2)!important;border-radius:5px!important;font-size:11px!important;padding:3px 7px!important;box-shadow:0 2px 8px rgba(0,0,0,.5)!important}

/* Loading */
.loading-ov{position:absolute;inset:0;z-index:600;background:rgba(10,14,23,.85);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px}
.loading-ov .sp{font-size:32px;animation:spin 1s linear infinite;display:inline-block}
.loading-ov .st{color:var(--muted);font-size:13px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Responsive */
@media(max-width:700px){
  .rpanel{display:none}
  .tb-search{width:80px}
}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <span class="logo">âš¡ OSINT<span>TRACKER</span></span>
  <span class="tb-label">Country:</span>
  <button class="tb-btn on" id="bc-all" onclick="setCF('all')">ğŸŒ All</button>
  <button class="tb-btn" id="bc-us" onclick="setCF('us')">ğŸ‡ºğŸ‡¸ US</button>
  <button class="tb-btn" id="bc-iran" onclick="setCF('iran')">ğŸ‡®ğŸ‡· Iran</button>
  <button class="tb-btn" id="bc-russia" onclick="setCF('russia')">ğŸ‡·ğŸ‡º Russia</button>
  <button class="tb-btn" id="bc-china" onclick="setCF('china')">ğŸ‡¨ğŸ‡³ China</button>
  <button class="tb-btn" id="bc-allied" onclick="setCF('allied')">ğŸ¤ Allied</button>
  <div class="tb-sep"></div>
  <span class="tb-label">Type:</span>
  <button class="tb-btn on" id="bt-all" onclick="setTF('all')">All</button>
  <button class="tb-btn" id="bt-fighter" onclick="setTF('fighter')">âœˆï¸ Fighter</button>
  <button class="tb-btn" id="bt-transport" onclick="setTF('transport')">ğŸ›©ï¸ Transport</button>
  <button class="tb-btn" id="bt-tanker" onclick="setTF('tanker')">â›½ Tanker</button>
  <button class="tb-btn" id="bt-recon" onclick="setTF('recon')">ğŸ” ISR</button>
  <button class="tb-btn" id="bt-heli" onclick="setTF('heli')">ğŸš Heli</button>
  <button class="tb-btn" id="bt-bomber" onclick="setTF('bomber')">ğŸ’£ Bomber</button>
  <div class="tb-sep"></div>
  <input class="tb-search" id="searchBox" placeholder="Search callsign/hex..." oninput="doSearch()"/>
  <button class="tb-btn" onclick="fetchData()" title="Refresh now">ğŸ”„ Refresh</button>
  <div class="tb-sep"></div>
  <span class="tb-label">Map:</span>
  <button class="tb-btn tile-btn on" data-t="dark" onclick="setTile('dark')">ğŸŒ‘ Dark</button>
  <button class="tb-btn tile-btn" data-t="satellite" onclick="setTile('satellite')">ğŸ›°ï¸ Sat</button>
  <button class="tb-btn tile-btn" data-t="terrain" onclick="setTile('terrain')">ğŸ—ºï¸ Terrain</button>
  <div class="tb-sep"></div>
  <button class="tb-btn" id="btn-bases" onclick="toggleBases()">ğŸ“ Bases</button>
  <button class="tb-btn" id="btn-notif" onclick="toggleNotifications()">ğŸ”” Alerts</button>
</div>

<!-- DASHBOARD GRID -->
<div class="dashboard">

  <!-- MAP WIDGET -->
  <div class="widget w-map">
    <div id="map" style="position:absolute;inset:0"></div>
    <div class="map-legend" style="position:absolute;top:10px;right:10px;z-index:400">
      <div class="ml-row"><div class="ml-dot" style="background:#3b82f6"></div>ğŸ‡ºğŸ‡¸ US</div>
      <div class="ml-row"><div class="ml-dot" style="background:#ef4444"></div>ğŸ‡®ğŸ‡· Iran</div>
      <div class="ml-row"><div class="ml-dot" style="background:#dc2626"></div>ğŸ‡·ğŸ‡º Russia</div>
      <div class="ml-row"><div class="ml-dot" style="background:#eab308"></div>ğŸ‡¨ğŸ‡³ China</div>
      <div class="ml-row"><div class="ml-dot" style="background:#8b5cf6"></div>ğŸ¤ Allied</div>
    </div>
    <div class="region-btns" style="position:absolute;bottom:10px;left:10px;z-index:400">
      <button onclick="goTo(30,50,5)">ğŸ”¥ Mid East</button>
      <button onclick="goTo(38,-97,4)">ğŸ‡ºğŸ‡¸ CONUS</button>
      <button onclick="goTo(50,15,4)">ğŸ‡ªğŸ‡º Europe</button>
      <button onclick="goTo(25,125,4)">ğŸŒ Pacific</button>
      <button onclick="goTo(20,0,2)">ğŸŒ Global</button>
    </div>
    <div class="infopanel" id="infoP" style="position:absolute;bottom:50px;left:10px;z-index:500">
      <div class="ip-head"><h3 id="pTitle">â€”</h3><button class="x" onclick="closeP()">&times;</button></div>
      <div id="pBody"></div>
    </div>
    <div class="loading-ov" id="loadOv" style="position:absolute;inset:0;z-index:600">
      <div class="sp">âœˆï¸</div><div class="st">Loading...</div>
    </div>
  </div>

  <!-- ZONES WIDGET -->
  <div class="widget w-zones">
    <div class="widget-header">âš ï¸ <span class="wh-title">Alert Zones</span><span class="wh-count" id="zone-hot">0 hot</span></div>
    <div class="widget-body" id="pane-alerts"></div>
  </div>

  <!-- STATS WIDGET -->
  <div class="widget w-stats">
    <div class="widget-header">ğŸ“Š <span class="wh-title">Stats</span></div>
    <div class="widget-body" id="pane-stats"></div>
  </div>

  <!-- ACTIVITY WIDGET -->
  <div class="widget w-activity">
    <div class="widget-header">ğŸ”” <span class="wh-title">Live Activity</span><span class="wh-count" id="ac-count">0</span></div>
    <div class="widget-body" id="pane-activity"></div>
  </div>

  <!-- EVENT LOG WIDGET -->
  <div class="widget w-log">
    <div class="widget-header">ğŸ“‹ <span class="wh-title">Event Log</span><span class="wh-count" id="log-count">0</span></div>
    <div class="widget-body" id="pane-log"></div>
  </div>

</div>

<!-- NEWS STRIP -->
<div class="news-strip">
  <div class="news-strip-label">Intel Feed</div>
  <div class="news-strip-inner" id="newsStrip"></div>
</div>

<!-- TICKER -->

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const map = L.map('map', { center:[30,50], zoom:5, zoomControl:true });
const TILES = {
  dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {attribution:'&copy; OSM &copy; CARTO | adsb.lol',subdomains:'abcd',maxZoom:19}),
  satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution:'&copy; Esri',maxZoom:19}),
  terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {attribution:'&copy; OSM',subdomains:'abc',maxZoom:17}),
};
let currentTile = 'dark';
TILES.dark.addTo(map);
function setTile(t){
  map.removeLayer(TILES[currentTile]);
  currentTile=t;
  TILES[t].addTo(map);
  document.querySelectorAll('.tile-btn').forEach(b=>b.classList.toggle('on',b.dataset.t===t));
}
function goTo(lat,lon,z){ map.setView([lat,lon],z); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MILITARY BASES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BASES = [
  // US
  {name:'Al Udeid AB',lat:25.117,lon:51.315,country:'us',type:'Air Base'},
  {name:'Ali Al Salem AB',lat:29.347,lon:47.521,country:'us',type:'Air Base'},
  {name:'Al Dhafra AB',lat:24.248,lon:54.548,country:'us',type:'Air Base'},
  {name:'Incirlik AB',lat:37.002,lon:35.426,country:'us',type:'Air Base'},
  {name:'RAF Mildenhall',lat:52.362,lon:0.486,country:'us',type:'Air Base'},
  {name:'Ramstein AB',lat:49.437,lon:7.600,country:'us',type:'Air Base'},
  {name:'Kadena AB',lat:26.356,lon:127.768,country:'us',type:'Air Base'},
  {name:'Yokota AB',lat:35.748,lon:139.348,country:'us',type:'Air Base'},
  {name:'Diego Garcia',lat:-7.313,lon:72.423,country:'us',type:'Naval Base'},
  {name:'Naval Base Bahrain',lat:26.218,lon:50.612,country:'us',type:'Naval Base'},
  {name:'Camp Lemonnier',lat:11.553,lon:43.159,country:'us',type:'Base'},
  {name:'Andersen AFB',lat:13.584,lon:144.930,country:'us',type:'Air Base'},
  {name:'Osan AB',lat:37.090,lon:127.030,country:'us',type:'Air Base'},
  {name:'Aviano AB',lat:46.032,lon:12.597,country:'us',type:'Air Base'},
  // Iran
  {name:'Mehrabad Air Base',lat:35.689,lon:51.314,country:'iran',type:'Air Base'},
  {name:'Isfahan Air Base',lat:32.508,lon:51.694,country:'iran',type:'Air Base'},
  {name:'Bandar Abbas Naval',lat:27.218,lon:56.362,country:'iran',type:'Naval Base'},
  {name:'Bushehr Naval',lat:28.942,lon:50.835,country:'iran',type:'Naval Base'},
  {name:'Tabriz Air Base',lat:38.133,lon:46.235,country:'iran',type:'Air Base'},
  {name:'Omidiyeh Air Base',lat:30.835,lon:49.534,country:'iran',type:'Air Base'},
  // Russia
  {name:'Hmeimim AB (Syria)',lat:35.401,lon:35.948,country:'russia',type:'Air Base'},
  {name:'Sevastopol Naval',lat:44.623,lon:33.523,country:'russia',type:'Naval Base'},
  {name:'Engelss-2 AB',lat:51.428,lon:46.177,country:'russia',type:'Air Base'},
  {name:'Kaliningrad Base',lat:54.710,lon:20.508,country:'russia',type:'Base'},
  {name:'Tartus Naval (Syria)',lat:34.893,lon:35.887,country:'russia',type:'Naval Base'},
  // China
  {name:'Sanya Naval Base',lat:18.230,lon:109.572,country:'china',type:'Naval Base'},
  {name:'Zhanjiang Naval',lat:21.182,lon:110.401,country:'china',type:'Naval Base'},
  {name:'Lingshui AF',lat:18.492,lon:110.038,country:'china',type:'Air Base'},
  {name:'Fiery Cross Reef',lat:9.549,lon:112.893,country:'china',type:'Island Base'},
  {name:'Mischief Reef',lat:9.908,lon:115.534,country:'china',type:'Island Base'},
];

const baseCols={us:'#3b82f6',iran:'#ef4444',russia:'#dc2626',china:'#eab308'};
let baseMarkers=[];
let basesVisible=false;

function toggleBases(){
  basesVisible=!basesVisible;
  document.getElementById('btn-bases').classList.toggle('on',basesVisible);
  if(basesVisible){
    BASES.forEach(b=>{
      const col=baseCols[b.country]||'#64748b';
      const m=L.marker([b.lat,b.lon],{
        icon:L.divIcon({html:`<div style="color:${col};font-size:14px;text-shadow:0 0 6px ${col}80">â¬Ÿ</div>`,className:'',iconSize:[14,14],iconAnchor:[7,7]})
      }).bindTooltip(`${FLAGS[b.country]||'ğŸŒ'} ${b.name} (${b.type})`,{className:'dark-tooltip',direction:'top'}).addTo(map);
      baseMarkers.push(m);
    });
  } else {
    baseMarkers.forEach(m=>map.removeLayer(m));
    baseMarkers=[];
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTRY DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CR = {
  us:[[0xA00000,0xAFFFFF]],
  iran:[[0x730000,0x737FFF]],
  russia:[[0x100000,0x13FFFF]],
  china:[[0x780000,0x7BFFFF]],
  uk:[[0x400000,0x43FFFF]],
  france:[[0x380000,0x3BFFFF]],
  germany:[[0x3C0000,0x3FFFFF]],
  australia:[[0x7C0000,0x7FFFFF]],
  japan:[[0x840000,0x87FFFF]],
  korea:[[0x718000,0x71FFFF]],
  israel:[[0x738000,0x73FFFF]],
  saudi:[[0x710000,0x717FFF]],
  turkey:[[0x4B0000,0x4B7FFF]],
  india:[[0x800000,0x83FFFF]],
  pakistan:[[0x760000,0x767FFF]],
  canada:[[0xC00000,0xC3FFFF]],
  italy:[[0x300000,0x33FFFF]],
  nato:[[0x480000,0x480FFF]],
  uae:[[0x896000,0x896FFF]],
};
const FLAGS={us:'ğŸ‡ºğŸ‡¸',iran:'ğŸ‡®ğŸ‡·',russia:'ğŸ‡·ğŸ‡º',china:'ğŸ‡¨ğŸ‡³',uk:'ğŸ‡¬ğŸ‡§',france:'ğŸ‡«ğŸ‡·',germany:'ğŸ‡©ğŸ‡ª',australia:'ğŸ‡¦ğŸ‡º',japan:'ğŸ‡¯ğŸ‡µ',korea:'ğŸ‡°ğŸ‡·',israel:'ğŸ‡®ğŸ‡±',saudi:'ğŸ‡¸ğŸ‡¦',turkey:'ğŸ‡¹ğŸ‡·',india:'ğŸ‡®ğŸ‡³',pakistan:'ğŸ‡µğŸ‡°',canada:'ğŸ‡¨ğŸ‡¦',italy:'ğŸ‡®ğŸ‡¹',nato:'ğŸ›ï¸',uae:'ğŸ‡¦ğŸ‡ª'};
const CNAMES={us:'United States',iran:'Iran',russia:'Russia',china:'China',uk:'United Kingdom',france:'France',germany:'Germany',australia:'Australia',japan:'Japan',korea:'South Korea',israel:'Israel',saudi:'Saudi Arabia',turkey:'Turkey',india:'India',pakistan:'Pakistan',canada:'Canada',italy:'Italy',nato:'NATO',uae:'UAE'};
const GCOL={us:'#3b82f6',iran:'#ef4444',russia:'#dc2626',china:'#eab308',allied:'#8b5cf6',unknown:'#64748b'};

function getCountry(hex){
  const h=parseInt(hex,16);
  for(const[c,rs]of Object.entries(CR))for(const[lo,hi]of rs)if(h>=lo&&h<=hi)return c;
  return'unknown';
}
function getGroup(hex){const c=getCountry(hex);return(['us','iran','russia','china'].includes(c))?c:'allied';}
function getFlag(hex){return FLAGS[getCountry(hex)]||'ğŸŒ';}
function getCName(hex){return CNAMES[getCountry(hex)]||'Unknown';}
function getCol(hex){return GCOL[getGroup(hex)]||'#64748b';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AIRCRAFT TYPE CLASSIFICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TYPES = {
  fighter: ['F15','F16','F18','F22','F35','FA18','EUFI','A10','AV8B','EA18','F14','F5','SU27','SU30','SU35','MIG29','MIG31','J10','J11','J16','J20','RFAL','TOR','F4','MIR'],
  transport:['C17','C130','C30J','C5','C5M','C12','C40','C37','IL76','AN124','AN12','Y20','A400','C295','C27J','C160','C145','C146','C2'],
  tanker:   ['KC10','KC46','KC135','KC130','MRTT','IL78','KC30'],
  recon:    ['P8','P3','EP3','RC135','E3','E6','E8','E2','U2','RQ4','MQ9','MQ1','MC12','E737','WC135','WC130','MC130','EC130','RQ170'],
  heli:     ['UH60','AH64','CH47','CH53','MH60','V22','MV22','CV22','MI17','MI24','MI8','MI28','HH60','SH60','AS65','NH90','UH1','AH1','H60','H47','H53'],
  bomber:   ['B52','B1','B2','B21','TU95','TU160','H6','B1B','B52H'],
  trainer:  ['T6','T38','T45','T1','BE20','PC12','C172','T7','T50','PC21','LJ35','T44','TH57']
};
const TCOL={fighter:'#f97316',transport:'#38bdf8',tanker:'#c084fc',recon:'#22d3ee',heli:'#4ade80',bomber:'#f87171',trainer:'#facc15',other:'#64748b'};
const TLAB={fighter:'Fighter/Attack',transport:'Transport',tanker:'Tanker',recon:'ISR/Patrol',heli:'Helicopter',bomber:'Bomber',trainer:'Trainer',other:'Other'};
const TICO={fighter:'âœˆï¸',transport:'ğŸ›©ï¸',tanker:'â›½',recon:'ğŸ”',heli:'ğŸš',bomber:'ğŸ’£',trainer:'ğŸ“',other:'â—†'};

function classifyType(ac){
  const t=(ac.t||'').toUpperCase().replace(/[^A-Z0-9]/g,'');
  const fl=(ac.flight||'').trim().toUpperCase();
  for(const[cat,pats]of Object.entries(TYPES)){
    for(const p of pats){const pp=p.replace(/[^A-Z0-9]/g,'');if(t.includes(pp)||t.startsWith(pp))return cat;}
  }
  if(/^VIPER|^RAGE|^COBRA/.test(fl))return'fighter';
  if(/^RCH|^REACH/.test(fl))return'transport';
  if(/^ETHYL|^TEXAC/.test(fl))return'tanker';
  if(/^JAKE|^TOPCAT/.test(fl))return'recon';
  if(/^DUST|^PEDRO/.test(fl))return'heli';
  return'other';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERT ZONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ZONES=[
  {name:'Strait of Hormuz',   bounds:[[25.5,55.5],[27.5,57.5]], color:'#ef4444', icon:'ğŸš¨'},
  {name:'Persian Gulf',       bounds:[[24,48],[30,56]],          color:'#f97316', icon:'âš ï¸'},
  {name:'Taiwan Strait',      bounds:[[22,117],[26,121]],        color:'#eab308', icon:'âš ï¸'},
  {name:'South China Sea',    bounds:[[5,108],[18,121]],         color:'#eab308', icon:'âš ï¸'},
  {name:'Black Sea',          bounds:[[41,27],[47,42]],          color:'#dc2626', icon:'âš ï¸'},
  {name:'Baltic Sea',         bounds:[[53,12],[60,30]],          color:'#8b5cf6', icon:'â„¹ï¸'},
  {name:'Mediterranean',      bounds:[[30,10],[46,36]],          color:'#8b5cf6', icon:'â„¹ï¸'},
  {name:'Arabian Sea',        bounds:[[10,55],[25,72]],          color:'#f97316', icon:'âš ï¸'},
];
ZONES.forEach(z=>{
  L.rectangle(z.bounds,{color:z.color,weight:1,fillOpacity:0.07,opacity:0.35,interactive:false}).addTo(map);
  L.marker([(z.bounds[0][0]+z.bounds[1][0])/2,(z.bounds[0][1]+z.bounds[1][1])/2],{
    icon:L.divIcon({html:`<div style="font-size:9px;color:${z.color};white-space:nowrap;text-shadow:0 0 3px #000;font-weight:700;opacity:.7">${z.name}</div>`,className:'',iconAnchor:[0,0]})
  }).addTo(map);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let mkrs={}, acData=[], trails={}, cFilt='all', tFilt='all', searchQ='', curTab='news';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARKERS + TRAILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SVG paths for each aircraft type (all pointing UP = 0Â°, rotated by heading)
const SVG_ICONS = {
  fighter: `<polygon points="8,0 10,14 8,11 6,14" fill="COLOR" stroke="COLOR" stroke-width=".5"/>
    <polygon points="8,4 14,12 8,9 2,12" fill="COLOR" opacity=".85"/>
    <polygon points="8,9 11,16 8,14 5,16" fill="COLOR" opacity=".7"/>`,
  bomber: `<polygon points="8,0 11,10 8,8 5,10" fill="COLOR"/>
    <polygon points="8,3 16,14 8,10 0,14" fill="COLOR" opacity=".9"/>
    <polygon points="8,9 12,17 8,15 4,17" fill="COLOR" opacity=".7"/>`,
  transport: `<rect x="6" y="0" width="4" height="14" rx="2" fill="COLOR"/>
    <polygon points="8,3 16,10 8,8 0,10" fill="COLOR" opacity=".85"/>
    <polygon points="8,10 11,16 8,14 5,16" fill="COLOR" opacity=".7"/>`,
  tanker: `<rect x="6.5" y="0" width="3" height="14" rx="1.5" fill="COLOR"/>
    <polygon points="8,2 15,9 8,7 1,9" fill="COLOR" opacity=".85"/>
    <polygon points="8,9 11,15 8,13 5,15" fill="COLOR" opacity=".7"/>
    <circle cx="8" cy="0" r="1.5" fill="COLOR"/>`,
  recon: `<ellipse cx="8" cy="7" rx="3" ry="7" fill="COLOR"/>
    <polygon points="8,2 15,8 8,6 1,8" fill="COLOR" opacity=".8"/>
    <line x1="8" y1="14" x2="8" y2="17" stroke="COLOR" stroke-width="1.5"/>`,
  heli: `<ellipse cx="8" cy="9" rx="3" ry="4" fill="COLOR"/>
    <line x1="1" y1="7" x2="15" y2="7" stroke="COLOR" stroke-width="2" stroke-linecap="round"/>
    <line x1="6" y1="14" x2="12" y2="14" stroke="COLOR" stroke-width="1.5" stroke-linecap="round"/>
    <line x1="8" y1="7" x2="8" y2="14" stroke="COLOR" stroke-width="1"/>`,
  trainer: `<polygon points="8,1 10,12 8,10 6,12" fill="COLOR"/>
    <polygon points="8,4 13,10 8,8 3,10" fill="COLOR" opacity=".85"/>`,
  other: `<polygon points="8,0 10,12 8,10 6,12" fill="COLOR"/>
    <polygon points="8,3 14,11 8,8 2,11" fill="COLOR" opacity=".8"/>`,
};

function mkIcon(ac){
  const tp=classifyType(ac);
  const g=getGroup(ac.hex);
  const col=getCol(ac.hex);
  const adv=(g==='iran'||g==='russia'||g==='china');
  const rot=ac.track||0;
  const sz=adv?22:18;
  const svgPath=(SVG_ICONS[tp]||SVG_ICONS.other).replace(/COLOR/g,col);
  const glow=adv?`drop-shadow(0 0 3px ${col})`:'drop-shadow(0 0 1px #000)';
  const html=`<svg width="${sz}" height="${sz}" viewBox="0 0 16 18" style="transform:rotate(${rot}deg);filter:${glow};overflow:visible">${svgPath}</svg>`;
  return L.divIcon({html,className:'',iconSize:[sz,sz],iconAnchor:[sz/2,sz/2]});
}

function updateTrail(ac){
  if(!ac.lat||!ac.lon)return;
  if(!trails[ac.hex])trails[ac.hex]={pts:[],line:null};
  const tr=trails[ac.hex];
  const last=tr.pts[tr.pts.length-1];
  if(!last||last[0]!==ac.lat||last[1]!==ac.lon)tr.pts.push([ac.lat,ac.lon]);
  if(tr.pts.length>40)tr.pts.shift();
}
function showTrail(hex){
  hideTrails();
  const tr=trails[hex];if(!tr||tr.pts.length<2)return;
  tr.line=L.polyline(tr.pts,{color:getCol(hex),weight:2,opacity:0.55,dashArray:'5 4'}).addTo(map);
}
function hideTrails(){Object.values(trails).forEach(t=>{if(t.line){map.removeLayer(t.line);t.line=null;}})}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INFO PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showP(ac){
  const fl=(ac.flight||'').trim();
  const tp=classifyType(ac);
  const col=getCol(ac.hex);
  document.getElementById('pTitle').innerHTML=`${getFlag(ac.hex)} ${fl||ac.hex}`;
  const alt=ac.alt_baro==='ground'?'On Ground':(ac.alt_baro?ac.alt_baro.toLocaleString()+' ft':'â€”');
  const spd=ac.gs?Math.round(ac.gs)+' kts':'â€”';
  const hdg=ac.track?Math.round(ac.track)+'Â°':'â€”';
  const vr=ac.baro_rate?(ac.baro_rate>0?'+':'')+ac.baro_rate+' ft/min':'â€”';
  document.getElementById('pBody').innerHTML=`
    <div class="f"><span class="k">Country: </span><span class="v" style="color:${col}">${getFlag(ac.hex)} ${getCName(ac.hex)}</span></div>
    <div class="f"><span class="k">Category: </span><span class="v">${TICO[tp]} ${TLAB[tp]}</span></div>
    <div class="f"><span class="k">Aircraft: </span><span class="v">${ac.t||'â€”'}</span></div>
    <div class="f"><span class="k">Reg: </span><span class="v">${ac.r||'â€”'}</span></div>
    <div class="f"><span class="k">Callsign: </span><span class="v">${fl||'â€”'}</span></div>
    <div class="f"><span class="k">Altitude: </span><span class="v">${alt}</span></div>
    <div class="f"><span class="k">Speed: </span><span class="v">${spd}</span></div>
    <div class="f"><span class="k">Heading: </span><span class="v">${hdg}</span></div>
    <div class="f"><span class="k">Vert Rate: </span><span class="v">${vr}</span></div>
    <div class="f"><span class="k">Squawk: </span><span class="v">${ac.squawk||'â€”'}</span></div>
    <div class="f"><span class="k">ICAO Hex: </span><span class="v">${ac.hex}</span></div>
    <div class="f"><span class="k">Position: </span><span class="v">${ac.lat?.toFixed(4)}, ${ac.lon?.toFixed(4)}</span></div>
    <div class="f"><span class="k">Last Seen: </span><span class="v">${Math.round(ac.seen||0)}s ago</span></div>
    <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
      <a href="https://www.planespotters.net/hex/${ac.hex}" target="_blank" style="font-size:10px;color:#3b82f6;text-decoration:none;background:#111827;padding:3px 7px;border-radius:4px;border:1px solid #1e2a42">ğŸ“· Planespotters</a>
      <a href="https://globe.adsbexchange.com/?icao=${ac.hex}" target="_blank" style="font-size:10px;color:#3b82f6;text-decoration:none;background:#111827;padding:3px 7px;border-radius:4px;border:1px solid #1e2a42">ğŸŒ ADSBx</a>
      <a href="https://flightaware.com/live/modes/${ac.hex}/ident/${(ac.flight||'').trim()}/redirect" target="_blank" style="font-size:10px;color:#3b82f6;text-decoration:none;background:#111827;padding:3px 7px;border-radius:4px;border:1px solid #1e2a42">âœˆ FlightAware</a>
    </div>
  `;
  document.getElementById('infoP').classList.add('vis');
  showTrail(ac.hex);
}
function closeP(){document.getElementById('infoP').classList.remove('vis');hideTrails();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS & SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setCF(f){
  cFilt=f;
  document.querySelectorAll('[id^="bc-"]').forEach(b=>{b.classList.remove('on','iran-on','russia-on','china-on');});
  const btn=document.getElementById('bc-'+f);
  if(f==='iran')btn.classList.add('iran-on');
  else if(f==='russia')btn.classList.add('russia-on');
  else if(f==='china')btn.classList.add('china-on');
  else btn.classList.add('on');
  render();
}
function setTF(f){
  tFilt=f;
  document.querySelectorAll('[id^="bt-"]').forEach(b=>b.classList.remove('on'));
  document.getElementById('bt-'+f).classList.add('on');
  render();
}
function doSearch(){searchQ=document.getElementById('searchBox').value.toUpperCase();render();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function passFilter(ac){
  const g=getGroup(ac.hex);
  const tp=classifyType(ac);
  if(cFilt!=='all'&&g!==cFilt)return false;
  if(tFilt!=='all'&&tp!==tFilt)return false;
  if(searchQ){
    const s=((ac.flight||'')+(ac.t||'')+(ac.hex||'')+(ac.r||'')).toUpperCase();
    if(!s.includes(searchQ))return false;
  }
  return true;
}

function inZone(ac,z){
  return ac.lat&&ac.lon&&
    ac.lat>=z.bounds[0][0]&&ac.lat<=z.bounds[1][0]&&
    ac.lon>=z.bounds[0][1]&&ac.lon<=z.bounds[1][1];
}

function render(){
  Object.values(mkrs).forEach(m=>map.removeLayer(m));
  mkrs={};

  const counts={us:0,iran:0,russia:0,china:0,allied:0};
  const typeCounts={};
  const visible=[];

  acData.forEach(ac=>{
    if(!ac.lat||!ac.lon)return;
    updateTrail(ac);
    if(!passFilter(ac))return;

    const g=getGroup(ac.hex);
    counts[g]=(counts[g]||0)+1;
    const tp=classifyType(ac);
    typeCounts[tp]=(typeCounts[tp]||0)+1;
    visible.push(ac);

    const m=L.marker([ac.lat,ac.lon],{icon:mkIcon(ac)})
      .on('click',()=>showP(ac)).addTo(map);
    const fl=(ac.flight||'').trim();
    const alt=ac.alt_baro==='ground'?'GND':(ac.alt_baro?ac.alt_baro.toLocaleString()+'ft':'?');
    m.bindTooltip(`${getFlag(ac.hex)} ${fl||ac.hex} Â· ${ac.t||'?'} Â· ${alt}`,
      {className:'dark-tooltip',direction:'top',offset:[0,-10]});
    mkrs[ac.hex]=m;
  });

  // Update ticker counts
  const total=visible.length;
  document.title=`OSINT Tracker â€” ${total} aircraft`;

  // Update widget counts
  document.getElementById('ac-count').textContent=total;

  // Update panels
  updateStatsPane(counts,typeCounts,total);
  updateAlertsPane(visible);
  updateActivityPane(visible);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS PANE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStatsPane(counts,typeCounts,total){
  const countryData=[
    {key:'us',   flag:'ğŸ‡ºğŸ‡¸',name:'US',     col:'#3b82f6'},
    {key:'iran', flag:'ğŸ‡®ğŸ‡·',name:'Iran',   col:'#ef4444'},
    {key:'russia',flag:'ğŸ‡·ğŸ‡º',name:'Russia',col:'#dc2626'},
    {key:'china',flag:'ğŸ‡¨ğŸ‡³',name:'China',  col:'#eab308'},
    {key:'allied',flag:'ğŸ¤',name:'Allied', col:'#8b5cf6'},
  ];
  const maxC=Math.max(...countryData.map(d=>counts[d.key]||0),1);
  let ch='<div class="stat-block"><div class="sb-label">Country Breakdown</div>';
  countryData.forEach(d=>{
    const n=counts[d.key]||0;
    const w=Math.round((n/maxC)*80);
    ch+=`<div class="country-row"><div class="cr-flag">${d.flag}</div><div class="cr-name">${d.name}</div><div class="cr-bar-wrap"><div class="cr-bar" style="width:${w}px;background:${d.col}"></div></div><div class="cr-count">${n}</div></div>`;
  });
  ch+=`</div>`;

  const typeData=Object.entries(typeCounts).sort((a,b)=>b[1]-a[1]);
  const maxT=Math.max(...typeData.map(d=>d[1]),1);
  ch+='<div class="stat-block"><div class="sb-label">Type Breakdown</div>';
  typeData.forEach(([tp,n])=>{
    const w=Math.round((n/maxT)*70);
    ch+=`<div class="type-row"><div class="tr-icon">${TICO[tp]||'â—†'}</div><div class="tr-name">${TLAB[tp]||tp}</div><div class="tr-bar-wrap"><div class="tr-bar" style="width:${w}px;background:${TCOL[tp]||'#64748b'}"></div></div><div class="tr-count">${n}</div></div>`;
  });
  ch+=`</div>`;

  ch+=`<div class="stat-block"><div class="sb-label">Summary</div>
    <div class="country-row"><div class="cr-flag">âœˆï¸</div><div class="cr-name">Total tracked</div><div class="cr-count" style="color:#fff;font-size:16px">${total}</div></div>
    <div class="country-row"><div class="cr-flag">â±ï¸</div><div class="cr-name">Refresh interval</div><div class="cr-count" style="color:#8892a8">30s</div></div>
  </div>`;

  document.getElementById('pane-stats').innerHTML=ch;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS PANE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateAlertsPane(visible){
  let h='<div style="padding:8px 12px 4px;font-size:10px;color:#6b7a9e;text-transform:uppercase;letter-spacing:.5px">Live aircraft in monitored zones</div>';
  ZONES.forEach(z=>{
    const ac_in=visible.filter(ac=>inZone(ac,z));
    const hot=ac_in.length>0;
    const warm=ac_in.length===0&&visible.filter(ac=>inZone(ac,z)).length>0;
    h+=`<div class="zone-card ${hot?'hot':warm?'warm':''}">
      <div>
        <div class="zc-name">${z.icon} ${z.name}</div>
        ${hot?ac_in.slice(0,3).map(ac=>`<div style="font-size:10px;color:#6b7a9e;margin-top:2px">${getFlag(ac.hex)} ${(ac.flight||'').trim()||ac.hex} Â· ${ac.t||'?'}</div>`).join(''):''}
      </div>
      <div class="zc-count" style="color:${hot?z.color:'#3a4560'}">${ac_in.length}</div>
    </div>`;
  });
  document.getElementById('pane-alerts').innerHTML=h;
  const hotCount=ZONES.filter(z=>visible.filter(ac=>['iran','russia','china'].includes(getGroup(ac.hex))&&inZone(ac,z)).length>0).length;
  document.getElementById('zone-hot').textContent=hotCount+' hot';
  document.getElementById('zone-hot').style.color=hotCount>0?'#ef4444':'';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIVITY PANE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateActivityPane(visible){
  const sorted=[...visible].sort((a,b)=>(a.seen||999)-(b.seen||999)).slice(0,40);
  let h='<div style="padding:8px 12px 4px;font-size:10px;color:#6b7a9e;text-transform:uppercase;letter-spacing:.5px">Most recently seen</div>';
  sorted.forEach(ac=>{
    const fl=(ac.flight||'').trim()||ac.hex;
    const alt=ac.alt_baro==='ground'?'GND':(ac.alt_baro?Math.round(ac.alt_baro/100)/10+'kft':'?');
    const spd=ac.gs?Math.round(ac.gs)+'kt':'â€”';
    const col=getCol(ac.hex);
    h+=`<div class="feed-item" onclick="map.setView([${ac.lat},${ac.lon}],9);showP(acData.find(a=>a.hex==='${ac.hex}'))" style="cursor:pointer">
      <span class="fi-flag" style="color:${col}">${getFlag(ac.hex)}</span>
      <span class="fi-call" style="color:${col}">${fl}</span>
      <span class="fi-type">${ac.t||'?'}</span>
      <span class="fi-alt">${alt} ${spd}</span>
    </div>`;
  });
  document.getElementById('pane-activity').innerHTML=h;
}

// no-op: tabs replaced by widget grid
function switchTab(t){ curTab=t; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEWS / INTEL FEED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NEWS_SOURCES=[
  {name:'Defense News',url:'https://www.defensenews.com/arc/outboundfeeds/rss/',label:'DEFNEWS'},
  {name:'Reuters World',url:'https://feeds.reuters.com/Reuters/worldNews',label:'REUTERS'},
  {name:'BBC Middle East',url:'https://feeds.bbci.co.uk/news/world/middle_east/rss.xml',label:'BBC ME'},
  {name:'BBC World',url:'https://feeds.bbci.co.uk/news/world/rss.xml',label:'BBC'},
  {name:'Al Jazeera',url:'https://www.aljazeera.com/xml/rss/all.xml',label:'AL JAZEERA'},
  {name:'Breaking Defense',url:'https://breakingdefense.com/feed/',label:'BREAK DEF'},
];

let allNews=[];

async function fetchRSS(src){
  try{
    const proxy='https://api.allorigins.win/raw?url='+encodeURIComponent(src.url);
    const r=await fetch(proxy,{signal:AbortSignal.timeout(8000)});
    const txt=await r.text();
    const doc=new DOMParser().parseFromString(txt,'text/xml');
    const items=[...doc.querySelectorAll('item')].slice(0,8);
    return items.map(i=>({
      source:src.label,
      title:(i.querySelector('title')?.textContent||'').replace('<![CDATA[','').replace(']]>','').trim(),
      link:i.querySelector('link')?.textContent?.trim()||'#',
      date:new Date(i.querySelector('pubDate')?.textContent||Date.now()),
    })).filter(n=>n.title);
  }catch(e){return[];}
}

async function fetchAllNews(){
  const results=await Promise.allSettled(NEWS_SOURCES.map(s=>fetchRSS(s)));
  const items=results.flatMap(r=>r.status==='fulfilled'?r.value:[]);
  items.sort((a,b)=>b.date-a.date);
  allNews=items;
  renderNews(items);
  updateTicker(items);
}

// Military keywords for highlighting
const MIL_KEYWORDS=['military','missile','strike','iran','russia','china','nato','navy','airforce','army','nuclear','drone','warship','attack','defense','conflict','troops','weapons','sanction','war','bomb','radar','satellite','intercept'];

function isAlert(title){
  const t=title.toLowerCase();
  return MIL_KEYWORDS.some(k=>t.includes(k));
}

function renderNews(items){
  const strip = document.getElementById('newsStrip');
  if(!items.length){
    strip.innerHTML='<div style="padding:20px;color:#6b7a9e;font-size:12px">Loading intel feed...</div>';
    return;
  }
  let h='';
  items.forEach(n=>{
    const alert=isAlert(n.title);
    const ago=getTimeAgo(n.date);
    h+=`<a href="${n.link}" target="_blank" rel="noopener" style="text-decoration:none">
      <div class="news-card ${alert?'alert':''}">
        <div class="nc-src">${alert?'ğŸ”´ ':''} ${n.source}</div>
        <div class="nc-title">${n.title}</div>
        <div class="nc-meta">${ago}</div>
      </div>
    </a>`;
  });
  strip.innerHTML=h;
}

function getTimeAgo(date){
  const mins=Math.round((Date.now()-date)/60000);
  if(mins<60)return`${mins}m ago`;
  const hrs=Math.round(mins/60);
  if(hrs<24)return`${hrs}h ago`;
  return`${Math.round(hrs/24)}d ago`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TICKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateTicker(news){
  const items=[
    ...news.slice(0,12).map(n=>`<span class="ticker-item"><span class="ti-src">${n.source}</span>${n.title}<span class="ti-sep">|</span></span>`),
  ];
  document.getElementById('tickerInner').innerHTML=items.join('')+items.join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AIRCRAFT FETCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AC_URLS=[
  'https://api.adsb.lol/v2/mil',
  'https://corsproxy.io/?url=https://api.adsb.lol/v2/mil',
  'https://api.allorigins.win/raw?url='+encodeURIComponent('https://api.adsb.lol/v2/mil'),
];

async function fetchData(){
  for(const url of AC_URLS){
    try{
      const r=await fetch(url,{signal:AbortSignal.timeout(10000)});
      if(!r.ok)throw new Error(r.status);
      const d=await r.json();
      acData=d.ac||[];
      render();
      document.getElementById('loadOv').style.display='none';
      return;
    }catch(e){console.warn('AC fetch fail',url,e.message);}
  }
  document.getElementById('loadOv').style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let notifEnabled = false;
let prevZoneSets = {}; // zone -> Set of hex ids

function toggleNotifications(){
  if(!notifEnabled){
    Notification.requestPermission().then(p=>{
      if(p==='granted'){
        notifEnabled=true;
        document.getElementById('btn-notif').classList.add('on');
        document.getElementById('btn-notif').textContent='ğŸ”” Alerts ON';
        new Notification('OSINT Tracker', {body:'Zone alerts enabled. You\'ll be notified when adversary aircraft enter monitored zones.'});
      }
    });
  } else {
    notifEnabled=false;
    document.getElementById('btn-notif').classList.remove('on');
    document.getElementById('btn-notif').textContent='ğŸ”” Alerts';
  }
}

function checkZoneAlerts(visible){
  if(!notifEnabled) return;
  const adversary=['iran','russia','china'];
  ZONES.forEach(z=>{
    const key=z.name;
    const current=new Set(
      visible.filter(ac=>adversary.includes(getGroup(ac.hex))&&inZone(ac,z)).map(ac=>ac.hex)
    );
    const prev=prevZoneSets[key]||new Set();
    current.forEach(hex=>{
      if(!prev.has(hex)){
        const ac=acData.find(a=>a.hex===hex);
        const fl=(ac?.flight||'').trim()||hex;
        new Notification(`âš ï¸ ${z.name}`, {
          body:`${getFlag(hex)} ${fl} (${ac?.t||'?'}) entered ${z.name}`,
          icon:'https://rpike623.github.io/mil-tracker/favicon.ico'
        });
      }
    });
    prevZoneSets[key]=current;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENT LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const eventLog = [];
let prevAcSet = new Set();

function updateEventLog(visible){
  const currentSet = new Set(visible.map(ac=>ac.hex));
  const adversary = ['iran','russia','china'];

  // New adversary detections
  visible.forEach(ac=>{
    if(adversary.includes(getGroup(ac.hex)) && !prevAcSet.has(ac.hex)){
      const fl=(ac.flight||'').trim()||ac.hex;
      eventLog.unshift({
        time: new Date(),
        type: 'new',
        msg: `${getFlag(ac.hex)} NEW: ${fl} (${ac.t||'?'}) detected`,
        col: getCol(ac.hex),
      });
    }
  });

  // Zone entries
  ZONES.forEach(z=>{
    const inNow = visible.filter(ac=>adversary.includes(getGroup(ac.hex))&&inZone(ac,z));
    inNow.forEach(ac=>{
      if(!prevAcSet.has(ac.hex)){
        const fl=(ac.flight||'').trim()||ac.hex;
        eventLog.unshift({
          time: new Date(),
          type: 'zone',
          msg: `${getFlag(ac.hex)} ZONE: ${fl} in ${z.name}`,
          col: z.color,
        });
      }
    });
  });

  if(eventLog.length > 200) eventLog.splice(200);
  prevAcSet = currentSet;
  renderEventLog();
  document.getElementById('log-count').textContent=eventLog.length;
}

function renderEventLog(){
  if(!eventLog.length){
    document.getElementById('pane-log').innerHTML='<div style="padding:20px;color:#6b7a9e;font-size:12px;text-align:center">No events yet.<br>Adversary aircraft detections and zone entries will appear here.</div>';
    return;
  }
  let h='<div style="padding:8px 12px 4px;font-size:10px;color:#6b7a9e;text-transform:uppercase;letter-spacing:.5px">Adversary detection log</div>';
  eventLog.slice(0,60).forEach(e=>{
    const ts=e.time.toLocaleTimeString();
    h+=`<div class="feed-item">
      <span style="color:${e.col};font-size:10px;min-width:55px">${ts}</span>
      <span style="font-size:11px;color:${e.col}">${e.msg}</span>
    </div>`;
  });
  document.getElementById('pane-log').innerHTML=h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATCH RENDER TO INCLUDE NEW FEATURES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _origRender = render;
// Override render to also run notifications + log
const _render = render;
render = function(){
  _render();
  // Get visible aircraft for post-render hooks
  const visible = acData.filter(ac=>ac.lat&&ac.lon&&passFilter(ac));
  checkZoneAlerts(visible);
  updateEventLog(visible);
};

// switchTab is now a no-op (widget grid replaces tabs)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
fetchData();
fetchAllNews();
setInterval(fetchData, 30000);
setInterval(fetchAllNews, 300000); // news every 5 min

switchTab('news');
</script>
</body>
</html>
