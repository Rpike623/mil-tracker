<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Military Tracker â€” PikeClaw âš¡</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0a0e17; color: #e0e0e0; }
  #map { width: 100%; height: 100vh; }

  /* Controls overlay */
  .controls {
    position: absolute; top: 12px; left: 60px; z-index: 1000;
    display: flex; gap: 6px; align-items: center; flex-wrap: wrap; max-width: calc(100% - 80px);
  }
  .controls button {
    background: #1a1f2e; border: 1px solid #2a3045; color: #e0e0e0;
    padding: 7px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;
    transition: all 0.2s; white-space: nowrap;
  }
  .controls button:hover { background: #2a3045; border-color: #4a5580; }
  .controls button.active { background: #1e3a5f; border-color: #3b82f6; color: #60a5fa; }
  .controls .separator { width: 1px; height: 24px; background: #2a3045; margin: 0 2px; }

  /* Country filter buttons */
  .controls button.country-us.active { background: #1e3a5f; border-color: #3b82f6; color: #60a5fa; }
  .controls button.country-iran.active { background: #4a1e1e; border-color: #ef4444; color: #f87171; }

  /* Stats bar */
  .stats {
    position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
    background: rgba(10, 14, 23, 0.92); border-top: 1px solid #1a1f2e;
    padding: 10px 20px; display: flex; gap: 20px; align-items: center;
    font-size: 13px; backdrop-filter: blur(8px); flex-wrap: wrap;
  }
  .stats .stat { display: flex; align-items: center; gap: 6px; }
  .stats .stat .dot { width: 8px; height: 8px; border-radius: 50%; }
  .stats .stat .count { font-weight: 600; color: #fff; }
  .stats .stat .label { color: #8892a8; }
  .stats .update-time { margin-left: auto; color: #555e73; }

  /* Info panel */
  .info-panel {
    position: absolute; top: 12px; right: 12px; z-index: 1000;
    background: rgba(16, 20, 32, 0.95); border: 1px solid #1a1f2e;
    border-radius: 10px; padding: 16px; min-width: 280px; max-width: 340px;
    display: none; backdrop-filter: blur(8px);
  }
  .info-panel.visible { display: block; }
  .info-panel h3 { font-size: 15px; margin-bottom: 8px; color: #fff; }
  .info-panel .close-btn {
    position: absolute; top: 8px; right: 12px; background: none;
    border: none; color: #666; cursor: pointer; font-size: 18px;
  }
  .info-panel .close-btn:hover { color: #fff; }
  .info-panel .field { margin-bottom: 6px; font-size: 13px; }
  .info-panel .field .key { color: #8892a8; }
  .info-panel .field .val { color: #e0e0e0; font-weight: 500; }

  /* Leaflet popup override */
  .leaflet-popup-content-wrapper { background: #1a1f2e; color: #e0e0e0; border-radius: 8px; }
  .leaflet-popup-tip { background: #1a1f2e; }
  .leaflet-popup-content { font-size: 13px; line-height: 1.5; }

  /* Aircraft icon */
  .aircraft-icon { font-size: 20px; text-shadow: 0 0 6px rgba(0,0,0,0.8); transition: transform 0.3s; }

  /* Legend */
  .legend {
    position: absolute; bottom: 54px; right: 12px; z-index: 1000;
    background: rgba(16, 20, 32, 0.92); border: 1px solid #1a1f2e;
    border-radius: 8px; padding: 12px 16px; font-size: 12px;
    backdrop-filter: blur(8px);
  }
  .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  .legend-item .swatch { width: 12px; height: 12px; border-radius: 2px; }
  .legend-section { font-weight: 600; margin-top: 8px; margin-bottom: 4px; font-size: 11px; text-transform: uppercase; color: #8892a8; }
  .legend-section:first-child { margin-top: 0; }

  .loading-overlay {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    z-index: 2000; background: rgba(10,14,23,0.9); padding: 24px 32px;
    border-radius: 10px; border: 1px solid #2a3045; text-align: center;
  }
  .loading-overlay .spinner { font-size: 32px; animation: spin 1s linear infinite; display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="map"></div>

<div class="controls">
  <!-- Country filters -->
  <button id="btn-country-all" class="active" onclick="setCountryFilter('all')">ğŸŒ All</button>
  <button id="btn-country-us" class="country-us" onclick="setCountryFilter('us')">ğŸ‡ºğŸ‡¸ US</button>
  <button id="btn-country-iran" class="country-iran" onclick="setCountryFilter('iran')">ğŸ‡®ğŸ‡· Iran</button>
  <button id="btn-country-allied" onclick="setCountryFilter('allied')">ğŸ¤ Allied</button>
  <div class="separator"></div>
  <!-- Type filters -->
  <button id="btn-all" class="active" onclick="setTypeFilter('all')">All Types</button>
  <button id="btn-fighter" onclick="setTypeFilter('fighter')">âœˆï¸ Fighter</button>
  <button id="btn-transport" onclick="setTypeFilter('transport')">ğŸ›©ï¸ Transport</button>
  <button id="btn-tanker" onclick="setTypeFilter('tanker')">â›½ Tanker</button>
  <button id="btn-recon" onclick="setTypeFilter('recon')">ğŸ” ISR</button>
  <button id="btn-heli" onclick="setTypeFilter('heli')">ğŸš Heli</button>
  <button id="btn-bomber" onclick="setTypeFilter('bomber')">ğŸ’£ Bomber</button>
  <button id="btn-trainer" onclick="setTypeFilter('trainer')">ğŸ“ Trainer</button>
</div>

<div class="info-panel" id="infoPanel">
  <button class="close-btn" onclick="closePanel()">&times;</button>
  <h3 id="panelTitle">â€”</h3>
  <div id="panelBody"></div>
</div>

<div class="legend">
  <div class="legend-section">Country</div>
  <div class="legend-item"><div class="swatch" style="background:#3b82f6"></div> ğŸ‡ºğŸ‡¸ United States</div>
  <div class="legend-item"><div class="swatch" style="background:#ef4444"></div> ğŸ‡®ğŸ‡· Iran</div>
  <div class="legend-item"><div class="swatch" style="background:#8b5cf6"></div> Allied / Other</div>
  <div class="legend-section">Aircraft Type</div>
  <div class="legend-item"><div class="swatch" style="background:#f97316"></div> Fighter/Attack</div>
  <div class="legend-item"><div class="swatch" style="background:#38bdf8"></div> Transport</div>
  <div class="legend-item"><div class="swatch" style="background:#c084fc"></div> Tanker</div>
  <div class="legend-item"><div class="swatch" style="background:#22d3ee"></div> ISR/Patrol</div>
  <div class="legend-item"><div class="swatch" style="background:#4ade80"></div> Helicopter</div>
  <div class="legend-item"><div class="swatch" style="background:#f87171"></div> Bomber</div>
  <div class="legend-item"><div class="swatch" style="background:#facc15"></div> Trainer</div>
  <div class="legend-item"><div class="swatch" style="background:#64748b"></div> Other</div>
</div>

<div class="stats" id="statsBar">
  <div class="stat"><div class="dot" style="background:#22c55e"></div><span class="count" id="totalCount">â€”</span><span class="label">total</span></div>
  <div class="stat"><div class="dot" style="background:#3b82f6"></div><span class="count" id="usCount">â€”</span><span class="label">US</span></div>
  <div class="stat"><div class="dot" style="background:#ef4444"></div><span class="count" id="iranCount">â€”</span><span class="label">Iran</span></div>
  <div class="stat"><div class="dot" style="background:#8b5cf6"></div><span class="count" id="allyCount">â€”</span><span class="label">allied</span></div>
  <span class="update-time" id="updateTime">Loading...</span>
</div>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner">âœˆï¸</div>
  <div style="margin-top:8px; color:#8892a8;">Loading military aircraft...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// â”€â”€ Map setup â”€â”€
const map = L.map('map', {
  center: [32, 44], // Center between US and Middle East
  zoom: 3,
  zoomControl: true,
  attributionControl: true,
});

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://osm.org">OSM</a> &copy; <a href="https://carto.com">CARTO</a> | Data: <a href="https://adsb.lol">adsb.lol</a>',
  subdomains: 'abcd', maxZoom: 19,
}).addTo(map);

// â”€â”€ Country identification by ICAO hex range â”€â”€
// Reference: https://www.aerotransport.org/html/ICAO_hex.html
const COUNTRY_RANGES = {
  us: [
    [0xA00000, 0xAFFFFF],  // US (includes military)
  ],
  iran: [
    [0x730000, 0x737FFF],  // Iran
  ],
  // Key allied nations
  uk:       [[0x400000, 0x43FFFF]],
  canada:   [[0xC00000, 0xC3FFFF]],
  australia:[[0x7C0000, 0x7FFFFF]],
  france:   [[0x380000, 0x3BFFFF]],
  germany:  [[0x3C0000, 0x3FFFFF]],
  japan:    [[0x840000, 0x87FFFF]],
  korea:    [[0x718000, 0x71FFFF]],
  italy:    [[0x300000, 0x33FFFF]],
  israel:   [[0x738000, 0x73FFFF]],
  nato:     [[0x480000, 0x480FFF]],
  saudi:    [[0x710000, 0x717FFF]],
  turkey:   [[0x4B0000, 0x4B7FFF]],
  india:    [[0x800000, 0x83FFFF]],
  pakistan:  [[0x760000, 0x767FFF]],
  uae:      [[0x896000, 0x896FFF]],
};

function getCountry(hex) {
  const h = parseInt(hex, 16);
  for (const [country, ranges] of Object.entries(COUNTRY_RANGES)) {
    for (const [lo, hi] of ranges) {
      if (h >= lo && h <= hi) return country;
    }
  }
  return 'unknown';
}

function getCountryGroup(hex) {
  const country = getCountry(hex);
  if (country === 'us') return 'us';
  if (country === 'iran') return 'iran';
  return 'allied';
}

function getCountryFlag(hex) {
  const country = getCountry(hex);
  const flags = {
    us: 'ğŸ‡ºğŸ‡¸', iran: 'ğŸ‡®ğŸ‡·', uk: 'ğŸ‡¬ğŸ‡§', canada: 'ğŸ‡¨ğŸ‡¦', australia: 'ğŸ‡¦ğŸ‡º',
    france: 'ğŸ‡«ğŸ‡·', germany: 'ğŸ‡©ğŸ‡ª', japan: 'ğŸ‡¯ğŸ‡µ', korea: 'ğŸ‡°ğŸ‡·', italy: 'ğŸ‡®ğŸ‡¹',
    israel: 'ğŸ‡®ğŸ‡±', nato: 'ğŸ›ï¸', saudi: 'ğŸ‡¸ğŸ‡¦', turkey: 'ğŸ‡¹ğŸ‡·', india: 'ğŸ‡®ğŸ‡³',
    pakistan: 'ğŸ‡µğŸ‡°', uae: 'ğŸ‡¦ğŸ‡ª',
  };
  return flags[country] || 'ğŸŒ';
}

function getCountryName(hex) {
  const country = getCountry(hex);
  const names = {
    us: 'United States', iran: 'Iran', uk: 'United Kingdom', canada: 'Canada',
    australia: 'Australia', france: 'France', germany: 'Germany', japan: 'Japan',
    korea: 'South Korea', italy: 'Italy', israel: 'Israel', nato: 'NATO',
    saudi: 'Saudi Arabia', turkey: 'Turkey', india: 'India', pakistan: 'Pakistan',
    uae: 'UAE',
  };
  return names[country] || 'Unknown';
}

// â”€â”€ Aircraft type classification â”€â”€
const AIRCRAFT_TYPES = {
  fighter: {
    types: ['F15','F16','F18','F22','F35','FA18','EUFI','GR4','TOR','RFAL','JF17','SU27','SU30','SU35','MIG29','MIG31','J10','J11','J15','J16','J20','F2','F4','A10','AV8B','EA18','EF18','F14','F5','F7','MIR2','MIRA'],
    label: 'Fighter/Attack'
  },
  transport: {
    types: ['C17','C130','C30J','C5','C5M','C12','C40','C37','C20','C21','C26','C32','C38','C145','C146','C27J','A400','C160','C295','CN35','IL76','AN124','AN12','Y20','C2','B707','B703'],
    label: 'Transport'
  },
  tanker: {
    types: ['KC10','KC46','KC135','KC130','KC30','KC46A','A330','MRTT','IL78'],
    label: 'Tanker'
  },
  recon: {
    types: ['P8','P3','EP3','RC135','E3','E6','E8','E2','E737','E767','U2','RQ4','MQ4','MQ9','MQ1','RQ170','MC12','RC12','RC26','WC130','WC135','OC135','MC130','EC130','JSTAR','AWACS','SENT','R1','NIMR'],
    label: 'ISR/Patrol'
  },
  heli: {
    types: ['UH60','AH64','CH47','CH53','MH60','HH60','MH53','SH60','OH58','UH1','AH1','V22','MV22','CV22','H60','H47','H53','EC45','NH90','AS65','EH10','LYNX','MH65','HH65','AS32','H64','H1','B212','B412','AB21','AB41','MI17','MI24','MI8','MI28','S61','S70'],
    label: 'Helicopter'
  },
  bomber: {
    types: ['B52','B1','B2','B21','B1B','B52H','TU95','TU160','H6'],
    label: 'Bomber'
  },
  trainer: {
    types: ['T6','T38','T45','T1','T44','T7','T50','TH57','TH67','PC12','PC21','T346','AT38','BE20','C560','T37','T41','LJ35','LJ45','C172','PC9','PC7','T34','EMB3'],
    label: 'Trainer'
  }
};

// Type colors (used when in type-color mode)
const TYPE_COLORS = {
  fighter: '#f97316', transport: '#38bdf8', tanker: '#c084fc', recon: '#22d3ee',
  heli: '#4ade80', bomber: '#f87171', trainer: '#facc15', other: '#64748b'
};

// Country group colors
const COUNTRY_COLORS = {
  us: '#3b82f6',
  iran: '#ef4444',
  allied: '#8b5cf6',
};

function classifyType(ac) {
  const t = (ac.t || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
  const flight = (ac.flight || '').trim().toUpperCase();

  for (const [cat, info] of Object.entries(AIRCRAFT_TYPES)) {
    for (const pattern of info.types) {
      const p = pattern.replace(/[^A-Z0-9]/g, '');
      if (t.includes(p) || t.startsWith(p)) {
        return { category: cat, label: info.label };
      }
    }
  }
  if (/^VIPER|^RAGE|^COBRA|^HAWK/.test(flight)) return { category: 'fighter', label: 'Fighter/Attack' };
  if (/^RCH|^REACH/.test(flight)) return { category: 'transport', label: 'Transport' };
  if (/^ETHYL|^TEXAC|^SHELL|^TEAL/.test(flight)) return { category: 'tanker', label: 'Tanker' };
  if (/^JAKE|^TOPCAT|^TRIDENT/.test(flight)) return { category: 'recon', label: 'ISR/Patrol' };
  if (/^DUST|^PEDRO|^RESCUE/.test(flight)) return { category: 'heli', label: 'Helicopter' };
  if (/^BOMB|^DEATH|^DOOM/.test(flight)) return { category: 'bomber', label: 'Bomber' };

  return { category: 'other', label: 'Other/Unknown' };
}

// Color: country group is primary, type is secondary info
function getMarkerColor(ac) {
  const group = getCountryGroup(ac.hex);
  return COUNTRY_COLORS[group] || '#64748b';
}

// Iran gets a distinct glow
function getMarkerGlow(ac) {
  const group = getCountryGroup(ac.hex);
  if (group === 'iran') return '0 0 8px rgba(239,68,68,0.6)';
  return '0 0 4px rgba(0,0,0,0.9)';
}

// â”€â”€ State â”€â”€
let markers = {};
let aircraftData = [];
let currentTypeFilter = 'all';
let currentCountryFilter = 'all';
let refreshTimer;

// â”€â”€ Create rotated aircraft marker â”€â”€
function createIcon(ac) {
  const rotation = ac.track || 0;
  const typeInfo = classifyType(ac);
  const size = typeInfo.category === 'heli' ? 18 : 22;
  const color = getMarkerColor(ac);
  const glow = getMarkerGlow(ac);
  const group = getCountryGroup(ac.hex);
  // Iran aircraft are slightly larger for visibility
  const finalSize = group === 'iran' ? size + 4 : size;
  const symbol = typeInfo.category === 'heli' ? 'ğŸš' : 'âœˆ';

  return L.divIcon({
    html: `<div style="color:${color}; transform:rotate(${rotation}deg); font-size:${finalSize}px; line-height:1; text-shadow: ${glow}; filter: ${group === 'iran' ? 'brightness(1.2)' : 'none'};">${symbol}</div>`,
    className: 'aircraft-icon',
    iconSize: [finalSize, finalSize],
    iconAnchor: [finalSize/2, finalSize/2],
  });
}

// â”€â”€ Info panel â”€â”€
function showPanel(ac) {
  const panel = document.getElementById('infoPanel');
  const flight = (ac.flight || '').trim();
  const typeInfo = classifyType(ac);
  const flag = getCountryFlag(ac.hex);
  const countryName = getCountryName(ac.hex);

  document.getElementById('panelTitle').textContent = `${flag} ${flight || ac.hex}`;

  const alt = ac.alt_baro === 'ground' ? 'On Ground' : (ac.alt_baro ? ac.alt_baro.toLocaleString() + ' ft' : 'â€”');
  const speed = ac.gs ? Math.round(ac.gs) + ' kts' : 'â€”';
  const heading = ac.track ? Math.round(ac.track) + 'Â°' : 'â€”';
  const vr = ac.baro_rate ? (ac.baro_rate > 0 ? '+' : '') + ac.baro_rate + ' ft/min' : 'â€”';
  const reg = ac.r || 'â€”';
  const type = ac.t || 'â€”';
  const squawk = ac.squawk || 'â€”';
  const groupColor = getMarkerColor(ac);

  document.getElementById('panelBody').innerHTML = `
    <div class="field"><span class="key">Country: </span><span class="val" style="color:${groupColor}">${flag} ${countryName}</span></div>
    <div class="field"><span class="key">Category: </span><span class="val">${typeInfo.label}</span></div>
    <div class="field"><span class="key">Type: </span><span class="val">${type}</span></div>
    <div class="field"><span class="key">Registration: </span><span class="val">${reg}</span></div>
    <div class="field"><span class="key">Callsign: </span><span class="val">${flight || 'â€”'}</span></div>
    <div class="field"><span class="key">Altitude: </span><span class="val">${alt}</span></div>
    <div class="field"><span class="key">Speed: </span><span class="val">${speed}</span></div>
    <div class="field"><span class="key">Heading: </span><span class="val">${heading}</span></div>
    <div class="field"><span class="key">Vertical Rate: </span><span class="val">${vr}</span></div>
    <div class="field"><span class="key">Squawk: </span><span class="val">${squawk}</span></div>
    <div class="field"><span class="key">ICAO Hex: </span><span class="val">${ac.hex}</span></div>
    <div class="field"><span class="key">Position: </span><span class="val">${ac.lat?.toFixed(4)}, ${ac.lon?.toFixed(4)}</span></div>
  `;
  panel.classList.add('visible');
}

function closePanel() {
  document.getElementById('infoPanel').classList.remove('visible');
}

// â”€â”€ Filters â”€â”€
function setCountryFilter(f) {
  currentCountryFilter = f;
  document.querySelectorAll('.controls button[id^="btn-country-"]').forEach(b => b.classList.remove('active'));
  document.getElementById('btn-country-' + f).classList.add('active');
  renderMarkers();
}

function setTypeFilter(f) {
  currentTypeFilter = f;
  document.querySelectorAll('.controls button[id^="btn-"]:not([id^="btn-country-"])').forEach(b => b.classList.remove('active'));
  document.getElementById('btn-' + f).classList.add('active');
  renderMarkers();
}

// â”€â”€ Render â”€â”€
function renderMarkers() {
  Object.values(markers).forEach(m => map.removeLayer(m));
  markers = {};

  let total = 0, us = 0, iran = 0, ally = 0;

  aircraftData.forEach(ac => {
    if (!ac.lat || !ac.lon) return;

    const typeInfo = classifyType(ac);
    const group = getCountryGroup(ac.hex);

    // Apply country filter
    if (currentCountryFilter !== 'all' && group !== currentCountryFilter) return;
    // Apply type filter
    if (currentTypeFilter !== 'all' && typeInfo.category !== currentTypeFilter) return;

    total++;
    if (group === 'us') us++;
    else if (group === 'iran') iran++;
    else ally++;

    const marker = L.marker([ac.lat, ac.lon], { icon: createIcon(ac) })
      .on('click', () => showPanel(ac))
      .addTo(map);

    const flight = (ac.flight || '').trim();
    const alt = ac.alt_baro === 'ground' ? 'GND' : (ac.alt_baro ? ac.alt_baro.toLocaleString() + 'ft' : '?');
    const flag = getCountryFlag(ac.hex);
    marker.bindTooltip(`${flag} ${flight || ac.hex} Â· ${ac.t || '?'} Â· ${alt}`, {
      className: 'dark-tooltip', direction: 'top', offset: [0, -12]
    });

    markers[ac.hex] = marker;
  });

  document.getElementById('totalCount').textContent = total;
  document.getElementById('usCount').textContent = us;
  document.getElementById('iranCount').textContent = iran;
  document.getElementById('allyCount').textContent = ally;
}

// â”€â”€ Fetch data with fallback â”€â”€
const API_URLS = [
  'https://api.adsb.lol/v2/mil',
  'https://corsproxy.io/?url=https://api.adsb.lol/v2/mil',
  'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://api.adsb.lol/v2/mil'),
];

async function fetchData() {
  let lastErr;
  for (const url of API_URLS) {
    try {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();
      aircraftData = data.ac || [];
      renderMarkers();

      const now = new Date();
      const iranActive = aircraftData.filter(ac => getCountryGroup(ac.hex) === 'iran' && ac.lat).length;
      document.getElementById('updateTime').textContent =
        `Last update: ${now.toLocaleTimeString()} Â· ${aircraftData.length} in feed` +
        (iranActive > 0 ? ` Â· ğŸ‡®ğŸ‡· ${iranActive} Iranian active` : '');

      document.getElementById('loadingOverlay').style.display = 'none';
      return;
    } catch (err) {
      lastErr = err;
      console.warn('Fetch failed for', url, err.message);
    }
  }
  console.error('All endpoints failed:', lastErr);
  document.getElementById('updateTime').textContent = 'Error fetching data â€” retrying in 30s...';
  document.getElementById('loadingOverlay').style.display = 'none';
}

// â”€â”€ Init â”€â”€
fetchData();
refreshTimer = setInterval(fetchData, 30000);

// Tooltip style
const tooltipStyle = document.createElement('style');
tooltipStyle.textContent = `.dark-tooltip { background: rgba(16,20,32,0.92) !important; color: #e0e0e0 !important; border: 1px solid #2a3045 !important; border-radius: 6px !important; font-size: 12px !important; padding: 4px 8px !important; } .dark-tooltip::before { border-top-color: rgba(16,20,32,0.92) !important; }`;
document.head.appendChild(tooltipStyle);
</script>
</body>
</html>
