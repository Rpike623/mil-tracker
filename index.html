<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>US Military Tracker ‚Äî PikeClaw ‚ö°</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0a0e17; color: #e0e0e0; }
  #map { width: 100%; height: 100vh; }

  /* Controls overlay */
  .controls {
    position: absolute; top: 12px; left: 60px; z-index: 1000;
    display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
  }
  .controls button {
    background: #1a1f2e; border: 1px solid #2a3045; color: #e0e0e0;
    padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 13px;
    transition: all 0.2s;
  }
  .controls button:hover { background: #2a3045; border-color: #4a5580; }
  .controls button.active { background: #1e3a5f; border-color: #3b82f6; color: #60a5fa; }

  /* Stats bar */
  .stats {
    position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
    background: rgba(10, 14, 23, 0.92); border-top: 1px solid #1a1f2e;
    padding: 10px 20px; display: flex; gap: 24px; align-items: center;
    font-size: 13px; backdrop-filter: blur(8px);
  }
  .stats .stat { display: flex; align-items: center; gap: 6px; }
  .stats .stat .dot { width: 8px; height: 8px; border-radius: 50%; }
  .stats .stat .count { font-weight: 600; color: #fff; }
  .stats .stat .label { color: #8892a8; }
  .stats .update-time { margin-left: auto; color: #555e73; }

  /* Info panel */
  .info-panel {
    position: absolute; top: 12px; right: 12px; z-index: 1000;
    background: rgba(16, 20, 32, 0.95); border: 1px solid #1a1f2e;
    border-radius: 10px; padding: 16px; min-width: 280px; max-width: 340px;
    display: none; backdrop-filter: blur(8px);
  }
  .info-panel.visible { display: block; }
  .info-panel h3 { font-size: 15px; margin-bottom: 8px; color: #fff; }
  .info-panel .close-btn {
    position: absolute; top: 8px; right: 12px; background: none;
    border: none; color: #666; cursor: pointer; font-size: 18px;
  }
  .info-panel .close-btn:hover { color: #fff; }
  .info-panel .field { margin-bottom: 6px; font-size: 13px; }
  .info-panel .field .key { color: #8892a8; }
  .info-panel .field .val { color: #e0e0e0; font-weight: 500; }

  /* Leaflet popup override */
  .leaflet-popup-content-wrapper { background: #1a1f2e; color: #e0e0e0; border-radius: 8px; }
  .leaflet-popup-tip { background: #1a1f2e; }
  .leaflet-popup-content { font-size: 13px; line-height: 1.5; }

  /* Aircraft icon */
  .aircraft-icon {
    font-size: 20px; text-shadow: 0 0 6px rgba(0,0,0,0.8);
    transition: transform 0.3s;
  }

  /* Legend */
  .legend {
    position: absolute; bottom: 54px; right: 12px; z-index: 1000;
    background: rgba(16, 20, 32, 0.92); border: 1px solid #1a1f2e;
    border-radius: 8px; padding: 12px 16px; font-size: 12px;
    backdrop-filter: blur(8px);
  }
  .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
  .legend-item .swatch { width: 12px; height: 12px; border-radius: 2px; }

  .loading-overlay {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    z-index: 2000; background: rgba(10,14,23,0.9); padding: 24px 32px;
    border-radius: 10px; border: 1px solid #2a3045; text-align: center;
  }
  .loading-overlay .spinner { font-size: 32px; animation: spin 1s linear infinite; display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="map"></div>

<div class="controls">
  <button id="btn-all" class="active" onclick="setFilter('all')">All Military</button>
  <button id="btn-fighter" onclick="setFilter('fighter')">‚úàÔ∏è Fighter/Attack</button>
  <button id="btn-transport" onclick="setFilter('transport')">üõ©Ô∏è Transport</button>
  <button id="btn-tanker" onclick="setFilter('tanker')">‚õΩ Tanker</button>
  <button id="btn-recon" onclick="setFilter('recon')">üîç ISR/Patrol</button>
  <button id="btn-heli" onclick="setFilter('heli')">üöÅ Helicopter</button>
  <button id="btn-bomber" onclick="setFilter('bomber')">üí£ Bomber</button>
  <button id="btn-trainer" onclick="setFilter('trainer')">üéì Trainer</button>
</div>

<div class="info-panel" id="infoPanel">
  <button class="close-btn" onclick="closePanel()">&times;</button>
  <h3 id="panelTitle">‚Äî</h3>
  <div id="panelBody"></div>
</div>

<div class="legend">
  <div class="legend-item"><div class="swatch" style="background:#f97316"></div> Fighter/Attack</div>
  <div class="legend-item"><div class="swatch" style="background:#3b82f6"></div> Transport</div>
  <div class="legend-item"><div class="swatch" style="background:#a855f7"></div> Tanker</div>
  <div class="legend-item"><div class="swatch" style="background:#22d3ee"></div> ISR/Patrol</div>
  <div class="legend-item"><div class="swatch" style="background:#22c55e"></div> Helicopter</div>
  <div class="legend-item"><div class="swatch" style="background:#ef4444"></div> Bomber</div>
  <div class="legend-item"><div class="swatch" style="background:#eab308"></div> Trainer</div>
  <div class="legend-item"><div class="swatch" style="background:#64748b"></div> Other/Unknown</div>
</div>

<div class="stats" id="statsBar">
  <div class="stat"><div class="dot" style="background:#22c55e"></div><span class="count" id="totalCount">‚Äî</span><span class="label">tracked</span></div>
  <div class="stat"><div class="dot" style="background:#3b82f6"></div><span class="count" id="usCount">‚Äî</span><span class="label">US</span></div>
  <div class="stat"><div class="dot" style="background:#a855f7"></div><span class="count" id="allyCount">‚Äî</span><span class="label">allied</span></div>
  <span class="update-time" id="updateTime">Loading...</span>
</div>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner">‚úàÔ∏è</div>
  <div style="margin-top:8px; color:#8892a8;">Loading military aircraft...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ‚îÄ‚îÄ Map setup ‚îÄ‚îÄ
const map = L.map('map', {
  center: [38, -97],
  zoom: 5,
  zoomControl: true,
  attributionControl: true,
}).setView([38, -97], 5);

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://osm.org">OSM</a> &copy; <a href="https://carto.com">CARTO</a> | Data: <a href="https://adsb.lol">adsb.lol</a>',
  subdomains: 'abcd', maxZoom: 19,
}).addTo(map);

// ‚îÄ‚îÄ Aircraft classification ‚îÄ‚îÄ
const AIRCRAFT_TYPES = {
  fighter: {
    types: ['F15','F16','F18','F22','F35','FA18','F/A-18','EUFI','GR4','TOR','RFAL','JF17','SU27','SU30','SU35','MIG29','MIG31','J10','J11','J15','J16','J20','F2','F4','A10','AV8B','EA18','EF18'],
    color: '#f97316', emoji: '‚úàÔ∏è', label: 'Fighter/Attack'
  },
  transport: {
    types: ['C17','C130','C30J','C5','C5M','C12','C40','C37','C20','C21','C26','C32','C38','C145','C146','C27J','KC30','A400','C160','C295','CN35','IL76','AN124','AN12','Y20'],
    color: '#3b82f6', emoji: 'üõ©Ô∏è', label: 'Transport'
  },
  tanker: {
    types: ['KC10','KC46','KC135','KC130','KC30','KC46A','A330','MRTT','IL78'],
    color: '#a855f7', emoji: '‚õΩ', label: 'Tanker'
  },
  recon: {
    types: ['P8','P3','EP3','RC135','E3','E6','E8','E2','E737','E767','U2','RQ4','MQ4','MQ9','MQ1','RQ170','MC12','RC12','RC26','WC130','WC135','OC135','MC130','EC130','EP3','RC135','JSTAR','AWACS','SENT','R1','NIMR'],
    color: '#22d3ee', emoji: 'üîç', label: 'ISR/Patrol'
  },
  heli: {
    types: ['UH60','AH64','CH47','CH53','MH60','HH60','MH53','SH60','OH58','UH1','AH1','V22','MV22','CV22','H60','H47','H53','EC45','NH90','AS65','EH10','LYNX','MH65','HH65','AS32','H64','H1'],
    color: '#22c55e', emoji: 'üöÅ', label: 'Helicopter'
  },
  bomber: {
    types: ['B52','B1','B2','B21','B1B','B52H','TU95','TU160','H6'],
    color: '#ef4444', emoji: 'üí£', label: 'Bomber'
  },
  trainer: {
    types: ['T6','T38','T45','T1','T44','T7','T50','TH57','TH67','PC12','PC21','T346','AT38','BE20','C560','T37','T41','LJ35','LJ45','C172'],
    color: '#eab308', emoji: 'üéì', label: 'Trainer'
  }
};

function classifyAircraft(ac) {
  const t = (ac.t || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
  const flight = (ac.flight || '').trim().toUpperCase();

  for (const [cat, info] of Object.entries(AIRCRAFT_TYPES)) {
    for (const pattern of info.types) {
      if (t.includes(pattern.replace(/[^A-Z0-9]/g, '')) || t.startsWith(pattern.replace(/[^A-Z0-9]/g, ''))) {
        return { category: cat, ...info };
      }
    }
  }
  // Callsign-based hints
  if (/^VIPER|^RAGE|^COBRA|^HAWK/.test(flight)) return { category: 'fighter', ...AIRCRAFT_TYPES.fighter };
  if (/^RCH|^REACH/.test(flight)) return { category: 'transport', ...AIRCRAFT_TYPES.transport };
  if (/^ETHYL|^TEXAC|^SHELL|^TEAL/.test(flight)) return { category: 'tanker', ...AIRCRAFT_TYPES.tanker };
  if (/^JAKE|^TOPCAT|^TRIDENT/.test(flight)) return { category: 'recon', ...AIRCRAFT_TYPES.recon };
  if (/^DUST|^PEDRO|^RESCUE/.test(flight)) return { category: 'heli', ...AIRCRAFT_TYPES.heli };
  if (/^BOMB|^DEATH|^DOOM/.test(flight)) return { category: 'bomber', ...AIRCRAFT_TYPES.bomber };

  return { category: 'other', color: '#64748b', emoji: '‚óÜ', label: 'Other/Unknown' };
}

function isUSMilitary(hex) {
  const h = parseInt(hex, 16);
  // US military ICAO range: AE0000-AE FFFF + AF0000-AFFFFF
  return (h >= 0xAE0000 && h <= 0xAFFFFF) || (h >= 0xA00000 && h <= 0xAFFFFF);
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let markers = {};
let aircraftData = [];
let currentFilter = 'all';
let refreshTimer;

// ‚îÄ‚îÄ Create rotated aircraft marker ‚îÄ‚îÄ
function createIcon(ac, info) {
  const rotation = ac.track || 0;
  const size = info.category === 'heli' ? 18 : 22;
  return L.divIcon({
    html: `<div style="color:${info.color}; transform:rotate(${rotation}deg); font-size:${size}px; line-height:1; text-shadow: 0 0 4px rgba(0,0,0,0.9);">‚úà</div>`,
    className: 'aircraft-icon',
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
  });
}

// ‚îÄ‚îÄ Info panel ‚îÄ‚îÄ
function showPanel(ac, info) {
  const panel = document.getElementById('infoPanel');
  const flight = (ac.flight || '').trim();
  document.getElementById('panelTitle').textContent = flight || ac.hex;
  
  const alt = ac.alt_baro === 'ground' ? 'On Ground' : (ac.alt_baro ? ac.alt_baro.toLocaleString() + ' ft' : '‚Äî');
  const speed = ac.gs ? Math.round(ac.gs) + ' kts' : '‚Äî';
  const heading = ac.track ? Math.round(ac.track) + '¬∞' : '‚Äî';
  const vr = ac.baro_rate ? (ac.baro_rate > 0 ? '+' : '') + ac.baro_rate + ' ft/min' : '‚Äî';
  const reg = ac.r || '‚Äî';
  const type = ac.t || '‚Äî';
  const squawk = ac.squawk || '‚Äî';

  document.getElementById('panelBody').innerHTML = `
    <div class="field"><span class="key">Category: </span><span class="val" style="color:${info.color}">${info.label}</span></div>
    <div class="field"><span class="key">Type: </span><span class="val">${type}</span></div>
    <div class="field"><span class="key">Registration: </span><span class="val">${reg}</span></div>
    <div class="field"><span class="key">Callsign: </span><span class="val">${flight || '‚Äî'}</span></div>
    <div class="field"><span class="key">Altitude: </span><span class="val">${alt}</span></div>
    <div class="field"><span class="key">Speed: </span><span class="val">${speed}</span></div>
    <div class="field"><span class="key">Heading: </span><span class="val">${heading}</span></div>
    <div class="field"><span class="key">Vertical Rate: </span><span class="val">${vr}</span></div>
    <div class="field"><span class="key">Squawk: </span><span class="val">${squawk}</span></div>
    <div class="field"><span class="key">ICAO Hex: </span><span class="val">${ac.hex}</span></div>
    <div class="field"><span class="key">Position: </span><span class="val">${ac.lat?.toFixed(4)}, ${ac.lon?.toFixed(4)}</span></div>
  `;
  panel.classList.add('visible');
}

function closePanel() {
  document.getElementById('infoPanel').classList.remove('visible');
}

// ‚îÄ‚îÄ Filter ‚îÄ‚îÄ
function setFilter(f) {
  currentFilter = f;
  document.querySelectorAll('.controls button').forEach(b => b.classList.remove('active'));
  document.getElementById('btn-' + f).classList.add('active');
  renderMarkers();
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function renderMarkers() {
  // Remove old markers
  Object.values(markers).forEach(m => map.removeLayer(m));
  markers = {};

  let total = 0, us = 0, ally = 0;

  aircraftData.forEach(ac => {
    if (!ac.lat || !ac.lon) return;
    const info = classifyAircraft(ac);
    if (currentFilter !== 'all' && info.category !== currentFilter) return;

    total++;
    if (isUSMilitary(ac.hex)) us++;
    else ally++;

    const marker = L.marker([ac.lat, ac.lon], { icon: createIcon(ac, info) })
      .on('click', () => showPanel(ac, info))
      .addTo(map);

    const flight = (ac.flight || '').trim();
    const alt = ac.alt_baro === 'ground' ? 'GND' : (ac.alt_baro ? ac.alt_baro.toLocaleString() + 'ft' : '?');
    marker.bindTooltip(`${flight || ac.hex} ¬∑ ${ac.t || '?'} ¬∑ ${alt}`, {
      className: 'dark-tooltip', direction: 'top', offset: [0, -12]
    });

    markers[ac.hex] = marker;
  });

  document.getElementById('totalCount').textContent = total;
  document.getElementById('usCount').textContent = us;
  document.getElementById('allyCount').textContent = ally;
}

// ‚îÄ‚îÄ Fetch data with fallback ‚îÄ‚îÄ
const API_URLS = [
  'https://api.adsb.lol/v2/mil',
  'https://corsproxy.io/?url=https://api.adsb.lol/v2/mil',
  'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://api.adsb.lol/v2/mil'),
];

async function fetchData() {
  let lastErr;
  for (const url of API_URLS) {
    try {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();
      aircraftData = data.ac || [];
      renderMarkers();

      const now = new Date();
      document.getElementById('updateTime').textContent = 
        `Last update: ${now.toLocaleTimeString()} ¬∑ ${aircraftData.length} aircraft in feed`;

      document.getElementById('loadingOverlay').style.display = 'none';
      return; // success
    } catch (err) {
      lastErr = err;
      console.warn('Fetch failed for', url, err.message);
    }
  }
  console.error('All endpoints failed:', lastErr);
  document.getElementById('updateTime').textContent = 'Error fetching data ‚Äî retrying in 30s...';
  document.getElementById('loadingOverlay').style.display = 'none';
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
fetchData();
refreshTimer = setInterval(fetchData, 30000); // refresh every 30s

// Tooltip style injection
const tooltipStyle = document.createElement('style');
tooltipStyle.textContent = `.dark-tooltip { background: rgba(16,20,32,0.92) !important; color: #e0e0e0 !important; border: 1px solid #2a3045 !important; border-radius: 6px !important; font-size: 12px !important; padding: 4px 8px !important; } .dark-tooltip::before { border-top-color: rgba(16,20,32,0.92) !important; }`;
document.head.appendChild(tooltipStyle);
</script>
</body>
</html>
