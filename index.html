<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PIKECLAW // OSINT TRACKER</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Exo+2:wght@300;400;600;700;800&family=Orbitron:wght@400;500;600;700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#000000;
  --bg2:#050a05;
  --panel:rgba(2,8,2,0.94);
  --panel2:rgba(4,12,4,0.92);
  --border:#0a1f0a;
  --border2:#0d2e0d;
  --border-glow:#00ff41;
  --text:#b8e6b8;
  --text-bright:#e0ffe0;
  --muted:#3a6b3a;
  --accent:#00ff41;
  --accent2:#00cc33;
  --red:#ff2040;
  --orange:#ff6b2b;
  --yellow:#e5ff00;
  --purple:#bf5fff;
  --green:#00ff41;
  --cyan:#00ffcc;
  --grid-line:rgba(0,255,65,0.04);
}

/* ── SCANLINE + GRID OVERLAY ── */
body{
  font-family:'Exo 2',sans-serif;
  background:radial-gradient(ellipse 1400px 700px at 15% -5%, rgba(0,255,65,.06), transparent 60%),
             radial-gradient(ellipse 900px 500px at 85% 0%, rgba(0,255,65,.04), transparent 55%),
             radial-gradient(ellipse 600px 600px at 50% 100%, rgba(0,255,65,.03), transparent 50%),
             #000;
  color:var(--text);
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
body::before{
  content:'';
  position:fixed;
  inset:0;
  background:
    repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,255,65,.018) 2px, rgba(0,255,65,.018) 4px),
    repeating-linear-gradient(90deg, transparent, transparent 60px, rgba(0,255,65,.035) 60px, rgba(0,255,65,.035) 61px),
    repeating-linear-gradient(0deg, transparent, transparent 60px, rgba(0,255,65,.035) 60px, rgba(0,255,65,.035) 61px);
  pointer-events:none;
  z-index:9998;
}

/* ── ANIMATED SCANLINE ── */
body::after{
  content:'';
  position:fixed;
  top:0;left:0;right:0;
  height:2px;
  background:linear-gradient(90deg,transparent,rgba(0,255,65,.5),transparent);
  animation:scanline 8s linear infinite;
  pointer-events:none;
  z-index:9999;
}
@keyframes scanline{0%{top:-4px}100%{top:100vh}}

/* ── TOPBAR ── */
.topbar{
  flex-shrink:0;
  background:linear-gradient(180deg,rgba(0,8,0,0.98),rgba(0,4,0,0.99));
  border-bottom:1px solid rgba(0,255,65,.3);
  box-shadow:0 4px 30px rgba(0,255,65,.08), inset 0 -1px 0 rgba(0,255,65,.1);
  padding:7px 12px;
  display:flex;gap:6px;align-items:center;flex-wrap:wrap;z-index:200;
  position:relative;
  backdrop-filter: blur(12px);
}
.topbar::after{
  content:'';position:absolute;bottom:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(0,255,65,.4) 20%,rgba(0,255,65,.8) 50%,rgba(0,255,65,.4) 80%,transparent);
}
.topbar .logo{
  font-family:'Orbitron',sans-serif;
  font-size:13px;
  font-weight:700;
  color:var(--accent);
  margin-right:8px;
  letter-spacing:3px;
  text-shadow:0 0 15px rgba(0,255,65,.9),0 0 30px rgba(0,255,65,.4),0 0 60px rgba(0,255,65,.15);
  white-space:nowrap;
}
.topbar .logo span{color:rgba(0,255,65,.45)}
.tb-sep{width:1px;height:18px;background:linear-gradient(180deg,transparent,rgba(0,255,65,.4),transparent);margin:0 3px;flex-shrink:0}
.tb-btn{
  background:rgba(0,12,0,.85);
  border:1px solid rgba(0,255,65,.15);
  color:var(--muted);
  padding:4px 10px;
  border-radius:2px;
  cursor:pointer;
  font-size:10px;
  font-family:'Share Tech Mono',monospace;
  letter-spacing:.6px;
  transition:all .15s;
  white-space:nowrap;
  text-transform:uppercase;
  position:relative;
  overflow:hidden;
  box-shadow:0 2px 8px rgba(0,0,0,.4);
}
.tb-btn::before{
  content:'';position:absolute;inset:-1px;
  background:linear-gradient(135deg,rgba(0,255,65,.1),transparent 60%);
  opacity:0;transition:opacity .15s;
}
.tb-btn:hover{background:rgba(0,30,0,.9);border-color:var(--accent);color:var(--accent);box-shadow:0 0 12px rgba(0,255,65,.25),inset 0 0 10px rgba(0,255,65,.06);}
.tb-btn:hover::before{opacity:1}
.tb-btn.on{background:rgba(0,50,10,.5);border-color:var(--accent);color:var(--accent);box-shadow:0 0 18px rgba(0,255,65,.35),inset 0 0 12px rgba(0,255,65,.1);}
.tb-btn.iran-on{background:rgba(255,32,64,.12);border-color:var(--red);color:var(--red);box-shadow:0 0 12px rgba(255,32,64,.3)}
.tb-btn.russia-on{background:rgba(220,38,38,.12);border-color:#dc2626;color:#ff6666;box-shadow:0 0 12px rgba(220,38,38,.3)}
.tb-btn.china-on{background:rgba(229,255,0,.08);border-color:var(--yellow);color:var(--yellow);box-shadow:0 0 12px rgba(229,255,0,.25)}
.tb-search{
  background:rgba(0,8,0,0.9);
  border:1px solid rgba(0,255,65,.15);
  color:var(--accent);
  padding:4px 8px;
  border-radius:2px;
  font-size:10px;
  font-family:'Share Tech Mono',monospace;
  width:130px;
  outline:none;
  letter-spacing:.5px;
}
.tb-search:focus{border-color:var(--accent);box-shadow:0 0 10px rgba(0,255,65,.25)}
.tb-search::placeholder{color:rgba(0,255,65,.25)}
.tb-label{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;white-space:nowrap;font-family:'Share Tech Mono',monospace}

/* ── WIDGET SYSTEM ── */
.dashboard{flex:1;display:grid;grid-template-columns:1fr 270px 270px;grid-template-rows:1fr 1fr 1fr 220px;min-height:0;gap:0}
.widget{
  background:rgba(0,4,0,0.92);
  border:1px solid rgba(0,255,65,.1);
  display:flex;flex-direction:column;overflow:hidden;min-height:0;
  position:relative;
  box-shadow:0 8px 24px rgba(0,0,0,.5), inset 0 0 50px rgba(0,255,65,.02);
}
.widget::before{
  content:'';
  position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(0,255,65,.4),transparent);
  pointer-events:none;
}
.widget-header{
  flex-shrink:0;
  padding:6px 10px;
  background:linear-gradient(180deg,rgba(0,10,0,.95),rgba(0,6,0,.98));
  border-bottom:1px solid rgba(0,255,65,.12);
  font-size:10px;
  font-weight:700;
  letter-spacing:1px;
  color:var(--muted);
  text-transform:uppercase;
  display:flex;align-items:center;gap:6px;
  font-family:'Share Tech Mono',monospace;
}
.widget-header .wh-title{flex:1;color:rgba(0,255,65,.8)}
.widget-header .wh-count{
  background:rgba(0,255,65,.06);
  border:1px solid rgba(0,255,65,.2);
  border-radius:2px;
  padding:1px 7px;
  font-size:9px;
  color:var(--accent);
  font-family:'Share Tech Mono',monospace;
  box-shadow:0 0 10px rgba(0,255,65,.15);
}
.widget-body{flex:1;overflow-y:auto;overflow-x:hidden;min-height:0}
.widget-body::-webkit-scrollbar{width:3px}
.widget-body::-webkit-scrollbar-track{background:rgba(0,4,0,.5)}
.widget-body::-webkit-scrollbar-thumb{background:rgba(0,255,65,.2);border-radius:2px}
.w-map{grid-column:1;grid-row:1/4;position:relative;border:0;min-height:300px}
.w-zones{grid-column:2;grid-row:1}
.w-stats{grid-column:3;grid-row:1}
.w-activity{grid-column:2;grid-row:2}

/* News + bottom bar */
.news-card{min-width:220px;max-width:220px;padding:8px 10px;border-right:1px solid var(--border);cursor:pointer;transition:background .15s;flex-shrink:0;display:flex;flex-direction:column;justify-content:space-between}
.news-card:hover{background:rgba(0,212,255,.04)}
.news-card .nc-src{font-size:9px;color:var(--accent);font-weight:700;margin-bottom:3px;text-transform:uppercase;letter-spacing:.8px;font-family:'Share Tech Mono',monospace}
.news-card .nc-title{font-size:11px;line-height:1.4;color:var(--text);flex:1;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}
.news-card .nc-meta{font-size:9px;color:var(--muted);margin-top:4px;font-family:'Share Tech Mono',monospace}
.news-card.alert .nc-src{color:var(--red);text-shadow:0 0 8px rgba(255,51,85,.5)}
.news-card.alert{border-left:2px solid var(--red);box-shadow:inset 2px 0 10px rgba(255,51,85,.08)}

/* Poly cards */
.poly-card{min-width:175px;max-width:175px;padding:8px 10px;border-right:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column;gap:4px;cursor:pointer;transition:background .15s;text-decoration:none}
.poly-card:hover{background:rgba(0,212,255,.04)}
.poly-card .pc-q{font-size:10px;line-height:1.35;color:var(--text);display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;flex:1}
.poly-card .pc-odds{display:flex;align-items:center;gap:4px;margin-top:4px}
.poly-card .pc-yes{font-size:16px;font-weight:800;font-family:'Share Tech Mono',monospace}
.poly-card .pc-label{font-size:9px;color:var(--muted);font-family:'Share Tech Mono',monospace}
.poly-card .pc-bar{height:3px;background:rgba(0,212,255,.1);border-radius:2px;overflow:hidden;margin-top:2px}
.poly-card .pc-fill{height:100%;border-radius:2px;transition:width .5s;box-shadow:0 0 6px currentColor}
.poly-card .pc-vol{font-size:9px;color:var(--muted);font-family:'Share Tech Mono',monospace}

/* X feed */
.x-tab{background:rgba(0,8,0,.8);border:1px solid rgba(0,255,65,.12);color:var(--muted);padding:2px 7px;border-radius:2px;cursor:pointer;font-size:9px;white-space:nowrap;font-family:'Share Tech Mono',monospace;letter-spacing:.5px;text-transform:uppercase}
.x-tab:hover{color:var(--text)}.x-tab.on{border-color:var(--accent);color:var(--accent);box-shadow:0 0 10px rgba(0,255,65,.25)}
.x-post{padding:8px 10px;border-bottom:1px solid rgba(0,255,65,.06);font-size:11px;line-height:1.45;cursor:pointer;transition:background .15s}
.x-post:hover{background:rgba(0,255,65,.04)}
.x-post .xp-meta{font-size:9px;color:var(--muted);margin-bottom:3px;display:flex;gap:6px;font-family:'Share Tech Mono',monospace}
.x-post .xp-handle{color:var(--accent);font-weight:600}
.x-post .xp-text{color:var(--text)}

/* Info panel */
.infopanel{position:absolute;bottom:50px;left:10px;z-index:500;
  background:rgba(0,4,0,0.96);
  border:1px solid rgba(0,255,65,.3);
  box-shadow:0 0 40px rgba(0,255,65,.12), inset 0 0 40px rgba(0,255,65,.03);
  border-radius:2px;padding:0;width:260px;max-height:50vh;display:none;backdrop-filter:blur(18px);overflow:hidden}
.infopanel::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(0,255,65,.7),transparent);z-index:2}
.infopanel.vis{display:flex;flex-direction:column}
.infopanel .ip-head{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;flex-shrink:0;background:rgba(0,8,0,.8);border-bottom:1px solid rgba(0,255,65,.1);position:sticky;top:0;z-index:2}
.infopanel h3{font-size:12px;color:var(--accent);font-family:'Share Tech Mono',monospace;letter-spacing:1px;text-shadow:0 0 14px rgba(0,255,65,.8);margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.infopanel .x{background:rgba(0,255,65,.08);border:1px solid rgba(0,255,65,.2);color:var(--accent);cursor:pointer;font-size:18px;line-height:1;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:2px;flex-shrink:0;margin-left:6px;-webkit-tap-highlight-color:rgba(0,255,65,.2)}
.infopanel .x:hover,.infopanel .x:active{background:rgba(0,255,65,.2);color:#fff}
.infopanel #pBody{overflow-y:auto;padding:10px;flex:1}
.infopanel .f{margin-bottom:3px;font-size:11px;display:flex;gap:4px}
.infopanel .f .k{color:var(--muted);font-family:'Share Tech Mono',monospace;font-size:10px;white-space:nowrap;padding-top:1px}
.infopanel .f .v{color:var(--text-bright);font-weight:500}

/* Region buttons */
.region-btns{position:absolute;bottom:10px;left:10px;z-index:400;display:flex;flex-direction:column;gap:3px}
.region-btns button{
  background:rgba(0,4,0,0.88);
  border:1px solid rgba(0,255,65,.15);
  color:var(--muted);
  padding:4px 8px;border-radius:2px;cursor:pointer;
  font-size:9px;text-align:left;transition:all .15s;
  font-family:'Share Tech Mono',monospace;letter-spacing:.5px;text-transform:uppercase;
}
.region-btns button:hover{color:var(--accent);border-color:var(--accent);box-shadow:0 0 10px rgba(0,255,65,.25)}

/* Map legend */
.map-legend{
  background:rgba(0,4,0,0.92);
  border:1px solid rgba(0,255,65,.2);
  box-shadow:0 0 20px rgba(0,255,65,.12);
  border-radius:2px;padding:8px 10px;font-size:10px;font-family:'Share Tech Mono',monospace;letter-spacing:.3px;
}
.map-legend .ml-row{display:flex;align-items:center;gap:6px;margin-bottom:3px;color:var(--muted)}
.map-legend .ml-row .ml-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;box-shadow:0 0 4px currentColor}

/* Adversary tabs */
.adv-tab{flex:1;padding:8px 6px;text-align:center;font-size:11px;font-weight:600;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all .15s;user-select:none;border-right:1px solid rgba(0,255,65,.08);font-family:'Share Tech Mono',monospace;letter-spacing:.5px;text-transform:uppercase}
.adv-tab:last-child{border-right:0}
.adv-tab:hover{color:var(--text)}
.adv-tab.active{color:var(--accent);border-bottom-color:var(--accent);background:rgba(0,255,65,.04);text-shadow:0 0 12px rgba(0,255,65,.5)}
.adv-tab[data-adv="iran"].active{border-bottom-color:var(--red);color:var(--red);text-shadow:0 0 12px rgba(255,32,64,.5)}
.adv-tab[data-adv="russia"].active{border-bottom-color:#dc2626;color:#ff6666;text-shadow:0 0 12px rgba(220,38,38,.5)}
.adv-tab[data-adv="china"].active{border-bottom-color:var(--yellow);color:var(--yellow);text-shadow:0 0 12px rgba(229,255,0,.4)}
.adv-body{display:flex;height:100%;overflow:hidden}
.adv-col{flex:1;border-right:1px solid var(--border);overflow-y:auto;padding:8px 10px;font-size:11px}
.adv-col:last-child{border-right:0}
.adv-col h5{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:rgba(0,212,255,.5);margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border);font-family:'Share Tech Mono',monospace}
.adv-row{display:flex;justify-content:space-between;margin-bottom:4px;align-items:center;gap:8px}
.adv-row .ar-label{color:var(--muted);font-size:10px}
.adv-row .ar-val{font-weight:600;color:var(--text-bright);font-size:10px;text-align:right;font-family:'Share Tech Mono',monospace}
.adv-status{padding:2px 6px;border-radius:2px;font-size:9px;font-weight:700;font-family:'Share Tech Mono',monospace;letter-spacing:.5px}
.adv-status.hot{background:rgba(255,51,85,.15);color:var(--red);box-shadow:0 0 8px rgba(255,51,85,.2)}
.adv-status.warn{background:rgba(255,119,48,.15);color:var(--orange)}
.adv-status.calm{background:rgba(0,255,136,.1);color:var(--green)}

/* Loading overlay */
.loading-ov{position:absolute;inset:0;z-index:600;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px}
.loading-ov .sp{font-size:34px;animation:spin 1s linear infinite;display:inline-block;filter:drop-shadow(0 0 12px rgba(0,255,65,.8))}
.loading-ov .st{color:var(--accent);font-size:12px;font-family:'Share Tech Mono',monospace;letter-spacing:3px;text-transform:uppercase;animation:pulse 1.5s ease-in-out infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:.5}50%{opacity:1}}

/* Leaflet overrides */
.leaflet-popup-content-wrapper{background:rgba(0,4,0,.98);color:var(--text);border-radius:2px;border:1px solid rgba(0,255,65,.3);box-shadow:0 0 25px rgba(0,255,65,.15)}
.leaflet-popup-tip{background:rgba(0,4,0,.98)}
.dark-tooltip{background:rgba(0,4,0,.97)!important;color:var(--accent)!important;border:1px solid rgba(0,255,65,.3)!important;border-radius:2px!important;font-size:10px!important;padding:4px 8px!important;font-family:'Share Tech Mono',monospace!important;box-shadow:0 0 12px rgba(0,255,65,.15)!important;letter-spacing:.3px!important}
.leaflet-control-zoom a{background:rgba(0,4,0,.9)!important;color:var(--accent)!important;border:1px solid rgba(0,255,65,.2)!important}
.leaflet-control-attribution{background:rgba(0,0,0,.8)!important;color:var(--muted)!important;font-size:9px!important}
.leaflet-control-attribution a{color:var(--accent2)!important}

/* Zone cards */
.zone-card{padding:7px 12px;border-bottom:1px solid rgba(0,255,65,.06);display:flex;justify-content:space-between;align-items:center;transition:background .15s}
.zone-card:hover{background:rgba(0,255,65,.03)}
.zone-card .zc-name{font-size:11px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.3px}
.zone-card .zc-count{font-size:15px;font-weight:800;font-family:'Share Tech Mono',monospace}
.zone-card.hot{border-left:2px solid var(--red);background:rgba(255,51,85,.04)}
.zone-card.warm{border-left:2px solid var(--orange)}

/* Country/type bars */
.country-row{display:flex;align-items:center;gap:6px;margin-bottom:5px;font-size:11px}
.country-row .cr-flag{width:18px;text-align:center}
.country-row .cr-name{flex:1;color:var(--muted);font-size:10px;font-family:'Share Tech Mono',monospace;letter-spacing:.3px}
.country-row .cr-bar-wrap{width:80px;height:4px;background:rgba(0,212,255,.08);border-radius:2px;overflow:hidden}
.country-row .cr-bar{height:100%;border-radius:2px;transition:width .5s;box-shadow:0 0 4px currentColor}
.country-row .cr-count{width:24px;text-align:right;font-weight:700;color:var(--text-bright);font-family:'Share Tech Mono',monospace;font-size:11px}
.type-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:11px}
.type-row .tr-icon{width:16px;text-align:center}
.type-row .tr-name{flex:1;color:var(--muted);font-size:10px;font-family:'Share Tech Mono',monospace}
.type-row .tr-bar-wrap{width:70px;height:3px;background:rgba(0,212,255,.08);border-radius:2px;overflow:hidden}
.type-row .tr-bar{height:100%;border-radius:2px;transition:width .5s;box-shadow:0 0 4px currentColor}
.type-row .tr-count{width:24px;text-align:right;font-weight:700;color:var(--text-bright);font-family:'Share Tech Mono',monospace;font-size:11px}
.stat-block{padding:10px 12px;border-bottom:1px solid rgba(0,255,65,.06)}
.stat-block .sb-label{font-size:9px;color:rgba(0,255,65,.5);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;font-family:'Share Tech Mono',monospace}

/* Activity feed */
.feed-item{padding:6px 12px;border-bottom:1px solid rgba(0,255,65,.06);display:flex;align-items:center;gap:6px;font-size:11px;transition:background .15s;cursor:pointer}
.feed-item:hover{background:rgba(0,255,65,.03)}
.feed-item .fi-flag{flex-shrink:0}
.feed-item .fi-call{font-weight:700;color:var(--text-bright);flex-shrink:0;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.5px}
.feed-item .fi-type{color:var(--muted);font-size:10px}
.feed-item .fi-alt{margin-left:auto;color:var(--muted);flex-shrink:0;font-family:'Share Tech Mono',monospace;font-size:10px}

/* Section headers in panels */
.rp-section{padding:6px 12px 4px;font-size:9px;text-transform:uppercase;letter-spacing:1px;color:rgba(0,255,65,.4);border-bottom:1px solid rgba(0,255,65,.06);font-family:'Share Tech Mono',monospace}

/* CENTCOM Assets widget */
.centcom-col{flex:1;border-right:1px solid rgba(0,255,65,.08);display:flex;flex-direction:column;overflow:hidden;min-width:0}
.centcom-col:last-child{border-right:none}
.centcom-col-head{flex-shrink:0;padding:5px 10px;background:rgba(0,255,65,.03);border-bottom:1px solid rgba(0,255,65,.08);font-size:9px;font-family:'Share Tech Mono',monospace;text-transform:uppercase;letter-spacing:1.2px;color:rgba(0,255,65,.5);display:flex;align-items:center;gap:5px}
.centcom-col-body{flex:1;overflow-y:auto;overflow-x:hidden}
.centcom-col-body::-webkit-scrollbar{width:3px}
.centcom-col-body::-webkit-scrollbar-thumb{background:rgba(0,255,65,.15)}
.ca-item{padding:6px 10px;border-bottom:1px solid rgba(0,255,65,.05);cursor:pointer;transition:background .15s}
.ca-item:hover{background:rgba(0,255,65,.04)}
.ca-item:last-child{border-bottom:none}
.ca-name{font-size:11px;font-weight:700;color:var(--accent);font-family:'Share Tech Mono',monospace;letter-spacing:.4px;margin-bottom:2px}
.ca-sub{font-size:10px;color:var(--text);line-height:1.35;margin-bottom:2px}
.ca-meta{font-size:9px;color:var(--muted);font-family:'Share Tech Mono',monospace;display:flex;gap:8px;flex-wrap:wrap}
.ca-badge{display:inline-block;padding:1px 5px;border-radius:2px;font-size:8px;font-weight:700;font-family:'Share Tech Mono',monospace;letter-spacing:.5px;background:rgba(0,255,65,.08);border:1px solid rgba(0,255,65,.2);color:var(--accent)}
.ca-badge.air{background:rgba(34,211,238,.08);border-color:rgba(34,211,238,.3);color:#22d3ee}
.ca-badge.ground{background:rgba(234,179,8,.08);border-color:rgba(234,179,8,.3);color:#eab308}
.ca-badge.naval{background:rgba(0,255,65,.08);border-color:rgba(0,255,65,.3);color:#00ff41}
.ca-pax{font-weight:700;color:var(--text-bright)}

/* Naval widget */
.naval-group{padding:8px 10px;border-bottom:1px solid rgba(0,255,65,.06);cursor:pointer;transition:background .15s}
.naval-group:hover{background:rgba(0,255,65,.03)}
.naval-group .ng-header{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.naval-group .ng-name{font-size:11px;font-weight:700;color:var(--accent);font-family:'Share Tech Mono',monospace;letter-spacing:.5px}
.naval-group .ng-status{font-size:9px;padding:1px 6px;border-radius:2px;font-weight:700;font-family:'Share Tech Mono',monospace;letter-spacing:.5px}
.naval-group .ng-status.deployed{background:rgba(0,255,65,.1);color:var(--accent);box-shadow:0 0 6px rgba(0,255,65,.15)}
.naval-group .ng-status.combat{background:rgba(255,32,64,.12);color:var(--red);box-shadow:0 0 8px rgba(255,32,64,.2)}
.naval-group .ng-status.port{background:rgba(76,107,58,.15);color:var(--muted)}
.naval-group .ng-status.transit{background:rgba(229,255,0,.08);color:var(--yellow)}
.naval-group .ng-region{font-size:9px;color:var(--muted);font-family:'Share Tech Mono',monospace;letter-spacing:.3px}
.naval-group .ng-ships{font-size:10px;color:var(--text);margin-top:3px;line-height:1.4}
.naval-chokepoint{padding:6px 10px;border-bottom:1px solid rgba(0,255,65,.06);display:flex;justify-content:space-between;align-items:center}
.naval-chokepoint .nc-name{font-size:10px;color:var(--text);font-family:'Share Tech Mono',monospace}
.naval-chokepoint .nc-status{font-size:9px;font-weight:700;font-family:'Share Tech Mono',monospace;letter-spacing:.5px}

/* Mobile hamburger button */
.mob-menu-btn{display:none;background:rgba(0,12,0,.85);border:1px solid rgba(0,255,65,.2);color:var(--accent);padding:5px 10px;border-radius:2px;cursor:pointer;font-size:16px;line-height:1;flex-shrink:0;-webkit-tap-highlight-color:transparent}
.mob-menu-btn:active{background:rgba(0,30,0,.9)}
.mob-drawer{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:9990;flex-direction:column;background:rgba(0,0,0,.97)}
.mob-drawer.open{display:flex}
.mob-drawer-head{flex-shrink:0;padding:10px 14px;border-bottom:1px solid rgba(0,255,65,.2);display:flex;align-items:center;justify-content:space-between;background:rgba(0,8,0,.98)}
.mob-drawer-head .logo{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;color:var(--accent);letter-spacing:2px}
.mob-drawer-close{background:rgba(0,12,0,.85);border:1px solid rgba(0,255,65,.2);color:var(--accent);width:36px;height:36px;border-radius:2px;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center}
.mob-drawer-body{flex:1;overflow-y:auto;padding:10px 12px;display:flex;flex-direction:column;gap:12px}
.mob-section-label{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:rgba(0,255,65,.4);font-family:'Share Tech Mono',monospace;margin-bottom:4px}
.mob-btn-row{display:flex;flex-wrap:wrap;gap:6px}
.mob-btn-row .tb-btn{font-size:11px;padding:7px 12px}

/* Mobile */
@media(max-width:768px){
  body{overflow-y:auto;overflow-x:hidden;height:auto}
  .dashboard{display:block;height:auto}

  /* Map widget: explicit height so Leaflet can render */
  .w-map{height:60vw;min-height:260px;max-height:55vh;position:relative;display:block}
  #map{position:absolute;top:0;left:0;right:0;bottom:0}

  /* Stack all widgets to full width with fixed heights */
  .dashboard .widget{width:100%;display:flex;flex-direction:column}
  .w-zones,.w-stats{height:230px}
  .w-activity{height:250px}
  .w-log{height:250px}
  /* Adversary + naval span full width */
  .dashboard .widget[style*="grid-column:2/4"]{height:260px;width:100%}
  /* CENTCOM widget: stack columns vertically on mobile */
  .dashboard .widget[style*="grid-column:1/-1"]{height:auto!important;width:100%}
  #pane-centcom{flex-direction:column!important}
  .centcom-col{border-right:none!important;border-bottom:1px solid rgba(0,255,65,.08);min-height:160px}
  .centcom-col:last-child{border-bottom:none}

  /* Topbar: collapse overflow, show only essentials + hamburger */
  .topbar{padding:5px 8px;position:sticky;top:0;z-index:9999;flex-wrap:nowrap;overflow:hidden;justify-content:flex-start}
  .topbar .logo{font-size:11px;letter-spacing:1px;margin-right:6px;white-space:nowrap;flex-shrink:0}
  /* Show only country filter buttons + search + hamburger; hide the rest */
  .topbar .tb-btn:not(.mob-always):not([id^="bc-"]):not([onclick="fetchData()"]):not(.tile-btn){display:none}
  .topbar .tb-sep{display:none}
  .topbar .tb-label{display:none}
  .topbar .hb-live{display:none}
  #hb-time{display:none}
  .tb-search{width:80px;flex-shrink:0}
  .mob-menu-btn{display:flex;align-items:center;margin-left:auto;flex-shrink:0}

  /* Country buttons: compact */
  #bc-all,#bc-us,#bc-iran,#bc-russia,#bc-china,#bc-allied{padding:4px 6px;font-size:10px}
  /* Tile buttons stay hidden on mobile (moved to drawer) */
  .topbar .tile-btn{display:none}
  /* Refresh button stays */
  .topbar button[onclick="fetchData()"]{display:inline-flex!important;padding:4px 7px;font-size:10px}

  /* Clock bar: scroll horizontally */
  .clock-bar{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch}
  .clock-cell{min-width:68px;padding:3px 8px}
  .clock-label{font-size:7px}
  .clock-time{font-size:11px}
  #clk-zulu{font-size:13px}

  /* Info panel: full-width near bottom */
  .infopanel{left:8px!important;right:8px!important;width:auto!important;bottom:8px!important;max-height:45vh!important}
  .infopanel .x{width:36px;height:36px;font-size:22px}

  /* Region buttons: horizontal row at bottom-left */
  .region-btns{flex-direction:row;flex-wrap:wrap;bottom:8px;left:8px;gap:4px;max-width:calc(100% - 16px)}
  .region-btns button{font-size:9px;padding:4px 7px}

  /* Map legend: hidden on mobile (use drawer) */
  .map-legend{display:none}

  /* Boot screen: scale to mobile */
  .boot-screen{padding:20px 16px}
  .boot-line{font-size:10px}
  .boot-line.head{font-size:11px;letter-spacing:1px}
  .boot-line.ascii{font-size:8px}
  .boot-progress{width:100%}

  /* Bottom info bar: stack vertically */
  .bottom-bar{flex-direction:column!important;height:auto!important}
  .bottom-bar > div{width:100%!important;min-width:0!important;max-width:none!important;border-right:none!important;border-bottom:1px solid rgba(0,255,65,.1)!important;height:160px!important;flex-shrink:0!important}
  .bottom-bar > div:last-child{border-bottom:none!important}
  /* News strip and polymarket: horizontal scroll within */
  #polyStrip,#newsStrip{overflow-x:auto;overflow-y:hidden;display:flex;align-items:stretch}

  /* Briefing modal: full screen */
  .brief-modal{width:100%;max-width:none;max-height:90vh;border-radius:0;border-left:0;border-right:0}

  /* Nuke panel: full width at bottom */
  .nuke-panel{left:8px!important;right:8px!important;bottom:8px!important;width:auto!important}

  /* Hide cinema label on mobile */
  .cinema-label{display:none!important}
}

/* ── WIDGET SYSTEM (legacy removed) ── */
/* duplicate block intentionally removed */

/* News + Poly cards */
.news-card{min-width:220px;max-width:220px;padding:8px 10px;border-right:1px solid rgba(0,255,65,.06);cursor:pointer;transition:background .15s;flex-shrink:0;display:flex;flex-direction:column;justify-content:space-between}
.news-card:hover{background:rgba(0,255,65,.04)}
.news-card .nc-src{font-size:9px;color:var(--accent);font-weight:700;margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px;font-family:'Share Tech Mono',monospace}
.news-card .nc-title{font-size:11px;line-height:1.4;color:var(--text);flex:1;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}
.news-card .nc-meta{font-size:9px;color:var(--muted);margin-top:4px;font-family:'Share Tech Mono',monospace}
.news-card.alert .nc-src{color:var(--red)}
.news-card.alert{border-left:2px solid var(--red);padding-left:8px}

/* Adversary tabs (duplicate — overridden above) */
/* Adversary intel layout */
.adv-body{display:flex;height:100%;overflow:hidden}
.adv-col{flex:1;border-right:1px solid var(--border);overflow-y:auto;padding:8px 10px;font-size:11px}
.adv-col:last-child{border-right:0}
.adv-col h5{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border)}
.adv-row{display:flex;justify-content:space-between;margin-bottom:4px;align-items:center}
.adv-row .ar-label{color:var(--muted)}
.adv-row .ar-val{font-weight:600;color:var(--text)}
.adv-kv{margin-bottom:5px}
.adv-kv .ak{font-size:10px;color:var(--muted)}
.adv-kv .av{font-size:11px;color:var(--text)}
.adv-status{padding:3px 7px;border-radius:3px;font-size:10px;font-weight:700}
.adv-status.hot{background:rgba(239,68,68,.2);color:#ef4444}
.adv-status.warn{background:rgba(249,115,22,.2);color:#f97316}
.adv-status.calm{background:rgba(34,197,94,.15);color:#22c55e}

/* X / OSINT feed */
.x-tab{background:#111827;border:1px solid var(--border2);color:var(--muted);padding:2px 7px;border-radius:3px;cursor:pointer;font-size:10px;white-space:nowrap}
.x-tab:hover{color:var(--text)}.x-tab.on{border-color:#1d9bf0;color:#1d9bf0}
.x-post{padding:8px 10px;border-bottom:1px solid var(--border);font-size:11px;line-height:1.45;cursor:pointer;transition:background .15s}
.x-post:hover{background:rgba(29,155,240,.05)}
.x-post .xp-meta{font-size:10px;color:var(--muted);margin-bottom:3px;display:flex;gap:6px}
.x-post .xp-handle{color:#1d9bf0;font-weight:600}
.x-post .xp-text{color:var(--text)}
.x-post .xp-img{max-width:100%;max-height:80px;border-radius:4px;margin-top:5px;object-fit:cover}

/* Polymarket cards */
.poly-card{min-width:175px;max-width:175px;padding:8px 10px;border-right:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column;gap:4px;cursor:pointer;transition:background .15s;text-decoration:none}
.poly-card:hover{background:rgba(59,130,246,.06)}
.poly-card .pc-q{font-size:10px;line-height:1.35;color:var(--text);display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;flex:1}
.poly-card .pc-odds{display:flex;align-items:center;gap:4px;margin-top:4px}
.poly-card .pc-yes{font-size:16px;font-weight:800}
.poly-card .pc-label{font-size:9px;color:var(--muted)}
.poly-card .pc-bar{height:4px;background:#1e2a42;border-radius:2px;overflow:hidden;margin-top:2px}
.poly-card .pc-fill{height:100%;border-radius:2px;transition:width .5s}
.poly-card .pc-vol{font-size:9px;color:var(--muted)}

/* ── TOP BAR ── */
/* Clock bar */
.clock-bar{flex-shrink:0;display:flex;justify-content:center;gap:0;background:#000;border-bottom:1px solid rgba(0,255,65,.15);padding:0;font-family:'Share Tech Mono',monospace;overflow-x:auto;position:relative}
.clock-bar::before{content:'01001101 01001001 01001100';position:absolute;left:0;top:50%;transform:translateY(-50%);font-size:7px;color:rgba(0,255,65,.06);letter-spacing:2px;white-space:nowrap;animation:datastream 20s linear infinite;pointer-events:none}
@keyframes datastream{0%{transform:translateY(-50%) translateX(100%)}100%{transform:translateY(-50%) translateX(-100%)}}
.clock-cell{display:flex;flex-direction:column;align-items:center;padding:4px 14px;border-right:1px solid rgba(0,255,65,.06);min-width:80px}
.clock-cell:last-child{border-right:none}
.clock-label{font-size:8px;text-transform:uppercase;letter-spacing:1.5px;color:rgba(0,255,65,.35);margin-bottom:1px}
.clock-time{font-size:13px;font-weight:700;color:var(--accent);letter-spacing:1px;text-shadow:0 0 8px rgba(0,255,65,.3)}
.clock-cell.clock-date .clock-time{color:var(--text);text-shadow:none;font-size:11px}
#clk-zulu{font-size:15px;color:#fff;text-shadow:0 0 12px rgba(0,255,65,.5)}

/* DEFCON meter */
.defcon-meter{display:flex;gap:2px;margin:8px 0}
.defcon-level{flex:1;text-align:center;padding:6px 2px;font-size:10px;font-weight:700;font-family:'Orbitron','Share Tech Mono',monospace;letter-spacing:1px;border:1px solid rgba(0,255,65,.08);border-radius:2px;opacity:.3;transition:all .3s}
.defcon-level.active{opacity:1;box-shadow:0 0 12px var(--defcon-color)}
.defcon-5{--defcon-color:#00ff41;background:rgba(0,255,65,.08);color:#00ff41;border-color:rgba(0,255,65,.3)}
.defcon-4{--defcon-color:#22d3ee;background:rgba(34,211,238,.08);color:#22d3ee;border-color:rgba(34,211,238,.3)}
.defcon-3{--defcon-color:#eab308;background:rgba(234,179,8,.08);color:#eab308;border-color:rgba(234,179,8,.3)}
.defcon-2{--defcon-color:#f97316;background:rgba(249,115,22,.08);color:#f97316;border-color:rgba(249,115,22,.3)}
.defcon-1{--defcon-color:#ef4444;background:rgba(239,68,68,.08);color:#ef4444;border-color:rgba(239,68,68,.3)}
.threat-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(0,255,65,.04);font-size:10px}
.threat-row .tr-label{color:var(--muted);font-family:'Share Tech Mono',monospace}
.threat-row .tr-value{font-weight:700;font-family:'Share Tech Mono',monospace;letter-spacing:.5px}
.threat-bar{height:4px;background:rgba(0,255,65,.08);border-radius:2px;margin-top:3px;overflow:hidden}
.threat-bar-fill{height:100%;border-radius:2px;transition:width .5s}

/* Conflict pulse */
@keyframes pulse-conflict{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(1.4)}}

/* Earthquake seismic ripple */
@keyframes seismic-ripple{
  0%{transform:scale(0.3);opacity:0.8}
  100%{transform:scale(3);opacity:0}
}
.quake-marker{position:relative;cursor:pointer}
.quake-dot{border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
.quake-ripple{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border-radius:50%;border:2px solid;animation:seismic-ripple 2s ease-out infinite;pointer-events:none}
.quake-ripple.r2{animation-delay:0.6s}
.quake-ripple.r3{animation-delay:1.2s}

/* Space launch countdown pulse */
@keyframes launch-pulse{
  0%,100%{text-shadow:0 0 4px rgba(0,255,65,.3)}
  50%{text-shadow:0 0 16px rgba(0,255,65,.8),0 0 30px rgba(0,255,65,.3)}
}
.launch-countdown{animation:launch-pulse 2s ease-in-out infinite}

/* Currency flash on change */
@keyframes currency-flash{
  0%{background:rgba(0,255,65,.15)}
  100%{background:transparent}
}
.currency-updated{animation:currency-flash 1s ease-out}

/* Scanning line effect for widgets */
@keyframes widget-scan{
  0%{top:-2px}
  100%{top:100%}
}
.widget-scan-line::after{
  content:'';position:absolute;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,rgba(0,255,65,.15),rgba(0,255,65,.3),rgba(0,255,65,.15),transparent);
  animation:widget-scan 4s linear infinite;pointer-events:none;z-index:1
}

.topbar{flex-shrink:0;background:var(--panel);border-bottom:1px solid var(--border);padding:7px 12px;display:flex;gap:5px;align-items:center;flex-wrap:wrap;z-index:200}
.topbar .logo{font-weight:800;font-size:13px;color:var(--accent);margin-right:6px;letter-spacing:.5px;white-space:nowrap;font-family:'Orbitron','Share Tech Mono',monospace;text-shadow:0 0 10px rgba(0,255,65,.4);position:relative}
.topbar .logo span{color:var(--text)}
.topbar .logo::after{content:'';display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--accent);margin-left:6px;box-shadow:0 0 8px var(--accent),0 0 16px rgba(0,255,65,.3);animation:logo-pulse 3s ease-in-out infinite}
@keyframes logo-pulse{0%,100%{opacity:1;box-shadow:0 0 8px var(--accent),0 0 16px rgba(0,255,65,.3)}50%{opacity:.4;box-shadow:0 0 4px var(--accent)}}
@keyframes iss-orbit{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

/* Data received flash on topbar */
@keyframes data-flash{
  0%{border-bottom-color:rgba(0,255,65,.8);box-shadow:0 2px 12px rgba(0,255,65,.3)}
  100%{border-bottom-color:rgba(0,255,65,.08);box-shadow:none}
}
.topbar.data-flash{animation:data-flash .6s ease-out}

/* Status indicator dot in topbar — breathing */
@keyframes status-breathe{
  0%,100%{box-shadow:0 0 4px #00ff41}
  50%{box-shadow:0 0 12px #00ff41,0 0 20px rgba(0,255,65,.3)}
}
.status-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:#00ff41;animation:status-breathe 2s ease-in-out infinite;margin:0 4px}
.tb-sep{width:1px;height:18px;background:var(--border2);margin:0 3px;flex-shrink:0}
.tb-btn{background:#111827;border:1px solid var(--border2);color:var(--muted);padding:4px 9px;border-radius:4px;cursor:pointer;font-size:11px;transition:all .15s;white-space:nowrap}
.tb-btn:hover,`.tb-btn.on{background:#1e2a42;border-color:var(--accent);color:var(--text)}
.tb-btn.on{color:#93c5fd}
.tb-btn.iran-on{background:#2d1515;border-color:var(--red);color:#fca5a5}
.tb-btn.russia-on{background:#2d1a15;border-color:#dc2626;color:#fca5a5}
.tb-btn.china-on{background:#2a2610;border-color:var(--yellow);color:#fde047}
.tb-search{background:#111827;border:1px solid var(--border2);color:var(--text);padding:4px 8px;border-radius:4px;font-size:11px;width:120px;outline:none}
.tb-search:focus{border-color:var(--accent)}
.tb-search::placeholder{color:#3a4560}
.tb-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap}

/* ── MAIN BODY ── */
.main{flex:1;display:flex;overflow:hidden;min-height:0}

/* ── MAP AREA ── */
.map-wrap{flex:1;position:relative;min-width:0}
#map{position:absolute;inset:0}

/* ── RIGHT PANEL ── */
.rpanel{width:320px;flex-shrink:0;background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.rpanel-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0}
.rpanel-tabs .tab{flex:1;padding:8px 4px;text-align:center;font-size:11px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all .15s;user-select:none}
.rpanel-tabs .tab:hover{color:var(--text)}
.rpanel-tabs .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.rpanel-body{flex:1;overflow-y:auto;overflow-x:hidden}
.rpanel-body::-webkit-scrollbar{width:4px}
.rpanel-body::-webkit-scrollbar-track{background:#0d111c}
.rpanel-body::-webkit-scrollbar-thumb{background:#1e2a42;border-radius:2px}

/* Right panel sections */
.rp-section{padding:10px 12px 4px;font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);border-bottom:1px solid var(--border)}
.rp-section.mt{margin-top:4px}

/* News cards */
.news-card{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.news-card:hover{background:rgba(59,130,246,.06)}
.news-card .nc-src{font-size:10px;color:var(--accent);font-weight:600;margin-bottom:3px;text-transform:uppercase;letter-spacing:.4px}
.news-card .nc-title{font-size:12px;line-height:1.4;color:var(--text);margin-bottom:4px}
.news-card .nc-meta{font-size:10px;color:var(--muted)}
.news-card.alert .nc-src{color:var(--red)}
.news-card.alert{border-left:2px solid var(--red)}

/* Stats panel */
.stat-block{padding:10px 12px;border-bottom:1px solid var(--border)}
.stat-block .sb-label{font-size:10px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.country-row{display:flex;align-items:center;gap:6px;margin-bottom:5px;font-size:12px}
.country-row .cr-flag{width:18px;text-align:center}
.country-row .cr-name{flex:1;color:var(--muted)}
.country-row .cr-bar-wrap{width:80px;height:6px;background:#111827;border-radius:3px;overflow:hidden}
.country-row .cr-bar{height:100%;border-radius:3px;transition:width .3s}
.country-row .cr-count{width:24px;text-align:right;font-weight:600;color:var(--text)}
.type-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:11px}
.type-row .tr-icon{width:16px;text-align:center}
.type-row .tr-name{flex:1;color:var(--muted)}
.type-row .tr-bar-wrap{width:70px;height:5px;background:#111827;border-radius:3px;overflow:hidden}
.type-row .tr-bar{height:100%;border-radius:3px;transition:width .3s}
.type-row .tr-count{width:24px;text-align:right;font-weight:600;color:var(--text)}

/* Alerts panel */
.zone-card{padding:8px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.zone-card .zc-name{font-size:12px;color:var(--text)}
.zone-card .zc-count{font-size:14px;font-weight:700}
.zone-card.hot{border-left:2px solid var(--red)}
.zone-card.warm{border-left:2px solid var(--orange)}

/* Activity feed */
.feed-item{padding:6px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px;font-size:11px}
.feed-item .fi-flag{flex-shrink:0}
.feed-item .fi-call{font-weight:600;color:var(--text);flex-shrink:0}
.feed-item .fi-type{color:var(--muted)}
.feed-item .fi-alt{margin-left:auto;color:var(--muted);flex-shrink:0}

/* Briefing modal */
.brief-overlay{position:fixed;inset:0;z-index:90000;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.brief-overlay.vis{display:flex}
.brief-modal{background:#000;border:1px solid rgba(0,255,65,.3);border-radius:2px;width:90%;max-width:600px;max-height:85vh;overflow-y:auto;box-shadow:0 0 60px rgba(0,255,65,.15);position:relative}
.brief-modal::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(0,255,65,.7),transparent)}
.brief-head{padding:12px 16px;background:rgba(0,8,0,.8);border-bottom:1px solid rgba(0,255,65,.1);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:2}
.brief-head h2{font-size:14px;color:var(--accent);font-family:'Orbitron','Share Tech Mono',monospace;letter-spacing:2px;margin:0}
.brief-body{padding:16px}
.brief-section{margin-bottom:16px}
.brief-section h3{font-size:11px;color:var(--accent);font-family:'Share Tech Mono',monospace;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid rgba(0,255,65,.1)}
.brief-stat{display:flex;justify-content:space-between;padding:4px 0;font-size:11px;border-bottom:1px solid rgba(0,255,65,.04)}
.brief-stat .bs-label{color:var(--muted)}
.brief-stat .bs-value{color:var(--text);font-weight:700;font-family:'Share Tech Mono',monospace}

/* Region quick-jump */
.region-btns{position:absolute;bottom:10px;left:10px;z-index:400;display:flex;flex-direction:column;gap:3px}
.region-btns button{background:rgba(13,17,28,0.88);border:1px solid var(--border2);color:var(--muted);padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px;text-align:left;transition:all .15s}
.region-btns button:hover{color:var(--text);border-color:var(--accent)}

/* Alert zones */
.map-legend{position:absolute;top:10px;right:10px;z-index:400;background:rgba(13,17,28,0.88);border:1px solid var(--border2);border-radius:6px;padding:8px 10px;font-size:10px}
.map-legend .ml-row{display:flex;align-items:center;gap:6px;margin-bottom:3px;color:var(--muted)}
.map-legend .ml-row .ml-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

/* ── TICKER ── */
.ticker{flex-shrink:0;height:30px;background:rgba(0,0,0,.7);border-top:1px solid var(--border);overflow:hidden;position:relative}
.ticker-inner{display:flex;align-items:center;height:100%;white-space:nowrap;animation:ticker-scroll 80s linear infinite}
.ticker-inner:hover{animation-play-state:paused}
.ticker-item{padding:0 32px;font-size:11px;color:var(--muted)}
.ticker-item .ti-src{color:var(--accent);font-weight:700;margin-right:6px}
.ticker-item .ti-sep{color:var(--border2);margin:0 8px}
@keyframes ticker-scroll{0%{transform:translateX(100vw)}100%{transform:translateX(-100%)}}

/* Leaflet overrides */
.leaflet-popup-content-wrapper{background:#0d111c;color:var(--text);border-radius:8px;border:1px solid var(--border2)}
.leaflet-popup-tip{background:#0d111c}
.dark-tooltip{background:rgba(13,17,28,.95)!important;color:var(--text)!important;border:1px solid var(--border2)!important;border-radius:5px!important;font-size:11px!important;padding:3px 7px!important;box-shadow:0 2px 8px rgba(0,0,0,.5)!important}

/* Loading */
.loading-ov{position:absolute;inset:0;z-index:600;background:rgba(10,14,23,.85);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px}
.loading-ov .sp{font-size:32px;animation:spin 1s linear infinite;display:inline-block}
.loading-ov .st{color:var(--muted);font-size:13px}
@keyframes spin{to{transform:rotate(360deg)}}

/* CRT Boot Sequence */
.boot-screen{position:fixed;inset:0;z-index:99999;background:#000;display:flex;flex-direction:column;justify-content:flex-start;padding:40px 30px;overflow:hidden;font-family:'Share Tech Mono',monospace}
.boot-screen::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,255,65,.015) 2px,rgba(0,255,65,.015) 4px);pointer-events:none;z-index:1}
.boot-screen::after{content:'';position:absolute;inset:0;background:linear-gradient(transparent 50%,rgba(0,0,0,.03) 50%);background-size:100% 4px;pointer-events:none;z-index:2;animation:boot-flicker 0.15s infinite}
@keyframes boot-flicker{0%{opacity:0.97}50%{opacity:1}100%{opacity:0.97}}
.boot-line{font-size:12px;color:var(--accent);line-height:1.8;opacity:0;white-space:pre;letter-spacing:.5px;z-index:3;position:relative;transform:translateX(-4px);transition:opacity .15s,transform .15s}
.boot-line.vis{opacity:1;transform:translateX(0)}
.boot-line.sys{color:#00cc33}
.boot-line.warn{color:#f97316}
.boot-line.err{color:#ef4444;text-shadow:0 0 8px rgba(239,68,68,.4)}
.boot-line.ok{color:#00ff41}
.boot-line.head{color:#fff;font-size:14px;font-family:'Orbitron','Share Tech Mono',monospace;letter-spacing:3px;text-shadow:0 0 20px rgba(0,255,65,.6)}
.boot-line.ascii{color:rgba(0,255,65,.25);font-size:10px;line-height:1.2;letter-spacing:0}
.boot-line .cursor{display:inline-block;width:8px;height:14px;background:var(--accent);animation:blink-cursor .5s step-end infinite;vertical-align:text-bottom;margin-left:2px}
@keyframes blink-cursor{50%{opacity:0}}
.boot-progress{width:400px;height:6px;background:rgba(0,255,65,.08);border-radius:2px;margin-top:10px;overflow:hidden;z-index:3;position:relative;border:1px solid rgba(0,255,65,.15)}
.boot-progress-fill{height:100%;background:linear-gradient(90deg,#00ff41,#00cc33);width:0%;transition:width .3s;box-shadow:0 0 12px rgba(0,255,65,.6),inset 0 0 4px rgba(255,255,255,.15)}
@keyframes boot-glitch{0%,100%{transform:translate(0)}10%{transform:translate(-2px,1px)}20%{transform:translate(2px,-1px)}30%{transform:translate(0)}90%{transform:translate(1px,0)}}
.boot-glitch{animation:boot-glitch .15s linear}
/* Ambient floating particles on map */
@keyframes particle-float{0%{transform:translateY(0) translateX(0);opacity:0}10%{opacity:.6}90%{opacity:.6}100%{transform:translateY(-100vh) translateX(30px);opacity:0}}
.map-particles{position:absolute;inset:0;z-index:1;pointer-events:none;overflow:hidden}
.map-particle{position:absolute;width:2px;height:2px;background:#00ff41;border-radius:50%;box-shadow:0 0 4px #00ff41;animation:particle-float linear infinite;opacity:0}
/* Heartbeat pulse for live status */
@keyframes hb-pulse{0%,100%{opacity:1}50%{opacity:.3}}
.hb-live{animation:hb-pulse 2s ease-in-out infinite;color:#00ff41;font-size:9px;font-family:'Share Tech Mono',monospace;letter-spacing:.5px}

/* Radar sweep overlay */
.radar-overlay{position:absolute;top:10px;left:10px;z-index:399;width:120px;height:120px;pointer-events:none;display:none}
.radar-overlay.vis{display:block}
.radar-ring{fill:none;stroke:rgba(0,255,65,.12);stroke-width:1}
.radar-sweep{fill:conic-gradient(from 0deg,transparent,rgba(0,255,65,.25));transform-origin:50% 50%;animation:radar-rotate 3s linear infinite}
@keyframes radar-rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

/* Cinema mode overlay */
.cinema-label{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);z-index:9000;font-family:'Orbitron',monospace;font-size:11px;letter-spacing:6px;color:rgba(0,255,65,.12);text-transform:uppercase;pointer-events:none;display:none}
.cinema-label.vis{display:block}

/* Nuke radius tool */
.nuke-panel{position:absolute;bottom:50px;right:10px;z-index:500;background:rgba(0,4,0,.96);border:1px solid rgba(239,68,68,.3);border-radius:2px;padding:10px 12px;width:200px;display:none;font-family:'Share Tech Mono',monospace;font-size:10px;box-shadow:0 0 20px rgba(239,68,68,.1)}
.nuke-panel.vis{display:block}
.nuke-panel label{color:var(--muted);font-size:9px;text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px;margin-top:6px}
.nuke-panel select,.nuke-panel button{background:rgba(0,8,0,.9);border:1px solid rgba(0,255,65,.15);color:var(--accent);padding:4px 8px;font-family:'Share Tech Mono',monospace;font-size:10px;border-radius:2px;width:100%;cursor:pointer}
.nuke-panel button:hover{border-color:var(--accent);box-shadow:0 0 8px rgba(0,255,65,.2)}

/* (mobile styles consolidated above) */
</style>
<!-- LAST_UPDATE: 2026-02-26T06:43:14Z -->
</head>
<body>

<!-- CRT BOOT SEQUENCE -->
<div class="boot-screen" id="bootScreen">
  <div class="boot-line ascii" id="boot-0">        ___  _ _        ___ _                </div>
  <div class="boot-line ascii" id="boot-1">       / _ \(_) | ___  / __\ | __ ___      __</div>
  <div class="boot-line ascii" id="boot-2">      / /_)/ | |/ / _ \/ /  | |/ _` \ \ /\ / /</div>
  <div class="boot-line ascii" id="boot-3">     / ___/| |   &lt;  __/ /___| | (_| |\ V  V / </div>
  <div class="boot-line ascii" id="boot-4">     \/    |_|_|\_\___\____/|_|\__,_| \_/\_/  </div>
  <div class="boot-line" id="boot-5"></div>
  <div class="boot-line head" id="boot-6">╔══════════════════════════════════════════════════════════╗</div>
  <div class="boot-line head" id="boot-7">║   MILITARY OSINT TERMINAL v3.2 — SITUATION ROOM MODE    ║</div>
  <div class="boot-line head" id="boot-8">║   DEFENSE INTELLIGENCE MONITORING SYSTEM                 ║</div>
  <div class="boot-line head" id="boot-9">╚══════════════════════════════════════════════════════════╝</div>
  <div class="boot-line sys" id="boot-10">BIOS POST.......... OK</div>
  <div class="boot-line sys" id="boot-11">CPU: QUANTUM-X86/NEURAL v4.2 ✓  |  CORES: 128 ACTIVE</div>
  <div class="boot-line sys" id="boot-12">MEM CHECK: 131072K ████████████████████████████████ OK</div>
  <div class="boot-line sys" id="boot-13">GPU: TACTICAL-RENDER v2.1 ✓  |  VRAM: 32768K ALLOCATED</div>
  <div class="boot-line" id="boot-14">Initializing secure terminal session...</div>
  <div class="boot-line" id="boot-15">Loading cryptographic modules........... AES-256-GCM ✓ RSA-4096 ✓ ECDSA ✓</div>
  <div class="boot-line" id="boot-16">Verifying operator clearance............ LEVEL 5 — AUTHORIZED</div>
  <div class="boot-line err" id="boot-17">ERR: NSA BACKDOOR DETECTED ............. PATCHING ██████ NEUTRALIZED ✓</div>
  <div class="boot-line ok" id="boot-18">Establishing MILNET uplink.............</div>
  <div class="boot-line ok" id="boot-19">  ╠══ SATCOM CH-1:  ACTIVE  [ENCRYPTED]    ══╣</div>
  <div class="boot-line ok" id="boot-20">  ╠══ SATCOM CH-2:  STANDBY [BACKUP]       ══╣</div>
  <div class="boot-line ok" id="boot-21">  ╠══ MESH RELAY:   ACTIVE  [6 NODES]      ══╣</div>
  <div class="boot-line ok" id="boot-22">  ╠══ TOR CIRCUIT:  ACTIVE  [3 HOPS]       ══╣</div>
  <div class="boot-line" id="boot-23">Connecting data feeds:</div>
  <div class="boot-line" id="boot-24">  ├─ ADS-B mil transponders...... api.adsb.lol ✓</div>
  <div class="boot-line" id="boot-25">  ├─ OSINT news aggregator....... RSS x6 feeds ✓</div>
  <div class="boot-line" id="boot-26">  ├─ Prediction markets.......... Polymarket API ✓</div>
  <div class="boot-line" id="boot-27">  ├─ Seismic monitoring.......... USGS GeoJSON ✓</div>
  <div class="boot-line" id="boot-28">  ├─ Space launch telemetry...... TheSpaceDevs ✓</div>
  <div class="boot-line" id="boot-29">  ├─ FX/sanctions rates.......... open.er-api ✓</div>
  <div class="boot-line" id="boot-30">  ├─ ISS orbital telemetry....... open-notify ✓</div>
  <div class="boot-line" id="boot-31">  └─ Intel data pipeline......... GitHub CDN ✓</div>
  <div class="boot-line" id="boot-32">Loading tactical databases:</div>
  <div class="boot-line" id="boot-33">  ├─ Aircraft signatures.............. 487 type records</div>
  <div class="boot-line" id="boot-34">  ├─ Naval deployment tracking........ 12 battle groups</div>
  <div class="boot-line" id="boot-35">  ├─ Active conflict zones............ 8 theater regions</div>
  <div class="boot-line" id="boot-36">  ├─ GPS/GNSS interference............ 11 EW zones</div>
  <div class="boot-line" id="boot-37">  ├─ Military exercises............... 8 operations</div>
  <div class="boot-line" id="boot-38">  ├─ NOTAM/TFR airspace............... 10 restrictions</div>
  <div class="boot-line" id="boot-39">  ├─ Nuclear/WMD facilities........... 22 sites monitored</div>
  <div class="boot-line" id="boot-40">  └─ Air defense networks............. 13 SAM systems</div>
  <div class="boot-line" id="boot-41"></div>
  <div class="boot-line warn" id="boot-42">⚠ CLASSIFICATION: UNCLASSIFIED // OSINT ONLY</div>
  <div class="boot-line warn" id="boot-43">⚠ DOOMSDAY CLOCK: 90 SECONDS TO MIDNIGHT — CLOSEST EVER</div>
  <div class="boot-line ok" id="boot-44">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</div>
  <div class="boot-line ok" id="boot-45"><span id="boot-typed"></span><span class="cursor"></span></div>
  <div class="boot-progress" id="boot-bar"><div class="boot-progress-fill" id="boot-fill"></div></div>
</div>

<!-- BRIEFING MODAL -->
<div class="brief-overlay" id="briefOverlay" onclick="if(event.target===this)closeBriefing()">
  <div class="brief-modal">
    <div class="brief-head">
      <h2>📋 DAILY INTELLIGENCE BRIEFING</h2>
      <button class="x" onclick="closeBriefing()" style="background:rgba(0,255,65,.08);border:1px solid rgba(0,255,65,.2);color:var(--accent);cursor:pointer;font-size:18px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:2px">&times;</button>
    </div>
    <div class="brief-body" id="briefBody"></div>
  </div>
</div>

<!-- TOP BAR -->
<div class="topbar">
  <span class="logo">⚡ PIKE<span>CLAW</span> // OSINT-MIL <span class="status-dot" title="Live feeds active"></span></span>
  <span class="tb-label">Country:</span>
  <button class="tb-btn on" id="bc-all" onclick="setCF('all')">🌍 All</button>
  <button class="tb-btn" id="bc-us" onclick="setCF('us')">🇺🇸 US</button>
  <button class="tb-btn" id="bc-iran" onclick="setCF('iran')">🇮🇷 Iran</button>
  <button class="tb-btn" id="bc-russia" onclick="setCF('russia')">🇷🇺 Russia</button>
  <button class="tb-btn" id="bc-china" onclick="setCF('china')">🇨🇳 China</button>
  <button class="tb-btn" id="bc-allied" onclick="setCF('allied')">🤝 Allied</button>
  <div class="tb-sep"></div>
  <span class="tb-label">Type:</span>
  <button class="tb-btn on" id="bt-all" onclick="setTF('all')">All</button>
  <button class="tb-btn" id="bt-fighter" onclick="setTF('fighter')">✈️ Fighter</button>
  <button class="tb-btn" id="bt-transport" onclick="setTF('transport')">🛩️ Transport</button>
  <button class="tb-btn" id="bt-tanker" onclick="setTF('tanker')">⛽ Tanker</button>
  <button class="tb-btn" id="bt-recon" onclick="setTF('recon')">🔍 ISR</button>
  <button class="tb-btn" id="bt-heli" onclick="setTF('heli')">🚁 Heli</button>
  <button class="tb-btn" id="bt-bomber" onclick="setTF('bomber')">💣 Bomber</button>
  <div class="tb-sep"></div>
  <input class="tb-search" id="searchBox" placeholder="Search callsign/hex..." oninput="doSearch()"/>
  <button class="tb-btn" onclick="fetchData()" title="Refresh now">🔄 Refresh</button>
  <div class="tb-sep"></div>
  <span class="tb-label">Map:</span>
  <button class="tb-btn tile-btn on" data-t="dark" onclick="setTile('dark')">🌑 Dark</button>
  <button class="tb-btn tile-btn" data-t="satellite" onclick="setTile('satellite')">🛰️ Sat</button>
  <button class="tb-btn tile-btn" data-t="terrain" onclick="setTile('terrain')">🗺️ Terrain</button>
  <div class="tb-sep"></div>
  <button class="tb-btn" id="btn-bases" onclick="toggleBases()">📍 Bases</button>
  <button class="tb-btn" id="btn-missiles" onclick="toggleMissiles()">🚀 Ranges</button>
  <button class="tb-btn" id="btn-nuclear" onclick="toggleNuclear()">☢️ WMD Sites</button>
  <button class="tb-btn" id="btn-airdef" onclick="toggleAirDef()">🛡️ Air Defense</button>
  <button class="tb-btn" id="btn-quakes" onclick="toggleQuakes()">🌍 Quakes</button>
  <button class="tb-btn" id="btn-notams" onclick="toggleNOTAMs()">🔴 NOTAMs</button>
  <button class="tb-btn" id="btn-gpsjam" onclick="toggleGPSJam()">📡 GPS Jam</button>
  <button class="tb-btn" id="btn-exercises" onclick="toggleExercises()">🎯 Exercises</button>
  <button class="tb-btn" id="btn-conflicts" onclick="toggleConflicts()">⚔️ Conflicts</button>
  <button class="tb-btn on" id="btn-naval" onclick="toggleNavalLayer()">🚢 Naval</button>
  <button class="tb-btn" id="btn-terminator" onclick="toggleTerminator()">🌗 Day/Night</button>
  <button class="tb-btn" id="btn-paths" onclick="toggleFlightPaths()">➤ Paths</button>
  <button class="tb-btn" id="btn-nuke" onclick="toggleNukeMode()">☢️ Nuke Calc</button>
  <div class="tb-sep"></div>
  <button class="tb-btn" id="btn-brief" onclick="showBriefing()" style="background:rgba(0,255,65,.08);border-color:rgba(0,255,65,.3)">📋 Brief</button>
  <button class="tb-btn" id="btn-cinema" onclick="toggleCinema()">🎬 Cinema</button>
  <button class="tb-btn" id="btn-audio" onclick="toggleAudio()">🔇 Sound</button>
  <button class="tb-btn" id="btn-voice" onclick="toggleVoice()">🗣️ Voice</button>
  <button class="tb-btn" id="btn-notif" onclick="toggleNotifications()">🔔 Alerts</button>
  <div class="tb-sep"></div>
  <span class="hb-live" id="hb-indicator">● LIVE</span>
  <span style="font-size:9px;color:var(--muted);font-family:'Share Tech Mono',monospace" id="hb-time"></span>
  <!-- MOBILE HAMBURGER BUTTON -->
  <button class="mob-menu-btn" onclick="toggleMobDrawer()" aria-label="Menu">☰</button>
</div>

<!-- MOBILE DRAWER -->
<div class="mob-drawer" id="mobDrawer">
  <div class="mob-drawer-head">
    <span class="logo">⚡ PIKECLAW // CONTROLS</span>
    <button class="mob-drawer-close" onclick="toggleMobDrawer()">×</button>
  </div>
  <div class="mob-drawer-body">
    <div>
      <div class="mob-section-label">Aircraft Filter — Type</div>
      <div class="mob-btn-row">
        <button class="tb-btn on" id="mob-bt-all" onclick="setTF('all');updateMobTypeButtons('all')">All</button>
        <button class="tb-btn" id="mob-bt-fighter" onclick="setTF('fighter');updateMobTypeButtons('fighter')">✈️ Fighter</button>
        <button class="tb-btn" id="mob-bt-transport" onclick="setTF('transport');updateMobTypeButtons('transport')">🛩️ Transport</button>
        <button class="tb-btn" id="mob-bt-tanker" onclick="setTF('tanker');updateMobTypeButtons('tanker')">⛽ Tanker</button>
        <button class="tb-btn" id="mob-bt-recon" onclick="setTF('recon');updateMobTypeButtons('recon')">🔍 ISR</button>
        <button class="tb-btn" id="mob-bt-heli" onclick="setTF('heli');updateMobTypeButtons('heli')">🚁 Heli</button>
        <button class="tb-btn" id="mob-bt-bomber" onclick="setTF('bomber');updateMobTypeButtons('bomber')">💣 Bomber</button>
      </div>
    </div>
    <div>
      <div class="mob-section-label">Map Style</div>
      <div class="mob-btn-row">
        <button class="tb-btn tile-btn on" data-t="dark" onclick="setTile('dark')">🌑 Dark</button>
        <button class="tb-btn tile-btn" data-t="satellite" onclick="setTile('satellite')">🛰️ Sat</button>
        <button class="tb-btn tile-btn" data-t="terrain" onclick="setTile('terrain')">🗺️ Terrain</button>
      </div>
    </div>
    <div>
      <div class="mob-section-label">Map Overlays</div>
      <div class="mob-btn-row">
        <button class="tb-btn" id="mob-btn-bases" onclick="toggleBases()">📍 Bases</button>
        <button class="tb-btn" id="mob-btn-missiles" onclick="toggleMissiles()">🚀 Ranges</button>
        <button class="tb-btn" id="mob-btn-nuclear" onclick="toggleNuclear()">☢️ WMD</button>
        <button class="tb-btn" id="mob-btn-airdef" onclick="toggleAirDef()">🛡️ Air Def</button>
        <button class="tb-btn" id="mob-btn-quakes" onclick="toggleQuakes()">🌍 Quakes</button>
        <button class="tb-btn" id="mob-btn-notams" onclick="toggleNOTAMs()">🔴 NOTAMs</button>
        <button class="tb-btn" id="mob-btn-gpsjam" onclick="toggleGPSJam()">📡 GPS Jam</button>
        <button class="tb-btn" id="mob-btn-exercises" onclick="toggleExercises()">🎯 Exercises</button>
        <button class="tb-btn" id="mob-btn-conflicts" onclick="toggleConflicts()">⚔️ Conflicts</button>
        <button class="tb-btn on" id="mob-btn-naval" onclick="toggleNavalLayer()">🚢 Naval</button>
        <button class="tb-btn" id="mob-btn-terminator" onclick="toggleTerminator()">🌗 Day/Night</button>
        <button class="tb-btn" id="mob-btn-paths" onclick="toggleFlightPaths()">➤ Paths</button>
        <button class="tb-btn" id="mob-btn-nuke" onclick="toggleNukeMode()">☢️ Nuke Calc</button>
      </div>
    </div>
    <div>
      <div class="mob-section-label">Tools</div>
      <div class="mob-btn-row">
        <button class="tb-btn" onclick="showBriefing()" style="background:rgba(0,255,65,.08);border-color:rgba(0,255,65,.3)">📋 Brief</button>
        <button class="tb-btn" onclick="toggleAudio()">🔇 Sound</button>
        <button class="tb-btn" onclick="toggleNotifications()">🔔 Alerts</button>
        <button class="tb-btn" onclick="fetchData()">🔄 Refresh</button>
      </div>
    </div>
    <div style="border-top:1px solid rgba(0,255,65,.1);padding-top:10px">
      <div class="mob-section-label">Region Jump</div>
      <div class="mob-btn-row">
        <button class="tb-btn" onclick="goTo(30,50,5);toggleMobDrawer()">🔥 Mid East</button>
        <button class="tb-btn" onclick="goTo(38,-97,4);toggleMobDrawer()">🇺🇸 CONUS</button>
        <button class="tb-btn" onclick="goTo(50,15,4);toggleMobDrawer()">🇪🇺 Europe</button>
        <button class="tb-btn" onclick="goTo(25,125,4);toggleMobDrawer()">🌏 Pacific</button>
        <button class="tb-btn" onclick="goTo(20,0,2);toggleMobDrawer()">🌍 Global</button>
      </div>
    </div>
  </div>
</div>

<!-- ZULU CLOCK BAR -->
<div class="clock-bar" id="clockBar">
  <div class="clock-cell"><span class="clock-label">ZULU</span><span class="clock-time" id="clk-zulu">--:--:--Z</span></div>
  <div class="clock-cell"><span class="clock-label">🇺🇸 DC</span><span class="clock-time" id="clk-dc">--:--</span></div>
  <div class="clock-cell"><span class="clock-label">🇺🇦 KYIV</span><span class="clock-time" id="clk-kyiv">--:--</span></div>
  <div class="clock-cell"><span class="clock-label">🇷🇺 MOSCOW</span><span class="clock-time" id="clk-moscow">--:--</span></div>
  <div class="clock-cell"><span class="clock-label">🇮🇷 TEHRAN</span><span class="clock-time" id="clk-tehran">--:--</span></div>
  <div class="clock-cell"><span class="clock-label">🇨🇳 BEIJING</span><span class="clock-time" id="clk-beijing">--:--</span></div>
  <div class="clock-cell clock-date"><span class="clock-label">DATE</span><span class="clock-time" id="clk-date">--</span></div>
</div>

<!-- DASHBOARD GRID -->
<div class="dashboard">

  <!-- MAP WIDGET -->
  <div class="widget w-map">
    <div id="map" style="position:absolute;inset:0"></div>
    <div class="map-particles" id="mapParticles"></div>
    <!-- Radar sweep -->
    <svg class="radar-overlay" id="radarOverlay" viewBox="0 0 120 120">
      <circle class="radar-ring" cx="60" cy="60" r="20"/><circle class="radar-ring" cx="60" cy="60" r="40"/><circle class="radar-ring" cx="60" cy="60" r="58"/>
      <line x1="60" y1="2" x2="60" y2="118" stroke="rgba(0,255,65,.06)" stroke-width="0.5"/>
      <line x1="2" y1="60" x2="118" y2="60" stroke="rgba(0,255,65,.06)" stroke-width="0.5"/>
      <line x1="60" y1="60" x2="60" y2="2" stroke="rgba(0,255,65,.5)" stroke-width="1.5" stroke-linecap="round" style="transform-origin:60px 60px;animation:radar-rotate 3s linear infinite;filter:drop-shadow(0 0 4px #00ff41)"/>
      <circle cx="60" cy="60" r="2" fill="#00ff41" style="filter:drop-shadow(0 0 4px #00ff41)"/>
    </svg>
    <!-- Nuke calc panel -->
    <div class="nuke-panel" id="nukePanel">
      <div style="color:#ef4444;font-weight:700;font-size:11px;margin-bottom:4px">☢️ NUCLEAR BLAST CALCULATOR</div>
      <div style="color:var(--muted);font-size:9px;margin-bottom:6px">Click map to set detonation point</div>
      <label>Warhead Yield</label>
      <select id="nukeYield">
        <option value="15">15 KT (Hiroshima)</option>
        <option value="100">100 KT (Tactical)</option>
        <option value="300">300 KT (W87 ICBM)</option>
        <option value="800" selected>800 KT (Topol-M)</option>
        <option value="1000">1 MT (Strategic)</option>
        <option value="5000">5 MT (Thermonuclear)</option>
        <option value="50000">50 MT (Tsar Bomba)</option>
      </select>
      <label>Detonation</label>
      <select id="nukeBurst"><option value="air" selected>Airburst</option><option value="surface">Surface</option></select>
      <button onclick="clearNukeRings()" style="margin-top:8px;background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.3);color:#ef4444">Clear Rings</button>
    </div>
    <!-- Cinema mode label -->
    <div class="cinema-label" id="cinemaLabel">⚡ SITUATION ROOM — LIVE MONITORING ⚡</div>
    <div class="map-legend" style="position:absolute;top:10px;right:10px;z-index:400">
      <div class="ml-row"><div class="ml-dot" style="background:#00ff41"></div>🇺🇸 US</div>
      <div class="ml-row"><div class="ml-dot" style="background:#ef4444"></div>🇮🇷 Iran</div>
      <div class="ml-row"><div class="ml-dot" style="background:#dc2626"></div>🇷🇺 Russia</div>
      <div class="ml-row"><div class="ml-dot" style="background:#eab308"></div>🇨🇳 China</div>
      <div class="ml-row"><div class="ml-dot" style="background:#bf5fff"></div>🤝 Allied</div>
    </div>
    <div class="region-btns" style="position:absolute;bottom:10px;left:10px;z-index:400">
      <button onclick="goTo(30,50,5)">🔥 Mid East</button>
      <button onclick="goTo(38,-97,4)">🇺🇸 CONUS</button>
      <button onclick="goTo(50,15,4)">🇪🇺 Europe</button>
      <button onclick="goTo(25,125,4)">🌏 Pacific</button>
      <button onclick="goTo(20,0,2)">🌍 Global</button>
    </div>
    <div class="infopanel" id="infoP" style="position:absolute;bottom:50px;left:10px;z-index:500">
      <div class="ip-head"><h3 id="pTitle">—</h3><button class="x" onclick="closeP()">&times;</button></div>
      <div id="pBody"></div>
    </div>
    <div class="loading-ov" id="loadOv" style="position:absolute;inset:0;z-index:600">
      <div class="sp">✈️</div><div class="st">Loading...</div>
    </div>
  </div>

  <!-- ZONES WIDGET -->
  <div class="widget w-zones">
    <div class="widget-header">⚠️ <span class="wh-title">Alert Zones</span><span class="wh-count" id="zone-hot">0 hot</span></div>
    <div class="widget-body" id="pane-alerts"></div>
  </div>

  <!-- STATS WIDGET -->
  <div class="widget w-stats">
    <div class="widget-header">📊 <span class="wh-title">Stats</span></div>
    <div class="widget-body" id="pane-stats"></div>
  </div>

  <!-- ACTIVITY WIDGET -->
  <div class="widget w-activity">
    <div class="widget-header" style="padding:0;gap:0">
      <div style="display:flex;flex:1">
        <div id="act-tab-activity" onclick="switchActTab('activity')" style="flex:1;padding:7px 8px;text-align:center;font-size:9px;font-family:'Share Tech Mono',monospace;letter-spacing:.5px;text-transform:uppercase;cursor:pointer;color:rgba(0,255,65,.7);border-bottom:2px solid rgba(0,255,65,.6);border-right:1px solid rgba(0,255,65,.08)">🔔 ACTIVITY <span id="ac-count" style="opacity:.7">0</span></div>
        <div id="act-tab-log"      onclick="switchActTab('log')"      style="flex:1;padding:7px 8px;text-align:center;font-size:9px;font-family:'Share Tech Mono',monospace;letter-spacing:.5px;text-transform:uppercase;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent">📋 LOG <span id="log-count" style="opacity:.7">0</span></div>
      </div>
    </div>
    <div class="widget-body">
      <div id="pane-activity"></div>
      <div id="pane-log" style="display:none"></div>
    </div>
  </div>

  <!-- DEFCON / THREAT POSTURE WIDGET -->
  <div class="widget w-log widget-scan-line" style="grid-column:3;grid-row:1;position:relative;overflow:hidden">
    <div class="widget-header">🚨 <span class="wh-title">Threat Posture</span><span class="wh-count" id="threat-level" style="color:#22c55e">NORMAL</span></div>
    <div class="widget-body" id="pane-threat"></div>
  </div>

  <!-- ADVERSARY INTEL WIDGET -->
  <div class="widget" style="grid-column:2/4;grid-row:2">
    <div class="widget-header" style="padding:0">
      <div id="adv-tabs" style="display:flex;width:100%">
        <div class="adv-tab active" data-adv="iran"   onclick="switchAdv('iran')"  >🇮🇷 Iran</div>
        <div class="adv-tab"        data-adv="russia" onclick="switchAdv('russia')">🇷🇺 Russia</div>
        <div class="adv-tab"        data-adv="china"  onclick="switchAdv('china')" >🇨🇳 China</div>
      </div>
    </div>
    <div class="widget-body" id="pane-adv" style="padding:0"></div>
  </div>

  <!-- NAVAL ACTIVITY WIDGET -->
  <div class="widget widget-scan-line" style="grid-column:2/4;grid-row:3;position:relative;overflow:hidden">
    <div class="widget-header">🚢 <span class="wh-title">Naval Deployments</span><span class="wh-count" id="naval-count">0 assets</span></div>
    <div class="widget-body" id="pane-naval" style="padding:0;display:flex;flex-direction:column"></div>
  </div>

  <!-- CENTCOM ASSETS WIDGET -->
  <div class="widget widget-scan-line" style="grid-column:1/-1;grid-row:4;position:relative;overflow:hidden;min-height:220px">
    <div class="widget-header">
      🇺🇸 <span class="wh-title">US CENTCOM Assets — Middle East Posture</span>
      <span class="wh-count" id="centcom-troops" style="color:#00ff41">~40,000 troops</span>
      <span style="font-size:9px;color:var(--muted);font-family:'Share Tech Mono',monospace;margin-left:6px" id="centcom-updated"></span>
    </div>
    <div class="widget-body" id="pane-centcom" style="padding:0;display:flex;flex-direction:row;overflow-x:hidden;overflow-y:hidden"></div>
  </div>

</div>

<!-- BOTTOM INFO BAR -->
<div class="bottom-bar" style="flex-shrink:0;height:175px;display:flex;border-top:1px solid rgba(0,255,65,.15);background:#000">

  <!-- POLYMARKET WIDGET -->
  <div style="width:300px;flex-shrink:0;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden">
    <div style="flex-shrink:0;padding:6px 10px;background:rgba(0,4,0,.6);border-bottom:1px solid rgba(0,255,65,.1);font-size:10px;font-weight:700;letter-spacing:1px;color:rgba(0,255,65,.5);text-transform:uppercase;display:flex;align-items:center;gap:6px">
      🎲 <span style="flex:1">Polymarket Odds</span>
      <span id="poly-updated" style="font-size:9px;color:#3a4560"></span>
    </div>
    <div style="flex:1;overflow-x:auto;overflow-y:hidden;display:flex;align-items:stretch" id="polyStrip"></div>
  </div>

  <!-- SPACE LAUNCH TRACKER -->
  <div style="width:280px;flex-shrink:0;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;position:relative" class="widget-scan-line">
    <div style="flex-shrink:0;padding:6px 10px;background:rgba(0,4,0,.6);border-bottom:1px solid rgba(0,255,65,.1);font-size:10px;font-weight:700;letter-spacing:1px;color:rgba(0,255,65,.5);text-transform:uppercase;display:flex;align-items:center;gap:6px">
      🚀 <span style="flex:1">Launch Schedule</span>
      <span id="launch-count" style="font-size:9px;color:var(--muted)"></span>
    </div>
    <div style="flex:1;overflow-y:auto;overflow-x:hidden" id="launchStrip"></div>
  </div>

  <!-- CURRENCY / SANCTIONS WATCH -->
  <div style="width:220px;flex-shrink:0;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden">
    <div style="flex-shrink:0;padding:6px 10px;background:rgba(0,4,0,.6);border-bottom:1px solid rgba(0,255,65,.1);font-size:10px;font-weight:700;letter-spacing:1px;color:rgba(0,255,65,.5);text-transform:uppercase;display:flex;align-items:center;gap:6px">
      💱 <span style="flex:1">FX Watch</span>
    </div>
    <div style="flex:1;overflow-y:auto" id="currencyStrip"></div>
  </div>

  <!-- DOOMSDAY CLOCK -->
  <div style="width:140px;flex-shrink:0;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden" id="doomsdayWidget">
    <div style="flex-shrink:0;padding:6px 10px;background:rgba(0,4,0,.6);border-bottom:1px solid rgba(0,255,65,.1);font-size:10px;font-weight:700;letter-spacing:1px;color:rgba(0,255,65,.5);text-transform:uppercase;display:flex;align-items:center;gap:6px">
      ⏰ <span style="flex:1">Doomsday</span>
    </div>
    <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px">
      <div style="position:relative;width:80px;height:80px">
        <svg width="80" height="80" viewBox="0 0 80 80" style="transform:rotate(-90deg)">
          <circle cx="40" cy="40" r="36" fill="none" stroke="rgba(0,255,65,.08)" stroke-width="3"/>
          <circle cx="40" cy="40" r="36" fill="none" stroke="#ef4444" stroke-width="3" stroke-dasharray="226.2" stroke-dashoffset="2.26" stroke-linecap="round" style="filter:drop-shadow(0 0 4px #ef4444)"/>
        </svg>
        <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center">
          <div style="font-size:18px;font-weight:800;color:#ef4444;font-family:'Orbitron',monospace;text-shadow:0 0 12px rgba(239,68,68,.5);line-height:1">90</div>
          <div style="font-size:7px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:2px">SECONDS</div>
        </div>
      </div>
      <div style="font-size:8px;color:#ef4444;font-family:'Share Tech Mono',monospace;letter-spacing:1px;margin-top:6px;text-align:center;text-shadow:0 0 8px rgba(239,68,68,.3)">TO MIDNIGHT</div>
      <div style="font-size:7px;color:var(--muted);margin-top:3px;text-align:center">Bulletin of Atomic<br>Scientists — Jan 2024</div>
    </div>
  </div>

  <!-- X / OSINT ACCOUNTS WIDGET -->
  <div style="width:280px;flex-shrink:0;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden">
    <div style="flex-shrink:0;padding:6px 10px;background:rgba(0,4,0,.6);border-bottom:1px solid rgba(0,255,65,.1);font-size:10px;font-weight:700;letter-spacing:1px;color:rgba(0,255,65,.5);text-transform:uppercase;display:flex;align-items:center;gap:6px">
      📡 <span style="flex:1">OSINT Feeds</span>
      <span id="x-account-tabs" style="display:flex;gap:4px"></span>
    </div>
    <div style="flex:1;overflow-y:auto;overflow-x:hidden" id="xFeed"></div>
  </div>

  <!-- NEWS STRIP -->
  <div style="flex:1;display:flex;flex-direction:column;overflow:hidden">
    <div style="flex-shrink:0;padding:6px 10px;background:rgba(0,4,0,.6);border-bottom:1px solid rgba(0,255,65,.1);font-size:10px;font-weight:700;letter-spacing:1px;color:rgba(0,255,65,.5);text-transform:uppercase">📰 Intel Feed</div>
    <div style="flex:1;overflow-x:auto;overflow-y:hidden;display:flex;align-items:stretch" id="newsStrip"></div>
  </div>

</div>

<!-- TICKER -->

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ════════════════════════════════════════
// CRT BOOT SEQUENCE
// ════════════════════════════════════════
(function bootSequence(){
  const screen = document.getElementById('bootScreen');
  if(!screen) return;
  const totalLines = 46;
  let i = 0;
  let bootAudioCtx;
  try { bootAudioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){}

  function bootBeep(freq, dur){
    if(!bootAudioCtx) return;
    try {
      const o = bootAudioCtx.createOscillator();
      const g = bootAudioCtx.createGain();
      o.connect(g); g.connect(bootAudioCtx.destination);
      o.type = 'sine'; o.frequency.value = freq;
      g.gain.setValueAtTime(0.03, bootAudioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, bootAudioCtx.currentTime + dur);
      o.start(); o.stop(bootAudioCtx.currentTime + dur);
    } catch(e){}
  }

  function typeText(el, text, cb){
    let ci = 0;
    function t(){
      if(ci >= text.length){ if(cb) cb(); return; }
      el.textContent += text[ci]; ci++;
      bootBeep(600 + Math.random()*400, 0.03);
      setTimeout(t, 35 + Math.random()*25);
    }
    t();
  }

  // Dramatic delays per section
  function getDelay(idx){
    if(idx <= 5) return 50 + Math.random()*30;           // ASCII art — fast
    if(idx <= 9) return 140 + Math.random()*60;          // Header box — slow/dramatic
    if(idx <= 13) return 100 + Math.random()*50;         // BIOS/CPU/MEM
    if(idx === 14) return 200 + Math.random()*100;       // "Initializing..." — pause
    if(idx <= 16) return 120 + Math.random()*60;         // Crypto/clearance
    if(idx === 17) return 500;                           // ERR line — dramatic pause
    if(idx === 18) return 300;                           // "Establishing..." — pause
    if(idx <= 22) return 110 + Math.random()*40;         // SATCOM channels
    if(idx === 23) return 180;                           // "Connecting data feeds:"
    if(idx <= 31) return 80 + Math.random()*40;          // Feed connections — moderate
    if(idx === 32) return 160;                           // "Loading databases:"
    if(idx <= 40) return 60 + Math.random()*30;          // Database items — faster
    if(idx === 41) return 100;                           // blank line
    if(idx <= 43) return 300 + Math.random()*100;        // Warnings — slow
    if(idx === 44) return 200;                           // separator
    return 100;
  }

  function showLine(){
    if(i >= totalLines){
      // Type the final line character by character
      const typedEl = document.getElementById('boot-typed');
      if(typedEl){
        const el45 = document.getElementById('boot-45');
        if(el45) el45.classList.add('vis');
        typeText(typedEl, 'ALL SYSTEMS NOMINAL — LAUNCHING DASHBOARD', () => {
          const fill = document.getElementById('boot-fill');
          if(fill) fill.style.width = '100%';
          bootBeep(1200, 0.2);
          // Glitch effect before fade
          setTimeout(() => {
            screen.classList.add('boot-glitch');
            setTimeout(() => screen.classList.remove('boot-glitch'), 150);
          }, 400);
          setTimeout(() => {
            screen.style.transition = 'opacity 0.6s ease-out';
            screen.style.opacity = '0';
            setTimeout(() => { screen.remove(); if(bootAudioCtx) bootAudioCtx.close(); }, 600);
          }, 900);
        });
      }
      return;
    }
    const el = document.getElementById('boot-'+i);
    if(el){
      el.classList.add('vis');
      // Glitch on the ERR line
      if(i === 17){
        screen.classList.add('boot-glitch');
        bootBeep(200, 0.15);
        setTimeout(() => screen.classList.remove('boot-glitch'), 150);
      } else {
        bootBeep(800 + i*15, 0.04);
      }
    }
    const fill = document.getElementById('boot-fill');
    if(fill) fill.style.width = Math.round(((i+1)/totalLines)*95)+'%';
    const delay = getDelay(i);
    i++;
    setTimeout(showLine, delay);
  }
  setTimeout(showLine, 600);
})();

// ════════════════════════════════════════
// MAP SETUP
// ════════════════════════════════════════
const map = L.map('map', { center:[30,50], zoom:5, zoomControl:true });
const TILES = {
  dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {attribution:'&copy; OSM &copy; CARTO | adsb.lol',subdomains:'abcd',maxZoom:19}),
  labels: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {subdomains:'abcd',maxZoom:19,pane:'overlayPane'}),
  borders: L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-lines/{z}/{x}/{y}.png', {maxZoom:18,opacity:0.6,pane:'overlayPane'}),
  satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution:'&copy; Esri',maxZoom:19}),
  terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {attribution:'&copy; OSM',subdomains:'abc',maxZoom:17}),
};
let currentTile = 'dark';
TILES.dark.addTo(map);
TILES.labels.addTo(map);
TILES.borders.addTo(map);
// Tint the map green for situation room aesthetic
const mapEl = document.getElementById('map');
mapEl.style.filter = 'hue-rotate(85deg) saturate(0.6) brightness(0.9) contrast(1.1)';

function setTile(t){
  map.removeLayer(TILES[currentTile]);
  if(t==='dark'){
    // Re-add borders + labels for dark mode
    if(!map.hasLayer(TILES.borders)) TILES.borders.addTo(map);
    if(!map.hasLayer(TILES.labels)) TILES.labels.addTo(map);
  } else {
    // Remove extra layers for sat/terrain (they have their own features)
    if(map.hasLayer(TILES.borders)) map.removeLayer(TILES.borders);
    if(map.hasLayer(TILES.labels)) map.removeLayer(TILES.labels);
  }
  currentTile=t;
  TILES[t].addTo(map);
  document.querySelectorAll('.tile-btn').forEach(b=>b.classList.toggle('on',b.dataset.t===t));
}
function goTo(lat,lon,z){ map.setView([lat,lon],z); }

// ════════════════════════════════════════
// MILITARY BASES
// ════════════════════════════════════════
const BASES = [
  // US
  {name:'Al Udeid AB',lat:25.117,lon:51.315,country:'us',type:'Air Base'},
  {name:'Ali Al Salem AB',lat:29.347,lon:47.521,country:'us',type:'Air Base'},
  {name:'Al Dhafra AB',lat:24.248,lon:54.548,country:'us',type:'Air Base'},
  {name:'Incirlik AB',lat:37.002,lon:35.426,country:'us',type:'Air Base'},
  {name:'RAF Mildenhall',lat:52.362,lon:0.486,country:'us',type:'Air Base'},
  {name:'Ramstein AB',lat:49.437,lon:7.600,country:'us',type:'Air Base'},
  {name:'Kadena AB',lat:26.356,lon:127.768,country:'us',type:'Air Base'},
  {name:'Yokota AB',lat:35.748,lon:139.348,country:'us',type:'Air Base'},
  {name:'Diego Garcia',lat:-7.313,lon:72.423,country:'us',type:'Naval Base'},
  {name:'Naval Base Bahrain',lat:26.218,lon:50.612,country:'us',type:'Naval Base'},
  {name:'Camp Lemonnier',lat:11.553,lon:43.159,country:'us',type:'Base'},
  {name:'Andersen AFB',lat:13.584,lon:144.930,country:'us',type:'Air Base'},
  {name:'Osan AB',lat:37.090,lon:127.030,country:'us',type:'Air Base'},
  {name:'Aviano AB',lat:46.032,lon:12.597,country:'us',type:'Air Base'},
  // Iran
  {name:'Mehrabad Air Base',lat:35.689,lon:51.314,country:'iran',type:'Air Base'},
  {name:'Isfahan Air Base',lat:32.508,lon:51.694,country:'iran',type:'Air Base'},
  {name:'Bandar Abbas Naval',lat:27.218,lon:56.362,country:'iran',type:'Naval Base'},
  {name:'Bushehr Naval',lat:28.942,lon:50.835,country:'iran',type:'Naval Base'},
  {name:'Tabriz Air Base',lat:38.133,lon:46.235,country:'iran',type:'Air Base'},
  {name:'Omidiyeh Air Base',lat:30.835,lon:49.534,country:'iran',type:'Air Base'},
  // Russia
  {name:'Hmeimim AB (Syria)',lat:35.401,lon:35.948,country:'russia',type:'Air Base'},
  {name:'Sevastopol Naval',lat:44.623,lon:33.523,country:'russia',type:'Naval Base'},
  {name:'Engelss-2 AB',lat:51.428,lon:46.177,country:'russia',type:'Air Base'},
  {name:'Kaliningrad Base',lat:54.710,lon:20.508,country:'russia',type:'Base'},
  {name:'Tartus Naval (Syria)',lat:34.893,lon:35.887,country:'russia',type:'Naval Base'},
  // China
  {name:'Sanya Naval Base',lat:18.230,lon:109.572,country:'china',type:'Naval Base'},
  {name:'Zhanjiang Naval',lat:21.182,lon:110.401,country:'china',type:'Naval Base'},
  {name:'Lingshui AF',lat:18.492,lon:110.038,country:'china',type:'Air Base'},
  {name:'Fiery Cross Reef',lat:9.549,lon:112.893,country:'china',type:'Island Base'},
  {name:'Mischief Reef',lat:9.908,lon:115.534,country:'china',type:'Island Base'},
];

const baseCols={us:'#00ff41',iran:'#ff2040',russia:'#dc2626',china:'#e5ff00'};
let baseMarkers=[];
let basesVisible=false;

// ════════════════════════════════════════
// MOBILE DRAWER
// ════════════════════════════════════════
function toggleMobDrawer(){
  const d=document.getElementById('mobDrawer');
  if(!d) return;
  d.classList.toggle('open');
  // Sync overlay button states into drawer buttons
  ['bases','missiles','nuclear','airdef','quakes','notams','gpsjam','exercises','conflicts','naval','terminator','paths','nuke'].forEach(id=>{
    const src=document.getElementById('btn-'+id);
    const dst=document.getElementById('mob-btn-'+id);
    if(src&&dst) dst.className=src.className.replace('btn-'+id,'mob-btn-'+id);
  });
}
function updateMobTypeButtons(active){
  document.querySelectorAll('[id^="mob-bt-"]').forEach(b=>b.classList.toggle('on',b.id==='mob-bt-'+active));
}

function toggleBases(){
  basesVisible=!basesVisible;
  document.getElementById('btn-bases').classList.toggle('on',basesVisible);
  if(basesVisible){
    BASES.forEach(b=>{
      const col=baseCols[b.country]||'#64748b';
      const m=L.marker([b.lat,b.lon],{
        icon:L.divIcon({html:`<div style="color:${col};font-size:14px;text-shadow:0 0 6px ${col}80">⬟</div>`,className:'',iconSize:[14,14],iconAnchor:[7,7]})
      }).bindTooltip(`${FLAGS[b.country]||'🌐'} ${b.name} (${b.type})`,{className:'dark-tooltip',direction:'top'}).addTo(map);
      baseMarkers.push(m);
    });
  } else {
    baseMarkers.forEach(m=>map.removeLayer(m));
    baseMarkers=[];
  }
}

// ════════════════════════════════════════
// COUNTRY DETECTION
// ════════════════════════════════════════
const CR = {
  us:[[0xA00000,0xAFFFFF]],
  iran:[[0x730000,0x737FFF]],
  russia:[[0x100000,0x13FFFF]],
  china:[[0x780000,0x7BFFFF]],
  uk:[[0x400000,0x43FFFF]],
  france:[[0x380000,0x3BFFFF]],
  germany:[[0x3C0000,0x3FFFFF]],
  australia:[[0x7C0000,0x7FFFFF]],
  japan:[[0x840000,0x87FFFF]],
  korea:[[0x718000,0x71FFFF]],
  israel:[[0x738000,0x73FFFF]],
  saudi:[[0x710000,0x717FFF]],
  turkey:[[0x4B0000,0x4B7FFF]],
  india:[[0x800000,0x83FFFF]],
  pakistan:[[0x760000,0x767FFF]],
  canada:[[0xC00000,0xC3FFFF]],
  italy:[[0x300000,0x33FFFF]],
  nato:[[0x480000,0x480FFF]],
  uae:[[0x896000,0x896FFF]],
};
const FLAGS={us:'🇺🇸',iran:'🇮🇷',russia:'🇷🇺',china:'🇨🇳',uk:'🇬🇧',france:'🇫🇷',germany:'🇩🇪',australia:'🇦🇺',japan:'🇯🇵',korea:'🇰🇷',israel:'🇮🇱',saudi:'🇸🇦',turkey:'🇹🇷',india:'🇮🇳',pakistan:'🇵🇰',canada:'🇨🇦',italy:'🇮🇹',nato:'🏛️',uae:'🇦🇪'};
const CNAMES={us:'United States',iran:'Iran',russia:'Russia',china:'China',uk:'United Kingdom',france:'France',germany:'Germany',australia:'Australia',japan:'Japan',korea:'South Korea',israel:'Israel',saudi:'Saudi Arabia',turkey:'Turkey',india:'India',pakistan:'Pakistan',canada:'Canada',italy:'Italy',nato:'NATO',uae:'UAE'};
const GCOL={us:'#00ff41',iran:'#ff2040',russia:'#dc2626',china:'#e5ff00',allied:'#bf5fff',unknown:'#4a6a4a'};

function getCountry(hex){
  const h=parseInt(hex,16);
  for(const[c,rs]of Object.entries(CR))for(const[lo,hi]of rs)if(h>=lo&&h<=hi)return c;
  return'unknown';
}
function getGroup(hex){const c=getCountry(hex);return(['us','iran','russia','china'].includes(c))?c:'allied';}
function getFlag(hex){return FLAGS[getCountry(hex)]||'🌐';}
function getCName(hex){return CNAMES[getCountry(hex)]||'Unknown';}
function getCol(hex){return GCOL[getGroup(hex)]||'#64748b';}

// ════════════════════════════════════════
// AIRCRAFT TYPE CLASSIFICATION
// ════════════════════════════════════════
const TYPES = {
  fighter: ['F15','F16','F18','F22','F35','FA18','EUFI','A10','AV8B','EA18','F14','F5','SU27','SU30','SU35','MIG29','MIG31','J10','J11','J16','J20','RFAL','TOR','F4','MIR'],
  transport:['C17','C130','C30J','C5','C5M','C12','C40','C37','IL76','AN124','AN12','Y20','A400','C295','C27J','C160','C145','C146','C2'],
  tanker:   ['KC10','KC46','KC135','KC130','MRTT','IL78','KC30'],
  recon:    ['P8','P3','EP3','RC135','E3','E6','E8','E2','U2','RQ4','MQ9','MQ1','MC12','E737','WC135','WC130','MC130','EC130','RQ170'],
  heli:     ['UH60','AH64','CH47','CH53','MH60','V22','MV22','CV22','MI17','MI24','MI8','MI28','HH60','SH60','AS65','NH90','UH1','AH1','H60','H47','H53'],
  bomber:   ['B52','B1','B2','B21','TU95','TU160','H6','B1B','B52H'],
  trainer:  ['T6','T38','T45','T1','BE20','PC12','C172','T7','T50','PC21','LJ35','T44','TH57']
};
const TCOL={fighter:'#f97316',transport:'#38bdf8',tanker:'#c084fc',recon:'#22d3ee',heli:'#4ade80',bomber:'#f87171',trainer:'#facc15',other:'#64748b'};
const TLAB={fighter:'Fighter/Attack',transport:'Transport',tanker:'Tanker',recon:'ISR/Patrol',heli:'Helicopter',bomber:'Bomber',trainer:'Trainer',other:'Other'};
const TICO={fighter:'✈️',transport:'🛩️',tanker:'⛽',recon:'🔍',heli:'🚁',bomber:'💣',trainer:'🎓',other:'◆'};

function classifyType(ac){
  const t=(ac.t||'').toUpperCase().replace(/[^A-Z0-9]/g,'');
  const fl=(ac.flight||'').trim().toUpperCase();
  for(const[cat,pats]of Object.entries(TYPES)){
    for(const p of pats){const pp=p.replace(/[^A-Z0-9]/g,'');if(t.includes(pp)||t.startsWith(pp))return cat;}
  }
  if(/^VIPER|^RAGE|^COBRA/.test(fl))return'fighter';
  if(/^RCH|^REACH/.test(fl))return'transport';
  if(/^ETHYL|^TEXAC/.test(fl))return'tanker';
  if(/^JAKE|^TOPCAT/.test(fl))return'recon';
  if(/^DUST|^PEDRO/.test(fl))return'heli';
  return'other';
}

// ════════════════════════════════════════
// ALERT ZONES
// ════════════════════════════════════════
const ZONES=[
  {name:'Strait of Hormuz',   bounds:[[25.5,55.5],[27.5,57.5]], color:'#ef4444', icon:'🚨'},
  {name:'Persian Gulf',       bounds:[[24,48],[30,56]],          color:'#f97316', icon:'⚠️'},
  {name:'Taiwan Strait',      bounds:[[22,117],[26,121]],        color:'#eab308', icon:'⚠️'},
  {name:'South China Sea',    bounds:[[5,108],[18,121]],         color:'#eab308', icon:'⚠️'},
  {name:'Black Sea',          bounds:[[41,27],[47,42]],          color:'#dc2626', icon:'⚠️'},
  {name:'Baltic Sea',         bounds:[[53,12],[60,30]],          color:'#8b5cf6', icon:'ℹ️'},
  {name:'Mediterranean',      bounds:[[30,10],[46,36]],          color:'#8b5cf6', icon:'ℹ️'},
  {name:'Arabian Sea',        bounds:[[10,55],[25,72]],          color:'#f97316', icon:'⚠️'},
];
ZONES.forEach(z=>{
  L.rectangle(z.bounds,{color:z.color,weight:1,fillOpacity:0.07,opacity:0.35,interactive:false}).addTo(map);
  L.marker([(z.bounds[0][0]+z.bounds[1][0])/2,(z.bounds[0][1]+z.bounds[1][1])/2],{
    icon:L.divIcon({html:`<div style="font-size:9px;color:${z.color};white-space:nowrap;text-shadow:0 0 3px #000;font-weight:700;opacity:.7">${z.name}</div>`,className:'',iconAnchor:[0,0]})
  }).addTo(map);
});

// ════════════════════════════════════════
// STATE
// ════════════════════════════════════════
let mkrs={}, acData=[], trails={}, cFilt='all', tFilt='all', searchQ='', curTab='news';

// ════════════════════════════════════════
// MARKERS + TRAILS
// ════════════════════════════════════════
// SVG paths for each aircraft type (all pointing UP = 0°, rotated by heading)
const SVG_ICONS = {
  fighter: `<polygon points="8,0 10,14 8,11 6,14" fill="COLOR" stroke="COLOR" stroke-width=".5"/>
    <polygon points="8,4 14,12 8,9 2,12" fill="COLOR" opacity=".85"/>
    <polygon points="8,9 11,16 8,14 5,16" fill="COLOR" opacity=".7"/>`,
  bomber: `<polygon points="8,0 11,10 8,8 5,10" fill="COLOR"/>
    <polygon points="8,3 16,14 8,10 0,14" fill="COLOR" opacity=".9"/>
    <polygon points="8,9 12,17 8,15 4,17" fill="COLOR" opacity=".7"/>`,
  transport: `<rect x="6" y="0" width="4" height="14" rx="2" fill="COLOR"/>
    <polygon points="8,3 16,10 8,8 0,10" fill="COLOR" opacity=".85"/>
    <polygon points="8,10 11,16 8,14 5,16" fill="COLOR" opacity=".7"/>`,
  tanker: `<rect x="6.5" y="0" width="3" height="14" rx="1.5" fill="COLOR"/>
    <polygon points="8,2 15,9 8,7 1,9" fill="COLOR" opacity=".85"/>
    <polygon points="8,9 11,15 8,13 5,15" fill="COLOR" opacity=".7"/>
    <circle cx="8" cy="0" r="1.5" fill="COLOR"/>`,
  recon: `<ellipse cx="8" cy="7" rx="3" ry="7" fill="COLOR"/>
    <polygon points="8,2 15,8 8,6 1,8" fill="COLOR" opacity=".8"/>
    <line x1="8" y1="14" x2="8" y2="17" stroke="COLOR" stroke-width="1.5"/>`,
  heli: `<ellipse cx="8" cy="9" rx="3" ry="4" fill="COLOR"/>
    <line x1="1" y1="7" x2="15" y2="7" stroke="COLOR" stroke-width="2" stroke-linecap="round"/>
    <line x1="6" y1="14" x2="12" y2="14" stroke="COLOR" stroke-width="1.5" stroke-linecap="round"/>
    <line x1="8" y1="7" x2="8" y2="14" stroke="COLOR" stroke-width="1"/>`,
  trainer: `<polygon points="8,1 10,12 8,10 6,12" fill="COLOR"/>
    <polygon points="8,4 13,10 8,8 3,10" fill="COLOR" opacity=".85"/>`,
  other: `<polygon points="8,0 10,12 8,10 6,12" fill="COLOR"/>
    <polygon points="8,3 14,11 8,8 2,11" fill="COLOR" opacity=".8"/>`,
};

function mkIcon(ac){
  const tp=classifyType(ac);
  const g=getGroup(ac.hex);
  const col=getCol(ac.hex);
  const adv=(g==='iran'||g==='russia'||g==='china');
  const rot=ac.track||0;
  const sz=adv?22:18;
  const svgPath=(SVG_ICONS[tp]||SVG_ICONS.other).replace(/COLOR/g,col);
  const glow=adv?`drop-shadow(0 0 3px ${col})`:'drop-shadow(0 0 1px #000)';
  const html=`<svg width="${sz}" height="${sz}" viewBox="0 0 16 18" style="transform:rotate(${rot}deg);filter:${glow};overflow:visible">${svgPath}</svg>`;
  return L.divIcon({html,className:'',iconSize:[sz,sz],iconAnchor:[sz/2,sz/2]});
}

function updateTrail(ac){
  if(!ac.lat||!ac.lon)return;
  if(!trails[ac.hex])trails[ac.hex]={pts:[],line:null};
  const tr=trails[ac.hex];
  const last=tr.pts[tr.pts.length-1];
  if(!last||last[0]!==ac.lat||last[1]!==ac.lon)tr.pts.push([ac.lat,ac.lon]);
  if(tr.pts.length>40)tr.pts.shift();
}
function showTrail(hex){
  hideTrails();
  const tr=trails[hex];if(!tr||tr.pts.length<2)return;
  tr.line=L.polyline(tr.pts,{color:getCol(hex),weight:2,opacity:0.55,dashArray:'5 4'}).addTo(map);
}
function hideTrails(){Object.values(trails).forEach(t=>{if(t.line){map.removeLayer(t.line);t.line=null;}})}

// ════════════════════════════════════════
// INFO PANEL
// ════════════════════════════════════════
// ════════════════════════════════════════
// AIRCRAFT CAPABILITY DATABASE
// ════════════════════════════════════════
const AC_CAPS = {
  // Fighters
  'F15':  {name:'F-15 Eagle/Strike Eagle', role:'Air Superiority / Strike Fighter', crew:'1-2', range:'~1,200 nmi', ceiling:'65,000 ft', speed:'Mach 2.5', weapons:'AIM-120 AMRAAM, AIM-9X, JDAM, SDB, AGM-84 SLAM-ER', desc:'Twin-engine air superiority fighter. Strike Eagle variant adds precision ground attack. Backbone of USAF air dominance.'},
  'F16':  {name:'F-16 Fighting Falcon', role:'Multirole Fighter', crew:'1', range:'~1,200 nmi', ceiling:'50,000 ft', speed:'Mach 2.0', weapons:'AIM-120, AIM-9X, JDAM, AGM-88 HARM, Mk-80 series bombs', desc:'Lightweight multirole fighter. High agility, large weapons load. Most widely used Western fighter.'},
  'F18':  {name:'F/A-18 Hornet/Super Hornet', role:'Carrier-Based Multirole', crew:'1-2', range:'~1,275 nmi', ceiling:'50,000 ft', speed:'Mach 1.8', weapons:'AIM-120, AIM-9X, JDAM, JSOW, LRASM, AGM-88', desc:'Carrier-based strike fighter. Super Hornet (E/F) is primary US Navy combat aircraft. Growler (EA-18G) variant provides electronic warfare.'},
  'F22':  {name:'F-22 Raptor', role:'5th Gen Air Superiority', crew:'1', range:'~1,600 nmi', ceiling:'65,000 ft', speed:'Mach 2.25 (supercruise Mach 1.8)', weapons:'AIM-120 AMRAAM, AIM-9X, JDAM, SDB (internal bays)', desc:'Stealth air dominance fighter. Supercruise capability. Most advanced air superiority platform in the world.'},
  'F35':  {name:'F-35 Lightning II', role:'5th Gen Multirole Stealth', crew:'1', range:'~1,200 nmi', ceiling:'50,000 ft', speed:'Mach 1.6', weapons:'AIM-120, AIM-9X, JDAM, SDB, GBU-53 (internal + external)', desc:'Stealth multirole fighter. Advanced sensor fusion, EOTS, DAS. A/B/C variants for USAF/Marines/Navy.'},
  // Bombers
  'B52':  {name:'B-52H Stratofortress', role:'Strategic Bomber', crew:'5', range:'~8,800 nmi', ceiling:'50,000 ft', speed:'650 mph', weapons:'JASSM-ER, ALCM, JDAM, Mk-80 series, mines, Harpoon, nuclear (AGM-86B)', desc:'Long-range heavy bomber. Can carry 70,000 lbs of ordnance. Nuclear capable. In service since 1955, expected to fly until 2050s.'},
  'B1':   {name:'B-1B Lancer', role:'Strategic/Conventional Bomber', crew:'4', range:'~5,100 nmi', ceiling:'60,000 ft', speed:'Mach 1.25', weapons:'JASSM-ER, JDAM, JSOW, Mk-84, CBU-87/97, LRASM', desc:'Supersonic variable-sweep wing bomber. Largest conventional payload in USAF. No longer nuclear-tasked.'},
  'B2':   {name:'B-2 Spirit', role:'Stealth Strategic Bomber', crew:'2', range:'~6,000 nmi', ceiling:'50,000 ft', speed:'628 mph', weapons:'B61/B83 nuclear, JDAM, GBU-57 MOP, JSOW', desc:'Flying-wing stealth bomber. Penetrating strike — can hit any target on Earth. Nuclear capable. Only 20 built.'},
  'B21':  {name:'B-21 Raider', role:'Next-Gen Stealth Bomber', crew:'2', range:'Classified (est. 5,000+ nmi)', ceiling:'Classified', speed:'Subsonic', weapons:'Nuclear & conventional (classified payload)', desc:'Next-generation stealth bomber. Designed to penetrate advanced air defenses. Nuclear capable. Replacing B-2.'},
  // Tankers
  'KC135':{name:'KC-135 Stratotanker', role:'Aerial Refueling', crew:'3', range:'~1,500 nmi (w/ cargo)', ceiling:'50,000 ft', speed:'530 mph', weapons:'None — unarmed', desc:'Primary USAF aerial refueling tanker. Can offload 200,000 lbs of fuel. Enables global power projection. Force multiplier.'},
  'KC10': {name:'KC-10 Extender', role:'Aerial Refueling / Transport', crew:'4', range:'~4,400 nmi', ceiling:'42,000 ft', speed:'619 mph', weapons:'None — unarmed', desc:'Advanced tanker/cargo aircraft. Can refuel via boom and drogue simultaneously. Carries cargo + fuel.'},
  'KC46': {name:'KC-46 Pegasus', role:'Next-Gen Aerial Refueling', crew:'3', range:'~6,385 nmi', ceiling:'43,000 ft', speed:'570 mph', weapons:'None — unarmed', desc:'Replacing KC-135. Boom + drogue. Can carry 65 passengers or 58,000 lbs cargo while tanking. Advanced vision system.'},
  // ISR
  'RC135':{name:'RC-135 Rivet Joint', role:'Signals Intelligence (SIGINT)', crew:'27-32', range:'~3,900 nmi', ceiling:'50,000 ft', speed:'500 mph', weapons:'None — unarmed', desc:'Real-time SIGINT collection. Detects, identifies, and geolocates electronic emissions. Critical in conflict zones.'},
  'E3':   {name:'E-3 Sentry (AWACS)', role:'Airborne Early Warning & Control', crew:'19-34', range:'~4,600 nmi', ceiling:'41,000 ft', speed:'530 mph', weapons:'None — unarmed', desc:'Rotating radar dome provides 360° surveillance out to 250+ nmi. Controls air battle space. Command & control platform.'},
  'E8':   {name:'E-8 JSTARS', role:'Ground Surveillance / Battle Mgmt', crew:'21-34', range:'~5,000 nmi', ceiling:'42,000 ft', speed:'587 mph', weapons:'None — unarmed', desc:'Joint Surveillance Target Attack Radar System. Tracks ground vehicles and low-flying aircraft over massive areas.'},
  'RQ4':  {name:'RQ-4 Global Hawk', role:'High-Altitude ISR (UAV)', crew:'0 (remote)', range:'~12,300 nmi', ceiling:'60,000 ft', speed:'391 mph', weapons:'None — unarmed', desc:'Unmanned high-altitude ISR. Provides persistent surveillance over vast areas. 32+ hour endurance.'},
  'MQ9':  {name:'MQ-9 Reaper', role:'Hunter-Killer UAV', crew:'0 (remote)', range:'~1,150 nmi', ceiling:'50,000 ft', speed:'300 mph', weapons:'AGM-114 Hellfire, GBU-38 JDAM, GBU-12 Paveway II', desc:'Armed remotely piloted aircraft. Persistent ISR + precision strike. Primary US drone for targeted operations.'},
  'MQ4':  {name:'MQ-4C Triton', role:'Maritime ISR (UAV)', crew:'0 (remote)', range:'~8,200 nmi', ceiling:'56,500 ft', speed:'361 mph', weapons:'None — unarmed', desc:'Navy variant of Global Hawk. Maritime surveillance. Works with P-8 Poseidon for ocean domain awareness.'},
  'P8':   {name:'P-8A Poseidon', role:'Maritime Patrol / ASW', crew:'9', range:'~1,200 nmi (patrol)', ceiling:'41,000 ft', speed:'564 mph', weapons:'Mk-54 torpedoes, Harpoon, sonobuoys, mines', desc:'Primary US Navy maritime patrol aircraft. Anti-submarine warfare, anti-surface warfare, ISR. Replaced P-3 Orion.'},
  'P3':   {name:'P-3 Orion', role:'Maritime Patrol / ASW', crew:'11', range:'~2,380 nmi', ceiling:'28,300 ft', speed:'411 mph', weapons:'Mk-46/54 torpedoes, Harpoon, mines, sonobuoys', desc:'Legacy maritime patrol. Anti-submarine warfare specialist. Being replaced by P-8 Poseidon.'},
  'EP3':  {name:'EP-3E Aries II', role:'Signals Intelligence (SIGINT)', crew:'24', range:'~2,380 nmi', ceiling:'28,300 ft', speed:'411 mph', weapons:'None — unarmed', desc:'Electronic reconnaissance aircraft. Collects signals intelligence from airborne platform. Navy SIGINT workhorse.'},
  'U2':   {name:'U-2 Dragon Lady', role:'High-Altitude Reconnaissance', crew:'1', range:'~6,090 nmi', ceiling:'70,000+ ft', speed:'475 mph', weapons:'None — unarmed', desc:'Ultra-high altitude reconnaissance. Carries multiple sensor packages. Flies above most threats. In service since 1957.'},
  'E6':   {name:'E-6B Mercury', role:'Nuclear Command & Control (TACAMO)', crew:'22', range:'~6,600 nmi', ceiling:'40,000 ft', speed:'522 mph', weapons:'None — unarmed (relays nuclear launch orders)', desc:'Airborne command post for nuclear forces. TACAMO — communications link to ballistic missile submarines. Doomsday plane.'},
  'E4':   {name:'E-4B Nightwatch', role:'National Airborne Operations Center', crew:'48-112', range:'~6,325 nmi', ceiling:'45,000 ft', speed:'602 mph', weapons:'None — unarmed', desc:'\"Doomsday plane.\" National command authority airborne HQ during nuclear war. Hardened against EMP. Presidential succession platform.'},
  // Transports
  'C17':  {name:'C-17 Globemaster III', role:'Strategic/Tactical Airlift', crew:'3', range:'~2,400 nmi (full load)', ceiling:'45,000 ft', speed:'515 mph', weapons:'None — unarmed', desc:'Can carry 170,000 lbs — tanks, troops, helicopters. Lands on short/austere runways. Primary US strategic airlifter.'},
  'C5':   {name:'C-5M Super Galaxy', role:'Strategic Airlift', crew:'7', range:'~5,524 nmi', ceiling:'35,700 ft', speed:'518 mph', weapons:'None — unarmed', desc:'Largest US military transport. Carries 280,000 lbs. Can load 2x M1 Abrams tanks. Outsize/oversize cargo specialist.'},
  'C130':  {name:'C-130 Hercules/Super Herc', role:'Tactical Airlift', crew:'5', range:'~2,050 nmi', ceiling:'33,000 ft', speed:'366 mph', weapons:'None (AC-130 variant: 105mm howitzer, 40mm cannon, 25mm GAU)', desc:'Most versatile military transport ever built. Tactical airlift, spec ops, medevac, firefighting. 70+ nations operate it.'},
  'C130J': {name:'C-130J Super Hercules', role:'Tactical Airlift', crew:'3', range:'~2,835 nmi', ceiling:'28,000 ft', speed:'417 mph', weapons:'None — unarmed', desc:'Modernized Hercules. Faster, higher, farther than legacy C-130. Glass cockpit, 6-blade props. Tactical workhorse.'},
  'C40':  {name:'C-40 Clipper', role:'VIP / Fleet Logistics', crew:'4', range:'~5,200 nmi', ceiling:'41,000 ft', speed:'530 mph', weapons:'None — unarmed', desc:'Military 737 variant. Navy fleet logistics, VIP transport. Congressional delegations (CODEL).'},
  'V22':  {name:'V-22 Osprey', role:'Tiltrotor Transport', crew:'4', range:'~879 nmi', ceiling:'25,000 ft', speed:'316 mph', weapons:'Ramp-mounted .50 cal or GAU-21', desc:'Tiltrotor — helicopter takeoff, airplane speed. Carries 24 combat troops or 20,000 lbs cargo. USMC/AFSOC primary.'},
  // Helicopters
  'H60':  {name:'H-60 Black Hawk / Seahawk', role:'Utility / ASW Helicopter', crew:'2-4', range:'~320 nmi', ceiling:'19,000 ft', speed:'183 mph', weapons:'M240 MG, Hellfire, Mk-54 torpedo (SH-60), mines', desc:'Most produced military helicopter family. Army (UH-60), Navy (MH-60R/S), AFSOC (HH-60). Multi-mission workhorse.'},
  'H47':  {name:'CH-47 Chinook', role:'Heavy-Lift Helicopter', crew:'3', range:'~400 nmi', ceiling:'20,000 ft', speed:'196 mph', weapons:'M240 MG, M134 minigun', desc:'Tandem-rotor heavy lifter. Carries 33 troops or 28,000 lbs sling load. Mountain/high altitude specialist.'},
  'AH64': {name:'AH-64 Apache', role:'Attack Helicopter', crew:'2', range:'~257 nmi', ceiling:'21,000 ft', speed:'182 mph', weapons:'M230 30mm chain gun, AGM-114 Hellfire, Hydra 70 rockets, AIM-92 Stinger', desc:'Primary US Army attack helicopter. Day/night, all-weather. Longbow radar for fire-and-forget anti-armor.'},
  // Special
  'AC130':{name:'AC-130J Ghostrider', role:'Gunship / Close Air Support', crew:'13', range:'~2,530 nmi', ceiling:'28,000 ft', speed:'300 mph', weapons:'105mm M102 howitzer, 30mm GAU-23, GBU-39 SDB, AGM-176 Griffin', desc:'Flying artillery. Loiters overhead providing devastating fire support. AFSOC special operations only.'},
};

// Match aircraft type code to capability key
function getAcCap(typeCode){
  if(!typeCode) return null;
  const t = typeCode.toUpperCase();
  // Direct match
  if(AC_CAPS[t]) return AC_CAPS[t];
  // Fuzzy match
  const mappings = [
    [/^F.?15/,'F15'],[/^F.?16/,'F16'],[/^F.?18|FA.?18|EA.?18/,'F18'],[/^F.?22/,'F22'],[/^F.?35/,'F35'],
    [/^B.?52/,'B52'],[/^B.?1B|^B.?1L/,'B1'],[/^B.?2A|^B.?2S/,'B2'],[/^B.?21/,'B21'],
    [/^KC.?135|^K35/,'KC135'],[/^KC.?10|^DC10/,'KC10'],[/^KC.?46|^K46/,'KC46'],
    [/^RC.?135|^R135/,'RC135'],[/^E.?3[A-D]?$|AWACS/,'E3'],[/^E.?8[A-C]?$/,'E8'],
    [/^RQ.?4|GLBHWK/,'RQ4'],[/^MQ.?9|REAPER/,'MQ9'],[/^MQ.?4|TRITN/,'MQ4'],
    [/^P.?8/,'P8'],[/^P.?3/,'P3'],[/^EP.?3/,'EP3'],[/^U.?2[RS]?$/,'U2'],
    [/^E.?6[AB]?$/,'E6'],[/^E.?4[AB]?$/,'E4'],
    [/^C.?17/,'C17'],[/^C.?5[AM]?$/,'C5'],[/^C.?130|^C130|^L100|^C.?30J/,'C130'],[/^C130J|C.?30J/,'C130J'],
    [/^C.?40/,'C40'],[/^V.?22|MV22|CV22/,'V22'],
    [/^UH.?60|^HH.?60|^MH.?60|^SH.?60|^S70/,'H60'],[/^CH.?47|^H47/,'H47'],[/^AH.?64/,'AH64'],
    [/^AC.?130/,'AC130'],
  ];
  for(const [rx, key] of mappings){
    if(rx.test(t)) return AC_CAPS[key];
  }
  return null;
}

function showP(ac){
  const fl=(ac.flight||'').trim();
  const tp=classifyType(ac);
  const col=getCol(ac.hex);
  document.getElementById('pTitle').innerHTML=`${getFlag(ac.hex)} ${fl||ac.hex}`;
  const alt=ac.alt_baro==='ground'?'On Ground':(ac.alt_baro?ac.alt_baro.toLocaleString()+' ft':'—');
  const spd=ac.gs?Math.round(ac.gs)+' kts':'—';
  const cap = getAcCap(ac.t);

  // Capability section (primary focus)
  let capHtml = '';
  if(cap){
    capHtml = `
    <div style="padding:8px;background:rgba(0,255,65,.04);border:1px solid rgba(0,255,65,.12);border-radius:2px;margin-bottom:8px">
      <div style="font-size:11px;font-weight:700;color:var(--accent);font-family:'Share Tech Mono',monospace;margin-bottom:3px">${cap.role}</div>
      <div style="font-size:10px;color:var(--text);margin-bottom:6px;line-height:1.4">${cap.desc}</div>
      <div class="f"><span class="k">Crew: </span><span class="v">${cap.crew}</span></div>
      <div class="f"><span class="k">Range: </span><span class="v">${cap.range}</span></div>
      <div class="f"><span class="k">Speed: </span><span class="v">${cap.speed}</span></div>
      <div class="f"><span class="k">Ceiling: </span><span class="v">${cap.ceiling}</span></div>
      <div class="f"><span class="k">Weapons: </span><span class="v" style="line-height:1.4">${cap.weapons}</span></div>
    </div>`;
  }

  document.getElementById('pBody').innerHTML=`
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
      <span style="font-size:10px;padding:2px 6px;border-radius:2px;font-weight:700;font-family:'Share Tech Mono',monospace;background:${col}18;color:${col};border:1px solid ${col}40">${TICO[tp]} ${TLAB[tp]}</span>
      <span style="font-size:10px;color:var(--muted)">${ac.t||'Unknown type'}</span>
    </div>
    ${capHtml}
    <div class="f"><span class="k">Country: </span><span class="v" style="color:${col}">${getFlag(ac.hex)} ${getCName(ac.hex)}</span></div>
    <div class="f"><span class="k">Callsign: </span><span class="v">${fl||'—'}</span></div>
    <div class="f"><span class="k">Altitude: </span><span class="v">${alt}</span></div>
    <div class="f"><span class="k">Speed: </span><span class="v">${spd}</span></div>
    <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
      <a href="https://globe.adsbexchange.com/?icao=${ac.hex}" target="_blank" style="font-size:10px;color:var(--accent);text-decoration:none;background:rgba(0,12,0,.8);padding:3px 7px;border-radius:2px;border:1px solid rgba(0,255,65,.2)">🌐 Track</a>
      <a href="https://www.planespotters.net/hex/${ac.hex}" target="_blank" style="font-size:10px;color:var(--accent);text-decoration:none;background:rgba(0,12,0,.8);padding:3px 7px;border-radius:2px;border:1px solid rgba(0,255,65,.2)">📷 Photos</a>
    </div>
  `;
  document.getElementById('infoP').classList.add('vis');
  showTrail(ac.hex);
}
function closeP(){document.getElementById('infoP').classList.remove('vis');hideTrails();}
// Close panel on map click
map.on('click', () => { if(document.getElementById('infoP').classList.contains('vis')) closeP(); });

// ════════════════════════════════════════
// FILTERS & SEARCH
// ════════════════════════════════════════
function setCF(f){
  cFilt=f;
  document.querySelectorAll('[id^="bc-"]').forEach(b=>{b.classList.remove('on','iran-on','russia-on','china-on');});
  const btn=document.getElementById('bc-'+f);
  if(f==='iran')btn.classList.add('iran-on');
  else if(f==='russia')btn.classList.add('russia-on');
  else if(f==='china')btn.classList.add('china-on');
  else btn.classList.add('on');
  render();
}
function setTF(f){
  tFilt=f;
  document.querySelectorAll('[id^="bt-"]').forEach(b=>b.classList.remove('on'));
  const el=document.getElementById('bt-'+f);if(el)el.classList.add('on');
  // Sync mobile drawer type buttons
  document.querySelectorAll('[id^="mob-bt-"]').forEach(b=>b.classList.toggle('on',b.id==='mob-bt-'+f));
  render();
}
function doSearch(){searchQ=document.getElementById('searchBox').value.toUpperCase();render();}

// ════════════════════════════════════════
// RENDER
// ════════════════════════════════════════
function passFilter(ac){
  const g=getGroup(ac.hex);
  const tp=classifyType(ac);
  if(cFilt!=='all'&&g!==cFilt)return false;
  if(tFilt!=='all'&&tp!==tFilt)return false;
  if(searchQ){
    const s=((ac.flight||'')+(ac.t||'')+(ac.hex||'')+(ac.r||'')).toUpperCase();
    if(!s.includes(searchQ))return false;
  }
  return true;
}

function inZone(ac,z){
  return ac.lat&&ac.lon&&
    ac.lat>=z.bounds[0][0]&&ac.lat<=z.bounds[1][0]&&
    ac.lon>=z.bounds[0][1]&&ac.lon<=z.bounds[1][1];
}

function render(){
  Object.values(mkrs).forEach(m=>map.removeLayer(m));
  mkrs={};

  const counts={us:0,iran:0,russia:0,china:0,allied:0};
  const typeCounts={};
  const visible=[];

  acData.forEach(ac=>{
    if(!ac.lat||!ac.lon)return;
    updateTrail(ac);
    if(!passFilter(ac))return;

    const g=getGroup(ac.hex);
    counts[g]=(counts[g]||0)+1;
    const tp=classifyType(ac);
    typeCounts[tp]=(typeCounts[tp]||0)+1;
    visible.push(ac);

    const m=L.marker([ac.lat,ac.lon],{icon:mkIcon(ac)})
      .on('click',()=>showP(ac)).addTo(map);
    const fl=(ac.flight||'').trim();
    const alt=ac.alt_baro==='ground'?'GND':(ac.alt_baro?ac.alt_baro.toLocaleString()+'ft':'?');
    m.bindTooltip(`${getFlag(ac.hex)} ${fl||ac.hex} · ${ac.t||'?'} · ${alt}`,
      {className:'dark-tooltip',direction:'top',offset:[0,-10]});
    mkrs[ac.hex]=m;
  });

  // Update ticker counts
  const total=visible.length;
  document.title=`OSINT Tracker — ${total} aircraft`;

  // Update widget counts
  document.getElementById('ac-count').textContent=total;

  // Update panels
  updateStatsPane(counts,typeCounts,total);
  updateAlertsPane(visible);
  updateActivityPane(visible);
  renderThreat(visible);
  renderAdvPanel(currentAdv);
  checkAudioAlerts(visible);
}

// ════════════════════════════════════════
// STATS PANE
// ════════════════════════════════════════
function updateStatsPane(counts,typeCounts,total){
  const countryData=[
    {key:'us',   flag:'🇺🇸',name:'US',     col:'#3b82f6'},
    {key:'iran', flag:'🇮🇷',name:'Iran',   col:'#ef4444'},
    {key:'russia',flag:'🇷🇺',name:'Russia',col:'#dc2626'},
    {key:'china',flag:'🇨🇳',name:'China',  col:'#eab308'},
    {key:'allied',flag:'🤝',name:'Allied', col:'#8b5cf6'},
  ];
  const maxC=Math.max(...countryData.map(d=>counts[d.key]||0),1);
  let ch='<div class="stat-block"><div class="sb-label">Country Breakdown</div>';
  countryData.forEach(d=>{
    const n=counts[d.key]||0;
    const w=Math.round((n/maxC)*80);
    ch+=`<div class="country-row"><div class="cr-flag">${d.flag}</div><div class="cr-name">${d.name}</div><div class="cr-bar-wrap"><div class="cr-bar" style="width:${w}px;background:${d.col}"></div></div><div class="cr-count">${n}</div></div>`;
  });
  ch+=`</div>`;

  const typeData=Object.entries(typeCounts).sort((a,b)=>b[1]-a[1]);
  const maxT=Math.max(...typeData.map(d=>d[1]),1);
  ch+='<div class="stat-block"><div class="sb-label">Type Breakdown</div>';
  typeData.forEach(([tp,n])=>{
    const w=Math.round((n/maxT)*70);
    ch+=`<div class="type-row"><div class="tr-icon">${TICO[tp]||'◆'}</div><div class="tr-name">${TLAB[tp]||tp}</div><div class="tr-bar-wrap"><div class="tr-bar" style="width:${w}px;background:${TCOL[tp]||'#64748b'}"></div></div><div class="tr-count">${n}</div></div>`;
  });
  ch+=`</div>`;

  ch+=`<div class="stat-block"><div class="sb-label">Summary</div>
    <div class="country-row"><div class="cr-flag">✈️</div><div class="cr-name">Total tracked</div><div class="cr-count" style="color:#fff;font-size:16px">${total}</div></div>
    <div class="country-row"><div class="cr-flag">⏱️</div><div class="cr-name">Refresh interval</div><div class="cr-count" style="color:#8892a8">30s</div></div>
  </div>`;

  document.getElementById('pane-stats').innerHTML=ch;
}

// ════════════════════════════════════════
// ALERTS PANE
// ════════════════════════════════════════
function updateAlertsPane(visible){
  let h='<div style="padding:8px 12px 4px;font-size:10px;color:#6b7a9e;text-transform:uppercase;letter-spacing:.5px">Live aircraft in monitored zones</div>';
  ZONES.forEach(z=>{
    const ac_in=visible.filter(ac=>inZone(ac,z));
    const hot=ac_in.length>0;
    const warm=ac_in.length===0&&visible.filter(ac=>inZone(ac,z)).length>0;
    h+=`<div class="zone-card ${hot?'hot':warm?'warm':''}">
      <div>
        <div class="zc-name">${z.icon} ${z.name}</div>
        ${hot?ac_in.slice(0,3).map(ac=>`<div style="font-size:10px;color:#6b7a9e;margin-top:2px">${getFlag(ac.hex)} ${(ac.flight||'').trim()||ac.hex} · ${ac.t||'?'}</div>`).join(''):''}
      </div>
      <div class="zc-count" style="color:${hot?z.color:'#3a4560'}">${ac_in.length}</div>
    </div>`;
  });
  document.getElementById('pane-alerts').innerHTML=h;
  const hotCount=ZONES.filter(z=>visible.filter(ac=>['iran','russia','china'].includes(getGroup(ac.hex))&&inZone(ac,z)).length>0).length;
  document.getElementById('zone-hot').textContent=hotCount+' hot';
  document.getElementById('zone-hot').style.color=hotCount>0?'#ef4444':'';
}

// ════════════════════════════════════════
// ACTIVITY PANE
// ════════════════════════════════════════
function updateActivityPane(visible){
  const sorted=[...visible].sort((a,b)=>(a.seen||999)-(b.seen||999)).slice(0,40);
  let h='<div style="padding:8px 12px 4px;font-size:10px;color:#6b7a9e;text-transform:uppercase;letter-spacing:.5px">Most recently seen</div>';
  sorted.forEach(ac=>{
    const fl=(ac.flight||'').trim()||ac.hex;
    const alt=ac.alt_baro==='ground'?'GND':(ac.alt_baro?Math.round(ac.alt_baro/100)/10+'kft':'?');
    const spd=ac.gs?Math.round(ac.gs)+'kt':'—';
    const col=getCol(ac.hex);
    h+=`<div class="feed-item" onclick="map.setView([${ac.lat},${ac.lon}],9);showP(acData.find(a=>a.hex==='${ac.hex}'))" style="cursor:pointer">
      <span class="fi-flag" style="color:${col}">${getFlag(ac.hex)}</span>
      <span class="fi-call" style="color:${col}">${fl}</span>
      <span class="fi-type">${ac.t||'?'}</span>
      <span class="fi-alt">${alt} ${spd}</span>
    </div>`;
  });
  document.getElementById('pane-activity').innerHTML=h;
}

// no-op: tabs replaced by widget grid
function switchTab(t){ curTab=t; }

// ════════════════════════════════════════
// NEWS / INTEL FEED
// ════════════════════════════════════════
const NEWS_SOURCES=[
  {name:'Defense News',  url:'https://www.defensenews.com/arc/outboundfeeds/rss/',       label:'DEFNEWS'},
  {name:'Military Times', url:'https://www.militarytimes.com/arc/outboundfeeds/rss/',    label:'MIL TIMES'},
  {name:'BBC Middle East',url:'https://feeds.bbci.co.uk/news/world/middle_east/rss.xml', label:'BBC ME'},
  {name:'BBC World',      url:'https://feeds.bbci.co.uk/news/world/rss.xml',             label:'BBC'},
  {name:'C4ISRNET',       url:'https://www.c4isrnet.com/arc/outboundfeeds/rss/',         label:'C4ISR'},
  {name:'Defense Daily',  url:'https://www.defensedaily.com/feed/',                      label:'DEF DAILY'},
  {name:'Task & Purpose', url:'https://taskandpurpose.com/feed/',                        label:'T&PURPOSE'},
];

let allNews=[];

async function fetchRSS(src){
  try{
    // rss2json returns clean JSON — no XML parsing needed, no CORS issues
    // Note: count param requires paid key — free tier returns ~10 items by default
    const api='https://api.rss2json.com/v1/api.json?rss_url='+encodeURIComponent(src.url);
    const r=await fetch(api,{signal:AbortSignal.timeout(10000)});
    const d=await r.json();
    if(d.status!=='ok'||!d.items) return [];
    return d.items.map(i=>({
      source:src.label,
      title:(i.title||'').replace(/<[^>]+>/g,'').trim(),
      link:i.link||'#',
      date:new Date(i.pubDate||Date.now()),
    })).filter(n=>n.title);
  }catch(e){return[];}
}

async function fetchAllNews(){
  const results=await Promise.allSettled(NEWS_SOURCES.map(s=>fetchRSS(s)));
  const items=results.flatMap(r=>r.status==='fulfilled'?r.value:[]);
  items.sort((a,b)=>b.date-a.date);
  allNews=items;
  renderNews(items);
  updateTicker(items);
}

// Military keywords for highlighting
const MIL_KEYWORDS=['military','missile','strike','iran','russia','china','nato','navy','airforce','army','nuclear','drone','warship','attack','defense','conflict','troops','weapons','sanction','war','bomb','radar','satellite','intercept'];

function isAlert(title){
  const t=title.toLowerCase();
  return MIL_KEYWORDS.some(k=>t.includes(k));
}

function renderNews(items){
  const strip = document.getElementById('newsStrip');
  if(!items.length){
    strip.innerHTML='<div style="padding:20px;color:#6b7a9e;font-size:12px">Loading intel feed...</div>';
    return;
  }
  let h='';
  items.forEach(n=>{
    const alert=isAlert(n.title);
    const ago=getTimeAgo(n.date);
    h+=`<a href="${n.link}" target="_blank" rel="noopener" style="text-decoration:none">
      <div class="news-card ${alert?'alert':''}">
        <div class="nc-src">${alert?'🔴 ':''} ${n.source}</div>
        <div class="nc-title">${n.title}</div>
        <div class="nc-meta">${ago}</div>
      </div>
    </a>`;
  });
  strip.innerHTML=h;
}

function getTimeAgo(date){
  const mins=Math.round((Date.now()-date)/60000);
  if(mins<60)return`${mins}m ago`;
  const hrs=Math.round(mins/60);
  if(hrs<24)return`${hrs}h ago`;
  return`${Math.round(hrs/24)}d ago`;
}

// ════════════════════════════════════════
// TICKER
// ════════════════════════════════════════
function updateTicker(news){
  // Ticker removed — news now in strip. No-op.
}

// ════════════════════════════════════════
// AIRCRAFT FETCH
// ════════════════════════════════════════
const AC_URLS=[
  // working CORS proxies first
  'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent('https://api.adsb.lol/v2/mil'),
  'https://r.jina.ai/http://api.adsb.lol/v2/mil',
  // direct + fallback proxies
  'https://api.adsb.lol/v2/mil',
  'https://corsproxy.io/?url=https://api.adsb.lol/v2/mil',
  'https://api.allorigins.win/raw?url='+encodeURIComponent('https://api.adsb.lol/v2/mil'),
];

async function fetchData(){
  for(const url of AC_URLS){
    try{
      const r=await fetch(url,{signal:AbortSignal.timeout(10000)});
      if(!r.ok)throw new Error(r.status);
      const d=await r.json();
      acData=d.ac||[];
      render();
      document.getElementById('loadOv').style.display='none';
      // Flash topbar on new data
      const tb=document.querySelector('.topbar');
      if(tb){tb.classList.remove('data-flash');void tb.offsetWidth;tb.classList.add('data-flash');}
      playTone('data');
      return;
    }catch(e){console.warn('AC fetch fail',url,e.message);}
  }
  document.getElementById('loadOv').style.display='none';
}

// ════════════════════════════════════════
// NOTIFICATIONS
// ════════════════════════════════════════
let notifEnabled = false;
let prevZoneSets = {}; // zone -> Set of hex ids

function toggleNotifications(){
  if(!notifEnabled){
    Notification.requestPermission().then(p=>{
      if(p==='granted'){
        notifEnabled=true;
        document.getElementById('btn-notif').classList.add('on');
        document.getElementById('btn-notif').textContent='🔔 Alerts ON';
        new Notification('OSINT Tracker', {body:'Zone alerts enabled. You\'ll be notified when adversary aircraft enter monitored zones.'});
      }
    });
  } else {
    notifEnabled=false;
    document.getElementById('btn-notif').classList.remove('on');
    document.getElementById('btn-notif').textContent='🔔 Alerts';
  }
}

function checkZoneAlerts(visible){
  if(!notifEnabled) return;
  const adversary=['iran','russia','china'];
  ZONES.forEach(z=>{
    const key=z.name;
    const current=new Set(
      visible.filter(ac=>adversary.includes(getGroup(ac.hex))&&inZone(ac,z)).map(ac=>ac.hex)
    );
    const prev=prevZoneSets[key]||new Set();
    current.forEach(hex=>{
      if(!prev.has(hex)){
        const ac=acData.find(a=>a.hex===hex);
        const fl=(ac?.flight||'').trim()||hex;
        new Notification(`⚠️ ${z.name}`, {
          body:`${getFlag(hex)} ${fl} (${ac?.t||'?'}) entered ${z.name}`,
          icon:'https://rpike623.github.io/mil-tracker/favicon.ico'
        });
      }
    });
    prevZoneSets[key]=current;
  });
}

// ════════════════════════════════════════
// EVENT LOG
// ════════════════════════════════════════
const eventLog = [];
let prevAcSet = new Set();

function updateEventLog(visible){
  const currentSet = new Set(visible.map(ac=>ac.hex));
  const adversary = ['iran','russia','china'];

  // New adversary detections
  visible.forEach(ac=>{
    if(adversary.includes(getGroup(ac.hex)) && !prevAcSet.has(ac.hex)){
      const fl=(ac.flight||'').trim()||ac.hex;
      eventLog.unshift({
        time: new Date(),
        type: 'new',
        msg: `${getFlag(ac.hex)} NEW: ${fl} (${ac.t||'?'}) detected`,
        col: getCol(ac.hex),
      });
    }
  });

  // Zone entries
  ZONES.forEach(z=>{
    const inNow = visible.filter(ac=>adversary.includes(getGroup(ac.hex))&&inZone(ac,z));
    inNow.forEach(ac=>{
      if(!prevAcSet.has(ac.hex)){
        const fl=(ac.flight||'').trim()||ac.hex;
        eventLog.unshift({
          time: new Date(),
          type: 'zone',
          msg: `${getFlag(ac.hex)} ZONE: ${fl} in ${z.name}`,
          col: z.color,
        });
      }
    });
  });

  if(eventLog.length > 200) eventLog.splice(200);
  prevAcSet = currentSet;
  renderEventLog();
  document.getElementById('log-count').textContent=eventLog.length;
}

function renderEventLog(){
  if(!eventLog.length){
    document.getElementById('pane-log').innerHTML='<div style="padding:20px;color:#6b7a9e;font-size:12px;text-align:center">No events yet.<br>Adversary aircraft detections and zone entries will appear here.</div>';
    return;
  }
  let h='<div style="padding:8px 12px 4px;font-size:10px;color:#6b7a9e;text-transform:uppercase;letter-spacing:.5px">Adversary detection log</div>';
  eventLog.slice(0,60).forEach(e=>{
    const ts=e.time.toLocaleTimeString();
    h+=`<div class="feed-item">
      <span style="color:${e.col};font-size:10px;min-width:55px">${ts}</span>
      <span style="font-size:11px;color:${e.col}">${e.msg}</span>
    </div>`;
  });
  document.getElementById('pane-log').innerHTML=h;
}

// ════════════════════════════════════════
// PATCH RENDER TO INCLUDE NEW FEATURES
// ════════════════════════════════════════
// Override render to also run notifications + log
const _render = render;
render = function(){
  _render();
  // Get visible aircraft for post-render hooks
  const visible = acData.filter(ac=>ac.lat&&ac.lon&&passFilter(ac));
  checkZoneAlerts(visible);
  updateEventLog(visible);
};

// switchTab is now a no-op (widget grid replaces tabs)
function switchActTab(t){
  document.getElementById("pane-activity").style.display=t==="activity"?"block":"none";
  document.getElementById("pane-log").style.display=t==="log"?"block":"none";
  const aTab=document.getElementById("act-tab-activity");
  const lTab=document.getElementById("act-tab-log");
  aTab.style.color=t==="activity"?"rgba(0,212,255,.7)":"var(--muted)";
  aTab.style.borderBottom=t==="activity"?"2px solid rgba(0,212,255,.6)":"2px solid transparent";
  lTab.style.color=t==="log"?"rgba(0,212,255,.7)":"var(--muted)";
  lTab.style.borderBottom=t==="log"?"2px solid rgba(0,212,255,.6)":"2px solid transparent";
}

// ════════════════════════════════════════
// POLYMARKET
// ════════════════════════════════════════
async function fetchPolymarket(){
  const strip = document.getElementById('polyStrip');
  if(!strip) return;
  const queries = ['war military strike','Iran nuclear attack','Russia China Taiwan conflict','missile nuclear weapon'];
  const seen = new Set(); const allMarkets = [];
  for(const q of queries){
    try{
      const url = 'https://gamma-api.polymarket.com/markets?limit=12&active=true&closed=false&order=volume24hr&ascending=false&q='+encodeURIComponent(q);
      const proxied = 'https://corsproxy.io/?url='+encodeURIComponent(url);
      const r = await fetch(proxied,{signal:AbortSignal.timeout(8000)});
      if(!r.ok) continue;
      const data = await r.json();
      if(!Array.isArray(data)) continue;
      data.forEach(m=>{if(!seen.has(m.id)&&!m.closed&&m.active){seen.add(m.id);allMarkets.push(m);}});
    }catch(e){}
  }
  const KW=['strike','nuclear','war','attack','military','missile','iran','russia','china','conflict','invasion','ceasefire','troops','weapon','nato','ukraine','taiwan','bomb','coup','sanctions'];
  const filtered=allMarkets.filter(m=>KW.some(k=>(m.question||'').toLowerCase().includes(k))).sort((a,b)=>(b.volumeNum||0)-(a.volumeNum||0)).slice(0,20);
  if(!filtered.length){strip.innerHTML='<div style="padding:16px;color:#6b7a9e;font-size:11px;align-self:center">No active military markets found</div>';return;}
  let h='';
  filtered.forEach(m=>{
    let pct=0;
    try{const pr=JSON.parse(m.outcomePrices||'[]');const ou=JSON.parse(m.outcomes||'[]');const yi=ou.findIndex(o=>o.toLowerCase()==='yes');pct=Math.round(parseFloat(pr[yi>=0?yi:0]||0)*100);}catch(e){}
    const col=pct>=60?'#ef4444':pct>=35?'#f97316':pct>=15?'#eab308':'#22c55e';
    const vol=m.volumeNum>=1000000?'$'+(m.volumeNum/1000000).toFixed(1)+'M':m.volumeNum>=1000?'$'+(m.volumeNum/1000).toFixed(0)+'K':'$'+Math.round(m.volumeNum||0);
    const url='https://polymarket.com/event/'+(m.slug||m.id);
    h+=`<a class="poly-card" href="${url}" target="_blank" rel="noopener"><div class="pc-q">${m.question}</div><div><div class="pc-odds"><span class="pc-yes" style="color:${col}">${pct}%</span><span class="pc-label">YES</span></div><div class="pc-bar"><div class="pc-fill" style="width:${pct}%;background:${col}"></div></div><div class="pc-vol" style="margin-top:3px">${vol} vol</div></div></a>`;
  });
  strip.innerHTML=h;
  const el=document.getElementById('poly-updated');if(el)el.textContent='Updated '+new Date().toLocaleTimeString();
}

// ════════════════════════════════════════
// INIT
// ════════════════════════════════════════

// ════════════════════════════════════════
// X / OSINT ACCOUNTS FEED
// ════════════════════════════════════════
// ════════════════════════════════════════
// OSINT FEED (RSS-based — nitter/X RSS is dead)
// ════════════════════════════════════════
const OSINT_FEEDS = [
  { id:'warzone',   label:'The War Zone',    url:'https://www.thedrive.com/the-war-zone/feed' },
  { id:'defnews',   label:'Defense News',    url:'https://www.defensenews.com/arc/outboundfeeds/rss/' },
  { id:'breakdef',  label:'Breaking Defense', url:'https://breakingdefense.com/feed/' },
  { id:'naval',     label:'Naval News',      url:'https://www.navalnews.com/feed/' },
];

let osintCurrentFeed = OSINT_FEEDS[0].id;
let osintCache = {};

function buildXTabs(){
  const tabsEl = document.getElementById('x-account-tabs');
  if(!tabsEl) return;
  tabsEl.innerHTML = OSINT_FEEDS.map(a =>
    `<span class="x-tab${a.id===osintCurrentFeed?' on':''}" onclick="switchXAccount('${a.id}')">${a.label}</span>`
  ).join('');
}

function switchXAccount(id){
  osintCurrentFeed = id;
  buildXTabs();
  if(osintCache[id]) renderXFeed(id, osintCache[id]);
  else fetchOsintFeed(id);
}

async function fetchOsintFeed(id){
  const feed = document.getElementById('xFeed');
  const src = OSINT_FEEDS.find(f=>f.id===id);
  if(!src) return;
  if(!osintCache[id] && id === osintCurrentFeed && feed) feed.innerHTML = `<div style="padding:12px;color:var(--muted);font-size:11px">Loading ${src.label}...</div>`;

  const proxies = [
    'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(src.url),
    'https://api.allorigins.win/raw?url='+encodeURIComponent(src.url),
  ];

  for(const proxied of proxies){
    try {
      const ac = new AbortController();
      const tid = setTimeout(()=>ac.abort(), 10000);
      const r = await fetch(proxied, { signal: ac.signal });
      clearTimeout(tid);
      if(!r.ok) continue;
      const txt = await r.text();
      const doc = new DOMParser().parseFromString(txt, 'text/xml');
      const posts = [...doc.querySelectorAll('item')].slice(0,15).map(i => ({
        text: (i.querySelector('title')?.textContent || '').replace(/<!\[CDATA\[|]]>/g,'').trim(),
        link: (i.querySelector('link')?.textContent || '#').trim(),
        date: new Date(i.querySelector('pubDate')?.textContent || Date.now()),
        desc: (i.querySelector('description')?.textContent || '').replace(/<[^>]*>/g,'').slice(0,120).trim(),
      })).filter(p => p.text);
      if(posts.length){
        osintCache[id] = posts;
        if(id === osintCurrentFeed) renderXFeed(id, posts);
        return;
      }
    } catch(e) { /* try next proxy */ }
  }

  if(id === osintCurrentFeed && feed)
    feed.innerHTML = `<div style="padding:12px;color:var(--muted);font-size:11px">Could not load ${src.label}</div>`;
}

function renderXFeed(id, posts){
  if(id !== osintCurrentFeed) return;
  const feed = document.getElementById('xFeed');
  if(!feed) return;
  if(!posts.length){ feed.innerHTML = '<div style="padding:12px;color:var(--muted);font-size:11px">No posts</div>'; return; }
  const src = OSINT_FEEDS.find(f=>f.id===id);
  feed.innerHTML = posts.map(p => {
    const ago = getTimeAgo(p.date);
    return `<div class="x-post" onclick="window.open('${p.link}','_blank')">
      <div class="xp-meta"><span class="xp-handle">${src?.label||id}</span><span style="margin-left:auto">${ago}</span></div>
      <div class="xp-text">${p.text}</div>
      ${p.desc ? `<div style="color:var(--muted);font-size:10px;margin-top:3px;line-height:1.3">${p.desc}</div>` : ''}
    </div>`;
  }).join('');
}

function initXFeed(){
  buildXTabs();
  fetchOsintFeed(osintCurrentFeed);
  setTimeout(() => {
    OSINT_FEEDS.filter(a => a.id !== osintCurrentFeed).forEach((a,i) => {
      setTimeout(() => fetchOsintFeed(a.id), i * 1500);
    });
  }, 2000);
}

// ════════════════════════════════════════
// THREAT INDICATOR ENGINE
// ════════════════════════════════════════
// Scores observable signals to estimate likelihood of imminent military action

const THREAT_SIGNALS = [
  // Aircraft-based signals
  { id:'tanker_density',  label:'Aerial refueling activity',       weight:15, desc:'High tanker count = extended range ops being prepped' },
  { id:'isr_density',     label:'ISR/Recon concentration',         weight:20, desc:'Surge in recon = active target acquisition' },
  { id:'adversary_active',label:'Adversary aircraft airborne',     weight:25, desc:'Iran/Russia/China military flights visible' },
  { id:'bomber_activity', label:'Strategic bomber flights',        weight:30, desc:'B-52/B-1/TU-95/H-6 airborne = escalation signal' },
  { id:'zone_intrusion',  label:'Aircraft in alert zones',         weight:20, desc:'Flights in Hormuz/Taiwan Strait/etc.' },
  { id:'transport_surge', label:'Airlift surge (C-17/C-130)',      weight:10, desc:'Rapid troop/equipment movement' },
  { id:'electronic_ops',  label:'EA/EW aircraft active',           weight:15, desc:'Electronic attack = pre-strike jamming prep' },
];

let threatHistory = []; // rolling scores for trend

function computeThreat(visible){
  let score = 0;
  const signals = [];
  const adversary = ['iran','russia','china'];

  const tankers    = visible.filter(ac => classifyType(ac) === 'tanker').length;
  const isr        = visible.filter(ac => classifyType(ac) === 'recon').length;
  const advActive  = visible.filter(ac => adversary.includes(getGroup(ac.hex))).length;
  const bombers    = visible.filter(ac => classifyType(ac) === 'bomber').length;
  const transports = visible.filter(ac => classifyType(ac) === 'transport').length;
  const ea         = visible.filter(ac => (ac.t||'').toUpperCase().match(/^EA|^EC|^EF|^EP/)).length;
  const inZones    = ZONES.reduce((sum, z) => sum + visible.filter(ac => inZone(ac, z)).length, 0);

  const checks = [
    { id:'tanker_density',   active: tankers >= 3,   value: Math.min(tankers, 10),   max: 10 },
    { id:'isr_density',      active: isr >= 2,        value: Math.min(isr, 8),        max: 8  },
    { id:'adversary_active', active: advActive >= 1,  value: Math.min(advActive, 6),  max: 6  },
    { id:'bomber_activity',  active: bombers >= 1,    value: Math.min(bombers, 4),    max: 4  },
    { id:'zone_intrusion',   active: inZones >= 1,    value: Math.min(inZones, 8),    max: 8  },
    { id:'transport_surge',  active: transports >= 8, value: Math.min(transports,20), max: 20 },
    { id:'electronic_ops',   active: ea >= 1,         value: Math.min(ea, 5),         max: 5  },
  ];

  checks.forEach(c => {
    const sig = THREAT_SIGNALS.find(s => s.id === c.id);
    if(!sig) return;
    const contrib = c.active ? Math.round((c.value / c.max) * sig.weight) : 0;
    score += contrib;
    signals.push({ ...sig, active: c.active, contrib, raw: c.value });
  });

  // Normalize to 0-100
  const maxPossible = THREAT_SIGNALS.reduce((s,sig) => s + sig.weight, 0);
  const pct = Math.min(100, Math.round((score / maxPossible) * 100));

  threatHistory.push({ t: Date.now(), pct });
  if(threatHistory.length > 20) threatHistory.shift();

  return { pct, signals, tankers, isr, advActive, bombers };
}

function threatColor(pct){
  if(pct >= 70) return '#ef4444';
  if(pct >= 45) return '#f97316';
  if(pct >= 25) return '#eab308';
  return '#22c55e';
}
function threatLabel(pct){
  if(pct >= 70) return 'HIGH';
  if(pct >= 45) return 'ELEVATED';
  if(pct >= 25) return 'GUARDED';
  return 'LOW';
}

function renderThreat(visible){
  const { pct, signals, tankers, isr, advActive, bombers } = computeThreat(visible);
  const col = threatColor(pct);
  const lbl = threatLabel(pct);

  // Map threat pct to DEFCON level (5=lowest, 1=highest)
  const defcon = pct >= 80 ? 1 : pct >= 60 ? 2 : pct >= 40 ? 3 : pct >= 20 ? 4 : 5;
  const defconLabels = {5:'NORMAL READINESS',4:'INCREASED INTEL',3:'ELEVATED FORCE POSTURE',2:'HIGH ALERT',1:'MAXIMUM READINESS'};

  // Update header badge
  const badge = document.getElementById('threat-level');
  if(badge){ badge.textContent = `DEFCON ${defcon}`; badge.style.color = col; badge.style.borderColor = col; }

  // Trend
  const prev = threatHistory.length >= 2 ? threatHistory[threatHistory.length-2].pct : pct;
  const trend = pct > prev + 3 ? '▲ RISING' : pct < prev - 3 ? '▼ DECLINING' : '► STABLE';
  const trendCol = pct > prev + 3 ? '#ef4444' : pct < prev - 3 ? '#22c55e' : 'var(--muted)';

  let h = '';

  // DEFCON meter
  h += `<div style="padding:10px 12px 6px">
    <div class="defcon-meter">
      <div class="defcon-level defcon-5 ${defcon===5?'active':''}">5</div>
      <div class="defcon-level defcon-4 ${defcon===4?'active':''}">4</div>
      <div class="defcon-level defcon-3 ${defcon===3?'active':''}">3</div>
      <div class="defcon-level defcon-2 ${defcon===2?'active':''}">2</div>
      <div class="defcon-level defcon-1 ${defcon===1?'active':''}">1</div>
    </div>
    <div style="text-align:center;margin:4px 0">
      <div style="font-size:11px;font-weight:700;color:${col};font-family:'Orbitron',monospace;letter-spacing:2px">${defconLabels[defcon]}</div>
      <div style="font-size:10px;color:${trendCol};margin-top:2px;font-family:'Share Tech Mono',monospace">${trend}</div>
    </div>
    <div style="height:4px;background:rgba(0,255,65,.06);border-radius:2px;overflow:hidden;margin-top:6px">
      <div style="height:100%;width:${pct}%;background:${col};border-radius:2px;transition:width .5s"></div>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:3px;font-size:9px;color:var(--muted);font-family:'Share Tech Mono',monospace">
      <span>THREAT INDEX: ${pct}/100</span>
      <span>${acData.filter(ac=>ac.lat).length} TRACKED</span>
    </div>
  </div>`;

  // Signal breakdown
  h += `<div class="rp-section">📡 SIGNAL BREAKDOWN</div>`;
  signals.sort((a,b) => b.contrib - a.contrib).forEach(s => {
    const sigCol = s.active ? (s.contrib >= 15 ? '#ef4444' : s.contrib >= 8 ? '#f97316' : '#eab308') : 'var(--muted)';
    const barW = s.active ? Math.min(s.contrib * 5, 100) : 0;
    h += `<div class="threat-row" style="padding:5px 12px">
      <div style="flex:1">
        <span class="tr-label">${s.active?'🔴':'⚫'} ${s.label}</span>
        <div class="threat-bar"><div class="threat-bar-fill" style="width:${barW}%;background:${sigCol}"></div></div>
      </div>
      <span class="tr-value" style="color:${sigCol};min-width:30px;text-align:right">${s.active ? '+'+s.contrib : '—'}</span>
    </div>`;
  });

  // Quick stats
  h += `<div style="padding:8px 12px;font-size:10px;display:grid;grid-template-columns:1fr 1fr;gap:4px;border-top:1px solid rgba(0,255,65,.06)">
    <span style="color:var(--accent)">⛽ ${tankers} TANKERS</span>
    <span style="color:var(--accent)">🔍 ${isr} ISR</span>
    <span style="color:${advActive>0?'#ef4444':'var(--muted)'}">⚔️ ${advActive} ADVERSARY</span>
    <span style="color:${bombers>0?'#f97316':'var(--muted)'}">💣 ${bombers} BOMBERS</span>
  </div>`;

  const pane = document.getElementById('pane-threat');
  if(pane) pane.innerHTML = h;
}

// ════════════════════════════════════════
// MISSILE RANGES
// ════════════════════════════════════════
const MISSILE_SYSTEMS = [
  // Iran
  { name:'Shahab-3 MRBM (Iran)', lat:35.7, lon:51.4, radiusKm:1300, color:'#ef4444', country:'iran' },
  { name:'Khorramshahr IRBM (Iran)', lat:35.7, lon:51.4, radiusKm:2000, color:'#dc2626', country:'iran' },
  { name:'Qadr ICBM-class (Iran)', lat:35.7, lon:51.4, radiusKm:3000, color:'#b91c1c', country:'iran' },
  // Russia
  { name:'RS-28 Sarmat ICBM (Russia)', lat:52.0, lon:37.0, radiusKm:18000, color:'#f97316', country:'russia' },
  { name:'Iskander SRBM (Russia/Syria)', lat:35.4, lon:35.9, radiusKm:500, color:'#fb923c', country:'russia' },
  { name:'Kinzhal hypersonic (Russia)', lat:52.0, lon:37.0, radiusKm:2000, color:'#f97316', country:'russia' },
  // China
  { name:'DF-41 ICBM (China)', lat:35.0, lon:104.0, radiusKm:14000, color:'#eab308', country:'china' },
  { name:'DF-21D ASBM (China)', lat:35.0, lon:104.0, radiusKm:1800, color:'#ca8a04', country:'china' },
  { name:'DF-17 Hypersonic (China)', lat:35.0, lon:104.0, radiusKm:2000, color:'#eab308', country:'china' },
];

let missileVisible = false;
let missileLayers = [];

function toggleMissiles(){
  missileVisible = !missileVisible;
  document.getElementById('btn-missiles').classList.toggle('on', missileVisible);
  if(missileVisible){
    MISSILE_SYSTEMS.forEach(m => {
      // Convert km radius to meters for Leaflet circle
      const circle = L.circle([m.lat, m.lon], {
        radius: m.radiusKm * 1000,
        color: m.color, weight: 1, fillColor: m.color, fillOpacity: 0.04, opacity: 0.5,
        interactive: false, dashArray: '6 4'
      }).addTo(map);
      const label = L.marker([m.lat, m.lon], {
        icon: L.divIcon({
          html: `<div style="color:${m.color};font-size:13px;text-shadow:0 0 5px #000">🚀</div>`,
          className:'', iconSize:[13,13], iconAnchor:[6,6]
        })
      }).bindTooltip(`${m.name}<br>${m.radiusKm.toLocaleString()} km range`, {className:'dark-tooltip', direction:'top'}).addTo(map);
      missileLayers.push(circle, label);
    });
  } else {
    missileLayers.forEach(l => map.removeLayer(l));
    missileLayers = [];
  }
}

// ════════════════════════════════════════
// NUCLEAR / WMD SITES
// ════════════════════════════════════════
const NUCLEAR_SITES = [
  // Iran
  { name:'Fordow FEP', lat:34.885, lon:50.996, country:'iran', type:'Enrichment', risk:'HIGH',
    desc:'Underground enrichment facility near Qom. Buried in mountain for protection. Enriching up to 60% U-235. Under IAEA monitoring with gaps.'},
  { name:'Natanz FEP', lat:33.725, lon:51.727, country:'iran', type:'Enrichment', risk:'HIGH',
    desc:'Primary enrichment facility. Thousands of centrifuges. Target of Stuxnet cyberattack (2010) and Israeli sabotage (2021).'},
  { name:'Isfahan UCF', lat:32.625, lon:51.671, country:'iran', type:'Conversion', risk:'MED',
    desc:'Uranium conversion facility. Converts yellowcake to UF6 gas for centrifuge enrichment.'},
  { name:'Arak IR-40', lat:34.144, lon:49.230, country:'iran', type:'Reactor', risk:'MED',
    desc:'Heavy water reactor (redesigned under JCPOA). Original design could produce weapons-grade plutonium.'},
  { name:'Bushehr NPP', lat:28.829, lon:50.888, country:'iran', type:'Reactor', risk:'LOW',
    desc:'Russian-built civilian power reactor. 1GW output. Under IAEA safeguards. Low proliferation risk.'},
  { name:'Parchin Military Complex', lat:35.522, lon:51.773, country:'iran', type:'Suspected WMD', risk:'HIGH',
    desc:'Military site suspected of nuclear weapons development testing. IAEA has requested access multiple times.'},
  // DPRK
  { name:'Yongbyon Nuclear Complex', lat:39.800, lon:125.755, country:'china', type:'Weapons Production', risk:'HIGH',
    desc:'North Korea\'s primary nuclear facility. 5MW reactor produces plutonium. Enrichment facility also on-site. Has produced material for 40-60 warheads.'},
  { name:'Punggye-ri Test Site', lat:41.277, lon:129.087, country:'china', type:'Nuclear Test', risk:'HIGH',
    desc:'North Korea\'s underground nuclear test site. 6 tests conducted (2006-2017). Tunnels reportedly collapsed/sealed but new excavation observed.'},
  { name:'Sanum-dong', lat:39.040, lon:125.740, country:'china', type:'ICBM Assembly', risk:'HIGH',
    desc:'Missile research and assembly facility near Pyongyang. Where Hwasong-17/18 ICBMs are assembled and tested.'},
  // Russia
  { name:'Sarov (Arzamas-16)', lat:54.931, lon:43.321, country:'russia', type:'Weapons Lab', risk:'HIGH',
    desc:'Russia\'s primary nuclear weapons design laboratory. Equivalent to US Los Alamos. Closed city.'},
  { name:'Seversk (Tomsk-7)', lat:56.585, lon:84.869, country:'russia', type:'Enrichment/Production', risk:'HIGH',
    desc:'Major enrichment and plutonium production complex. One of the largest nuclear facilities in Russia.'},
  { name:'Zheleznogorsk (Krasnoyarsk-26)', lat:56.249, lon:93.529, country:'russia', type:'Plutonium Production', risk:'HIGH',
    desc:'Underground plutonium production reactors and reprocessing plant built into mountain.'},
  { name:'Novaya Zemlya', lat:73.370, lon:54.980, country:'russia', type:'Nuclear Test Site', risk:'HIGH',
    desc:'Russia\'s nuclear weapons test archipelago. Tsar Bomba (50MT) detonated here. Monitoring continues for potential test readiness.'},
  { name:'Plesetsk Cosmodrome', lat:62.925, lon:40.577, country:'russia', type:'ICBM Launch', risk:'HIGH',
    desc:'Primary Russian ICBM test launch site. Tests RS-28 Sarmat and other strategic missiles.'},
  // China
  { name:'Lop Nor', lat:40.710, lon:88.322, country:'china', type:'Nuclear Test Site', risk:'HIGH',
    desc:'China\'s nuclear weapons test site. 45 tests conducted (1964-1996). Now used for subcritical experiments.'},
  { name:'Jiuquan', lat:40.960, lon:100.288, country:'china', type:'Launch/Production', risk:'HIGH',
    desc:'Satellite launch center and nearby nuclear fuel cycle facilities. DF-41 ICBM tested from this region.'},
  { name:'China Academy of Engineering Physics', lat:31.489, lon:104.768, country:'china', type:'Weapons Lab', risk:'HIGH',
    desc:'China\'s primary nuclear warhead design facility in Mianyang, Sichuan. Equivalent to US Los Alamos.'},
  { name:'Lanzhou Gaseous Diffusion', lat:36.086, lon:103.830, country:'china', type:'Enrichment', risk:'MED',
    desc:'Uranium enrichment plant. Part of China\'s expanding enrichment capacity for both civilian and military use.'},
  // Ukraine (conflict relevant)
  { name:'Zaporizhzhia NPP', lat:47.507, lon:34.585, country:'russia', type:'Reactor (Occupied)', risk:'HIGH',
    desc:'Largest nuclear plant in Europe (6 reactors). Under Russian military occupation since Mar 2022. Ongoing shelling risks. IAEA monitoring present.'},
  { name:'Chernobyl Exclusion Zone', lat:51.389, lon:30.099, country:'russia', type:'Former Disaster Site', risk:'MED',
    desc:'Site of 1986 disaster. Briefly occupied by Russian forces Feb-Mar 2022. New Safe Confinement over Reactor 4.'},
  // Pakistan/India (declared nuclear states)
  { name:'Kahuta Research Labs', lat:33.590, lon:73.385, country:'allied', type:'Enrichment', risk:'HIGH',
    desc:'Pakistan\'s primary uranium enrichment facility. A.Q. Khan network origin. Produces HEU for nuclear weapons.'},
  { name:'Bhabha Atomic Research Centre', lat:19.010, lon:72.924, country:'allied', type:'Weapons Research', risk:'MED',
    desc:'India\'s primary nuclear research center in Mumbai. Plutonium production and weapons design.'},
];

let nuclearVisible = false;
let nuclearMarkers = [];
const RISK_COL = { HIGH:'#ef4444', MED:'#f97316', LOW:'#eab308' };

function toggleNuclear(){
  nuclearVisible = !nuclearVisible;
  document.getElementById('btn-nuclear').classList.toggle('on', nuclearVisible);
  if(nuclearVisible){
    NUCLEAR_SITES.forEach(s => {
      const col = RISK_COL[s.risk] || '#64748b';
      const flag = FLAGS[s.country] || '🌐';
      const m = L.marker([s.lat, s.lon], {
        icon: L.divIcon({
          html: `<div style="color:${col};font-size:15px;text-shadow:0 0 6px ${col}80">☢️</div>`,
          className:'', iconSize:[15,15], iconAnchor:[7,7]
        })
      }).bindTooltip(`${flag} ${s.name}<br>${s.type} — Risk: <b style="color:${col}">${s.risk}</b>`, {className:'dark-tooltip', direction:'top'}).addTo(map);
      m.on('click', () => {
        document.getElementById('pTitle').textContent = `☢️ ${s.name}`;
        document.getElementById('pBody').innerHTML = `
          <div style="margin-bottom:6px">
            <span style="font-size:10px;padding:2px 8px;border-radius:2px;font-weight:700;font-family:'Share Tech Mono',monospace;background:${col}18;color:${col};border:1px solid ${col}40">${s.type}</span>
            <span style="font-size:10px;padding:2px 8px;border-radius:2px;font-weight:700;font-family:'Share Tech Mono',monospace;background:${col}18;color:${col};border:1px solid ${col}40;margin-left:4px">${s.risk} RISK</span>
          </div>
          <div style="font-size:10px;color:var(--text);line-height:1.5;margin-top:6px">${s.desc||''}</div>
        `;
        document.getElementById('infoP').classList.add('vis');
      });
      nuclearMarkers.push(m);
    });
  } else {
    nuclearMarkers.forEach(m => map.removeLayer(m));
    nuclearMarkers = [];
  }
}

// ════════════════════════════════════════
// AIR DEFENSE SYSTEMS
// ════════════════════════════════════════
const AIR_DEFENSE = [
  // Iran
  { name:'Bavar-373 (Tehran)',     lat:35.7,  lon:51.4,  country:'iran',   rangeKm:200 },
  { name:'S-300PMU-2 (Khordad)',   lat:34.0,  lon:50.0,  country:'iran',   rangeKm:150 },
  { name:'Bavar-373 (Natanz)',     lat:33.7,  lon:51.7,  country:'iran',   rangeKm:200 },
  { name:'S-300 (Bushehr)',        lat:28.8,  lon:50.9,  country:'iran',   rangeKm:150 },
  // Russia
  { name:'S-400 (Moscow)',         lat:55.75, lon:37.6,  country:'russia', rangeKm:400 },
  { name:'S-400 (Kaliningrad)',    lat:54.71, lon:20.51, country:'russia', rangeKm:400 },
  { name:'S-500 (Central Russia)', lat:52.0,  lon:37.0,  country:'russia', rangeKm:600 },
  { name:'S-400 (Hmeimim Syria)',  lat:35.4,  lon:35.9,  country:'russia', rangeKm:400 },
  { name:'S-400 (Crimea)',         lat:44.95, lon:34.10, country:'russia', rangeKm:400 },
  // China
  { name:'HQ-9B (Beijing)',        lat:39.9,  lon:116.4, country:'china',  rangeKm:200 },
  { name:'HQ-9B (Fiery Cross)',    lat:9.55,  lon:112.9, country:'china',  rangeKm:200 },
  { name:'HQ-9B (Mischief Reef)',  lat:9.91,  lon:115.5, country:'china',  rangeKm:200 },
  { name:'S-400 (Xinjiang)',       lat:43.0,  lon:87.0,  country:'china',  rangeKm:400 },
];

let airDefVisible = false;
let airDefLayers = [];

function toggleAirDef(){
  airDefVisible = !airDefVisible;
  document.getElementById('btn-airdef').classList.toggle('on', airDefVisible);
  if(airDefVisible){
    AIR_DEFENSE.forEach(s => {
      const col = GCOL[s.country] || '#64748b';
      const circle = L.circle([s.lat, s.lon], {
        radius: s.rangeKm * 1000,
        color: col, weight: 1, fillColor: col, fillOpacity: 0.08, opacity: 0.5,
        interactive: false, dashArray: '3 5'
      }).addTo(map);
      const label = L.marker([s.lat, s.lon], {
        icon: L.divIcon({
          html: `<div style="color:${col};font-size:13px;text-shadow:0 0 5px #000">🛡️</div>`,
          className:'', iconSize:[13,13], iconAnchor:[6,6]
        })
      }).bindTooltip(`${FLAGS[s.country]||'🌐'} ${s.name}<br>Range: ${s.rangeKm} km`, {className:'dark-tooltip',direction:'top'}).addTo(map);
      airDefLayers.push(circle, label);
    });
  } else {
    airDefLayers.forEach(l => map.removeLayer(l));
    airDefLayers = [];
  }
}

// ════════════════════════════════════════
// ADVERSARY INTEL PANEL
// ════════════════════════════════════════
const ADV_INTEL = {
  iran: {
    name: 'Islamic Republic of Iran', flag: '🇮🇷', color: '#ef4444',
    oob: [
      { label:'Air Force Aircraft (est.)', val:'~330 fixed-wing' },
      { label:'Key fighters', val:'F-14A Tomcat, F-4E, MiG-29, Su-24' },
      { label:'Drones', val:'Shahed-136/131, Mohajer-6, Arash-2' },
      { label:'Navy surface vessels', val:'~100 (IRIN + IRGCN)' },
      { label:'Submarines', val:'3 Kilo-class + midget subs' },
      { label:'Ballistic missiles', val:'Shahab-3, Khorramshahr, Qadr' },
      { label:'Cruise missiles', val:'Soumar, Ya Ali, Hoveizeh' },
      { label:'Active personnel', val:'~610,000 + 220,000 IRGC' },
    ],
    hotspots: [
      { name:'Strait of Hormuz', status:'ACTIVE', note:'IRGCN patrols ongoing' },
      { name:'Natanz Enrichment', status:'ACTIVE', note:'90% enrichment confirmed' },
      { name:'Fordow Underground', status:'ACTIVE', note:'Deeply buried, air-strike resistant' },
      { name:'Syria/Iraq proxies', status:'ACTIVE', note:'Hezbollah, PMF active' },
    ],
    intel: [
      'Iran enriched uranium to near-weapons-grade (84%) at Fordow',
      'IRGCN fast-boat harassment of US vessels in Arabian Gulf ongoing',
      'Shahed drone exports to Russia confirm production scale-up',
      'Parchin military site expansion detected via satellite imagery',
      'Iran-Russia-China trilateral naval drills held in Indian Ocean',
    ],
    watchFor: [
      'IRIAF tanker aircraft (707/747) suggest extended-range strike prep',
      'Surge in IRGCN small boat activity near Hormuz = chokepoint threat',
      'Iranian ISR drones over Iraq/Syria = target designation ops',
      'Fordow or Natanz air defense activation = strike anticipation',
    ],
  },
  russia: {
    name: 'Russian Federation', flag: '🇷🇺', color: '#dc2626',
    oob: [
      { label:'Air Force Aircraft (est.)', val:'~4,000 total, ~1,500 active' },
      { label:'Key fighters', val:'Su-57, Su-35S, Su-30SM, MiG-31BM' },
      { label:'Bombers', val:'Tu-160M, Tu-95MS, Tu-22M3' },
      { label:'Navy vessels (active)', val:'~350 ships, 1 carrier (laid up)' },
      { label:'Submarines', val:'~60 (11 SSBN nuclear)' },
      { label:'ICBMs deployed', val:'~1,600 strategic warheads' },
      { label:'Hypersonic weapons', val:'Kinzhal, Avangard, Zircon' },
      { label:'Active personnel', val:'~900,000 (est. wartime)' },
    ],
    hotspots: [
      { name:'Ukraine frontline', status:'ACTIVE', note:'Ongoing combined arms offensive' },
      { name:'Black Sea Fleet', status:'WARN',   note:'Fleet degraded by Ukrainian strikes' },
      { name:'Kaliningrad',      status:'WARN',   note:'Iskander SRBM deployment confirmed' },
      { name:'Syria (Hmeimim)', status:'ACTIVE', note:'Russian air operations ongoing' },
    ],
    intel: [
      'Tu-160M strategic bombers conducted long-range patrols over Arctic',
      'Black Sea Fleet relocated assets to Novorossiysk after Sevastopol losses',
      'Kinzhal hypersonic missiles used in Ukraine — depleting stockpile',
      'Russian EW aircraft (IL-22PP) active over eastern Ukraine',
      'S-500 Prometheus system reached operational status',
    ],
    watchFor: [
      'Tu-95MS/Tu-160 sorties from Engels AB = nuclear/cruise missile patrol',
      'MiG-31BM with Kinzhal on hardpoints = hypersonic strike ready',
      'IL-20M Coot ELINT surges = pre-strike reconnaissance',
      'Su-34 strike jets + tankers = deep strike package being assembled',
    ],
  },
  china: {
    name: "People's Republic of China", flag: '🇨🇳', color: '#eab308',
    oob: [
      { label:'Air Force Aircraft (est.)', val:'~3,000 total combat' },
      { label:'Key fighters', val:'J-20, J-16, J-10C, Su-35' },
      { label:'Bombers', val:'H-6K/J/N (LACM capable)' },
      { label:'Navy vessels', val:'~355 ships (largest fleet by count)' },
      { label:'Aircraft carriers', val:'3 (Liaoning, Shandong, Fujian)' },
      { label:'Submarines', val:'~60 (6 SSBN nuclear)' },
      { label:'ICBMs deployed', val:'~500 warheads, expanding fast' },
      { label:'Active personnel', val:'~2,000,000' },
    ],
    hotspots: [
      { name:'Taiwan Strait',    status:'ACTIVE', note:'Near-daily PLA incursions into ADIZ' },
      { name:'South China Sea',  status:'ACTIVE', note:'Artificial island militarization ongoing' },
      { name:'Senkaku/Diaoyu',   status:'WARN',   note:'CCG vessels conducting regular patrols' },
      { name:'India border (LAC)',status:'WARN',   note:'Infrastructure buildup at multiple points' },
    ],
    intel: [
      'PLAAF J-20 stealth fighters now operational at multiple bases near Taiwan',
      'PLA SSBN patrols in Pacific increasing — nuclear deterrent posture shift',
      'DF-17 hypersonic glide vehicle entered full operational service',
      'Fujian carrier completed sea trials — first electromagnetic catapult carrier',
      'PLA established third overseas logistics base (Equatorial Guinea suspected)',
    ],
    watchFor: [
      'H-6K/J bomber sorties with air-launched cruise missiles = strike posture',
      'Multiple PLAN carrier strike groups leaving port simultaneously = major op',
      'Y-20 transport surge toward Taiwan Strait area = amphibious prep signal',
      'PLA EW aircraft (Y-8/Y-9) near Taiwan = electronic suppression prep',
    ],
  }
};

let currentAdv = 'iran';

function switchAdv(adv){
  currentAdv = adv;
  document.querySelectorAll('.adv-tab').forEach(t => t.classList.toggle('active', t.dataset.adv === adv));
  renderAdvPanel(adv);
}

function renderAdvPanel(adv){
  const d = ADV_INTEL[adv];
  if(!d) return;
  const pane = document.getElementById('pane-adv');
  if(!pane) return;

  // Count live aircraft for this adversary
  const live = acData.filter(ac => ac.lat && getGroup(ac.hex) === adv);
  const liveTypes = {};
  live.forEach(ac => { const t=classifyType(ac); liveTypes[t]=(liveTypes[t]||0)+1; });

  let h = `<div class="adv-body">`;

  // Col 1: Order of Battle
  h += `<div class="adv-col">
    <h5>⚔️ Order of Battle</h5>
    ${d.oob.map(o=>`<div class="adv-row"><span class="ar-label">${o.label}</span><span class="ar-val">${o.val}</span></div>`).join('')}
    <h5 style="margin-top:8px">✈️ Live Aircraft Now</h5>
    ${live.length ? Object.entries(liveTypes).map(([t,n])=>`<div class="adv-row"><span class="ar-label">${TICO[t]||'◆'} ${TLAB[t]||t}</span><span class="ar-val" style="color:${d.color}">${n}</span></div>`).join('') : `<div style="color:#3a4560;font-size:11px">No ${d.name} aircraft currently tracked</div>`}
  </div>`;

  // Col 2: Hotspots + Intel
  h += `<div class="adv-col">
    <h5>🔥 Active Hotspots</h5>
    ${d.hotspots.map(hs=>{
      const scls = hs.status==='ACTIVE'?'hot':hs.status==='WARN'?'warn':'calm';
      return `<div style="margin-bottom:7px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px">
          <span style="font-weight:600;color:var(--text)">${hs.name}</span>
          <span class="adv-status ${scls}">${hs.status}</span>
        </div>
        <div style="color:var(--muted);font-size:10px">${hs.note}</div>
      </div>`;
    }).join('')}
    <h5 style="margin-top:8px">📡 Recent Intel</h5>
    ${d.intel.map(i=>`<div style="margin-bottom:5px;color:var(--muted);font-size:10px;padding-left:6px;border-left:2px solid ${d.color}40">${i}</div>`).join('')}
  </div>`;

  // Col 3: Watch Signals
  h += `<div class="adv-col">
    <h5>👁️ Watch For These Signals</h5>
    ${d.watchFor.map(w=>`<div style="margin-bottom:8px;padding:6px 8px;background:rgba(239,68,68,.06);border:1px solid ${d.color}30;border-radius:4px;font-size:11px;color:var(--text);line-height:1.4">${w}</div>`).join('')}
  </div>`;

  h += `</div>`;
  pane.innerHTML = h;
}
// ════════════════════════════════════════
// EARTHQUAKE MONITOR (USGS API)
// ════════════════════════════════════════
let quakeLayer = L.layerGroup();
let quakesVisible = false;
let quakeData = [];

function toggleQuakes(){
  quakesVisible = !quakesVisible;
  const btn = document.getElementById('btn-quakes');
  if(quakesVisible){
    quakeLayer.addTo(map);
    btn.classList.add('on');
    fetchQuakes();
  } else {
    map.removeLayer(quakeLayer);
    btn.classList.remove('on');
  }
}

async function fetchQuakes(){
  try {
    const res = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_day.geojson');
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    quakeData = data.features || [];
    renderQuakes();
  } catch(e){
    console.warn('[QUAKE] Failed to fetch:', e.message);
  }
}

function renderQuakes(){
  quakeLayer.clearLayers();
  if(!quakesVisible || !quakeData.length) return;

  quakeData.forEach(q => {
    const p = q.properties;
    const [lon, lat, depth] = q.geometry.coordinates;
    const mag = p.mag || 0;
    const dotSize = Math.max(6, Math.min(mag * 4, 30));
    const rippleSize = dotSize * 2;

    // Color by magnitude
    const col = mag >= 7 ? '#ff0040' : mag >= 6 ? '#ef4444' : mag >= 5 ? '#f97316' : mag >= 4 ? '#eab308' : '#00ff41';
    const time = new Date(p.time);
    const ago = Math.round((Date.now() - time) / 60000);
    const agoStr = ago < 60 ? `${ago}m ago` : `${Math.round(ago/60)}h ago`;

    const marker = L.marker([lat, lon], {
      icon: L.divIcon({
        html:`<div class="quake-marker">
          <div class="quake-dot" style="width:${dotSize}px;height:${dotSize}px;background:${col};box-shadow:0 0 ${dotSize}px ${col}80"></div>
          ${mag >= 5 ? `<div class="quake-ripple" style="width:${rippleSize}px;height:${rippleSize}px;border-color:${col}"></div>
          <div class="quake-ripple r2" style="width:${rippleSize}px;height:${rippleSize}px;border-color:${col}"></div>
          <div class="quake-ripple r3" style="width:${rippleSize}px;height:${rippleSize}px;border-color:${col}"></div>` : ''}
        </div>`,
        className:'', iconSize:[dotSize, dotSize], iconAnchor:[dotSize/2, dotSize/2]
      })
    });

    marker.bindTooltip(`🌍 M${mag.toFixed(1)} — ${p.place}`, {className:'dark-tooltip', direction:'top', offset:[0,-dotSize/2]});
    marker.on('click', () => {
      document.getElementById('pTitle').textContent = `M${mag.toFixed(1)} Earthquake`;
      const tsunami = p.tsunami ? '<span style="color:#ef4444;font-weight:700">⚠️ TSUNAMI WARNING</span>' : '<span style="color:var(--accent)">No tsunami alert</span>';
      document.getElementById('pBody').innerHTML = `
        <div style="margin-bottom:6px">
          <span style="font-size:18px;font-weight:800;color:${col};font-family:'Orbitron',monospace;text-shadow:0 0 12px ${col}60">${mag.toFixed(1)}</span>
          <span style="font-size:10px;color:var(--muted);margin-left:6px">magnitude</span>
        </div>
        <div class="f"><span class="k">Location: </span><span class="v">${p.place || '—'}</span></div>
        <div class="f"><span class="k">Depth: </span><span class="v">${depth.toFixed(1)} km</span></div>
        <div class="f"><span class="k">Time: </span><span class="v">${time.toUTCString()} (${agoStr})</span></div>
        <div class="f"><span class="k">Tsunami: </span><span class="v">${tsunami}</span></div>
        <div class="f"><span class="k">Felt Reports: </span><span class="v">${p.felt || 'None'}</span></div>
        <div class="f"><span class="k">Alert Level: </span><span class="v" style="color:${p.alert==='red'?'#ef4444':p.alert==='orange'?'#f97316':p.alert==='yellow'?'#eab308':'var(--accent)'}">${(p.alert||'green').toUpperCase()}</span></div>
        <div style="margin-top:8px">
          <a href="${p.url}" target="_blank" style="font-size:10px;color:var(--accent);text-decoration:none;background:rgba(0,12,0,.8);padding:3px 7px;border-radius:2px;border:1px solid rgba(0,255,65,.2)">🔗 USGS Details</a>
        </div>
      `;
      document.getElementById('infoP').classList.add('vis');
    });

    quakeLayer.addLayer(marker);
  });
}

// Auto-refresh quakes every 2 min if visible
setInterval(() => { if(quakesVisible) fetchQuakes(); }, 120000);

// ════════════════════════════════════════
// TFR / NOTAM OVERLAY
// ════════════════════════════════════════
let NOTAMS = [
  // Active conflict TFRs
  {name:'Ukraine Conflict Zone TFR', type:'CONFLICT', severity:'PROHIBITED',
   lat:48.5, lon:36.0, radiusKm:500, color:'#ef4444',
   issued:'Feb 2022 — ONGOING', altitude:'ALL ALTITUDES (SFC-UNL)',
   desc:'Total airspace closure over Ukraine and surrounding areas. EUROCONTROL prohibited zone. All civil overflights banned since Russian invasion.',
   authority:'EUROCONTROL / Ukrainian ANSP'},
  {name:'Eastern Med TFR — Gaza', type:'CONFLICT', severity:'RESTRICTED',
   lat:31.4, lon:34.3, radiusKm:60, color:'#ef4444',
   issued:'Oct 2023 — ONGOING', altitude:'SFC-FL500',
   desc:'Airspace restrictions over Gaza and southern Israel. Active military operations. Ben Gurion diversions during escalations.',
   authority:'Israeli CAA / IAF'},
  {name:'Red Sea Danger Area', type:'MILITARY', severity:'DANGER',
   lat:14.0, lon:42.5, radiusKm:200, color:'#f97316',
   issued:'Nov 2023 — ONGOING', altitude:'SFC-UNL',
   desc:'Danger area over southern Red Sea and Gulf of Aden. Active Houthi anti-ship missile and drone threat. Military operations by US/UK forces.',
   authority:'US NAVCENT / CENTCOM'},
  // Military operating areas
  {name:'Nevada Test & Training Range', type:'MOA', severity:'RESTRICTED',
   lat:37.2, lon:-116.0, radiusKm:120, color:'#00ff41',
   issued:'PERMANENT', altitude:'SFC-FL600',
   desc:'Largest military airspace in the free world. Home to Nellis AFB, Area 51, Tonopah Test Range. Red Flag exercises, stealth testing, weapons development.',
   authority:'USAF / FAA'},
  {name:'White Sands Missile Range', type:'MOA', severity:'RESTRICTED',
   lat:32.4, lon:-106.3, radiusKm:80, color:'#00ff41',
   issued:'PERMANENT', altitude:'SFC-UNL',
   desc:'Primary US missile testing facility. Hypersonic weapons testing, air defense systems, directed energy weapons. Periodic closures for live fire.',
   authority:'US Army / FAA'},
  {name:'Aegean Sea — Turkish/Greek Exercises', type:'MILITARY', severity:'DANGER',
   lat:38.5, lon:25.5, radiusKm:150, color:'#eab308',
   issued:'RECURRING', altitude:'SFC-FL300',
   desc:'Frequent Turkish and Greek military exercise NOTAMs in the Aegean. Air and naval exercises. Overlapping FIR disputes. NATO deconfliction required.',
   authority:'Turkish/Greek CAA'},
  {name:'Persian Gulf Naval Exercise Area', type:'MILITARY', severity:'DANGER',
   lat:26.0, lon:53.0, radiusKm:200, color:'#f97316',
   issued:'RECURRING', altitude:'SFC-FL250',
   desc:'Iranian and US/coalition naval exercise areas. IRGCN live-fire drills, US carrier ops. NOTAMs issued for missile tests and naval gunfire.',
   authority:'Iran CAA / CENTCOM'},
  {name:'South China Sea ADIZ/TFR', type:'MILITARY', severity:'RESTRICTED',
   lat:16.5, lon:112.0, radiusKm:350, color:'#eab308',
   issued:'RECURRING', altitude:'SFC-UNL',
   desc:'Chinese military NOTAMs for live-fire exercises, missile launches, and naval drills. Periodic closures of large ocean areas. Affects international shipping lanes.',
   authority:'PLA / CAAC'},
  {name:'Barents Sea — Russian Missile Tests', type:'MILITARY', severity:'DANGER',
   lat:72.0, lon:40.0, radiusKm:300, color:'#dc2626',
   issued:'RECURRING', altitude:'SFC-UNL',
   desc:'Russian NOTAM area for ICBM tests from Plesetsk, SLBM tests from Northern Fleet submarines, and Novaya Zemlya nuclear test site proximity.',
   authority:'Russian MoD'},
  {name:'Korean Peninsula ADIZ Overlap', type:'ADIZ', severity:'RESTRICTED',
   lat:37.5, lon:127.0, radiusKm:150, color:'#eab308',
   issued:'PERMANENT', altitude:'SFC-UNL',
   desc:'Overlapping KADIZ/JADIZ/Chinese ADIZ. North Korean missile test NOTAMs. US-ROK exercise NOTAMs. One of the most contested airspaces globally.',
   authority:'ROK MND / USFK'},
];

let notamLayer = L.layerGroup();
let notamsVisible = false;

function toggleNOTAMs(){
  notamsVisible = !notamsVisible;
  const btn = document.getElementById('btn-notams');
  if(notamsVisible){
    notamLayer.addTo(map);
    btn.classList.add('on');
    renderNOTAMs();
  } else {
    map.removeLayer(notamLayer);
    btn.classList.remove('on');
  }
}

function renderNOTAMs(){
  notamLayer.clearLayers();
  if(!notamsVisible) return;
  NOTAMS.forEach(n => {
    const dashMap = {PROHIBITED:'',RESTRICTED:'6 4',DANGER:'4 8',MOA:'10 6',ADIZ:'3 6'};
    const circle = L.circle([n.lat, n.lon], {
      radius: n.radiusKm * 1000,
      fillColor: n.color,
      fillOpacity: 0.05,
      color: n.color,
      weight: 2,
      opacity: 0.35,
      dashArray: dashMap[n.severity]||'6 4'
    });

    const icon = n.severity==='PROHIBITED'?'🚫':n.severity==='DANGER'?'⚠️':n.type==='MOA'?'✈️':'🔴';
    const marker = L.marker([n.lat, n.lon], {
      icon: L.divIcon({
        html:`<div style="font-size:13px;text-shadow:0 0 6px ${n.color}80;cursor:pointer">${icon}</div>`,
        className:'', iconSize:[13,13], iconAnchor:[7,7]
      })
    });

    marker.bindTooltip(`${icon} ${n.name}`, {className:'dark-tooltip', direction:'top', offset:[0,-8]});
    marker.on('click', () => {
      document.getElementById('pTitle').textContent = n.name;
      document.getElementById('pBody').innerHTML = `
        <div style="margin-bottom:6px">
          <span style="font-size:10px;padding:2px 8px;border-radius:2px;font-weight:700;font-family:'Share Tech Mono',monospace;background:${n.color}18;color:${n.color};border:1px solid ${n.color}40">${n.severity}</span>
          <span style="font-size:10px;padding:2px 8px;border-radius:2px;font-family:'Share Tech Mono',monospace;background:rgba(0,255,65,.05);color:var(--muted);border:1px solid rgba(0,255,65,.1);margin-left:4px">${n.type}</span>
        </div>
        <div class="f"><span class="k">Issued: </span><span class="v">${n.issued}</span></div>
        <div class="f"><span class="k">Altitude: </span><span class="v">${n.altitude}</span></div>
        <div class="f"><span class="k">Authority: </span><span class="v">${n.authority}</span></div>
        <div style="margin-top:6px;font-size:10px;color:var(--text);line-height:1.5">${n.desc}</div>
      `;
      document.getElementById('infoP').classList.add('vis');
    });

    notamLayer.addLayer(circle);
    notamLayer.addLayer(marker);
  });
}

// ════════════════════════════════════════
// GPS JAMMING / SPOOFING ZONES
// ════════════════════════════════════════
let GPS_ZONES = [
  {name:'Kaliningrad Jammer', type:'JAMMING', severity:'HIGH', source:'🇷🇺 Russia',
   lat:54.7, lon:20.5, radiusKm:300, color:'#ef4444',
   desc:'Persistent GPS jamming emanating from Russian Kaliningrad exclave. Affects Baltic states, Poland, Finland, Sweden. Disrupts civilian aviation and maritime navigation.',
   affects:['Civil aviation GPS','Maritime navigation','Drone operations','Precision agriculture']},
  {name:'St. Petersburg / NW Russia', type:'JAMMING', severity:'HIGH', source:'🇷🇺 Russia',
   lat:59.9, lon:30.3, radiusKm:250, color:'#ef4444',
   desc:'Major jamming complex protecting St. Petersburg metro area and military installations. Affects Finland, Estonia, and Baltic Sea traffic.',
   affects:['Finnish airspace','Estonian border','Baltic Sea shipping','Civil GPS receivers']},
  {name:'Moscow Kremlin GPS Spoofing', type:'SPOOFING', severity:'MEDIUM', source:'🇷🇺 Russia',
   lat:55.75, lon:37.62, radiusKm:50, color:'#f97316',
   desc:'GPS spoofing around Kremlin area. Devices show false position (typically Vnukovo airport). Protective measure against GPS-guided threats targeting Russian leadership.',
   affects:['Ride-share apps','Personal navigation','Drone no-fly enforcement','Fitness trackers']},
  {name:'Eastern Mediterranean', type:'SPOOFING', severity:'HIGH', source:'🇷🇺/🇸🇾 Khmeimim AB',
   lat:35.4, lon:35.9, radiusKm:350, color:'#ef4444',
   desc:'Massive GPS spoofing from Russian Khmeimim air base in Syria. Affects Cyprus, Lebanon, Turkey, and Eastern Med shipping. Aircraft report false positions.',
   affects:['Beirut FIR flights','Cyprus airspace','Med shipping','Israeli airspace edge']},
  {name:'Ukraine War Zone', type:'JAMMING', severity:'CRITICAL', source:'🇷🇺/🇺🇦 Both sides',
   lat:48.5, lon:37.0, radiusKm:400, color:'#dc2626',
   desc:'Extensive GPS/GNSS jamming and spoofing across entire Ukrainian front. Both sides deploy electronic warfare. Critical impact on drone operations, PGMs, and navigation.',
   affects:['FPV drone guidance','Precision munitions','GLONASS/GPS receivers','HIMARS targeting']},
  {name:'Northern Black Sea', type:'SPOOFING', severity:'MEDIUM', source:'🇷🇺 Russia',
   lat:44.5, lon:34.0, radiusKm:200, color:'#f97316',
   desc:'GPS spoofing over northern Black Sea and Crimea. Ships report false AIS positions. Affects maritime traffic and overflight navigation.',
   affects:['Commercial shipping','Military navigation','Overflight GPS','Search and rescue']},
  {name:'Iran Border Regions', type:'SPOOFING', severity:'MEDIUM', source:'🇮🇷 Iran',
   lat:32.5, lon:53.0, radiusKm:400, color:'#f97316',
   desc:'Iranian GPS spoofing capability. Used to capture US RQ-170 drone in 2011. Active near nuclear facilities and military installations.',
   affects:['Drone operations','Overflight navigation','Gulf shipping','Military GPS']},
  {name:'Strait of Hormuz', type:'SPOOFING', severity:'MEDIUM', source:'🇮🇷 IRGC Navy',
   lat:26.5, lon:56.2, radiusKm:100, color:'#f97316',
   desc:'Intermittent GPS interference in Strait of Hormuz. IRGC capability to spoof ship AIS and GPS. Used during tanker harassment incidents.',
   affects:['Oil tanker navigation','Naval GPS','AIS positioning','Maritime safety']},
  {name:'Northern Israel / Lebanon', type:'SPOOFING', severity:'HIGH', source:'🇮🇱 Israel',
   lat:33.0, lon:35.2, radiusKm:100, color:'#eab308',
   desc:'Israeli GPS spoofing along northern border. Defensive measure against Hezbollah GPS-guided rockets and drones. Ben Gurion airport occasionally affected.',
   affects:['Hezbollah drone/rocket guidance','Civil aviation approaches','Lebanese airspace','Syrian border']},
  {name:'South China Sea', type:'SPOOFING', severity:'LOW', source:'🇨🇳 China',
   lat:16.0, lon:112.0, radiusKm:300, color:'#eab308',
   desc:'Reports of GPS manipulation near Chinese-occupied features in Spratly/Paracel Islands. Ships report sudden position jumps. Part of broader A2/AD strategy.',
   affects:['Naval navigation','Fishing fleet GPS','Commercial shipping','US FONOPs']},
  {name:'North Korea', type:'JAMMING', severity:'MEDIUM', source:'🇰🇵 DPRK',
   lat:38.0, lon:126.5, radiusKm:150, color:'#f97316',
   desc:'North Korean GPS jammers along DMZ. Periodically activated to disrupt South Korean military and civilian navigation. Affects Incheon airport approaches.',
   affects:['South Korean military','Incheon airport','Seoul metro area GPS','Maritime traffic']},
];

let gpsLayer = L.layerGroup();
let gpsVisible = false;

function toggleGPSJam(){
  gpsVisible = !gpsVisible;
  const btn = document.getElementById('btn-gpsjam');
  if(gpsVisible){
    gpsLayer.addTo(map);
    btn.classList.add('on');
    renderGPSJam();
  } else {
    map.removeLayer(gpsLayer);
    btn.classList.remove('on');
  }
}

function renderGPSJam(){
  gpsLayer.clearLayers();
  if(!gpsVisible) return;
  GPS_ZONES.forEach(z => {
    // Interference zone
    const circle = L.circle([z.lat, z.lon], {
      radius: z.radiusKm * 1000,
      fillColor: z.color,
      fillOpacity: 0.06,
      color: z.color,
      weight: 1.5,
      opacity: 0.3,
      dashArray: z.type==='SPOOFING' ? '4 8' : '12 4'
    });

    // Marker
    const icon = z.type==='SPOOFING' ? '👻' : '📡';
    const marker = L.marker([z.lat, z.lon], {
      icon: L.divIcon({
        html:`<div style="font-size:14px;text-shadow:0 0 6px ${z.color}80;cursor:pointer">${icon}</div>`,
        className:'', iconSize:[14,14], iconAnchor:[7,7]
      })
    });

    marker.bindTooltip(`${icon} ${z.name} — ${z.type}`, {className:'dark-tooltip', direction:'top', offset:[0,-8]});
    marker.on('click', () => {
      document.getElementById('pTitle').textContent = z.name;
      document.getElementById('pBody').innerHTML = `
        <div style="margin-bottom:6px">
          <span style="font-size:10px;padding:2px 8px;border-radius:2px;font-weight:700;font-family:'Share Tech Mono',monospace;background:${z.color}18;color:${z.color};border:1px solid ${z.color}40">${z.type}</span>
          <span style="font-size:10px;padding:2px 8px;border-radius:2px;font-weight:700;font-family:'Share Tech Mono',monospace;background:${z.color}18;color:${z.color};border:1px solid ${z.color}40;margin-left:4px">${z.severity}</span>
        </div>
        <div class="f"><span class="k">Source: </span><span class="v">${z.source}</span></div>
        <div class="f"><span class="k">Radius: </span><span class="v">~${z.radiusKm} km</span></div>
        <div style="margin-top:6px;font-size:10px;color:var(--text);line-height:1.5">${z.desc}</div>
        <div style="margin-top:8px">
          <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Systems Affected</div>
          ${z.affects.map(a=>`<span style="display:inline-block;font-size:10px;padding:2px 6px;margin:2px;background:${z.color}08;border:1px solid ${z.color}20;border-radius:2px;color:var(--text)">${a}</span>`).join('')}
        </div>
      `;
      document.getElementById('infoP').classList.add('vis');
    });

    gpsLayer.addLayer(circle);
    gpsLayer.addLayer(marker);
  });
}

// ════════════════════════════════════════
// MILITARY EXERCISES TRACKER
// ════════════════════════════════════════
let EXERCISES = [
  {name:'DEFENDER EUROPE 2026', status:'PLANNED', type:'NATO',
   lat:54.0, lon:20.0, radiusKm:400, color:'#00ff41',
   nations:'🇺🇸🇬🇧🇩🇪🇫🇷🇵🇱🇪🇪🇱🇹🇱🇻 + 20 NATO allies',
   period:'May-Jun 2026', personnel:'~30,000',
   summary:'Large-scale NATO deterrence exercise in Eastern Europe. Tests rapid deployment of US forces to European theater. Focus on Baltic and Polish corridors.',
   components:['Ground maneuver','Air defense integration','Logistics sustainment','Cyber defense']},
  {name:'RIMPAC 2026', status:'PLANNED', type:'MULTINATIONAL',
   lat:21.3, lon:-157.8, radiusKm:500, color:'#22d3ee',
   nations:'🇺🇸🇯🇵🇦🇺🇰🇷🇨🇦🇬🇧🇮🇳 + 20 Pacific partners',
   period:'Jun-Aug 2026', personnel:'~25,000',
   summary:'World\'s largest international maritime exercise. Held biennially near Hawaii. Anti-submarine warfare, amphibious ops, live-fire exercises, HADR.',
   components:['Carrier ops','Submarine warfare','Amphibious assault','Live-fire sinking exercise']},
  {name:'STEADFAST DEFENDER', status:'ONGOING', type:'NATO',
   lat:58.0, lon:15.0, radiusKm:600, color:'#00ff41',
   nations:'🇺🇸🇬🇧🇩🇪🇫🇷🇳🇴🇸🇪🇫🇮 + all 32 NATO members',
   period:'2024-2026 (rolling)', personnel:'~90,000',
   summary:'NATO\'s largest exercise since Cold War. Tests new defense plans against near-peer threat. Full-spectrum operations from Arctic to Mediterranean.',
   components:['Article 5 scenarios','Nuclear deterrence','Integrated air/missile defense','Maritime interdiction']},
  {name:'COBRA GOLD', status:'ANNUAL', type:'MULTINATIONAL',
   lat:14.5, lon:101.0, radiusKm:200, color:'#22d3ee',
   nations:'🇺🇸🇹🇭🇯🇵🇰🇷🇸🇬🇮🇩🇲🇾',
   period:'Feb-Mar 2026', personnel:'~10,000',
   summary:'Oldest and largest multinational exercise in Asia-Pacific. Hosted by Thailand. Focus on interoperability, humanitarian assistance, and jungle warfare.',
   components:['Jungle warfare','HADR','Amphibious landing','Command post exercise']},
  {name:'KEEN SWORD', status:'ANNUAL', type:'US-JAPAN',
   lat:35.5, lon:139.7, radiusKm:300, color:'#22d3ee',
   nations:'🇺🇸🇯🇵',
   period:'Oct-Nov (biennial)', personnel:'~15,000',
   summary:'Bilateral US-Japan exercise. Tests defense of Japanese home islands and surrounding seas. Integrates JSDF and USFJ forces.',
   components:['Island defense','Air superiority','Anti-ship warfare','BMD integration']},
  {name:'VOSTOK (Russia)', status:'ANNUAL', type:'RUSSIAN',
   lat:48.0, lon:135.0, radiusKm:500, color:'#dc2626',
   nations:'🇷🇺🇨🇳🇮🇳🇲🇳 (reduced since 2022)',
   period:'Varies', personnel:'~50,000 (claimed)',
   summary:'Russia\'s large-scale strategic exercise in Eastern Military District. Scaled down since Ukraine invasion. Tests Pacific Fleet and Eastern theater readiness.',
   components:['Strategic bomber flights','Naval fleet ops','Ground maneuver','Nuclear readiness drills']},
  {name:'JOINT SWORD (China)', status:'RECURRING', type:'PLA',
   lat:25.0, lon:121.0, radiusKm:200, color:'#e5ff00',
   nations:'🇨🇳 PLA',
   period:'Triggered by political events', personnel:'Unknown',
   summary:'PLA exercises encircling Taiwan. Simulates blockade and invasion scenarios. Live-fire drills, missile launches into surrounding waters. Escalatory signaling.',
   components:['Naval blockade drill','Amphibious assault','Missile launches','Air superiority ops']},
  {name:'RED FLAG', status:'RECURRING', type:'USAF',
   lat:36.8, lon:-115.0, radiusKm:100, color:'#00ff41',
   nations:'🇺🇸 + allied air forces',
   period:'Multiple annually at Nellis AFB', personnel:'~4,000',
   summary:'Premier USAF air combat training exercise. Realistic adversary air ("Red Air") scenarios. Tests 5th-gen integration, electronic warfare, SEAD/DEAD.',
   components:['BVR air combat','SEAD/DEAD','CAS integration','5th/4th gen fusion']},
];

let exerciseLayer = L.layerGroup();
let exercisesVisible = false;

function toggleExercises(){
  exercisesVisible = !exercisesVisible;
  const btn = document.getElementById('btn-exercises');
  if(exercisesVisible){
    exerciseLayer.addTo(map);
    btn.classList.add('on');
    renderExercises();
  } else {
    map.removeLayer(exerciseLayer);
    btn.classList.remove('on');
  }
}

function renderExercises(){
  exerciseLayer.clearLayers();
  if(!exercisesVisible) return;
  EXERCISES.forEach(ex => {
    const circle = L.circle([ex.lat, ex.lon], {
      radius: ex.radiusKm * 1000,
      fillColor: ex.color,
      fillOpacity: 0.05,
      color: ex.color,
      weight: 1.5,
      opacity: 0.35,
      dashArray: '6 6'
    });

    const marker = L.marker([ex.lat, ex.lon], {
      icon: L.divIcon({
        html:`<div style="font-size:14px;text-shadow:0 0 8px ${ex.color}80;cursor:pointer">🎯</div>`,
        className:'', iconSize:[14,14], iconAnchor:[7,7]
      })
    });

    marker.bindTooltip(`🎯 ${ex.name}`, {className:'dark-tooltip', direction:'top', offset:[0,-8]});
    marker.on('click', () => {
      document.getElementById('pTitle').textContent = ex.name;
      document.getElementById('pBody').innerHTML = `
        <div style="margin-bottom:6px"><span style="font-size:10px;padding:2px 8px;border-radius:2px;font-weight:700;font-family:'Share Tech Mono',monospace;background:${ex.color}18;color:${ex.color};border:1px solid ${ex.color}40">${ex.status}</span>
        <span style="font-size:10px;padding:2px 8px;border-radius:2px;font-family:'Share Tech Mono',monospace;background:rgba(0,255,65,.05);color:var(--muted);border:1px solid rgba(0,255,65,.1);margin-left:4px">${ex.type}</span></div>
        <div class="f"><span class="k">Nations: </span><span class="v">${ex.nations}</span></div>
        <div class="f"><span class="k">Period: </span><span class="v">${ex.period}</span></div>
        <div class="f"><span class="k">Personnel: </span><span class="v">${ex.personnel}</span></div>
        <div style="margin-top:6px;font-size:10px;color:var(--text);line-height:1.5">${ex.summary}</div>
        <div style="margin-top:8px">
          <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Components</div>
          ${ex.components.map(c=>`<span style="display:inline-block;font-size:10px;padding:2px 6px;margin:2px;background:rgba(0,255,65,.05);border:1px solid rgba(0,255,65,.12);border-radius:2px;color:var(--text)">${c}</span>`).join('')}
        </div>
      `;
      document.getElementById('infoP').classList.add('vis');
    });

    exerciseLayer.addLayer(circle);
    exerciseLayer.addLayer(marker);
  });
}

// ════════════════════════════════════════
// ACTIVE CONFLICTS OVERLAY
// ════════════════════════════════════════
let CONFLICTS = [
  {name:'Ukraine-Russia War', status:'ACTIVE COMBAT', intensity:'HIGH',
   lat:48.5, lon:37.5, radiusKm:350, color:'#ef4444',
   parties:'🇺🇦 Ukraine vs 🇷🇺 Russia', since:'Feb 2022',
   summary:'Full-scale conventional war. Active frontline ~1,200km. Russian occupation of Crimea, parts of Donetsk, Luhansk, Zaporizhzhia, Kherson. Drone warfare, artillery, trench combat.',
   hotspots:['Donetsk front','Zaporizhzhia sector','Kursk incursion','Black Sea drone ops']},
  {name:'Gaza Conflict', status:'ACTIVE COMBAT', intensity:'HIGH',
   lat:31.4, lon:34.4, radiusKm:40, color:'#ef4444',
   parties:'🇮🇱 Israel vs Hamas/PIJ', since:'Oct 2023',
   summary:'Intensive urban warfare following Oct 7 attack. IDF ground operations across Gaza. Massive humanitarian crisis. Regional escalation risk.',
   hotspots:['Rafah','Khan Younis','Gaza City','Netzarim Corridor']},
  {name:'Red Sea / Houthi Campaign', status:'ACTIVE', intensity:'MEDIUM',
   lat:14.5, lon:42.5, radiusKm:250, color:'#f97316',
   parties:'🇾🇪 Houthis vs 🇺🇸/🇬🇧 Coalition + Commercial Shipping', since:'Nov 2023',
   summary:'Houthi anti-ship missile and drone attacks on Red Sea/Gulf of Aden commercial shipping. US/UK strikes on Houthi positions in Yemen. Major disruption to Suez Canal trade.',
   hotspots:['Bab el-Mandeb strait','Gulf of Aden','Hudaydah port','Southern Red Sea']},
  {name:'Israel-Hezbollah Border', status:'TENSE', intensity:'MEDIUM',
   lat:33.2, lon:35.5, radiusKm:60, color:'#f97316',
   parties:'🇮🇱 Israel vs 🇱🇧 Hezbollah', since:'Oct 2023',
   summary:'Cross-border exchanges of fire. Israeli strikes on Hezbollah positions in Lebanon. Tens of thousands evacuated on both sides. Risk of full-scale war.',
   hotspots:['Blue Line','South Lebanon','Golan Heights','Beirut suburbs']},
  {name:'Syria Civil War (Frozen)', status:'LOW INTENSITY', intensity:'LOW',
   lat:35.5, lon:38.5, radiusKm:200, color:'#eab308',
   parties:'Multiple factions — Assad gov, SDF/Kurds, HTS, Turkish-backed forces', since:'2011',
   summary:'Largely frozen conflict. US forces at al-Tanf & NE Syria with SDF. Turkish operations against Kurdish forces. Israeli strikes on Iranian assets. Russian air base at Khmeimim.',
   hotspots:['Idlib province','NE Syria/SDF','al-Tanf garrison','Deir ez-Zor']},
  {name:'Taiwan Strait Tensions', status:'WATCH', intensity:'LOW',
   lat:24.0, lon:120.0, radiusKm:150, color:'#eab308',
   parties:'🇨🇳 PRC vs 🇹🇼 Taiwan (🇺🇸 support)', since:'Ongoing',
   summary:'Increased PLA military pressure. Regular PLAAF incursions into Taiwan ADIZ. PLA Navy exercises near Taiwan. US arms sales and naval transits continue.',
   hotspots:['Taiwan Strait','Kinmen Islands','Bashi Channel','First Island Chain']},
  {name:'South China Sea Disputes', status:'WATCH', intensity:'LOW',
   lat:14.5, lon:115.0, radiusKm:400, color:'#eab308',
   parties:'🇨🇳 China vs 🇵🇭🇻🇳🇲🇾🇧🇳🇹🇼 + 🇺🇸 FONOPs', since:'Ongoing',
   summary:'Chinese maritime militia, coast guard harassment at Second Thomas Shoal. Philippine resupply missions contested. US freedom of navigation operations.',
   hotspots:['Second Thomas Shoal','Scarborough Shoal','Spratly Islands','Paracel Islands']},
  {name:'Iran-Israel Shadow War', status:'ELEVATED', intensity:'MEDIUM',
   lat:33.0, lon:44.0, radiusKm:300, color:'#f97316',
   parties:'🇮🇱 Israel vs 🇮🇷 Iran + proxies', since:'Ongoing',
   summary:'Covert and overt strikes. Israeli attacks on Iranian nuclear/military facilities. Iranian proxy network (Hezbollah, Iraqi militias, Houthis). Direct missile exchanges in Apr 2024.',
   hotspots:['Isfahan nuclear sites','Syrian T4 airbase','Iraqi militia bases','Strait of Hormuz']},
];

let conflictLayer = L.layerGroup();
let conflictsVisible = false;

function toggleConflicts(){
  conflictsVisible = !conflictsVisible;
  const btn = document.getElementById('btn-conflicts');
  if(conflictsVisible){
    conflictLayer.addTo(map);
    btn.classList.add('on');
    renderConflicts();
  } else {
    map.removeLayer(conflictLayer);
    btn.classList.remove('on');
  }
}

function renderConflicts(){
  conflictLayer.clearLayers();
  if(!conflictsVisible) return;
  CONFLICTS.forEach(c => {
    // Conflict zone circle
    const circle = L.circle([c.lat, c.lon], {
      radius: c.radiusKm * 1000,
      fillColor: c.color,
      fillOpacity: 0.08,
      color: c.color,
      weight: 2,
      opacity: 0.4,
      dashArray: c.intensity==='HIGH' ? '' : '8 4'
    });

    // Pulsing center marker
    const pulseColor = c.intensity==='HIGH' ? '#ef4444' : c.intensity==='MEDIUM' ? '#f97316' : '#eab308';
    const marker = L.marker([c.lat, c.lon], {
      icon: L.divIcon({
        html:`<div style="width:12px;height:12px;background:${pulseColor};border-radius:50%;box-shadow:0 0 12px ${pulseColor},0 0 24px ${pulseColor}40;animation:pulse-conflict 2s infinite"></div>`,
        className:'', iconSize:[12,12], iconAnchor:[6,6]
      })
    });

    marker.bindTooltip(`⚔️ ${c.name} — ${c.status}`, {className:'dark-tooltip', direction:'top', offset:[0,-8]});
    marker.on('click', () => {
      document.getElementById('pTitle').textContent = c.name;
      document.getElementById('pBody').innerHTML = `
        <div style="margin-bottom:6px"><span style="font-size:10px;padding:2px 8px;border-radius:2px;font-weight:700;font-family:'Share Tech Mono',monospace;background:${c.color}18;color:${c.color};border:1px solid ${c.color}40">${c.status}</span></div>
        <div class="f"><span class="k">Parties: </span><span class="v">${c.parties}</span></div>
        <div class="f"><span class="k">Since: </span><span class="v">${c.since}</span></div>
        <div class="f"><span class="k">Intensity: </span><span class="v" style="color:${c.color}">${c.intensity}</span></div>
        <div style="margin-top:6px;font-size:10px;color:var(--text);line-height:1.5">${c.summary}</div>
        <div style="margin-top:8px">
          <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Hotspots</div>
          ${c.hotspots.map(h=>`<span style="display:inline-block;font-size:10px;padding:2px 6px;margin:2px;background:rgba(0,255,65,.05);border:1px solid rgba(0,255,65,.12);border-radius:2px;color:var(--text)">${h}</span>`).join('')}
        </div>
      `;
      document.getElementById('infoP').classList.add('vis');
    });

    conflictLayer.addLayer(circle);
    conflictLayer.addLayer(marker);
  });
}

// ════════════════════════════════════════
// NAVAL DEPLOYMENTS
// ════════════════════════════════════════
const NAVAL_CAPS = {
  CSG: {name:'Carrier Strike Group', desc:'The most powerful conventional naval force projection unit. Centers on a nuclear-powered aircraft carrier with an embarked air wing, protected by cruisers, destroyers, and submarines.',
    composition:'1x Aircraft Carrier (CVN), 1-2x Cruiser (CG), 2-3x Destroyer (DDG), 1-2x SSN Attack Sub, 1x Supply Ship',
    airWing:'~75 aircraft: F/A-18E/F Super Hornets, EA-18G Growlers, E-2D Hawkeye, MH-60R/S Seahawks, CMV-22 Osprey',
    capabilities:'Power projection (1,000+ nmi strike radius), air superiority, anti-submarine warfare, cruise missile strike (Tomahawk), ballistic missile defense (Aegis), ISR, humanitarian assistance'},
  ARG: {name:'Amphibious Ready Group', desc:'Expeditionary force designed to project Marine combat power ashore. Carries a Marine Expeditionary Unit (MEU) with ~2,200 Marines.',
    composition:'1x LHD/LHA Amphibious Assault Ship, 1x LPD San Antonio-class, 1x LSD Whidbey Island-class',
    airWing:'AV-8B Harriers or F-35B, MV-22 Osprey, CH-53E Super Stallion, AH-1Z Viper, UH-1Y Venom',
    capabilities:'Amphibious assault, vertical envelopment, special operations, non-combatant evacuation (NEO), humanitarian aid, crisis response'},
  SSBN: {name:'Ballistic Missile Submarine (SSBN)', desc:'Strategic nuclear deterrent. Ohio-class SSBNs carry up to 20 Trident II D5 SLBMs. The most survivable leg of the nuclear triad.',
    composition:'1x Ohio-class SSBN (14 active)',
    airWing:'N/A — submarine',
    capabilities:'Strategic nuclear deterrence (each sub carries ~90 nuclear warheads), virtually undetectable when submerged, 70+ day patrols'},
  FLEET: {name:'Naval Fleet / Task Force', desc:'Major naval formation comprising multiple warship classes. Composition varies by nation and mission.',
    composition:'Varies — carriers, cruisers, destroyers, frigates, submarines, support ships',
    airWing:'Varies by fleet composition',
    capabilities:'Sea control, power projection, anti-access/area denial, submarine warfare, mine warfare, amphibious operations'},
};

let NAVAL_DEPLOYMENTS = [
  // US Carrier Strike Groups
  {name:'CSG-3 — USS Abraham Lincoln (CVN-72)', type:'CSG', country:'us', status:'deployed',
   lat:25.5, lon:57.2, region:'PERSIAN GULF / ARABIAN SEA',
   ships:'CVN-72 Lincoln, CG-52 Bunker Hill, DDG-92 Momsen, DDG-114 Ralph Johnson',
   notes:'Forward deployed — 5th Fleet AOR'},
  {name:'CSG-5 — USS Ronald Reagan (CVN-76)', type:'CSG', country:'us', status:'deployed',
   lat:22.3, lon:131.5, region:'WESTERN PACIFIC',
   ships:'CVN-76 Reagan, CG-54 Antietam, DDG-85 McCampbell, DDG-89 Mustin',
   notes:'Forward deployed Yokosuka — 7th Fleet'},
  {name:'CSG-12 — USS Gerald R. Ford (CVN-78)', type:'CSG', country:'us', status:'deployed',
   lat:34.8, lon:28.5, region:'EASTERN MEDITERRANEAN',
   ships:'CVN-78 Ford, CG-66 Hue City, DDG-104 Sterett, DDG-110 William P. Lawrence',
   notes:'Eastern Med deterrence patrol'},
  {name:'CSG-9 — USS Nimitz (CVN-68)', type:'CSG', country:'us', status:'transit',
   lat:8.2, lon:73.5, region:'INDIAN OCEAN',
   ships:'CVN-68 Nimitz, CG-57 Lake Champlain, DDG-76 Higgins',
   notes:'Transit to CENTCOM AOR'},

  // Amphibious Ready Groups
  {name:'ARG — USS Bataan (LHD-5)', type:'ARG', country:'us', status:'deployed',
   lat:12.5, lon:44.3, region:'RED SEA / GULF OF ADEN',
   ships:'LHD-5 Bataan, LPD-23 Anchorage, LSD-50 Carter Hall + 26th MEU',
   notes:'Houthi threat response — force protection'},
  {name:'ARG — USS Boxer (LHD-4)', type:'ARG', country:'us', status:'port',
   lat:32.7, lon:-117.2, region:'SAN DIEGO',
   ships:'LHD-4 Boxer, LPD-27 Portland',
   notes:'Maintenance period'},

  // SSBNs (approximate patrol areas — not exact)
  {name:'SSBN Patrol — Atlantic', type:'SSBN', country:'us', status:'deployed',
   lat:45.0, lon:-30.0, region:'NORTH ATLANTIC',
   ships:'Ohio-class SSBN (undisclosed)',
   notes:'Strategic deterrence patrol'},
  {name:'SSBN Patrol — Pacific', type:'SSBN', country:'us', status:'deployed',
   lat:35.0, lon:170.0, region:'PACIFIC',
   ships:'Ohio-class SSBN (undisclosed)',
   notes:'Strategic deterrence patrol'},

  // Adversary Naval
  {name:'🇷🇺 Northern Fleet — Severomorsk', type:'FLEET', country:'russia', status:'combat',
   lat:69.1, lon:33.4, region:'BARENTS SEA',
   ships:'Adm. Kuznetsov (CV), Pyotr Velikiy (CGN), multiple SSNs',
   notes:'Increased submarine activity — NATO monitoring'},
  {name:'🇷🇺 Black Sea Fleet', type:'FLEET', country:'russia', status:'combat',
   lat:44.6, lon:33.5, region:'BLACK SEA / SEVASTOPOL',
   ships:'Reduced force — losses to Ukrainian strikes',
   notes:'Severely degraded — limited ops capability'},
  {name:'🇨🇳 PLA Navy — South Sea Fleet', type:'FLEET', country:'china', status:'deployed',
   lat:18.2, lon:109.5, region:'SOUTH CHINA SEA',
   ships:'Type 003 Fujian (CV), Type 055 destroyers, Type 093 SSN',
   notes:'SCS patrol + Taiwan contingency readiness'},
  {name:'🇮🇷 IRIN — Bandar Abbas', type:'FLEET', country:'iran', status:'deployed',
   lat:27.2, lon:56.3, region:'STRAIT OF HORMUZ',
   ships:'Frigates, fast attack craft, Ghadir-class submarines',
   notes:'Strait of Hormuz area denial posture'},
];

let CHOKEPOINTS = [
  {name:'Strait of Hormuz', status:'ELEVATED', color:'var(--red)', lat:26.6, lon:56.3,
   note:'Iranian naval posturing — IRGCN fast boats active'},
  {name:'Bab el-Mandeb', status:'HIGH RISK', color:'var(--red)', lat:12.6, lon:43.3,
   note:'Houthi anti-ship missile/drone threat — coalition patrols active'},
  {name:'Taiwan Strait', status:'WATCH', color:'var(--yellow)', lat:24.5, lon:119.5,
   note:'PLA Navy exercises — US transits ongoing'},
  {name:'Suez Canal', status:'NORMAL', color:'var(--accent)', lat:30.5, lon:32.3,
   note:'Operating normally — traffic diversions from Red Sea'},
  {name:'GIUK Gap', status:'WATCH', color:'var(--yellow)', lat:62.0, lon:-15.0,
   note:'Russian submarine transit monitoring — P-8 patrols'},
  {name:'Malacca Strait', status:'NORMAL', color:'var(--accent)', lat:2.5, lon:101.5,
   note:'Normal commercial traffic'},
];

let navalLayer = L.layerGroup().addTo(map);
let navalVisible = true;

function toggleNavalLayer(){
  navalVisible = !navalVisible;
  const btn = document.getElementById('btn-naval');
  if(navalVisible){
    navalLayer.addTo(map);
    btn.classList.add('on');
    btn.textContent = '🚢 Naval';
  } else {
    map.removeLayer(navalLayer);
    btn.classList.remove('on');
    btn.textContent = '🚢 Naval';
  }
  renderNaval();
}

function renderNaval(){
  navalLayer.clearLayers();
  const pane = document.getElementById('pane-naval');
  if(!pane) return;

  // Map markers for deployments
  const shipIcon = (country) => {
    const col = country==='us' ? '#00ff41' : country==='russia' ? '#dc2626' : country==='china' ? '#e5ff00' : country==='iran' ? '#ff2040' : '#bf5fff';
    return L.divIcon({
      html:`<div style="color:${col};font-size:16px;text-shadow:0 0 8px ${col}80;cursor:pointer">⚓</div>`,
      className:'', iconSize:[16,16], iconAnchor:[8,8]
    });
  };

  if(navalVisible){
    NAVAL_DEPLOYMENTS.forEach(d => {
      const m = L.marker([d.lat, d.lon], {icon: shipIcon(d.country)})
        .bindTooltip(d.name, {className:'dark-tooltip', direction:'top', offset:[0,-8]});
      m.on('click', () => {
        document.getElementById('pTitle').textContent = d.name;
        const capInfo = NAVAL_CAPS[d.type] || null;
        let capHtml = '';
        if(capInfo){
          capHtml = `<div style="margin-top:8px;padding:8px;background:rgba(0,255,65,.04);border:1px solid rgba(0,255,65,.12);border-radius:2px">
            <div style="font-size:11px;font-weight:700;color:var(--accent);font-family:'Share Tech Mono',monospace;margin-bottom:4px">${capInfo.name}</div>
            <div style="font-size:10px;color:var(--text);margin-bottom:4px;line-height:1.4">${capInfo.desc}</div>
            <div class="f"><span class="k">Composition: </span><span class="v" style="line-height:1.4">${capInfo.composition}</span></div>
            <div class="f"><span class="k">Air Wing: </span><span class="v" style="line-height:1.4">${capInfo.airWing||'N/A'}</span></div>
            <div class="f"><span class="k">Capabilities: </span><span class="v" style="line-height:1.4">${capInfo.capabilities}</span></div>
          </div>`;
        }
        document.getElementById('pBody').innerHTML = `
          <div class="f"><span class="k">Type: </span><span class="v">${d.type}</span></div>
          <div class="f"><span class="k">Region: </span><span class="v">${d.region}</span></div>
          <div class="f"><span class="k">Ships: </span><span class="v" style="line-height:1.4">${d.ships}</span></div>
          <div class="f"><span class="k">Notes: </span><span class="v">${d.notes}</span></div>
          ${capHtml}
        `;
        document.getElementById('infoP').classList.add('vis');
      });
      navalLayer.addLayer(m);
    });

    // Chokepoint markers
    CHOKEPOINTS.forEach(c => {
      const m = L.circleMarker([c.lat, c.lon], {
        radius: 8, fillColor: c.status==='HIGH RISK'||c.status==='ELEVATED' ? '#ff2040' : c.status==='WATCH' ? '#e5ff00' : '#00ff41',
        fillOpacity: 0.3, color: c.status==='HIGH RISK'||c.status==='ELEVATED' ? '#ff2040' : c.status==='WATCH' ? '#e5ff00' : '#00ff41',
        weight: 2, opacity: 0.6
      }).bindTooltip(`⚠ ${c.name}: ${c.status}`, {className:'dark-tooltip', direction:'top'});
      navalLayer.addLayer(m);
    });
  }

  // Widget content
  const countEl = document.getElementById('naval-count');
  if(countEl) countEl.textContent = NAVAL_DEPLOYMENTS.length + ' assets';

  let h = '';
  // Chokepoints section
  h += `<div class="rp-section">⚠️ CHOKEPOINTS</div>`;
  CHOKEPOINTS.forEach(c => {
    const scol = c.status==='HIGH RISK'||c.status==='ELEVATED' ? 'var(--red)' : c.status==='WATCH' ? 'var(--yellow)' : 'var(--accent)';
    h += `<div class="naval-chokepoint" onclick="goTo(${c.lat},${c.lon},6)" style="cursor:pointer">
      <span class="nc-name">${c.name}</span>
      <span class="nc-status" style="color:${scol}">${c.status}</span>
    </div>`;
  });

  // Deployments section
  h += `<div class="rp-section">🚢 CARRIER STRIKE GROUPS & FLEETS</div>`;
  NAVAL_DEPLOYMENTS.forEach(d => {
    const scls = d.status==='combat' ? 'combat' : d.status==='deployed' ? 'deployed' : d.status==='transit' ? 'transit' : 'port';
    h += `<div class="naval-group" onclick="map.setView([${d.lat},${d.lon}],6)">
      <div class="ng-header">
        <span class="ng-name">${d.name}</span>
        <span class="ng-status ${scls}">${d.status.toUpperCase()}</span>
      </div>
      <div class="ng-region">📍 ${d.region}</div>
      <div class="ng-ships">${d.ships}</div>
    </div>`;
  });

  pane.innerHTML = h;
}

// ════════════════════════════════════════
// ZULU CLOCK BAR
// ════════════════════════════════════════
function updateClocks(){
  const now = new Date();
  const fmt = (tz, h24=true) => now.toLocaleTimeString('en-GB',{timeZone:tz,hour:'2-digit',minute:'2-digit',second:h24?'2-digit':undefined,hour12:false});
  const fmtS = (tz) => now.toLocaleTimeString('en-GB',{timeZone:tz,hour:'2-digit',minute:'2-digit',hour12:false});
  document.getElementById('clk-zulu').textContent = fmt('UTC') + 'Z';
  document.getElementById('clk-dc').textContent = fmtS('America/New_York');
  document.getElementById('clk-kyiv').textContent = fmtS('Europe/Kyiv');
  document.getElementById('clk-moscow').textContent = fmtS('Europe/Moscow');
  document.getElementById('clk-tehran').textContent = fmtS('Asia/Tehran');
  document.getElementById('clk-beijing').textContent = fmtS('Asia/Shanghai');
  const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  const days = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
  document.getElementById('clk-date').textContent = `${days[now.getUTCDay()]} ${now.getUTCDate()} ${months[now.getUTCMonth()]} ${now.getUTCFullYear()}`;
}
updateClocks();
setInterval(updateClocks, 1000);

// ════════════════════════════════════════
// AUDIO ALERT SYSTEM
// ════════════════════════════════════════
let audioEnabled = false;
let audioCtx = null;
let prevAdvCount = 0;
let prevThreatLevel = 5;

function toggleAudio(){
  audioEnabled = !audioEnabled;
  const btn = document.getElementById('btn-audio');
  if(audioEnabled){
    btn.classList.add('on');
    btn.textContent = '🔊 Sound';
    // Init AudioContext on user gesture
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    playTone('confirm');
  } else {
    btn.classList.remove('on');
    btn.textContent = '🔇 Sound';
  }
}

function playTone(type){
  if(!audioEnabled || !audioCtx) return;
  try {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    switch(type){
      case 'confirm': // Short blip — toggle confirmation
        osc.type = 'sine';
        osc.frequency.value = 800;
        gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
        osc.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime + 0.15);
        break;
      case 'adversary': // Two-tone alert — new adversary aircraft
        osc.type = 'square';
        osc.frequency.value = 600;
        gain.gain.setValueAtTime(0.12, audioCtx.currentTime);
        osc.frequency.setValueAtTime(800, audioCtx.currentTime + 0.15);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.4);
        osc.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime + 0.4);
        break;
      case 'threat-up': // Rising alarm — threat level increased
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(300, audioCtx.currentTime);
        osc.frequency.linearRampToValueAtTime(900, audioCtx.currentTime + 0.5);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.6);
        osc.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime + 0.6);
        break;
      case 'data': // Soft blip — new data received
        osc.type = 'sine';
        osc.frequency.value = 1200;
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.08);
        osc.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime + 0.08);
        break;
    }
  } catch(e){ console.warn('[AUDIO]', e.message); }
}

function checkAudioAlerts(visible){
  if(!audioEnabled) return;
  const advNow = visible.filter(a=>['iran','russia','china'].includes(getGroup(a.hex))).length;
  const { pct } = computeThreat(visible);
  const defconNow = pct >= 80 ? 1 : pct >= 60 ? 2 : pct >= 40 ? 3 : pct >= 20 ? 4 : 5;

  // New adversary aircraft detected
  if(advNow > prevAdvCount && prevAdvCount >= 0){
    playTone('adversary');
  }
  // Threat level increased (lower DEFCON = higher threat)
  if(defconNow < prevThreatLevel){
    playTone('threat-up');
  }

  prevAdvCount = advNow;
  prevThreatLevel = defconNow;
}

// ════════════════════════════════════════
// DAILY BRIEFING MODE
// ════════════════════════════════════════
function showBriefing(){
  const now = new Date();
  const zuluStr = now.toUTCString();
  const visible = acData.filter(a=>a.lat);
  const usCount = visible.filter(a=>getGroup(a.hex)==='us').length;
  const advCount = visible.filter(a=>['iran','russia','china'].includes(getGroup(a.hex))).length;
  const alliedCount = visible.filter(a=>getGroup(a.hex)==='allied').length;
  const { pct } = computeThreat(visible);
  const defcon = pct >= 80 ? 1 : pct >= 60 ? 2 : pct >= 40 ? 3 : pct >= 20 ? 4 : 5;
  const defconCol = defcon<=2?'#ef4444':defcon===3?'#f97316':defcon===4?'#eab308':'#00ff41';

  // Count by type
  const types = {};
  visible.forEach(a => { const t = classifyType(a); types[t] = (types[t]||0)+1; });

  // Active chokepoints
  const hotChokepoints = CHOKEPOINTS.filter(c=>c.status!=='NORMAL');
  const activeConflicts = CONFLICTS.filter(c=>c.intensity==='HIGH'||c.intensity==='MEDIUM');

  let h = '';

  // Header
  h += `<div style="text-align:center;margin-bottom:16px">
    <div style="font-size:10px;color:var(--muted);font-family:'Share Tech Mono',monospace;letter-spacing:2px">GENERATED ${zuluStr}</div>
    <div style="font-size:24px;font-weight:800;color:${defconCol};font-family:'Orbitron',monospace;margin:8px 0;letter-spacing:3px;text-shadow:0 0 20px ${defconCol}60">DEFCON ${defcon}</div>
    <div style="font-size:11px;color:var(--muted)">Threat Index: ${pct}/100</div>
  </div>`;

  // Force posture
  h += `<div class="brief-section"><h3>🛩️ Force Posture</h3>
    <div class="brief-stat"><span class="bs-label">Total Tracked Aircraft</span><span class="bs-value">${visible.length}</span></div>
    <div class="brief-stat"><span class="bs-label">🇺🇸 US Military</span><span class="bs-value">${usCount}</span></div>
    <div class="brief-stat"><span class="bs-label">🤝 Allied</span><span class="bs-value">${alliedCount}</span></div>
    <div class="brief-stat"><span class="bs-label">⚔️ Adversary</span><span class="bs-value" style="color:${advCount>0?'#ef4444':'var(--accent)'}">${advCount}</span></div>
    ${Object.entries(types).filter(([k])=>k!=='other').map(([k,v])=>`<div class="brief-stat"><span class="bs-label">${TICO[k]||''} ${TLAB[k]||k}</span><span class="bs-value">${v}</span></div>`).join('')}
  </div>`;

  // Active conflicts
  h += `<div class="brief-section"><h3>⚔️ Active Conflicts (${activeConflicts.length})</h3>`;
  activeConflicts.forEach(c => {
    const col = c.intensity==='HIGH'?'#ef4444':'#f97316';
    h += `<div style="padding:6px 0;border-bottom:1px solid rgba(0,255,65,.04)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:11px;color:var(--text);font-weight:700">${c.name}</span>
        <span style="font-size:9px;padding:1px 6px;border-radius:2px;background:${col}18;color:${col};border:1px solid ${col}40;font-weight:700">${c.status}</span>
      </div>
      <div style="font-size:10px;color:var(--muted);margin-top:2px">${c.parties}</div>
    </div>`;
  });
  h += `</div>`;

  // Chokepoints
  h += `<div class="brief-section"><h3>🚢 Maritime Chokepoints</h3>`;
  CHOKEPOINTS.forEach(c => {
    const col = c.status==='HIGH RISK'||c.status==='ELEVATED'?'#ef4444':c.status==='WATCH'?'#eab308':'var(--accent)';
    h += `<div class="brief-stat"><span class="bs-label">${c.name}</span><span class="bs-value" style="color:${col}">${c.status}</span></div>`;
  });
  h += `</div>`;

  // Naval deployments summary
  const deployedNaval = NAVAL_DEPLOYMENTS.filter(d=>d.status!=='port');
  h += `<div class="brief-section"><h3>⚓ Naval Deployments (${deployedNaval.length} active)</h3>`;
  deployedNaval.forEach(d => {
    const scol = d.status==='combat'?'#ef4444':d.status==='deployed'?'var(--accent)':'#eab308';
    h += `<div class="brief-stat"><span class="bs-label">${d.name.split('—')[0].trim()}</span><span class="bs-value" style="color:${scol}">${d.region}</span></div>`;
  });
  h += `</div>`;

  // Upcoming launches
  if(launchData.length){
    h += `<div class="brief-section"><h3>🚀 Upcoming Launches</h3>`;
    launchData.slice(0,4).forEach(l => {
      const net = l.net ? new Date(l.net) : null;
      const dateStr = net ? net.toISOString().slice(0,10) : '?';
      const isMil = /military|classified|nrol|spy|recon|gps|sbirs|wgs|muos|defense/i.test(l.name+(l.mission?.description||''));
      h += `<div class="brief-stat"><span class="bs-label">${isMil?'🎖️':'🚀'} ${l.name}</span><span class="bs-value">${dateStr}</span></div>`;
    });
    h += `</div>`;
  }

  // Earthquakes summary
  if(quakeData.length){
    const bigQuakes = quakeData.filter(q=>q.properties.mag>=5);
    h += `<div class="brief-section"><h3>🌍 Seismic Activity (24h)</h3>
      <div class="brief-stat"><span class="bs-label">Total Earthquakes (M2.5+)</span><span class="bs-value">${quakeData.length}</span></div>
      <div class="brief-stat"><span class="bs-label">Significant (M5+)</span><span class="bs-value" style="color:${bigQuakes.length>0?'#f97316':'var(--accent)'}">${bigQuakes.length}</span></div>`;
    bigQuakes.slice(0,3).forEach(q => {
      h += `<div class="brief-stat"><span class="bs-label">M${q.properties.mag.toFixed(1)} — ${q.properties.place}</span><span class="bs-value">${new Date(q.properties.time).toISOString().slice(11,16)}Z</span></div>`;
    });
    h += `</div>`;
  }

  // Classification footer
  h += `<div style="text-align:center;margin-top:16px;padding-top:12px;border-top:1px solid rgba(0,255,65,.1)">
    <div style="font-size:9px;color:var(--muted);font-family:'Share Tech Mono',monospace;letter-spacing:2px">⚠️ UNCLASSIFIED // OSINT ONLY</div>
    <div style="font-size:9px;color:var(--muted);margin-top:4px">PIKECLAW MILITARY OSINT TERMINAL v3.1</div>
  </div>`;

  document.getElementById('briefBody').innerHTML = h;
  document.getElementById('briefOverlay').classList.add('vis');
}

function closeBriefing(){
  document.getElementById('briefOverlay').classList.remove('vis');
}

// ════════════════════════════════════════
// ISS + TIANGONG LIVE TRACKER
// ════════════════════════════════════════
let issMarker = null;
let issTrail = [];
const ISS_MAX_TRAIL = 80;

async function fetchISS(){
  try {
    const res = await fetch('http://api.open-notify.org/iss-now.json');
    if(!res.ok) throw new Error('HTTP '+res.status);
    const d = await res.json();
    const lat = parseFloat(d.iss_position.latitude);
    const lon = parseFloat(d.iss_position.longitude);

    if(!issMarker){
      issMarker = L.marker([lat, lon], {
        icon: L.divIcon({
          html:`<div style="position:relative">
            <div style="font-size:18px;filter:drop-shadow(0 0 8px rgba(0,200,255,.8))">🛰️</div>
            <div style="position:absolute;top:-4px;left:-4px;width:26px;height:26px;border:1px solid rgba(0,200,255,.3);border-radius:50%;animation:iss-orbit 3s linear infinite"></div>
          </div>`,
          className:'', iconSize:[18,18], iconAnchor:[9,9]
        }),
        zIndexOffset: 10000
      }).addTo(map);
      issMarker.bindTooltip('🛰️ ISS — International Space Station', {className:'dark-tooltip', direction:'top', offset:[0,-12]});
      issMarker.on('click', async () => {
        document.getElementById('pTitle').textContent = '🛰️ International Space Station';
        let crewHtml = '<span style="color:var(--muted)">Loading crew...</span>';
        try {
          const cr = await fetch('http://api.open-notify.org/astros.json');
          const cd = await cr.json();
          const issCrew = cd.people.filter(p=>p.craft==='ISS');
          const tiangongCrew = cd.people.filter(p=>p.craft==='Tiangong');
          crewHtml = `<div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">ISS Crew (${issCrew.length})</div>` +
            issCrew.map(p=>`<span style="display:inline-block;font-size:10px;padding:2px 6px;margin:2px;background:rgba(0,255,65,.05);border:1px solid rgba(0,255,65,.12);border-radius:2px;color:var(--text)">${p.name}</span>`).join('') +
            (tiangongCrew.length ? `<div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin:8px 0 4px">Tiangong Crew (${tiangongCrew.length})</div>` +
            tiangongCrew.map(p=>`<span style="display:inline-block;font-size:10px;padding:2px 6px;margin:2px;background:rgba(229,255,0,.05);border:1px solid rgba(229,255,0,.12);border-radius:2px;color:var(--text)">${p.name}</span>`).join('') : '') +
            `<div style="margin-top:6px;font-size:10px;color:var(--accent)">${cd.number} humans in space right now</div>`;
        } catch(e){}
        document.getElementById('pBody').innerHTML = `
          <div class="f"><span class="k">Position: </span><span class="v">${lat.toFixed(4)}°, ${lon.toFixed(4)}°</span></div>
          <div class="f"><span class="k">Altitude: </span><span class="v">~408 km (LEO)</span></div>
          <div class="f"><span class="k">Speed: </span><span class="v">~27,600 km/h (7.66 km/s)</span></div>
          <div class="f"><span class="k">Orbit Period: </span><span class="v">~92 minutes</span></div>
          <div style="margin-top:8px">${crewHtml}</div>
        `;
        document.getElementById('infoP').classList.add('vis');
      });
    } else {
      issMarker.setLatLng([lat, lon]);
    }

    // Trail
    issTrail.push([lat, lon]);
    if(issTrail.length > ISS_MAX_TRAIL) issTrail.shift();
    if(window._issTrailLine) map.removeLayer(window._issTrailLine);
    window._issTrailLine = L.polyline(issTrail, {color:'rgba(0,200,255,.3)', weight:1.5, dashArray:'4 6'}).addTo(map);

  } catch(e){
    console.warn('[ISS] Failed:', e.message);
  }
}

// Update ISS every 5 seconds
fetchISS();
setInterval(fetchISS, 5000);

// ════════════════════════════════════════
// SPACE LAUNCH TRACKER (TheSpaceDevs API)
// ════════════════════════════════════════
let launchData = [];

async function fetchLaunches(){
  try {
    const res = await fetch('https://ll.thespacedevs.com/2.2.0/launch/upcoming/?limit=8&format=json');
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    launchData = data.results || [];
    renderLaunches();
  } catch(e){
    console.warn('[LAUNCH] Failed:', e.message);
    // Fallback: try rocketlaunch.live
    try {
      const res2 = await fetch('https://fdo.rocketlaunch.live/json/launches/next/8');
      if(!res2.ok) throw new Error('HTTP '+res2.status);
      const data2 = await res2.json();
      launchData = (data2.result||[]).map(r=>({
        name: r.name,
        net: r.sort_date ? new Date(r.sort_date*1000).toISOString() : null,
        launch_service_provider: {name: r.provider?.name||'Unknown'},
        pad: {location:{name: r.pad?.location?.name||'Unknown'}},
        status: {abbrev: r.launch_description||'Go'},
        mission: {description: r.missions?.[0]?.description||'', type: r.missions?.[0]?.name||''}
      }));
      renderLaunches();
    } catch(e2){
      console.warn('[LAUNCH] Fallback also failed:', e2.message);
    }
  }
}

function renderLaunches(){
  const el = document.getElementById('launchStrip');
  const countEl = document.getElementById('launch-count');
  if(!el) return;
  if(countEl) countEl.textContent = launchData.length + ' upcoming';

  let h = '';
  launchData.forEach(l => {
    const net = l.net ? new Date(l.net) : null;
    let countdown = '';
    let countdownClass = '';
    if(net){
      const diff = net - Date.now();
      if(diff > 0){
        const hrs = Math.floor(diff/3600000);
        const mins = Math.floor((diff%3600000)/60000);
        if(hrs < 24){
          countdown = `T-${hrs}h ${mins}m`;
          countdownClass = 'launch-countdown';
        } else {
          const days = Math.floor(hrs/24);
          countdown = `T-${days}d ${hrs%24}h`;
        }
      } else {
        countdown = 'LAUNCHED';
        countdownClass = '';
      }
    }

    const provider = l.launch_service_provider?.name || '?';
    const loc = l.pad?.location?.name || '?';
    const status = l.status?.abbrev || 'Go';
    const statusCol = status==='Go' || status==='TBD' ? 'var(--accent)' : status==='TBC' ? 'var(--yellow)' : '#ef4444';
    const isMilitary = /military|classified|nrol|spy|recon|gps|sbirs|wgs|muos|defense/i.test(l.name + (l.mission?.description||''));

    h += `<div style="padding:6px 10px;border-bottom:1px solid rgba(0,255,65,.06);cursor:pointer" onclick="this.querySelector('.launch-detail')?.classList.toggle('vis')">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:4px">
        <span style="font-size:10px;color:${isMilitary?'#f97316':'var(--text)'};font-weight:700;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${isMilitary?'🎖️':'🚀'} ${l.name}</span>
        <span class="${countdownClass}" style="font-size:10px;font-weight:700;color:var(--accent);font-family:'Orbitron',monospace;letter-spacing:1px;white-space:nowrap">${countdown}</span>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--muted);margin-top:2px">
        <span>${provider}</span>
        <span style="color:${statusCol}">${status}</span>
      </div>
    </div>`;
  });

  el.innerHTML = h || '<div style="padding:12px;color:var(--muted);font-size:10px">No launches found</div>';
}

// Update countdowns every 30s
setInterval(renderLaunches, 30000);

// ════════════════════════════════════════
// CURRENCY / SANCTIONS WATCH
// ════════════════════════════════════════
const FX_PAIRS = [
  {code:'RUB', label:'🇷🇺 USD/RUB', name:'Russian Ruble', note:'Sanctions pressure indicator'},
  {code:'CNY', label:'🇨🇳 USD/CNY', name:'Chinese Yuan', note:'Trade war barometer'},
  {code:'IRR', label:'🇮🇷 USD/IRR', name:'Iranian Rial', note:'Sanctions impact gauge'},
  {code:'EUR', label:'🇪🇺 USD/EUR', name:'Euro', note:'Western economic baseline'},
  {code:'GBP', label:'🇬🇧 USD/GBP', name:'British Pound', note:'NATO ally benchmark'},
  {code:'UAH', label:'🇺🇦 USD/UAH', name:'Ukrainian Hryvnia', note:'War economy indicator'},
  {code:'KRW', label:'🇰🇷 USD/KRW', name:'S. Korean Won', note:'Peninsula stability gauge'},
  {code:'TWD', label:'🇹🇼 USD/TWD', name:'Taiwan Dollar', note:'Strait tension proxy'},
];

let prevRates = {};

async function fetchCurrency(){
  try {
    const res = await fetch('https://open.er-api.com/v6/latest/USD');
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    renderCurrency(data.rates || {});
  } catch(e){
    console.warn('[FX] Failed:', e.message);
  }
}

function renderCurrency(rates){
  const el = document.getElementById('currencyStrip');
  if(!el) return;

  let h = '';
  FX_PAIRS.forEach(p => {
    const rate = rates[p.code];
    if(rate === undefined) return;
    const prev = prevRates[p.code];
    const change = prev ? ((rate - prev) / prev * 100) : 0;
    const arrow = change > 0.01 ? '▲' : change < -0.01 ? '▼' : '►';
    const changeCol = change > 0.01 ? '#ef4444' : change < -0.01 ? '#00ff41' : 'var(--muted)';
    const flashClass = prev && Math.abs(change) > 0.01 ? 'currency-updated' : '';

    h += `<div class="${flashClass}" style="padding:5px 10px;border-bottom:1px solid rgba(0,255,65,.06);display:flex;justify-content:space-between;align-items:center" title="${p.note}">
      <div>
        <div style="font-size:10px;color:var(--text);font-weight:700">${p.label}</div>
        <div style="font-size:8px;color:var(--muted)">${p.note}</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:11px;font-weight:700;color:var(--accent);font-family:'Share Tech Mono',monospace">${rate < 100 ? rate.toFixed(4) : rate.toFixed(1)}</div>
        <div style="font-size:9px;color:${changeCol};font-family:'Share Tech Mono',monospace">${arrow} ${Math.abs(change).toFixed(2)}%</div>
      </div>
    </div>`;
  });

  el.innerHTML = h || '<div style="padding:12px;color:var(--muted);font-size:10px">Loading rates...</div>';
  prevRates = {...rates};
}

// ════════════════════════════════════════
// ════════════════════════════════════════
// CENTCOM ASSETS WIDGET
// ════════════════════════════════════════
function renderCentcom(data){
  const pane = document.getElementById('pane-centcom');
  if(!pane || !data) return;

  // Update header badges
  const trEl = document.getElementById('centcom-troops');
  if(trEl) trEl.textContent = (data.troops_total||'~40,000') + ' troops';
  const upEl = document.getElementById('centcom-updated');
  if(upEl) upEl.textContent = 'UPDATED ' + (data.updated||'');

  // Build three columns: Naval | Air | Ground
  const cols = [
    { icon:'⚓', label:'NAVAL ASSETS', key:'naval', badge:'naval',
      items: (data.naval||[]).map(a=>({
        name: a.name,
        sub: a.escorts ? `${a.type} — ${a.escorts}` : a.type,
        detail: a.airwing || '',
        meta: [a.location, a.personnel ? a.personnel+' pax' : ''].filter(Boolean),
        notes: a.notes,
        lat: a.lat, lon: a.lon,
        status: a.status,
        full: a
      }))
    },
    { icon:'✈️', label:'AIR ASSETS', key:'air', badge:'air',
      items: (data.air||[]).map(a=>({
        name: a.name,
        sub: a.aircraft,
        detail: a.units || '',
        meta: [a.country, a.personnel ? a.personnel+' pax' : ''].filter(Boolean),
        notes: a.notes,
        lat: a.lat, lon: a.lon,
        status: 'deployed',
        full: a
      }))
    },
    { icon:'🪖', label:'GROUND FORCES', key:'ground', badge:'ground',
      items: (data.ground||[]).map(a=>({
        name: a.name,
        sub: a.units,
        detail: '',
        meta: [a.country, a.personnel ? a.personnel+' pax' : ''].filter(Boolean),
        notes: a.notes,
        lat: a.lat, lon: a.lon,
        status: 'deployed',
        full: a
      }))
    }
  ];

  let html = '';
  cols.forEach(col => {
    html += `<div class="centcom-col">
      <div class="centcom-col-head">${col.icon} ${col.label} <span class="ca-badge ${col.badge}">${col.items.length}</span></div>
      <div class="centcom-col-body">`;
    col.items.forEach((item, i) => {
      const statusCol = item.status==='deployed' ? 'var(--accent)' : item.status==='combat' ? 'var(--red)' : 'var(--yellow)';
      const metaStr = item.meta.join(' · ');
      html += `<div class="ca-item" onclick="showCentcomDetail(${col.key === 'naval' ? i : -1},'${col.key}',${i})">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:2px">
          <div class="ca-name">${item.name}</div>
          <div style="width:5px;height:5px;border-radius:50%;background:${statusCol};box-shadow:0 0 4px ${statusCol};flex-shrink:0"></div>
        </div>
        ${item.sub ? `<div class="ca-sub">${item.sub}</div>` : ''}
        ${item.detail ? `<div class="ca-meta" style="color:rgba(0,255,65,.45);margin-bottom:2px">${item.detail}</div>` : ''}
        <div class="ca-meta">
          ${metaStr ? `<span>${metaStr}</span>` : ''}
          ${item.notes ? `<span style="color:rgba(0,255,65,.35);font-style:italic">${item.notes}</span>` : ''}
        </div>
      </div>`;
    });
    html += `</div></div>`;
  });

  pane.innerHTML = html;

  // Store data for click-to-map
  pane._centcomData = data;
}

function showCentcomDetail(navalIdx, colKey, itemIdx){
  // Try to find coordinates and show on map
  const pane = document.getElementById('pane-centcom');
  if(!pane || !pane._centcomData) return;
  const data = pane._centcomData;
  const cols = {naval: data.naval||[], air: data.air||[], ground: data.ground||[]};
  const item = cols[colKey]?.[itemIdx];
  if(!item) return;

  if(item.lat && item.lon){
    map.setView([item.lat, item.lon], 6);
    document.getElementById('pTitle').textContent = item.name;
    const rows = [
      item.type       ? `<div class="f"><span class="k">Type: </span><span class="v">${item.type}</span></div>` : '',
      item.units      ? `<div class="f"><span class="k">Units: </span><span class="v">${item.units}</span></div>` : '',
      item.aircraft   ? `<div class="f"><span class="k">Aircraft: </span><span class="v">${item.aircraft}</span></div>` : '',
      item.airwing    ? `<div class="f"><span class="k">Air Wing: </span><span class="v">${item.airwing}</span></div>` : '',
      item.escorts    ? `<div class="f"><span class="k">Escorts: </span><span class="v">${item.escorts}</span></div>` : '',
      item.personnel  ? `<div class="f"><span class="k">Personnel: </span><span class="v">${item.personnel}</span></div>` : '',
      item.country    ? `<div class="f"><span class="k">Country: </span><span class="v">${item.country}</span></div>` : '',
      item.location   ? `<div class="f"><span class="k">Location: </span><span class="v">${item.location}</span></div>` : '',
      item.notes      ? `<div class="f"><span class="k">Notes: </span><span class="v">${item.notes}</span></div>` : '',
    ].join('');
    document.getElementById('pBody').innerHTML = rows;
    document.getElementById('infoP').classList.add('vis');
  }
}

// INTEL DATA LOADER (from data/intel-data.json)
// ════════════════════════════════════════
async function loadIntelData(){
  try {
    const res = await fetch('data/intel-data.json?t='+Date.now());
    if(!res.ok) throw new Error('HTTP '+res.status);
    const d = await res.json();
    if(d.naval_deployments) NAVAL_DEPLOYMENTS = d.naval_deployments;
    if(d.chokepoints) CHOKEPOINTS = d.chokepoints;
    if(d.conflicts) CONFLICTS = d.conflicts;
    if(d.exercises) EXERCISES = d.exercises;
    if(d.gps_zones) GPS_ZONES = d.gps_zones;
    if(d.notams) NOTAMS = d.notams;
    if(d.centcom_assets) renderCentcom(d.centcom_assets);
    // Re-render active overlays
    renderNaval();
    if(conflictsVisible) renderConflicts();
    if(exercisesVisible) renderExercises();
    if(gpsVisible) renderGPSJam();
    if(notamsVisible) renderNOTAMs();
    console.log('[INTEL] Loaded intel-data.json, generated:', d.generated_utc);
  } catch(e){
    console.warn('[INTEL] Failed to load intel-data.json, using inline defaults:', e.message);
    renderNaval();
  }
}

fetchData();
fetchAllNews();
fetchPolymarket();
fetchLaunches();
fetchCurrency();
initXFeed();
renderAdvPanel('iran');
loadIntelData();
// Fix Leaflet map size on mobile after layout settles
setTimeout(() => map.invalidateSize(), 300);
setTimeout(() => map.invalidateSize(), 1000);
window.addEventListener('resize', () => map.invalidateSize());

setInterval(fetchData, 30000);
setInterval(fetchAllNews, 300000);
setInterval(fetchPolymarket, 300000);
setInterval(fetchLaunches, 600000);   // Launches every 10min
setInterval(fetchCurrency, 900000);   // FX rates every 15min
setInterval(() => { xPostCache={}; initXFeed(); }, 300000);
setInterval(loadIntelData, 1800000); // Reload intel data every 30min

switchTab('news');

// ════════════════════════════════════════
// 1. DAY/NIGHT TERMINATOR
// ════════════════════════════════════════
let terminatorLayer = null;
let terminatorVisible = false;

function getSolarTerminator(now){
  const dayOfYear = Math.floor((now - new Date(now.getFullYear(),0,0)) / 86400000);
  const declination = -23.44 * Math.cos(2 * Math.PI / 365 * (dayOfYear + 10));
  const decRad = declination * Math.PI / 180;
  const utcHours = now.getUTCHours() + now.getUTCMinutes()/60 + now.getUTCSeconds()/3600;
  const subSolarLon = (12 - utcHours) * 15;
  const pts = [];
  for(let lon = -180; lon <= 180; lon += 2){
    const lonRad = lon * Math.PI / 180;
    const subLonRad = subSolarLon * Math.PI / 180;
    const hourAngle = lonRad - subLonRad;
    const lat = Math.atan(-Math.cos(hourAngle) / Math.tan(decRad)) * 180 / Math.PI;
    pts.push([lat, lon]);
  }
  return pts;
}

function buildTerminatorPolygon(pts){
  // Night side: from terminator line to the pole that's in darkness
  const now = new Date();
  const dayOfYear = Math.floor((now - new Date(now.getFullYear(),0,0)) / 86400000);
  const declination = -23.44 * Math.cos(2 * Math.PI / 365 * (dayOfYear + 10));
  const nightPole = declination >= 0 ? -90 : 90;
  const poly = [...pts];
  poly.push([nightPole, 180]);
  poly.push([nightPole, -180]);
  return poly;
}

function updateTerminator(){
  if(!terminatorVisible) return;
  const pts = getSolarTerminator(new Date());
  const poly = buildTerminatorPolygon(pts);
  if(terminatorLayer) map.removeLayer(terminatorLayer);
  terminatorLayer = L.polygon(poly, {
    fillColor: '#000', fillOpacity: 0.35, stroke: true,
    color: 'rgba(0,255,65,.25)', weight: 1, dashArray: '4 4', interactive: false
  }).addTo(map);
}

function toggleTerminator(){
  terminatorVisible = !terminatorVisible;
  document.getElementById('btn-terminator').classList.toggle('on', terminatorVisible);
  if(terminatorVisible){
    updateTerminator();
  } else {
    if(terminatorLayer){ map.removeLayer(terminatorLayer); terminatorLayer = null; }
  }
}
setInterval(updateTerminator, 60000);

// ════════════════════════════════════════
// 2. CINEMA MODE / AUTOPILOT
// ════════════════════════════════════════
let cinemaActive = false;
let cinemaTimer = null;
const CINEMA_STOPS = [
  {lat:26.5, lon:56, z:6, label:'STRAIT OF HORMUZ'},
  {lat:48.5, lon:37.5, z:5, label:'UKRAINE THEATER'},
  {lat:24, lon:120, z:6, label:'TAIWAN STRAIT'},
  {lat:14.5, lon:42.5, z:6, label:'RED SEA / YEMEN'},
  {lat:33, lon:44, z:5, label:'IRAN-ISRAEL THEATER'},
  {lat:14.5, lon:115, z:5, label:'SOUTH CHINA SEA'},
  {lat:55, lon:37, z:4, label:'RUSSIAN WESTERN MD'},
  {lat:38, lon:127, z:6, label:'KOREAN PENINSULA'},
  {lat:20, lon:0, z:2, label:'GLOBAL OVERVIEW'},
];
let cinemaIdx = 0;

function toggleCinema(){
  cinemaActive = !cinemaActive;
  const btn = document.getElementById('btn-cinema');
  const label = document.getElementById('cinemaLabel');
  btn.classList.toggle('on', cinemaActive);
  if(cinemaActive){
    btn.textContent = '🎬 LIVE';
    label.classList.add('vis');
    cinemaStep();
    cinemaTimer = setInterval(cinemaStep, 15000);
  } else {
    btn.textContent = '🎬 Cinema';
    label.classList.remove('vis');
    if(cinemaTimer){ clearInterval(cinemaTimer); cinemaTimer = null; }
  }
}

function cinemaStep(){
  const stop = CINEMA_STOPS[cinemaIdx % CINEMA_STOPS.length];
  map.flyTo([stop.lat, stop.lon], stop.z, {duration: 2.5, easeLinearity: 0.25});
  const label = document.getElementById('cinemaLabel');
  if(label) label.textContent = '\u26A1 ' + stop.label + ' — LIVE MONITORING \u26A1';
  cinemaIdx++;
}

// ════════════════════════════════════════
// 3. SPOKEN VOICE ALERTS
// ════════════════════════════════════════
let voiceEnabled = false;
let voicePrevAdv = new Set();

function toggleVoice(){
  voiceEnabled = !voiceEnabled;
  const btn = document.getElementById('btn-voice');
  btn.classList.toggle('on', voiceEnabled);
  btn.textContent = voiceEnabled ? '🗣️ Voice ON' : '🗣️ Voice';
  if(voiceEnabled) speak('Voice alerts activated. Monitoring all sectors.');
}

function speak(text){
  if(!voiceEnabled || !window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.95; u.pitch = 0.8; u.volume = 0.7;
  // Prefer a low/authoritative voice
  const voices = speechSynthesis.getVoices();
  const pref = voices.find(v => /daniel|google uk|english.*male/i.test(v.name)) || voices.find(v => /en/i.test(v.lang));
  if(pref) u.voice = pref;
  speechSynthesis.speak(u);
}

// Hook into render cycle for voice alerts
const _renderForVoice = render;
render = function(){
  _renderForVoice();
  if(!voiceEnabled) return;
  const adversary = ['iran','russia','china'];
  const advNow = acData.filter(ac => ac.lat && adversary.includes(getGroup(ac.hex)));
  const currentHexes = new Set(advNow.map(a=>a.hex));
  // Detect new adversary aircraft
  currentHexes.forEach(hex => {
    if(!voicePrevAdv.has(hex)){
      const ac = acData.find(a=>a.hex===hex);
      if(ac){
        const country = getCName(ac.hex);
        const type = ac.t || 'unknown type';
        const call = (ac.flight||'').trim() || 'no callsign';
        // Find which zone they're in
        let zoneName = '';
        for(const z of ZONES){
          if(inZone(ac, z)){ zoneName = z.name; break; }
        }
        const zoneStr = zoneName ? `, ${zoneName} zone` : '';
        speak(`Caution. ${country} ${type}, callsign ${call}, detected${zoneStr}.`);
      }
    }
  });
  voicePrevAdv = currentHexes;
  // Threat level voice
  const {pct} = computeThreat(acData.filter(ac=>ac.lat));
  const defcon = pct >= 80 ? 1 : pct >= 60 ? 2 : pct >= 40 ? 3 : pct >= 20 ? 4 : 5;
  if(defcon < prevThreatLevel && voiceEnabled){
    speak(`Alert. Threat posture elevated to DEFCON ${defcon}.`);
  }
};

// ════════════════════════════════════════
// 4. RADAR SWEEP ANIMATION
// ════════════════════════════════════════
// Radar is always present in HTML, just hidden. Toggle shows/hides it.
// We also add blips that flash when aircraft are nearby
let radarVisible = false;
// Auto-show radar on load
setTimeout(() => {
  document.getElementById('radarOverlay').classList.add('vis');
  radarVisible = true;
}, 4000);

// ════════════════════════════════════════
// 5. NUCLEAR BLAST RADIUS TOOL
// ════════════════════════════════════════
let nukeMode = false;
let nukeRings = [];

const NUKE_RADII = {
  // yield in KT -> radii in km [fireball, heavy_blast, moderate_blast, thermal_3rd, radiation]
  15:    [0.2, 0.8,  1.6,  2.0,  1.4],
  100:   [0.4, 1.5,  3.2,  4.5,  2.0],
  300:   [0.6, 2.2,  4.8,  7.0,  2.4],
  800:   [0.8, 3.2,  6.8,  10.5, 2.8],
  1000:  [0.9, 3.6,  7.5,  12.0, 3.0],
  5000:  [1.6, 6.5,  14.0, 25.0, 4.0],
  50000: [3.5, 15.0, 35.0, 60.0, 6.5],
};

const NUKE_COLORS = ['#ff0000','#ff4400','#ff8800','#ffcc00','#00ff41'];
const NUKE_LABELS = ['Fireball','Heavy blast (20psi)','Moderate blast (5psi)','Thermal radiation (3rd°)','Radiation (500rem)'];

function toggleNukeMode(){
  nukeMode = !nukeMode;
  document.getElementById('btn-nuke').classList.toggle('on', nukeMode);
  document.getElementById('nukePanel').classList.toggle('vis', nukeMode);
  if(nukeMode){
    map.getContainer().style.cursor = 'crosshair';
    map.on('click', onNukeClick);
  } else {
    map.getContainer().style.cursor = '';
    map.off('click', onNukeClick);
  }
}

function onNukeClick(e){
  if(!nukeMode) return;
  const yieldKt = parseInt(document.getElementById('nukeYield').value);
  const burst = document.getElementById('nukeBurst').value;
  const radii = NUKE_RADII[yieldKt] || NUKE_RADII[800];
  const mult = burst === 'surface' ? 0.8 : 1.0; // surface bursts have smaller blast radii but more fallout

  // Draw concentric rings from outside in
  for(let ri = radii.length - 1; ri >= 0; ri--){
    const r = radii[ri] * mult * 1000; // to meters
    const circle = L.circle([e.latlng.lat, e.latlng.lng], {
      radius: r, fillColor: NUKE_COLORS[ri], fillOpacity: ri === 0 ? 0.5 : 0.12,
      color: NUKE_COLORS[ri], weight: 1.5, opacity: 0.6, interactive: false
    }).addTo(map);
    nukeRings.push(circle);

    // Label
    const labelPos = L.latLng(e.latlng.lat + (r/111320)*0.9, e.latlng.lng);
    const label = L.marker(labelPos, {
      icon: L.divIcon({
        html: `<div style="font-size:8px;color:${NUKE_COLORS[ri]};font-family:'Share Tech Mono',monospace;white-space:nowrap;text-shadow:0 0 4px #000">${NUKE_LABELS[ri]} (${radii[ri]}km)</div>`,
        className:'', iconAnchor:[0,0]
      }),
      interactive: false
    }).addTo(map);
    nukeRings.push(label);
  }

  // Ground zero marker
  const gz = L.marker([e.latlng.lat, e.latlng.lng], {
    icon: L.divIcon({
      html: `<div style="font-size:16px;text-shadow:0 0 12px #ff0000;animation:pulse-conflict 1s infinite">☢️</div>`,
      className:'', iconSize:[16,16], iconAnchor:[8,8]
    })
  }).addTo(map);
  nukeRings.push(gz);

  // Stats popup
  const totalArea = Math.PI * Math.pow(radii[2] * mult, 2);
  gz.bindPopup(`<div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--text)">
    <div style="color:#ef4444;font-weight:700;font-size:12px;margin-bottom:4px">☢️ ${yieldKt >= 1000 ? (yieldKt/1000)+'MT' : yieldKt+'KT'} ${burst.toUpperCase()}</div>
    <div>Fireball: ${radii[0]}km radius</div>
    <div>Heavy blast: ${radii[1]}km</div>
    <div>Moderate blast: ${radii[2]}km</div>
    <div>Thermal burns: ${radii[3]}km</div>
    <div>Lethal radiation: ${radii[4]}km</div>
    <div style="margin-top:4px;color:var(--muted)">Affected area: ~${totalArea.toFixed(0)} km²</div>
  </div>`, {className:'leaflet-popup-content-wrapper'}).openPopup();
}

function clearNukeRings(){
  nukeRings.forEach(r => map.removeLayer(r));
  nukeRings = [];
}

// ════════════════════════════════════════
// 6. FLIGHT PATH PROJECTION
// ════════════════════════════════════════
let pathsVisible = false;
let pathLines = [];

function toggleFlightPaths(){
  pathsVisible = !pathsVisible;
  document.getElementById('btn-paths').classList.toggle('on', pathsVisible);
  if(!pathsVisible) clearFlightPaths();
  else drawFlightPaths();
}

function clearFlightPaths(){
  pathLines.forEach(l => map.removeLayer(l));
  pathLines = [];
}

function drawFlightPaths(){
  clearFlightPaths();
  if(!pathsVisible) return;
  acData.forEach(ac => {
    if(!ac.lat || !ac.lon || !ac.track || !ac.gs) return;
    if(!passFilter(ac)) return;
    const speed = ac.gs * 0.514444; // knots to m/s
    const projDist = speed * 300; // 5 minutes ahead
    const trackRad = ac.track * Math.PI / 180;
    const R = 6371000;
    const lat1 = ac.lat * Math.PI / 180;
    const lon1 = ac.lon * Math.PI / 180;
    const lat2 = Math.asin(Math.sin(lat1)*Math.cos(projDist/R) + Math.cos(lat1)*Math.sin(projDist/R)*Math.cos(trackRad));
    const lon2 = lon1 + Math.atan2(Math.sin(trackRad)*Math.sin(projDist/R)*Math.cos(lat1), Math.cos(projDist/R)-Math.sin(lat1)*Math.sin(lat2));
    const endLat = lat2 * 180 / Math.PI;
    const endLon = lon2 * 180 / Math.PI;
    const col = getCol(ac.hex);
    const line = L.polyline([[ac.lat, ac.lon],[endLat, endLon]], {
      color: col, weight: 1, opacity: 0.35, dashArray: '3 6', interactive: false
    }).addTo(map);
    // Arrowhead dot at end
    const dot = L.circleMarker([endLat, endLon], {
      radius: 2, fillColor: col, fillOpacity: 0.5, stroke: false, interactive: false
    }).addTo(map);
    pathLines.push(line, dot);
  });
}

// Redraw paths on each data refresh
const _renderForPaths = render;
render = function(){
  _renderForPaths();
  if(pathsVisible) drawFlightPaths();
};

// ════════════════════════════════════════
// AMBIENT MAP PARTICLES
// ════════════════════════════════════════
(function spawnParticles(){
  const container = document.getElementById('mapParticles');
  if(!container) return;
  function spawn(){
    const p = document.createElement('div');
    p.className = 'map-particle';
    p.style.left = Math.random()*100+'%';
    p.style.bottom = '-4px';
    p.style.animationDuration = (8 + Math.random()*12)+'s';
    p.style.animationDelay = Math.random()*2+'s';
    container.appendChild(p);
    setTimeout(() => p.remove(), 22000);
  }
  setInterval(spawn, 800);
  for(let j=0;j<6;j++) setTimeout(spawn, j*300);
})();

// ════════════════════════════════════════
// LIVE HEARTBEAT INDICATOR
// ════════════════════════════════════════
let lastDataTime = Date.now();
const origFetchData = fetchData;
fetchData = async function(){
  await origFetchData();
  lastDataTime = Date.now();
};
setInterval(() => {
  const el = document.getElementById('hb-time');
  if(!el) return;
  const ago = Math.round((Date.now()-lastDataTime)/1000);
  el.textContent = ago < 5 ? 'just now' : ago+'s ago';
}, 1000);
</script>
</body>
</html>
