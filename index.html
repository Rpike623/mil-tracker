<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PIKECLAW // OSINT TRACKER</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Exo+2:wght@300;400;600;700;800&family=Orbitron:wght@400;500;600;700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#000000;
  --bg2:#050a05;
  --panel:rgba(2,8,2,0.94);
  --panel2:rgba(4,12,4,0.92);
  --border:#0a1f0a;
  --border2:#0d2e0d;
  --border-glow:#00ff41;
  --text:#b8e6b8;
  --text-bright:#e0ffe0;
  --muted:#3a6b3a;
  --accent:#00ff41;
  --accent2:#00cc33;
  --red:#ff2040;
  --orange:#ff6b2b;
  --yellow:#e5ff00;
  --purple:#bf5fff;
  --green:#00ff41;
  --cyan:#00ffcc;
  --grid-line:rgba(0,255,65,0.04);
}

/* ‚îÄ‚îÄ SCANLINE + GRID OVERLAY ‚îÄ‚îÄ */
body{
  font-family:'Exo 2',sans-serif;
  background:radial-gradient(ellipse 1400px 700px at 15% -5%, rgba(0,255,65,.06), transparent 60%),
             radial-gradient(ellipse 900px 500px at 85% 0%, rgba(0,255,65,.04), transparent 55%),
             radial-gradient(ellipse 600px 600px at 50% 100%, rgba(0,255,65,.03), transparent 50%),
             #000;
  color:var(--text);
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
body::before{
  content:'';
  position:fixed;
  inset:0;
  background:
    repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,255,65,.018) 2px, rgba(0,255,65,.018) 4px),
    repeating-linear-gradient(90deg, transparent, transparent 60px, rgba(0,255,65,.035) 60px, rgba(0,255,65,.035) 61px),
    repeating-linear-gradient(0deg, transparent, transparent 60px, rgba(0,255,65,.035) 60px, rgba(0,255,65,.035) 61px);
  pointer-events:none;
  z-index:9998;
}

/* ‚îÄ‚îÄ ANIMATED SCANLINE ‚îÄ‚îÄ */
body::after{
  content:'';
  position:fixed;
  top:0;left:0;right:0;
  height:2px;
  background:linear-gradient(90deg,transparent,rgba(0,255,65,.5),transparent);
  animation:scanline 8s linear infinite;
  pointer-events:none;
  z-index:9999;
}
@keyframes scanline{0%{top:-4px}100%{top:100vh}}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{
  flex-shrink:0;
  background:linear-gradient(180deg,rgba(0,8,0,0.98),rgba(0,4,0,0.99));
  border-bottom:1px solid rgba(0,255,65,.3);
  box-shadow:0 4px 30px rgba(0,255,65,.08), inset 0 -1px 0 rgba(0,255,65,.1);
  padding:7px 12px;
  display:flex;gap:6px;align-items:center;flex-wrap:wrap;z-index:200;
  position:relative;
  backdrop-filter: blur(12px);
}
.topbar::after{
  content:'';position:absolute;bottom:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(0,255,65,.4) 20%,rgba(0,255,65,.8) 50%,rgba(0,255,65,.4) 80%,transparent);
}
.topbar .logo{
  font-family:'Orbitron',sans-serif;
  font-size:13px;
  font-weight:700;
  color:var(--accent);
  margin-right:8px;
  letter-spacing:3px;
  text-shadow:0 0 15px rgba(0,255,65,.9),0 0 30px rgba(0,255,65,.4),0 0 60px rgba(0,255,65,.15);
  white-space:nowrap;
}
.topbar .logo span{color:rgba(0,255,65,.45)}
.tb-sep{width:1px;height:18px;background:linear-gradient(180deg,transparent,rgba(0,255,65,.4),transparent);margin:0 3px;flex-shrink:0}
.tb-btn{
  background:rgba(0,12,0,.85);
  border:1px solid rgba(0,255,65,.15);
  color:var(--muted);
  padding:4px 10px;
  border-radius:2px;
  cursor:pointer;
  font-size:10px;
  font-family:'Share Tech Mono',monospace;
  letter-spacing:.6px;
  transition:all .15s;
  white-space:nowrap;
  text-transform:uppercase;
  position:relative;
  overflow:hidden;
  box-shadow:0 2px 8px rgba(0,0,0,.4);
}
.tb-btn::before{
  content:'';position:absolute;inset:-1px;
  background:linear-gradient(135deg,rgba(0,255,65,.1),transparent 60%);
  opacity:0;transition:opacity .15s;
}
.tb-btn:hover{background:rgba(0,30,0,.9);border-color:var(--accent);color:var(--accent);box-shadow:0 0 12px rgba(0,255,65,.25),inset 0 0 10px rgba(0,255,65,.06);}
.tb-btn:hover::before{opacity:1}
.tb-btn.on{background:rgba(0,50,10,.5);border-color:var(--accent);color:var(--accent);box-shadow:0 0 18px rgba(0,255,65,.35),inset 0 0 12px rgba(0,255,65,.1);}
.tb-btn.iran-on{background:rgba(255,32,64,.12);border-color:var(--red);color:var(--red);box-shadow:0 0 12px rgba(255,32,64,.3)}
.tb-btn.russia-on{background:rgba(220,38,38,.12);border-color:#dc2626;color:#ff6666;box-shadow:0 0 12px rgba(220,38,38,.3)}
.tb-btn.china-on{background:rgba(229,255,0,.08);border-color:var(--yellow);color:var(--yellow);box-shadow:0 0 12px rgba(229,255,0,.25)}
.tb-search{
  background:rgba(0,8,0,0.9);
  border:1px solid rgba(0,255,65,.15);
  color:var(--accent);
  padding:4px 8px;
  border-radius:2px;
  font-size:10px;
  font-family:'Share Tech Mono',monospace;
  width:130px;
  outline:none;
  letter-spacing:.5px;
}
.tb-search:focus{border-color:var(--accent);box-shadow:0 0 10px rgba(0,255,65,.25)}
.tb-search::placeholder{color:rgba(0,255,65,.25)}
.tb-label{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;white-space:nowrap;font-family:'Share Tech Mono',monospace}

/* ‚îÄ‚îÄ WIDGET SYSTEM ‚îÄ‚îÄ */
.dashboard{flex:1;display:grid;grid-template-columns:1fr 270px 270px;grid-template-rows:1fr 1fr 1fr;min-height:0;gap:0}
.widget{
  background:rgba(0,4,0,0.92);
  border:1px solid rgba(0,255,65,.1);
  display:flex;flex-direction:column;overflow:hidden;min-height:0;
  position:relative;
  box-shadow:0 8px 24px rgba(0,0,0,.5), inset 0 0 50px rgba(0,255,65,.02);
}
.widget::before{
  content:'';
  position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(0,255,65,.4),transparent);
  pointer-events:none;
}
.widget-header{
  flex-shrink:0;
  padding:6px 10px;
  background:linear-gradient(180deg,rgba(0,10,0,.95),rgba(0,6,0,.98));
  border-bottom:1px solid rgba(0,255,65,.12);
  font-size:10px;
  font-weight:700;
  letter-spacing:1px;
  color:var(--muted);
  text-transform:uppercase;
  display:flex;align-items:center;gap:6px;
  font-family:'Share Tech Mono',monospace;
}
.widget-header .wh-title{flex:1;color:rgba(0,255,65,.8)}
.widget-header .wh-count{
  background:rgba(0,255,65,.06);
  border:1px solid rgba(0,255,65,.2);
  border-radius:2px;
  padding:1px 7px;
  font-size:9px;
  color:var(--accent);
  font-family:'Share Tech Mono',monospace;
  box-shadow:0 0 10px rgba(0,255,65,.15);
}
.widget-body{flex:1;overflow-y:auto;overflow-x:hidden;min-height:0}
.widget-body::-webkit-scrollbar{width:3px}
.widget-body::-webkit-scrollbar-track{background:rgba(0,4,0,.5)}
.widget-body::-webkit-scrollbar-thumb{background:rgba(0,255,65,.2);border-radius:2px}
.w-map{grid-column:1;grid-row:1/4;position:relative;border:0;min-height:300px}
.w-zones{grid-column:2;grid-row:1}
.w-stats{grid-column:3;grid-row:1}
.w-activity{grid-column:2;grid-row:2}

/* News + bottom bar */
.news-card{min-width:220px;max-width:220px;padding:8px 10px;border-right:1px solid var(--border);cursor:pointer;transition:background .15s;flex-shrink:0;display:flex;flex-direction:column;justify-content:space-between}
.news-card:hover{background:rgba(0,212,255,.04)}
.news-card .nc-src{font-size:9px;color:var(--accent);font-weight:700;margin-bottom:3px;text-transform:uppercase;letter-spacing:.8px;font-family:'Share Tech Mono',monospace}
.news-card .nc-title{font-size:11px;line-height:1.4;color:var(--text);flex:1;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}
.news-card .nc-meta{font-size:9px;color:var(--muted);margin-top:4px;font-family:'Share Tech Mono',monospace}
.news-card.alert .nc-src{color:var(--red);text-shadow:0 0 8px rgba(255,51,85,.5)}
.news-card.alert{border-left:2px solid var(--red);box-shadow:inset 2px 0 10px rgba(255,51,85,.08)}

/* Poly cards */
.poly-card{min-width:175px;max-width:175px;padding:8px 10px;border-right:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column;gap:4px;cursor:pointer;transition:background .15s;text-decoration:none}
.poly-card:hover{background:rgba(0,212,255,.04)}
.poly-card .pc-q{font-size:10px;line-height:1.35;color:var(--text);display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;flex:1}
.poly-card .pc-odds{display:flex;align-items:center;gap:4px;margin-top:4px}
.poly-card .pc-yes{font-size:16px;font-weight:800;font-family:'Share Tech Mono',monospace}
.poly-card .pc-label{font-size:9px;color:var(--muted);font-family:'Share Tech Mono',monospace}
.poly-card .pc-bar{height:3px;background:rgba(0,212,255,.1);border-radius:2px;overflow:hidden;margin-top:2px}
.poly-card .pc-fill{height:100%;border-radius:2px;transition:width .5s;box-shadow:0 0 6px currentColor}
.poly-card .pc-vol{font-size:9px;color:var(--muted);font-family:'Share Tech Mono',monospace}

/* X feed */
.x-tab{background:rgba(0,8,0,.8);border:1px solid rgba(0,255,65,.12);color:var(--muted);padding:2px 7px;border-radius:2px;cursor:pointer;font-size:9px;white-space:nowrap;font-family:'Share Tech Mono',monospace;letter-spacing:.5px;text-transform:uppercase}
.x-tab:hover{color:var(--text)}.x-tab.on{border-color:var(--accent);color:var(--accent);box-shadow:0 0 10px rgba(0,255,65,.25)}
.x-post{padding:8px 10px;border-bottom:1px solid rgba(0,255,65,.06);font-size:11px;line-height:1.45;cursor:pointer;transition:background .15s}
.x-post:hover{background:rgba(0,255,65,.04)}
.x-post .xp-meta{font-size:9px;color:var(--muted);margin-bottom:3px;display:flex;gap:6px;font-family:'Share Tech Mono',monospace}
.x-post .xp-handle{color:var(--accent);font-weight:600}
.x-post .xp-text{color:var(--text)}

/* Info panel */
.infopanel{position:absolute;bottom:50px;left:10px;z-index:500;
  background:rgba(0,4,0,0.96);
  border:1px solid rgba(0,255,65,.3);
  box-shadow:0 0 40px rgba(0,255,65,.12), inset 0 0 40px rgba(0,255,65,.03);
  border-radius:2px;padding:12px;width:300px;max-height:70vh;overflow-y:auto;display:none;backdrop-filter:blur(18px)}
.infopanel::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(0,255,65,.7),transparent)}
.infopanel.vis{display:block}
.infopanel .ip-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.infopanel h3{font-size:13px;color:var(--accent);font-family:'Share Tech Mono',monospace;letter-spacing:1px;text-shadow:0 0 14px rgba(0,255,65,.8)}
.infopanel .x{background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;line-height:1}
.infopanel .x:hover{color:var(--accent)}
.infopanel .f{margin-bottom:3px;font-size:11px;display:flex;gap:4px}
.infopanel .f .k{color:var(--muted);font-family:'Share Tech Mono',monospace;font-size:10px;white-space:nowrap;padding-top:1px}
.infopanel .f .v{color:var(--text-bright);font-weight:500}

/* Region buttons */
.region-btns{position:absolute;bottom:10px;left:10px;z-index:400;display:flex;flex-direction:column;gap:3px}
.region-btns button{
  background:rgba(0,4,0,0.88);
  border:1px solid rgba(0,255,65,.15);
  color:var(--muted);
  padding:4px 8px;border-radius:2px;cursor:pointer;
  font-size:9px;text-align:left;transition:all .15s;
  font-family:'Share Tech Mono',monospace;letter-spacing:.5px;text-transform:uppercase;
}
.region-btns button:hover{color:var(--accent);border-color:var(--accent);box-shadow:0 0 10px rgba(0,255,65,.25)}

/* Map legend */
.map-legend{
  background:rgba(0,4,0,0.92);
  border:1px solid rgba(0,255,65,.2);
  box-shadow:0 0 20px rgba(0,255,65,.12);
  border-radius:2px;padding:8px 10px;font-size:10px;font-family:'Share Tech Mono',monospace;letter-spacing:.3px;
}
.map-legend .ml-row{display:flex;align-items:center;gap:6px;margin-bottom:3px;color:var(--muted)}
.map-legend .ml-row .ml-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;box-shadow:0 0 4px currentColor}

/* Adversary tabs */
.adv-tab{flex:1;padding:8px 6px;text-align:center;font-size:11px;font-weight:600;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all .15s;user-select:none;border-right:1px solid rgba(0,255,65,.08);font-family:'Share Tech Mono',monospace;letter-spacing:.5px;text-transform:uppercase}
.adv-tab:last-child{border-right:0}
.adv-tab:hover{color:var(--text)}
.adv-tab.active{color:var(--accent);border-bottom-color:var(--accent);background:rgba(0,255,65,.04);text-shadow:0 0 12px rgba(0,255,65,.5)}
.adv-tab[data-adv="iran"].active{border-bottom-color:var(--red);color:var(--red);text-shadow:0 0 12px rgba(255,32,64,.5)}
.adv-tab[data-adv="russia"].active{border-bottom-color:#dc2626;color:#ff6666;text-shadow:0 0 12px rgba(220,38,38,.5)}
.adv-tab[data-adv="china"].active{border-bottom-color:var(--yellow);color:var(--yellow);text-shadow:0 0 12px rgba(229,255,0,.4)}
.adv-body{display:flex;height:100%;overflow:hidden}
.adv-col{flex:1;border-right:1px solid var(--border);overflow-y:auto;padding:8px 10px;font-size:11px}
.adv-col:last-child{border-right:0}
.adv-col h5{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:rgba(0,212,255,.5);margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border);font-family:'Share Tech Mono',monospace}
.adv-row{display:flex;justify-content:space-between;margin-bottom:4px;align-items:center;gap:8px}
.adv-row .ar-label{color:var(--muted);font-size:10px}
.adv-row .ar-val{font-weight:600;color:var(--text-bright);font-size:10px;text-align:right;font-family:'Share Tech Mono',monospace}
.adv-status{padding:2px 6px;border-radius:2px;font-size:9px;font-weight:700;font-family:'Share Tech Mono',monospace;letter-spacing:.5px}
.adv-status.hot{background:rgba(255,51,85,.15);color:var(--red);box-shadow:0 0 8px rgba(255,51,85,.2)}
.adv-status.warn{background:rgba(255,119,48,.15);color:var(--orange)}
.adv-status.calm{background:rgba(0,255,136,.1);color:var(--green)}

/* Loading overlay */
.loading-ov{position:absolute;inset:0;z-index:600;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px}
.loading-ov .sp{font-size:34px;animation:spin 1s linear infinite;display:inline-block;filter:drop-shadow(0 0 12px rgba(0,255,65,.8))}
.loading-ov .st{color:var(--accent);font-size:12px;font-family:'Share Tech Mono',monospace;letter-spacing:3px;text-transform:uppercase;animation:pulse 1.5s ease-in-out infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:.5}50%{opacity:1}}

/* Leaflet overrides */
.leaflet-popup-content-wrapper{background:rgba(0,4,0,.98);color:var(--text);border-radius:2px;border:1px solid rgba(0,255,65,.3);box-shadow:0 0 25px rgba(0,255,65,.15)}
.leaflet-popup-tip{background:rgba(0,4,0,.98)}
.dark-tooltip{background:rgba(0,4,0,.97)!important;color:var(--accent)!important;border:1px solid rgba(0,255,65,.3)!important;border-radius:2px!important;font-size:10px!important;padding:4px 8px!important;font-family:'Share Tech Mono',monospace!important;box-shadow:0 0 12px rgba(0,255,65,.15)!important;letter-spacing:.3px!important}
.leaflet-control-zoom a{background:rgba(0,4,0,.9)!important;color:var(--accent)!important;border:1px solid rgba(0,255,65,.2)!important}
.leaflet-control-attribution{background:rgba(0,0,0,.8)!important;color:var(--muted)!important;font-size:9px!important}
.leaflet-control-attribution a{color:var(--accent2)!important}

/* Zone cards */
.zone-card{padding:7px 12px;border-bottom:1px solid rgba(0,255,65,.06);display:flex;justify-content:space-between;align-items:center;transition:background .15s}
.zone-card:hover{background:rgba(0,255,65,.03)}
.zone-card .zc-name{font-size:11px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.3px}
.zone-card .zc-count{font-size:15px;font-weight:800;font-family:'Share Tech Mono',monospace}
.zone-card.hot{border-left:2px solid var(--red);background:rgba(255,51,85,.04)}
.zone-card.warm{border-left:2px solid var(--orange)}

/* Country/type bars */
.country-row{display:flex;align-items:center;gap:6px;margin-bottom:5px;font-size:11px}
.country-row .cr-flag{width:18px;text-align:center}
.country-row .cr-name{flex:1;color:var(--muted);font-size:10px;font-family:'Share Tech Mono',monospace;letter-spacing:.3px}
.country-row .cr-bar-wrap{width:80px;height:4px;background:rgba(0,212,255,.08);border-radius:2px;overflow:hidden}
.country-row .cr-bar{height:100%;border-radius:2px;transition:width .5s;box-shadow:0 0 4px currentColor}
.country-row .cr-count{width:24px;text-align:right;font-weight:700;color:var(--text-bright);font-family:'Share Tech Mono',monospace;font-size:11px}
.type-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:11px}
.type-row .tr-icon{width:16px;text-align:center}
.type-row .tr-name{flex:1;color:var(--muted);font-size:10px;font-family:'Share Tech Mono',monospace}
.type-row .tr-bar-wrap{width:70px;height:3px;background:rgba(0,212,255,.08);border-radius:2px;overflow:hidden}
.type-row .tr-bar{height:100%;border-radius:2px;transition:width .5s;box-shadow:0 0 4px currentColor}
.type-row .tr-count{width:24px;text-align:right;font-weight:700;color:var(--text-bright);font-family:'Share Tech Mono',monospace;font-size:11px}
.stat-block{padding:10px 12px;border-bottom:1px solid rgba(0,255,65,.06)}
.stat-block .sb-label{font-size:9px;color:rgba(0,255,65,.5);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;font-family:'Share Tech Mono',monospace}

/* Activity feed */
.feed-item{padding:6px 12px;border-bottom:1px solid rgba(0,255,65,.06);display:flex;align-items:center;gap:6px;font-size:11px;transition:background .15s;cursor:pointer}
.feed-item:hover{background:rgba(0,255,65,.03)}
.feed-item .fi-flag{flex-shrink:0}
.feed-item .fi-call{font-weight:700;color:var(--text-bright);flex-shrink:0;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:.5px}
.feed-item .fi-type{color:var(--muted);font-size:10px}
.feed-item .fi-alt{margin-left:auto;color:var(--muted);flex-shrink:0;font-family:'Share Tech Mono',monospace;font-size:10px}

/* Section headers in panels */
.rp-section{padding:6px 12px 4px;font-size:9px;text-transform:uppercase;letter-spacing:1px;color:rgba(0,255,65,.4);border-bottom:1px solid rgba(0,255,65,.06);font-family:'Share Tech Mono',monospace}

/* Naval widget */
.naval-group{padding:8px 10px;border-bottom:1px solid rgba(0,255,65,.06);cursor:pointer;transition:background .15s}
.naval-group:hover{background:rgba(0,255,65,.03)}
.naval-group .ng-header{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.naval-group .ng-name{font-size:11px;font-weight:700;color:var(--accent);font-family:'Share Tech Mono',monospace;letter-spacing:.5px}
.naval-group .ng-status{font-size:9px;padding:1px 6px;border-radius:2px;font-weight:700;font-family:'Share Tech Mono',monospace;letter-spacing:.5px}
.naval-group .ng-status.deployed{background:rgba(0,255,65,.1);color:var(--accent);box-shadow:0 0 6px rgba(0,255,65,.15)}
.naval-group .ng-status.combat{background:rgba(255,32,64,.12);color:var(--red);box-shadow:0 0 8px rgba(255,32,64,.2)}
.naval-group .ng-status.port{background:rgba(76,107,58,.15);color:var(--muted)}
.naval-group .ng-status.transit{background:rgba(229,255,0,.08);color:var(--yellow)}
.naval-group .ng-region{font-size:9px;color:var(--muted);font-family:'Share Tech Mono',monospace;letter-spacing:.3px}
.naval-group .ng-ships{font-size:10px;color:var(--text);margin-top:3px;line-height:1.4}
.naval-chokepoint{padding:6px 10px;border-bottom:1px solid rgba(0,255,65,.06);display:flex;justify-content:space-between;align-items:center}
.naval-chokepoint .nc-name{font-size:10px;color:var(--text);font-family:'Share Tech Mono',monospace}
.naval-chokepoint .nc-status{font-size:9px;font-weight:700;font-family:'Share Tech Mono',monospace;letter-spacing:.5px}

/* Mobile */
@media(max-width:768px){
  body{overflow-y:auto;overflow-x:hidden;height:auto}
  .dashboard{display:block;height:auto}
  .w-map{height:55vmax;min-height:300px;max-height:70vh;position:relative;display:block}
  #map{position:absolute;top:0;left:0;right:0;bottom:0}
  .w-zones,.w-stats,.w-activity,.w-log,.widget{height:250px;display:flex;flex-direction:column}
  .topbar{padding:5px 8px;position:sticky;top:0;z-index:9999}
  .tb-btn{padding:4px 6px;font-size:9px}
  .tb-search{width:90px}
  .tb-sep{display:none}
  .tb-label{display:none}
  .infopanel{left:8px!important;right:8px!important;width:auto!important;bottom:8px!important}
  .region-btns{bottom:8px}
  .region-btns button{font-size:9px;padding:3px 5px}
  .map-legend{display:none}
}

/* ‚îÄ‚îÄ WIDGET SYSTEM (legacy removed) ‚îÄ‚îÄ */
/* duplicate block intentionally removed */

/* News + Poly cards */
.news-card{min-width:220px;max-width:220px;padding:8px 10px;border-right:1px solid rgba(0,255,65,.06);cursor:pointer;transition:background .15s;flex-shrink:0;display:flex;flex-direction:column;justify-content:space-between}
.news-card:hover{background:rgba(0,255,65,.04)}
.news-card .nc-src{font-size:9px;color:var(--accent);font-weight:700;margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px;font-family:'Share Tech Mono',monospace}
.news-card .nc-title{font-size:11px;line-height:1.4;color:var(--text);flex:1;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}
.news-card .nc-meta{font-size:9px;color:var(--muted);margin-top:4px;font-family:'Share Tech Mono',monospace}
.news-card.alert .nc-src{color:var(--red)}
.news-card.alert{border-left:2px solid var(--red);padding-left:8px}

/* Adversary tabs (duplicate ‚Äî overridden above) */
/* Adversary intel layout */
.adv-body{display:flex;height:100%;overflow:hidden}
.adv-col{flex:1;border-right:1px solid var(--border);overflow-y:auto;padding:8px 10px;font-size:11px}
.adv-col:last-child{border-right:0}
.adv-col h5{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border)}
.adv-row{display:flex;justify-content:space-between;margin-bottom:4px;align-items:center}
.adv-row .ar-label{color:var(--muted)}
.adv-row .ar-val{font-weight:600;color:var(--text)}
.adv-kv{margin-bottom:5px}
.adv-kv .ak{font-size:10px;color:var(--muted)}
.adv-kv .av{font-size:11px;color:var(--text)}
.adv-status{padding:3px 7px;border-radius:3px;font-size:10px;font-weight:700}
.adv-status.hot{background:rgba(239,68,68,.2);color:#ef4444}
.adv-status.warn{background:rgba(249,115,22,.2);color:#f97316}
.adv-status.calm{background:rgba(34,197,94,.15);color:#22c55e}

/* X / OSINT feed */
.x-tab{background:#111827;border:1px solid var(--border2);color:var(--muted);padding:2px 7px;border-radius:3px;cursor:pointer;font-size:10px;white-space:nowrap}
.x-tab:hover{color:var(--text)}.x-tab.on{border-color:#1d9bf0;color:#1d9bf0}
.x-post{padding:8px 10px;border-bottom:1px solid var(--border);font-size:11px;line-height:1.45;cursor:pointer;transition:background .15s}
.x-post:hover{background:rgba(29,155,240,.05)}
.x-post .xp-meta{font-size:10px;color:var(--muted);margin-bottom:3px;display:flex;gap:6px}
.x-post .xp-handle{color:#1d9bf0;font-weight:600}
.x-post .xp-text{color:var(--text)}
.x-post .xp-img{max-width:100%;max-height:80px;border-radius:4px;margin-top:5px;object-fit:cover}

/* Polymarket cards */
.poly-card{min-width:175px;max-width:175px;padding:8px 10px;border-right:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column;gap:4px;cursor:pointer;transition:background .15s;text-decoration:none}
.poly-card:hover{background:rgba(59,130,246,.06)}
.poly-card .pc-q{font-size:10px;line-height:1.35;color:var(--text);display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;flex:1}
.poly-card .pc-odds{display:flex;align-items:center;gap:4px;margin-top:4px}
.poly-card .pc-yes{font-size:16px;font-weight:800}
.poly-card .pc-label{font-size:9px;color:var(--muted)}
.poly-card .pc-bar{height:4px;background:#1e2a42;border-radius:2px;overflow:hidden;margin-top:2px}
.poly-card .pc-fill{height:100%;border-radius:2px;transition:width .5s}
.poly-card .pc-vol{font-size:9px;color:var(--muted)}

/* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
/* Clock bar */
.clock-bar{flex-shrink:0;display:flex;justify-content:center;gap:0;background:#000;border-bottom:1px solid rgba(0,255,65,.15);padding:0;font-family:'Share Tech Mono',monospace;overflow-x:auto}
.clock-cell{display:flex;flex-direction:column;align-items:center;padding:4px 14px;border-right:1px solid rgba(0,255,65,.06);min-width:80px}
.clock-cell:last-child{border-right:none}
.clock-label{font-size:8px;text-transform:uppercase;letter-spacing:1.5px;color:rgba(0,255,65,.35);margin-bottom:1px}
.clock-time{font-size:13px;font-weight:700;color:var(--accent);letter-spacing:1px;text-shadow:0 0 8px rgba(0,255,65,.3)}
.clock-cell.clock-date .clock-time{color:var(--text);text-shadow:none;font-size:11px}
#clk-zulu{font-size:15px;color:#fff;text-shadow:0 0 12px rgba(0,255,65,.5)}

/* DEFCON meter */
.defcon-meter{display:flex;gap:2px;margin:8px 0}
.defcon-level{flex:1;text-align:center;padding:6px 2px;font-size:10px;font-weight:700;font-family:'Orbitron','Share Tech Mono',monospace;letter-spacing:1px;border:1px solid rgba(0,255,65,.08);border-radius:2px;opacity:.3;transition:all .3s}
.defcon-level.active{opacity:1;box-shadow:0 0 12px var(--defcon-color)}
.defcon-5{--defcon-color:#00ff41;background:rgba(0,255,65,.08);color:#00ff41;border-color:rgba(0,255,65,.3)}
.defcon-4{--defcon-color:#22d3ee;background:rgba(34,211,238,.08);color:#22d3ee;border-color:rgba(34,211,238,.3)}
.defcon-3{--defcon-color:#eab308;background:rgba(234,179,8,.08);color:#eab308;border-color:rgba(234,179,8,.3)}
.defcon-2{--defcon-color:#f97316;background:rgba(249,115,22,.08);color:#f97316;border-color:rgba(249,115,22,.3)}
.defcon-1{--defcon-color:#ef4444;background:rgba(239,68,68,.08);color:#ef4444;border-color:rgba(239,68,68,.3)}
.threat-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(0,255,65,.04);font-size:10px}
.threat-row .tr-label{color:var(--muted);font-family:'Share Tech Mono',monospace}
.threat-row .tr-value{font-weight:700;font-family:'Share Tech Mono',monospace;letter-spacing:.5px}
.threat-bar{height:4px;background:rgba(0,255,65,.08);border-radius:2px;margin-top:3px;overflow:hidden}
.threat-bar-fill{height:100%;border-radius:2px;transition:width .5s}

.topbar{flex-shrink:0;background:var(--panel);border-bottom:1px solid var(--border);padding:7px 12px;display:flex;gap:5px;align-items:center;flex-wrap:wrap;z-index:200}
.topbar .logo{font-weight:800;font-size:13px;color:var(--accent);margin-right:6px;letter-spacing:.5px;white-space:nowrap}
.topbar .logo span{color:var(--text)}
.tb-sep{width:1px;height:18px;background:var(--border2);margin:0 3px;flex-shrink:0}
.tb-btn{background:#111827;border:1px solid var(--border2);color:var(--muted);padding:4px 9px;border-radius:4px;cursor:pointer;font-size:11px;transition:all .15s;white-space:nowrap}
.tb-btn:hover,`.tb-btn.on{background:#1e2a42;border-color:var(--accent);color:var(--text)}
.tb-btn.on{color:#93c5fd}
.tb-btn.iran-on{background:#2d1515;border-color:var(--red);color:#fca5a5}
.tb-btn.russia-on{background:#2d1a15;border-color:#dc2626;color:#fca5a5}
.tb-btn.china-on{background:#2a2610;border-color:var(--yellow);color:#fde047}
.tb-search{background:#111827;border:1px solid var(--border2);color:var(--text);padding:4px 8px;border-radius:4px;font-size:11px;width:120px;outline:none}
.tb-search:focus{border-color:var(--accent)}
.tb-search::placeholder{color:#3a4560}
.tb-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap}

/* ‚îÄ‚îÄ MAIN BODY ‚îÄ‚îÄ */
.main{flex:1;display:flex;overflow:hidden;min-height:0}

/* ‚îÄ‚îÄ MAP AREA ‚îÄ‚îÄ */
.map-wrap{flex:1;position:relative;min-width:0}
#map{position:absolute;inset:0}

/* ‚îÄ‚îÄ RIGHT PANEL ‚îÄ‚îÄ */
.rpanel{width:320px;flex-shrink:0;background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.rpanel-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0}
.rpanel-tabs .tab{flex:1;padding:8px 4px;text-align:center;font-size:11px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all .15s;user-select:none}
.rpanel-tabs .tab:hover{color:var(--text)}
.rpanel-tabs .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.rpanel-body{flex:1;overflow-y:auto;overflow-x:hidden}
.rpanel-body::-webkit-scrollbar{width:4px}
.rpanel-body::-webkit-scrollbar-track{background:#0d111c}
.rpanel-body::-webkit-scrollbar-thumb{background:#1e2a42;border-radius:2px}

/* Right panel sections */
.rp-section{padding:10px 12px 4px;font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);border-bottom:1px solid var(--border)}
.rp-section.mt{margin-top:4px}

/* News cards */
.news-card{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.news-card:hover{background:rgba(59,130,246,.06)}
.news-card .nc-src{font-size:10px;color:var(--accent);font-weight:600;margin-bottom:3px;text-transform:uppercase;letter-spacing:.4px}
.news-card .nc-title{font-size:12px;line-height:1.4;color:var(--text);margin-bottom:4px}
.news-card .nc-meta{font-size:10px;color:var(--muted)}
.news-card.alert .nc-src{color:var(--red)}
.news-card.alert{border-left:2px solid var(--red)}

/* Stats panel */
.stat-block{padding:10px 12px;border-bottom:1px solid var(--border)}
.stat-block .sb-label{font-size:10px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.country-row{display:flex;align-items:center;gap:6px;margin-bottom:5px;font-size:12px}
.country-row .cr-flag{width:18px;text-align:center}
.country-row .cr-name{flex:1;color:var(--muted)}
.country-row .cr-bar-wrap{width:80px;height:6px;background:#111827;border-radius:3px;overflow:hidden}
.country-row .cr-bar{height:100%;border-radius:3px;transition:width .3s}
.country-row .cr-count{width:24px;text-align:right;font-weight:600;color:var(--text)}
.type-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:11px}
.type-row .tr-icon{width:16px;text-align:center}
.type-row .tr-name{flex:1;color:var(--muted)}
.type-row .tr-bar-wrap{width:70px;height:5px;background:#111827;border-radius:3px;overflow:hidden}
.type-row .tr-bar{height:100%;border-radius:3px;transition:width .3s}
.type-row .tr-count{width:24px;text-align:right;font-weight:600;color:var(--text)}

/* Alerts panel */
.zone-card{padding:8px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.zone-card .zc-name{font-size:12px;color:var(--text)}
.zone-card .zc-count{font-size:14px;font-weight:700}
.zone-card.hot{border-left:2px solid var(--red)}
.zone-card.warm{border-left:2px solid var(--orange)}

/* Activity feed */
.feed-item{padding:6px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px;font-size:11px}
.feed-item .fi-flag{flex-shrink:0}
.feed-item .fi-call{font-weight:600;color:var(--text);flex-shrink:0}
.feed-item .fi-type{color:var(--muted)}
.feed-item .fi-alt{margin-left:auto;color:var(--muted);flex-shrink:0}

/* Info panel overlay */
.infopanel{position:absolute;bottom:50px;left:10px;z-index:500;background:rgba(13,17,28,0.97);border:1px solid var(--border2);border-radius:8px;padding:12px;width:260px;display:none;backdrop-filter:blur(12px)}
.infopanel.vis{display:block}
.infopanel .ip-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.infopanel h3{font-size:13px;color:#fff}
.infopanel .x{background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;line-height:1}
.infopanel .x:hover{color:#fff}
.infopanel .f{margin-bottom:3px;font-size:11px}
.infopanel .f .k{color:var(--muted)}
.infopanel .f .v{color:var(--text);font-weight:500}

/* Region quick-jump */
.region-btns{position:absolute;bottom:10px;left:10px;z-index:400;display:flex;flex-direction:column;gap:3px}
.region-btns button{background:rgba(13,17,28,0.88);border:1px solid var(--border2);color:var(--muted);padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px;text-align:left;transition:all .15s}
.region-btns button:hover{color:var(--text);border-color:var(--accent)}

/* Alert zones */
.map-legend{position:absolute;top:10px;right:10px;z-index:400;background:rgba(13,17,28,0.88);border:1px solid var(--border2);border-radius:6px;padding:8px 10px;font-size:10px}
.map-legend .ml-row{display:flex;align-items:center;gap:6px;margin-bottom:3px;color:var(--muted)}
.map-legend .ml-row .ml-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

/* ‚îÄ‚îÄ TICKER ‚îÄ‚îÄ */
.ticker{flex-shrink:0;height:30px;background:rgba(0,0,0,.7);border-top:1px solid var(--border);overflow:hidden;position:relative}
.ticker-inner{display:flex;align-items:center;height:100%;white-space:nowrap;animation:ticker-scroll 80s linear infinite}
.ticker-inner:hover{animation-play-state:paused}
.ticker-item{padding:0 32px;font-size:11px;color:var(--muted)}
.ticker-item .ti-src{color:var(--accent);font-weight:700;margin-right:6px}
.ticker-item .ti-sep{color:var(--border2);margin:0 8px}
@keyframes ticker-scroll{0%{transform:translateX(100vw)}100%{transform:translateX(-100%)}}

/* Leaflet overrides */
.leaflet-popup-content-wrapper{background:#0d111c;color:var(--text);border-radius:8px;border:1px solid var(--border2)}
.leaflet-popup-tip{background:#0d111c}
.dark-tooltip{background:rgba(13,17,28,.95)!important;color:var(--text)!important;border:1px solid var(--border2)!important;border-radius:5px!important;font-size:11px!important;padding:3px 7px!important;box-shadow:0 2px 8px rgba(0,0,0,.5)!important}

/* Loading */
.loading-ov{position:absolute;inset:0;z-index:600;background:rgba(10,14,23,.85);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px}
.loading-ov .sp{font-size:32px;animation:spin 1s linear infinite;display:inline-block}
.loading-ov .st{color:var(--muted);font-size:13px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Responsive */
@media(max-width:768px){
  body{overflow-y:auto;overflow-x:hidden;height:auto}
  .dashboard{display:block;height:auto}
  /* Map widget: explicit height so Leaflet can render */
  .w-map{height:55vmax;min-height:300px;max-height:70vh;position:relative;display:block}
  #map{position:absolute;top:0;left:0;right:0;bottom:0}
  .w-zones,.w-stats,.w-activity,.w-log{height:220px;display:flex;flex-direction:column}
  .topbar{padding:5px 8px;position:sticky;top:0;z-index:9999}
  .tb-btn{padding:4px 6px;font-size:10px}
  .tb-search{width:90px}
  .tb-sep{display:none}
  .tb-label{display:none}
  .infopanel{left:8px!important;right:8px!important;width:auto!important;bottom:8px!important}
  .region-btns{bottom:8px}
  .region-btns button{font-size:9px;padding:3px 5px}
  .map-legend{display:none}
}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <span class="logo">‚ö° PIKE<span>CLAW</span> // OSINT-MIL</span>
  <span class="tb-label">Country:</span>
  <button class="tb-btn on" id="bc-all" onclick="setCF('all')">üåç All</button>
  <button class="tb-btn" id="bc-us" onclick="setCF('us')">üá∫üá∏ US</button>
  <button class="tb-btn" id="bc-iran" onclick="setCF('iran')">üáÆüá∑ Iran</button>
  <button class="tb-btn" id="bc-russia" onclick="setCF('russia')">üá∑üá∫ Russia</button>
  <button class="tb-btn" id="bc-china" onclick="setCF('china')">üá®üá≥ China</button>
  <button class="tb-btn" id="bc-allied" onclick="setCF('allied')">ü§ù Allied</button>
  <div class="tb-sep"></div>
  <span class="tb-label">Type:</span>
  <button class="tb-btn on" id="bt-all" onclick="setTF('all')">All</button>
  <button class="tb-btn" id="bt-fighter" onclick="setTF('fighter')">‚úàÔ∏è Fighter</button>
  <button class="tb-btn" id="bt-transport" onclick="setTF('transport')">üõ©Ô∏è Transport</button>
  <button class="tb-btn" id="bt-tanker" onclick="setTF('tanker')">‚õΩ Tanker</button>
  <button class="tb-btn" id="bt-recon" onclick="setTF('recon')">üîç ISR</button>
  <button class="tb-btn" id="bt-heli" onclick="setTF('heli')">üöÅ Heli</button>
  <button class="tb-btn" id="bt-bomber" onclick="setTF('bomber')">üí£ Bomber</button>
  <div class="tb-sep"></div>
  <input class="tb-search" id="searchBox" placeholder="Search callsign/hex..." oninput="doSearch()"/>
  <button class="tb-btn" onclick="fetchData()" title="Refresh now">üîÑ Refresh</button>
  <div class="tb-sep"></div>
  <span class="tb-label">Map:</span>
  <button class="tb-btn tile-btn on" data-t="dark" onclick="setTile('dark')">üåë Dark</button>
  <button class="tb-btn tile-btn" data-t="satellite" onclick="setTile('satellite')">üõ∞Ô∏è Sat</button>
  <button class="tb-btn tile-btn" data-t="terrain" onclick="setTile('terrain')">üó∫Ô∏è Terrain</button>
  <div class="tb-sep"></div>
  <button class="tb-btn" id="btn-bases" onclick="toggleBases()">üìç Bases</button>
  <button class="tb-btn" id="btn-missiles" onclick="toggleMissiles()">üöÄ Ranges</button>
  <button class="tb-btn" id="btn-nuclear" onclick="toggleNuclear()">‚ò¢Ô∏è WMD Sites</button>
  <button class="tb-btn" id="btn-airdef" onclick="toggleAirDef()">üõ°Ô∏è Air Defense</button>
  <button class="tb-btn on" id="btn-naval" onclick="toggleNavalLayer()">üö¢ Naval</button>
  <button class="tb-btn" id="btn-notif" onclick="toggleNotifications()">üîî Alerts</button>
</div>

<!-- ZULU CLOCK BAR -->
<div class="clock-bar" id="clockBar">
  <div class="clock-cell"><span class="clock-label">ZULU</span><span class="clock-time" id="clk-zulu">--:--:--Z</span></div>
  <div class="clock-cell"><span class="clock-label">üá∫üá∏ DC</span><span class="clock-time" id="clk-dc">--:--</span></div>
  <div class="clock-cell"><span class="clock-label">üá∫üá¶ KYIV</span><span class="clock-time" id="clk-kyiv">--:--</span></div>
  <div class="clock-cell"><span class="clock-label">üá∑üá∫ MOSCOW</span><span class="clock-time" id="clk-moscow">--:--</span></div>
  <div class="clock-cell"><span class="clock-label">üáÆüá∑ TEHRAN</span><span class="clock-time" id="clk-tehran">--:--</span></div>
  <div class="clock-cell"><span class="clock-label">üá®üá≥ BEIJING</span><span class="clock-time" id="clk-beijing">--:--</span></div>
  <div class="clock-cell clock-date"><span class="clock-label">DATE</span><span class="clock-time" id="clk-date">--</span></div>
</div>

<!-- DASHBOARD GRID -->
<div class="dashboard">

  <!-- MAP WIDGET -->
  <div class="widget w-map">
    <div id="map" style="position:absolute;inset:0"></div>
    <div class="map-legend" style="position:absolute;top:10px;right:10px;z-index:400">
      <div class="ml-row"><div class="ml-dot" style="background:#00ff41"></div>üá∫üá∏ US</div>
      <div class="ml-row"><div class="ml-dot" style="background:#ef4444"></div>üáÆüá∑ Iran</div>
      <div class="ml-row"><div class="ml-dot" style="background:#dc2626"></div>üá∑üá∫ Russia</div>
      <div class="ml-row"><div class="ml-dot" style="background:#eab308"></div>üá®üá≥ China</div>
      <div class="ml-row"><div class="ml-dot" style="background:#bf5fff"></div>ü§ù Allied</div>
    </div>
    <div class="region-btns" style="position:absolute;bottom:10px;left:10px;z-index:400">
      <button onclick="goTo(30,50,5)">üî• Mid East</button>
      <button onclick="goTo(38,-97,4)">üá∫üá∏ CONUS</button>
      <button onclick="goTo(50,15,4)">üá™üá∫ Europe</button>
      <button onclick="goTo(25,125,4)">üåè Pacific</button>
      <button onclick="goTo(20,0,2)">üåç Global</button>
    </div>
    <div class="infopanel" id="infoP" style="position:absolute;bottom:50px;left:10px;z-index:500">
      <div class="ip-head"><h3 id="pTitle">‚Äî</h3><button class="x" onclick="closeP()">&times;</button></div>
      <div id="pBody"></div>
    </div>
    <div class="loading-ov" id="loadOv" style="position:absolute;inset:0;z-index:600">
      <div class="sp">‚úàÔ∏è</div><div class="st">Loading...</div>
    </div>
  </div>

  <!-- ZONES WIDGET -->
  <div class="widget w-zones">
    <div class="widget-header">‚ö†Ô∏è <span class="wh-title">Alert Zones</span><span class="wh-count" id="zone-hot">0 hot</span></div>
    <div class="widget-body" id="pane-alerts"></div>
  </div>

  <!-- STATS WIDGET -->
  <div class="widget w-stats">
    <div class="widget-header">üìä <span class="wh-title">Stats</span></div>
    <div class="widget-body" id="pane-stats"></div>
  </div>

  <!-- ACTIVITY WIDGET -->
  <div class="widget w-activity">
    <div class="widget-header" style="padding:0;gap:0">
      <div style="display:flex;flex:1">
        <div id="act-tab-activity" onclick="switchActTab('activity')" style="flex:1;padding:7px 8px;text-align:center;font-size:9px;font-family:'Share Tech Mono',monospace;letter-spacing:.5px;text-transform:uppercase;cursor:pointer;color:rgba(0,255,65,.7);border-bottom:2px solid rgba(0,255,65,.6);border-right:1px solid rgba(0,255,65,.08)">üîî ACTIVITY <span id="ac-count" style="opacity:.7">0</span></div>
        <div id="act-tab-log"      onclick="switchActTab('log')"      style="flex:1;padding:7px 8px;text-align:center;font-size:9px;font-family:'Share Tech Mono',monospace;letter-spacing:.5px;text-transform:uppercase;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent">üìã LOG <span id="log-count" style="opacity:.7">0</span></div>
      </div>
    </div>
    <div class="widget-body">
      <div id="pane-activity"></div>
      <div id="pane-log" style="display:none"></div>
    </div>
  </div>

  <!-- DEFCON / THREAT POSTURE WIDGET -->
  <div class="widget w-log" style="grid-column:3;grid-row:1">
    <div class="widget-header">üö® <span class="wh-title">Threat Posture</span><span class="wh-count" id="threat-level" style="color:#22c55e">NORMAL</span></div>
    <div class="widget-body" id="pane-threat"></div>
  </div>

  <!-- ADVERSARY INTEL WIDGET -->
  <div class="widget" style="grid-column:2/4;grid-row:2">
    <div class="widget-header" style="padding:0">
      <div id="adv-tabs" style="display:flex;width:100%">
        <div class="adv-tab active" data-adv="iran"   onclick="switchAdv('iran')"  >üáÆüá∑ Iran</div>
        <div class="adv-tab"        data-adv="russia" onclick="switchAdv('russia')">üá∑üá∫ Russia</div>
        <div class="adv-tab"        data-adv="china"  onclick="switchAdv('china')" >üá®üá≥ China</div>
      </div>
    </div>
    <div class="widget-body" id="pane-adv" style="padding:0"></div>
  </div>

  <!-- NAVAL ACTIVITY WIDGET -->
  <div class="widget" style="grid-column:2/4;grid-row:3">
    <div class="widget-header">üö¢ <span class="wh-title">Naval Deployments</span><span class="wh-count" id="naval-count">0 assets</span></div>
    <div class="widget-body" id="pane-naval" style="padding:0;display:flex;flex-direction:column"></div>
  </div>

</div>

<!-- POLYMARKET + NEWS ROW -->
<div style="flex-shrink:0;height:175px;display:flex;border-top:1px solid rgba(0,255,65,.15);background:#000">

  <!-- POLYMARKET WIDGET -->
  <div style="width:380px;flex-shrink:0;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden">
    <div style="flex-shrink:0;padding:6px 10px;background:rgba(0,4,0,.6);border-bottom:1px solid rgba(0,255,65,.1);font-size:10px;font-weight:700;letter-spacing:1px;color:rgba(0,255,65,.5);text-transform:uppercase;display:flex;align-items:center;gap:6px">
      üé≤ <span style="flex:1">Polymarket ‚Äî Military & Conflict Odds</span>
      <span id="poly-updated" style="font-size:9px;color:#3a4560"></span>
    </div>
    <div style="flex:1;overflow-x:auto;overflow-y:hidden;display:flex;align-items:stretch" id="polyStrip"></div>
  </div>

</div>

  <!-- X / OSINT ACCOUNTS WIDGET -->
  <div style="width:420px;flex-shrink:0;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden">
    <div style="flex-shrink:0;padding:6px 10px;background:rgba(0,4,0,.6);border-bottom:1px solid rgba(0,255,65,.1);font-size:10px;font-weight:700;letter-spacing:1px;color:rgba(0,255,65,.5);text-transform:uppercase;display:flex;align-items:center;gap:6px">
      üì° <span style="flex:1">OSINT Feeds</span>
      <span id="x-account-tabs" style="display:flex;gap:4px"></span>
    </div>
    <div style="flex:1;overflow-y:auto;overflow-x:hidden" id="xFeed"></div>
  </div>

  <!-- NEWS STRIP -->
  <div style="flex:1;display:flex;flex-direction:column;overflow:hidden">
    <div style="flex-shrink:0;padding:6px 10px;background:rgba(0,4,0,.6);border-bottom:1px solid rgba(0,255,65,.1);font-size:10px;font-weight:700;letter-spacing:1px;color:rgba(0,255,65,.5);text-transform:uppercase">üì∞ Intel Feed</div>
    <div style="flex:1;overflow-x:auto;overflow-y:hidden;display:flex;align-items:stretch" id="newsStrip"></div>
  </div>

</div>

<!-- TICKER -->

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAP SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const map = L.map('map', { center:[30,50], zoom:5, zoomControl:true });
const TILES = {
  dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {attribution:'&copy; OSM &copy; CARTO | adsb.lol',subdomains:'abcd',maxZoom:19}),
  labels: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {subdomains:'abcd',maxZoom:19,pane:'overlayPane'}),
  borders: L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-lines/{z}/{x}/{y}.png', {maxZoom:18,opacity:0.6,pane:'overlayPane'}),
  satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution:'&copy; Esri',maxZoom:19}),
  terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {attribution:'&copy; OSM',subdomains:'abc',maxZoom:17}),
};
let currentTile = 'dark';
TILES.dark.addTo(map);
TILES.labels.addTo(map);
TILES.borders.addTo(map);
// Tint the map green for situation room aesthetic
const mapEl = document.getElementById('map');
mapEl.style.filter = 'hue-rotate(85deg) saturate(0.6) brightness(0.9) contrast(1.1)';

function setTile(t){
  map.removeLayer(TILES[currentTile]);
  if(t==='dark'){
    // Re-add borders + labels for dark mode
    if(!map.hasLayer(TILES.borders)) TILES.borders.addTo(map);
    if(!map.hasLayer(TILES.labels)) TILES.labels.addTo(map);
  } else {
    // Remove extra layers for sat/terrain (they have their own features)
    if(map.hasLayer(TILES.borders)) map.removeLayer(TILES.borders);
    if(map.hasLayer(TILES.labels)) map.removeLayer(TILES.labels);
  }
  currentTile=t;
  TILES[t].addTo(map);
  document.querySelectorAll('.tile-btn').forEach(b=>b.classList.toggle('on',b.dataset.t===t));
}
function goTo(lat,lon,z){ map.setView([lat,lon],z); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MILITARY BASES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BASES = [
  // US
  {name:'Al Udeid AB',lat:25.117,lon:51.315,country:'us',type:'Air Base'},
  {name:'Ali Al Salem AB',lat:29.347,lon:47.521,country:'us',type:'Air Base'},
  {name:'Al Dhafra AB',lat:24.248,lon:54.548,country:'us',type:'Air Base'},
  {name:'Incirlik AB',lat:37.002,lon:35.426,country:'us',type:'Air Base'},
  {name:'RAF Mildenhall',lat:52.362,lon:0.486,country:'us',type:'Air Base'},
  {name:'Ramstein AB',lat:49.437,lon:7.600,country:'us',type:'Air Base'},
  {name:'Kadena AB',lat:26.356,lon:127.768,country:'us',type:'Air Base'},
  {name:'Yokota AB',lat:35.748,lon:139.348,country:'us',type:'Air Base'},
  {name:'Diego Garcia',lat:-7.313,lon:72.423,country:'us',type:'Naval Base'},
  {name:'Naval Base Bahrain',lat:26.218,lon:50.612,country:'us',type:'Naval Base'},
  {name:'Camp Lemonnier',lat:11.553,lon:43.159,country:'us',type:'Base'},
  {name:'Andersen AFB',lat:13.584,lon:144.930,country:'us',type:'Air Base'},
  {name:'Osan AB',lat:37.090,lon:127.030,country:'us',type:'Air Base'},
  {name:'Aviano AB',lat:46.032,lon:12.597,country:'us',type:'Air Base'},
  // Iran
  {name:'Mehrabad Air Base',lat:35.689,lon:51.314,country:'iran',type:'Air Base'},
  {name:'Isfahan Air Base',lat:32.508,lon:51.694,country:'iran',type:'Air Base'},
  {name:'Bandar Abbas Naval',lat:27.218,lon:56.362,country:'iran',type:'Naval Base'},
  {name:'Bushehr Naval',lat:28.942,lon:50.835,country:'iran',type:'Naval Base'},
  {name:'Tabriz Air Base',lat:38.133,lon:46.235,country:'iran',type:'Air Base'},
  {name:'Omidiyeh Air Base',lat:30.835,lon:49.534,country:'iran',type:'Air Base'},
  // Russia
  {name:'Hmeimim AB (Syria)',lat:35.401,lon:35.948,country:'russia',type:'Air Base'},
  {name:'Sevastopol Naval',lat:44.623,lon:33.523,country:'russia',type:'Naval Base'},
  {name:'Engelss-2 AB',lat:51.428,lon:46.177,country:'russia',type:'Air Base'},
  {name:'Kaliningrad Base',lat:54.710,lon:20.508,country:'russia',type:'Base'},
  {name:'Tartus Naval (Syria)',lat:34.893,lon:35.887,country:'russia',type:'Naval Base'},
  // China
  {name:'Sanya Naval Base',lat:18.230,lon:109.572,country:'china',type:'Naval Base'},
  {name:'Zhanjiang Naval',lat:21.182,lon:110.401,country:'china',type:'Naval Base'},
  {name:'Lingshui AF',lat:18.492,lon:110.038,country:'china',type:'Air Base'},
  {name:'Fiery Cross Reef',lat:9.549,lon:112.893,country:'china',type:'Island Base'},
  {name:'Mischief Reef',lat:9.908,lon:115.534,country:'china',type:'Island Base'},
];

const baseCols={us:'#00ff41',iran:'#ff2040',russia:'#dc2626',china:'#e5ff00'};
let baseMarkers=[];
let basesVisible=false;

function toggleBases(){
  basesVisible=!basesVisible;
  document.getElementById('btn-bases').classList.toggle('on',basesVisible);
  if(basesVisible){
    BASES.forEach(b=>{
      const col=baseCols[b.country]||'#64748b';
      const m=L.marker([b.lat,b.lon],{
        icon:L.divIcon({html:`<div style="color:${col};font-size:14px;text-shadow:0 0 6px ${col}80">‚¨ü</div>`,className:'',iconSize:[14,14],iconAnchor:[7,7]})
      }).bindTooltip(`${FLAGS[b.country]||'üåê'} ${b.name} (${b.type})`,{className:'dark-tooltip',direction:'top'}).addTo(map);
      baseMarkers.push(m);
    });
  } else {
    baseMarkers.forEach(m=>map.removeLayer(m));
    baseMarkers=[];
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COUNTRY DETECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CR = {
  us:[[0xA00000,0xAFFFFF]],
  iran:[[0x730000,0x737FFF]],
  russia:[[0x100000,0x13FFFF]],
  china:[[0x780000,0x7BFFFF]],
  uk:[[0x400000,0x43FFFF]],
  france:[[0x380000,0x3BFFFF]],
  germany:[[0x3C0000,0x3FFFFF]],
  australia:[[0x7C0000,0x7FFFFF]],
  japan:[[0x840000,0x87FFFF]],
  korea:[[0x718000,0x71FFFF]],
  israel:[[0x738000,0x73FFFF]],
  saudi:[[0x710000,0x717FFF]],
  turkey:[[0x4B0000,0x4B7FFF]],
  india:[[0x800000,0x83FFFF]],
  pakistan:[[0x760000,0x767FFF]],
  canada:[[0xC00000,0xC3FFFF]],
  italy:[[0x300000,0x33FFFF]],
  nato:[[0x480000,0x480FFF]],
  uae:[[0x896000,0x896FFF]],
};
const FLAGS={us:'üá∫üá∏',iran:'üáÆüá∑',russia:'üá∑üá∫',china:'üá®üá≥',uk:'üá¨üáß',france:'üá´üá∑',germany:'üá©üá™',australia:'üá¶üá∫',japan:'üáØüáµ',korea:'üá∞üá∑',israel:'üáÆüá±',saudi:'üá∏üá¶',turkey:'üáπüá∑',india:'üáÆüá≥',pakistan:'üáµüá∞',canada:'üá®üá¶',italy:'üáÆüáπ',nato:'üèõÔ∏è',uae:'üá¶üá™'};
const CNAMES={us:'United States',iran:'Iran',russia:'Russia',china:'China',uk:'United Kingdom',france:'France',germany:'Germany',australia:'Australia',japan:'Japan',korea:'South Korea',israel:'Israel',saudi:'Saudi Arabia',turkey:'Turkey',india:'India',pakistan:'Pakistan',canada:'Canada',italy:'Italy',nato:'NATO',uae:'UAE'};
const GCOL={us:'#00ff41',iran:'#ff2040',russia:'#dc2626',china:'#e5ff00',allied:'#bf5fff',unknown:'#4a6a4a'};

function getCountry(hex){
  const h=parseInt(hex,16);
  for(const[c,rs]of Object.entries(CR))for(const[lo,hi]of rs)if(h>=lo&&h<=hi)return c;
  return'unknown';
}
function getGroup(hex){const c=getCountry(hex);return(['us','iran','russia','china'].includes(c))?c:'allied';}
function getFlag(hex){return FLAGS[getCountry(hex)]||'üåê';}
function getCName(hex){return CNAMES[getCountry(hex)]||'Unknown';}
function getCol(hex){return GCOL[getGroup(hex)]||'#64748b';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AIRCRAFT TYPE CLASSIFICATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TYPES = {
  fighter: ['F15','F16','F18','F22','F35','FA18','EUFI','A10','AV8B','EA18','F14','F5','SU27','SU30','SU35','MIG29','MIG31','J10','J11','J16','J20','RFAL','TOR','F4','MIR'],
  transport:['C17','C130','C30J','C5','C5M','C12','C40','C37','IL76','AN124','AN12','Y20','A400','C295','C27J','C160','C145','C146','C2'],
  tanker:   ['KC10','KC46','KC135','KC130','MRTT','IL78','KC30'],
  recon:    ['P8','P3','EP3','RC135','E3','E6','E8','E2','U2','RQ4','MQ9','MQ1','MC12','E737','WC135','WC130','MC130','EC130','RQ170'],
  heli:     ['UH60','AH64','CH47','CH53','MH60','V22','MV22','CV22','MI17','MI24','MI8','MI28','HH60','SH60','AS65','NH90','UH1','AH1','H60','H47','H53'],
  bomber:   ['B52','B1','B2','B21','TU95','TU160','H6','B1B','B52H'],
  trainer:  ['T6','T38','T45','T1','BE20','PC12','C172','T7','T50','PC21','LJ35','T44','TH57']
};
const TCOL={fighter:'#f97316',transport:'#38bdf8',tanker:'#c084fc',recon:'#22d3ee',heli:'#4ade80',bomber:'#f87171',trainer:'#facc15',other:'#64748b'};
const TLAB={fighter:'Fighter/Attack',transport:'Transport',tanker:'Tanker',recon:'ISR/Patrol',heli:'Helicopter',bomber:'Bomber',trainer:'Trainer',other:'Other'};
const TICO={fighter:'‚úàÔ∏è',transport:'üõ©Ô∏è',tanker:'‚õΩ',recon:'üîç',heli:'üöÅ',bomber:'üí£',trainer:'üéì',other:'‚óÜ'};

function classifyType(ac){
  const t=(ac.t||'').toUpperCase().replace(/[^A-Z0-9]/g,'');
  const fl=(ac.flight||'').trim().toUpperCase();
  for(const[cat,pats]of Object.entries(TYPES)){
    for(const p of pats){const pp=p.replace(/[^A-Z0-9]/g,'');if(t.includes(pp)||t.startsWith(pp))return cat;}
  }
  if(/^VIPER|^RAGE|^COBRA/.test(fl))return'fighter';
  if(/^RCH|^REACH/.test(fl))return'transport';
  if(/^ETHYL|^TEXAC/.test(fl))return'tanker';
  if(/^JAKE|^TOPCAT/.test(fl))return'recon';
  if(/^DUST|^PEDRO/.test(fl))return'heli';
  return'other';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALERT ZONES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ZONES=[
  {name:'Strait of Hormuz',   bounds:[[25.5,55.5],[27.5,57.5]], color:'#ef4444', icon:'üö®'},
  {name:'Persian Gulf',       bounds:[[24,48],[30,56]],          color:'#f97316', icon:'‚ö†Ô∏è'},
  {name:'Taiwan Strait',      bounds:[[22,117],[26,121]],        color:'#eab308', icon:'‚ö†Ô∏è'},
  {name:'South China Sea',    bounds:[[5,108],[18,121]],         color:'#eab308', icon:'‚ö†Ô∏è'},
  {name:'Black Sea',          bounds:[[41,27],[47,42]],          color:'#dc2626', icon:'‚ö†Ô∏è'},
  {name:'Baltic Sea',         bounds:[[53,12],[60,30]],          color:'#8b5cf6', icon:'‚ÑπÔ∏è'},
  {name:'Mediterranean',      bounds:[[30,10],[46,36]],          color:'#8b5cf6', icon:'‚ÑπÔ∏è'},
  {name:'Arabian Sea',        bounds:[[10,55],[25,72]],          color:'#f97316', icon:'‚ö†Ô∏è'},
];
ZONES.forEach(z=>{
  L.rectangle(z.bounds,{color:z.color,weight:1,fillOpacity:0.07,opacity:0.35,interactive:false}).addTo(map);
  L.marker([(z.bounds[0][0]+z.bounds[1][0])/2,(z.bounds[0][1]+z.bounds[1][1])/2],{
    icon:L.divIcon({html:`<div style="font-size:9px;color:${z.color};white-space:nowrap;text-shadow:0 0 3px #000;font-weight:700;opacity:.7">${z.name}</div>`,className:'',iconAnchor:[0,0]})
  }).addTo(map);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let mkrs={}, acData=[], trails={}, cFilt='all', tFilt='all', searchQ='', curTab='news';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MARKERS + TRAILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SVG paths for each aircraft type (all pointing UP = 0¬∞, rotated by heading)
const SVG_ICONS = {
  fighter: `<polygon points="8,0 10,14 8,11 6,14" fill="COLOR" stroke="COLOR" stroke-width=".5"/>
    <polygon points="8,4 14,12 8,9 2,12" fill="COLOR" opacity=".85"/>
    <polygon points="8,9 11,16 8,14 5,16" fill="COLOR" opacity=".7"/>`,
  bomber: `<polygon points="8,0 11,10 8,8 5,10" fill="COLOR"/>
    <polygon points="8,3 16,14 8,10 0,14" fill="COLOR" opacity=".9"/>
    <polygon points="8,9 12,17 8,15 4,17" fill="COLOR" opacity=".7"/>`,
  transport: `<rect x="6" y="0" width="4" height="14" rx="2" fill="COLOR"/>
    <polygon points="8,3 16,10 8,8 0,10" fill="COLOR" opacity=".85"/>
    <polygon points="8,10 11,16 8,14 5,16" fill="COLOR" opacity=".7"/>`,
  tanker: `<rect x="6.5" y="0" width="3" height="14" rx="1.5" fill="COLOR"/>
    <polygon points="8,2 15,9 8,7 1,9" fill="COLOR" opacity=".85"/>
    <polygon points="8,9 11,15 8,13 5,15" fill="COLOR" opacity=".7"/>
    <circle cx="8" cy="0" r="1.5" fill="COLOR"/>`,
  recon: `<ellipse cx="8" cy="7" rx="3" ry="7" fill="COLOR"/>
    <polygon points="8,2 15,8 8,6 1,8" fill="COLOR" opacity=".8"/>
    <line x1="8" y1="14" x2="8" y2="17" stroke="COLOR" stroke-width="1.5"/>`,
  heli: `<ellipse cx="8" cy="9" rx="3" ry="4" fill="COLOR"/>
    <line x1="1" y1="7" x2="15" y2="7" stroke="COLOR" stroke-width="2" stroke-linecap="round"/>
    <line x1="6" y1="14" x2="12" y2="14" stroke="COLOR" stroke-width="1.5" stroke-linecap="round"/>
    <line x1="8" y1="7" x2="8" y2="14" stroke="COLOR" stroke-width="1"/>`,
  trainer: `<polygon points="8,1 10,12 8,10 6,12" fill="COLOR"/>
    <polygon points="8,4 13,10 8,8 3,10" fill="COLOR" opacity=".85"/>`,
  other: `<polygon points="8,0 10,12 8,10 6,12" fill="COLOR"/>
    <polygon points="8,3 14,11 8,8 2,11" fill="COLOR" opacity=".8"/>`,
};

function mkIcon(ac){
  const tp=classifyType(ac);
  const g=getGroup(ac.hex);
  const col=getCol(ac.hex);
  const adv=(g==='iran'||g==='russia'||g==='china');
  const rot=ac.track||0;
  const sz=adv?22:18;
  const svgPath=(SVG_ICONS[tp]||SVG_ICONS.other).replace(/COLOR/g,col);
  const glow=adv?`drop-shadow(0 0 3px ${col})`:'drop-shadow(0 0 1px #000)';
  const html=`<svg width="${sz}" height="${sz}" viewBox="0 0 16 18" style="transform:rotate(${rot}deg);filter:${glow};overflow:visible">${svgPath}</svg>`;
  return L.divIcon({html,className:'',iconSize:[sz,sz],iconAnchor:[sz/2,sz/2]});
}

function updateTrail(ac){
  if(!ac.lat||!ac.lon)return;
  if(!trails[ac.hex])trails[ac.hex]={pts:[],line:null};
  const tr=trails[ac.hex];
  const last=tr.pts[tr.pts.length-1];
  if(!last||last[0]!==ac.lat||last[1]!==ac.lon)tr.pts.push([ac.lat,ac.lon]);
  if(tr.pts.length>40)tr.pts.shift();
}
function showTrail(hex){
  hideTrails();
  const tr=trails[hex];if(!tr||tr.pts.length<2)return;
  tr.line=L.polyline(tr.pts,{color:getCol(hex),weight:2,opacity:0.55,dashArray:'5 4'}).addTo(map);
}
function hideTrails(){Object.values(trails).forEach(t=>{if(t.line){map.removeLayer(t.line);t.line=null;}})}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INFO PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AIRCRAFT CAPABILITY DATABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AC_CAPS = {
  // Fighters
  'F15':  {name:'F-15 Eagle/Strike Eagle', role:'Air Superiority / Strike Fighter', crew:'1-2', range:'~1,200 nmi', ceiling:'65,000 ft', speed:'Mach 2.5', weapons:'AIM-120 AMRAAM, AIM-9X, JDAM, SDB, AGM-84 SLAM-ER', desc:'Twin-engine air superiority fighter. Strike Eagle variant adds precision ground attack. Backbone of USAF air dominance.'},
  'F16':  {name:'F-16 Fighting Falcon', role:'Multirole Fighter', crew:'1', range:'~1,200 nmi', ceiling:'50,000 ft', speed:'Mach 2.0', weapons:'AIM-120, AIM-9X, JDAM, AGM-88 HARM, Mk-80 series bombs', desc:'Lightweight multirole fighter. High agility, large weapons load. Most widely used Western fighter.'},
  'F18':  {name:'F/A-18 Hornet/Super Hornet', role:'Carrier-Based Multirole', crew:'1-2', range:'~1,275 nmi', ceiling:'50,000 ft', speed:'Mach 1.8', weapons:'AIM-120, AIM-9X, JDAM, JSOW, LRASM, AGM-88', desc:'Carrier-based strike fighter. Super Hornet (E/F) is primary US Navy combat aircraft. Growler (EA-18G) variant provides electronic warfare.'},
  'F22':  {name:'F-22 Raptor', role:'5th Gen Air Superiority', crew:'1', range:'~1,600 nmi', ceiling:'65,000 ft', speed:'Mach 2.25 (supercruise Mach 1.8)', weapons:'AIM-120 AMRAAM, AIM-9X, JDAM, SDB (internal bays)', desc:'Stealth air dominance fighter. Supercruise capability. Most advanced air superiority platform in the world.'},
  'F35':  {name:'F-35 Lightning II', role:'5th Gen Multirole Stealth', crew:'1', range:'~1,200 nmi', ceiling:'50,000 ft', speed:'Mach 1.6', weapons:'AIM-120, AIM-9X, JDAM, SDB, GBU-53 (internal + external)', desc:'Stealth multirole fighter. Advanced sensor fusion, EOTS, DAS. A/B/C variants for USAF/Marines/Navy.'},
  // Bombers
  'B52':  {name:'B-52H Stratofortress', role:'Strategic Bomber', crew:'5', range:'~8,800 nmi', ceiling:'50,000 ft', speed:'650 mph', weapons:'JASSM-ER, ALCM, JDAM, Mk-80 series, mines, Harpoon, nuclear (AGM-86B)', desc:'Long-range heavy bomber. Can carry 70,000 lbs of ordnance. Nuclear capable. In service since 1955, expected to fly until 2050s.'},
  'B1':   {name:'B-1B Lancer', role:'Strategic/Conventional Bomber', crew:'4', range:'~5,100 nmi', ceiling:'60,000 ft', speed:'Mach 1.25', weapons:'JASSM-ER, JDAM, JSOW, Mk-84, CBU-87/97, LRASM', desc:'Supersonic variable-sweep wing bomber. Largest conventional payload in USAF. No longer nuclear-tasked.'},
  'B2':   {name:'B-2 Spirit', role:'Stealth Strategic Bomber', crew:'2', range:'~6,000 nmi', ceiling:'50,000 ft', speed:'628 mph', weapons:'B61/B83 nuclear, JDAM, GBU-57 MOP, JSOW', desc:'Flying-wing stealth bomber. Penetrating strike ‚Äî can hit any target on Earth. Nuclear capable. Only 20 built.'},
  'B21':  {name:'B-21 Raider', role:'Next-Gen Stealth Bomber', crew:'2', range:'Classified (est. 5,000+ nmi)', ceiling:'Classified', speed:'Subsonic', weapons:'Nuclear & conventional (classified payload)', desc:'Next-generation stealth bomber. Designed to penetrate advanced air defenses. Nuclear capable. Replacing B-2.'},
  // Tankers
  'KC135':{name:'KC-135 Stratotanker', role:'Aerial Refueling', crew:'3', range:'~1,500 nmi (w/ cargo)', ceiling:'50,000 ft', speed:'530 mph', weapons:'None ‚Äî unarmed', desc:'Primary USAF aerial refueling tanker. Can offload 200,000 lbs of fuel. Enables global power projection. Force multiplier.'},
  'KC10': {name:'KC-10 Extender', role:'Aerial Refueling / Transport', crew:'4', range:'~4,400 nmi', ceiling:'42,000 ft', speed:'619 mph', weapons:'None ‚Äî unarmed', desc:'Advanced tanker/cargo aircraft. Can refuel via boom and drogue simultaneously. Carries cargo + fuel.'},
  'KC46': {name:'KC-46 Pegasus', role:'Next-Gen Aerial Refueling', crew:'3', range:'~6,385 nmi', ceiling:'43,000 ft', speed:'570 mph', weapons:'None ‚Äî unarmed', desc:'Replacing KC-135. Boom + drogue. Can carry 65 passengers or 58,000 lbs cargo while tanking. Advanced vision system.'},
  // ISR
  'RC135':{name:'RC-135 Rivet Joint', role:'Signals Intelligence (SIGINT)', crew:'27-32', range:'~3,900 nmi', ceiling:'50,000 ft', speed:'500 mph', weapons:'None ‚Äî unarmed', desc:'Real-time SIGINT collection. Detects, identifies, and geolocates electronic emissions. Critical in conflict zones.'},
  'E3':   {name:'E-3 Sentry (AWACS)', role:'Airborne Early Warning & Control', crew:'19-34', range:'~4,600 nmi', ceiling:'41,000 ft', speed:'530 mph', weapons:'None ‚Äî unarmed', desc:'Rotating radar dome provides 360¬∞ surveillance out to 250+ nmi. Controls air battle space. Command & control platform.'},
  'E8':   {name:'E-8 JSTARS', role:'Ground Surveillance / Battle Mgmt', crew:'21-34', range:'~5,000 nmi', ceiling:'42,000 ft', speed:'587 mph', weapons:'None ‚Äî unarmed', desc:'Joint Surveillance Target Attack Radar System. Tracks ground vehicles and low-flying aircraft over massive areas.'},
  'RQ4':  {name:'RQ-4 Global Hawk', role:'High-Altitude ISR (UAV)', crew:'0 (remote)', range:'~12,300 nmi', ceiling:'60,000 ft', speed:'391 mph', weapons:'None ‚Äî unarmed', desc:'Unmanned high-altitude ISR. Provides persistent surveillance over vast areas. 32+ hour endurance.'},
  'MQ9':  {name:'MQ-9 Reaper', role:'Hunter-Killer UAV', crew:'0 (remote)', range:'~1,150 nmi', ceiling:'50,000 ft', speed:'300 mph', weapons:'AGM-114 Hellfire, GBU-38 JDAM, GBU-12 Paveway II', desc:'Armed remotely piloted aircraft. Persistent ISR + precision strike. Primary US drone for targeted operations.'},
  'MQ4':  {name:'MQ-4C Triton', role:'Maritime ISR (UAV)', crew:'0 (remote)', range:'~8,200 nmi', ceiling:'56,500 ft', speed:'361 mph', weapons:'None ‚Äî unarmed', desc:'Navy variant of Global Hawk. Maritime surveillance. Works with P-8 Poseidon for ocean domain awareness.'},
  'P8':   {name:'P-8A Poseidon', role:'Maritime Patrol / ASW', crew:'9', range:'~1,200 nmi (patrol)', ceiling:'41,000 ft', speed:'564 mph', weapons:'Mk-54 torpedoes, Harpoon, sonobuoys, mines', desc:'Primary US Navy maritime patrol aircraft. Anti-submarine warfare, anti-surface warfare, ISR. Replaced P-3 Orion.'},
  'P3':   {name:'P-3 Orion', role:'Maritime Patrol / ASW', crew:'11', range:'~2,380 nmi', ceiling:'28,300 ft', speed:'411 mph', weapons:'Mk-46/54 torpedoes, Harpoon, mines, sonobuoys', desc:'Legacy maritime patrol. Anti-submarine warfare specialist. Being replaced by P-8 Poseidon.'},
  'EP3':  {name:'EP-3E Aries II', role:'Signals Intelligence (SIGINT)', crew:'24', range:'~2,380 nmi', ceiling:'28,300 ft', speed:'411 mph', weapons:'None ‚Äî unarmed', desc:'Electronic reconnaissance aircraft. Collects signals intelligence from airborne platform. Navy SIGINT workhorse.'},
  'U2':   {name:'U-2 Dragon Lady', role:'High-Altitude Reconnaissance', crew:'1', range:'~6,090 nmi', ceiling:'70,000+ ft', speed:'475 mph', weapons:'None ‚Äî unarmed', desc:'Ultra-high altitude reconnaissance. Carries multiple sensor packages. Flies above most threats. In service since 1957.'},
  'E6':   {name:'E-6B Mercury', role:'Nuclear Command & Control (TACAMO)', crew:'22', range:'~6,600 nmi', ceiling:'40,000 ft', speed:'522 mph', weapons:'None ‚Äî unarmed (relays nuclear launch orders)', desc:'Airborne command post for nuclear forces. TACAMO ‚Äî communications link to ballistic missile submarines. Doomsday plane.'},
  'E4':   {name:'E-4B Nightwatch', role:'National Airborne Operations Center', crew:'48-112', range:'~6,325 nmi', ceiling:'45,000 ft', speed:'602 mph', weapons:'None ‚Äî unarmed', desc:'\"Doomsday plane.\" National command authority airborne HQ during nuclear war. Hardened against EMP. Presidential succession platform.'},
  // Transports
  'C17':  {name:'C-17 Globemaster III', role:'Strategic/Tactical Airlift', crew:'3', range:'~2,400 nmi (full load)', ceiling:'45,000 ft', speed:'515 mph', weapons:'None ‚Äî unarmed', desc:'Can carry 170,000 lbs ‚Äî tanks, troops, helicopters. Lands on short/austere runways. Primary US strategic airlifter.'},
  'C5':   {name:'C-5M Super Galaxy', role:'Strategic Airlift', crew:'7', range:'~5,524 nmi', ceiling:'35,700 ft', speed:'518 mph', weapons:'None ‚Äî unarmed', desc:'Largest US military transport. Carries 280,000 lbs. Can load 2x M1 Abrams tanks. Outsize/oversize cargo specialist.'},
  'C130':  {name:'C-130 Hercules/Super Herc', role:'Tactical Airlift', crew:'5', range:'~2,050 nmi', ceiling:'33,000 ft', speed:'366 mph', weapons:'None (AC-130 variant: 105mm howitzer, 40mm cannon, 25mm GAU)', desc:'Most versatile military transport ever built. Tactical airlift, spec ops, medevac, firefighting. 70+ nations operate it.'},
  'C130J': {name:'C-130J Super Hercules', role:'Tactical Airlift', crew:'3', range:'~2,835 nmi', ceiling:'28,000 ft', speed:'417 mph', weapons:'None ‚Äî unarmed', desc:'Modernized Hercules. Faster, higher, farther than legacy C-130. Glass cockpit, 6-blade props. Tactical workhorse.'},
  'C40':  {name:'C-40 Clipper', role:'VIP / Fleet Logistics', crew:'4', range:'~5,200 nmi', ceiling:'41,000 ft', speed:'530 mph', weapons:'None ‚Äî unarmed', desc:'Military 737 variant. Navy fleet logistics, VIP transport. Congressional delegations (CODEL).'},
  'V22':  {name:'V-22 Osprey', role:'Tiltrotor Transport', crew:'4', range:'~879 nmi', ceiling:'25,000 ft', speed:'316 mph', weapons:'Ramp-mounted .50 cal or GAU-21', desc:'Tiltrotor ‚Äî helicopter takeoff, airplane speed. Carries 24 combat troops or 20,000 lbs cargo. USMC/AFSOC primary.'},
  // Helicopters
  'H60':  {name:'H-60 Black Hawk / Seahawk', role:'Utility / ASW Helicopter', crew:'2-4', range:'~320 nmi', ceiling:'19,000 ft', speed:'183 mph', weapons:'M240 MG, Hellfire, Mk-54 torpedo (SH-60), mines', desc:'Most produced military helicopter family. Army (UH-60), Navy (MH-60R/S), AFSOC (HH-60). Multi-mission workhorse.'},
  'H47':  {name:'CH-47 Chinook', role:'Heavy-Lift Helicopter', crew:'3', range:'~400 nmi', ceiling:'20,000 ft', speed:'196 mph', weapons:'M240 MG, M134 minigun', desc:'Tandem-rotor heavy lifter. Carries 33 troops or 28,000 lbs sling load. Mountain/high altitude specialist.'},
  'AH64': {name:'AH-64 Apache', role:'Attack Helicopter', crew:'2', range:'~257 nmi', ceiling:'21,000 ft', speed:'182 mph', weapons:'M230 30mm chain gun, AGM-114 Hellfire, Hydra 70 rockets, AIM-92 Stinger', desc:'Primary US Army attack helicopter. Day/night, all-weather. Longbow radar for fire-and-forget anti-armor.'},
  // Special
  'AC130':{name:'AC-130J Ghostrider', role:'Gunship / Close Air Support', crew:'13', range:'~2,530 nmi', ceiling:'28,000 ft', speed:'300 mph', weapons:'105mm M102 howitzer, 30mm GAU-23, GBU-39 SDB, AGM-176 Griffin', desc:'Flying artillery. Loiters overhead providing devastating fire support. AFSOC special operations only.'},
};

// Match aircraft type code to capability key
function getAcCap(typeCode){
  if(!typeCode) return null;
  const t = typeCode.toUpperCase();
  // Direct match
  if(AC_CAPS[t]) return AC_CAPS[t];
  // Fuzzy match
  const mappings = [
    [/^F.?15/,'F15'],[/^F.?16/,'F16'],[/^F.?18|FA.?18|EA.?18/,'F18'],[/^F.?22/,'F22'],[/^F.?35/,'F35'],
    [/^B.?52/,'B52'],[/^B.?1B|^B.?1L/,'B1'],[/^B.?2A|^B.?2S/,'B2'],[/^B.?21/,'B21'],
    [/^KC.?135|^K35/,'KC135'],[/^KC.?10|^DC10/,'KC10'],[/^KC.?46|^K46/,'KC46'],
    [/^RC.?135|^R135/,'RC135'],[/^E.?3[A-D]?$|AWACS/,'E3'],[/^E.?8[A-C]?$/,'E8'],
    [/^RQ.?4|GLBHWK/,'RQ4'],[/^MQ.?9|REAPER/,'MQ9'],[/^MQ.?4|TRITN/,'MQ4'],
    [/^P.?8/,'P8'],[/^P.?3/,'P3'],[/^EP.?3/,'EP3'],[/^U.?2[RS]?$/,'U2'],
    [/^E.?6[AB]?$/,'E6'],[/^E.?4[AB]?$/,'E4'],
    [/^C.?17/,'C17'],[/^C.?5[AM]?$/,'C5'],[/^C.?130|^C130|^L100|^C.?30J/,'C130'],[/^C130J|C.?30J/,'C130J'],
    [/^C.?40/,'C40'],[/^V.?22|MV22|CV22/,'V22'],
    [/^UH.?60|^HH.?60|^MH.?60|^SH.?60|^S70/,'H60'],[/^CH.?47|^H47/,'H47'],[/^AH.?64/,'AH64'],
    [/^AC.?130/,'AC130'],
  ];
  for(const [rx, key] of mappings){
    if(rx.test(t)) return AC_CAPS[key];
  }
  return null;
}

function showP(ac){
  const fl=(ac.flight||'').trim();
  const tp=classifyType(ac);
  const col=getCol(ac.hex);
  document.getElementById('pTitle').innerHTML=`${getFlag(ac.hex)} ${fl||ac.hex}`;
  const alt=ac.alt_baro==='ground'?'On Ground':(ac.alt_baro?ac.alt_baro.toLocaleString()+' ft':'‚Äî');
  const spd=ac.gs?Math.round(ac.gs)+' kts':'‚Äî';
  const hdg=ac.track?Math.round(ac.track)+'¬∞':'‚Äî';
  const vr=ac.baro_rate?(ac.baro_rate>0?'+':'')+ac.baro_rate+' ft/min':'‚Äî';
  const cap = getAcCap(ac.t);
  let capHtml = '';
  if(cap){
    capHtml = `
    <div style="margin-top:8px;padding:8px;background:rgba(0,255,65,.04);border:1px solid rgba(0,255,65,.12);border-radius:2px">
      <div style="font-size:11px;font-weight:700;color:var(--accent);font-family:'Share Tech Mono',monospace;margin-bottom:4px">${cap.name}</div>
      <div style="font-size:10px;color:var(--text);margin-bottom:4px;line-height:1.4">${cap.desc}</div>
      <div class="f"><span class="k">Role: </span><span class="v">${cap.role}</span></div>
      <div class="f"><span class="k">Crew: </span><span class="v">${cap.crew}</span></div>
      <div class="f"><span class="k">Range: </span><span class="v">${cap.range}</span></div>
      <div class="f"><span class="k">Ceiling: </span><span class="v">${cap.ceiling}</span></div>
      <div class="f"><span class="k">Speed: </span><span class="v">${cap.speed}</span></div>
      <div class="f"><span class="k">Weapons: </span><span class="v" style="line-height:1.4">${cap.weapons}</span></div>
    </div>`;
  }
  document.getElementById('pBody').innerHTML=`
    <div class="f"><span class="k">Country: </span><span class="v" style="color:${col}">${getFlag(ac.hex)} ${getCName(ac.hex)}</span></div>
    <div class="f"><span class="k">Category: </span><span class="v">${TICO[tp]} ${TLAB[tp]}</span></div>
    <div class="f"><span class="k">Aircraft: </span><span class="v">${ac.t||'‚Äî'}</span></div>
    <div class="f"><span class="k">Reg: </span><span class="v">${ac.r||'‚Äî'}</span></div>
    <div class="f"><span class="k">Callsign: </span><span class="v">${fl||'‚Äî'}</span></div>
    <div class="f"><span class="k">Altitude: </span><span class="v">${alt}</span></div>
    <div class="f"><span class="k">Speed: </span><span class="v">${spd}</span></div>
    <div class="f"><span class="k">Heading: </span><span class="v">${hdg}</span></div>
    <div class="f"><span class="k">Vert Rate: </span><span class="v">${vr}</span></div>
    <div class="f"><span class="k">Squawk: </span><span class="v">${ac.squawk||'‚Äî'}</span></div>
    <div class="f"><span class="k">ICAO Hex: </span><span class="v">${ac.hex}</span></div>
    <div class="f"><span class="k">Position: </span><span class="v">${ac.lat?.toFixed(4)}, ${ac.lon?.toFixed(4)}</span></div>
    <div class="f"><span class="k">Last Seen: </span><span class="v">${Math.round(ac.seen||0)}s ago</span></div>
    ${capHtml}
    <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
      <a href="https://www.planespotters.net/hex/${ac.hex}" target="_blank" style="font-size:10px;color:var(--accent);text-decoration:none;background:rgba(0,12,0,.8);padding:3px 7px;border-radius:2px;border:1px solid rgba(0,255,65,.2)">üì∑ Planespotters</a>
      <a href="https://globe.adsbexchange.com/?icao=${ac.hex}" target="_blank" style="font-size:10px;color:var(--accent);text-decoration:none;background:rgba(0,12,0,.8);padding:3px 7px;border-radius:2px;border:1px solid rgba(0,255,65,.2)">üåê ADSBx</a>
      <a href="https://flightaware.com/live/modes/${ac.hex}/ident/${(ac.flight||'').trim()}/redirect" target="_blank" style="font-size:10px;color:var(--accent);text-decoration:none;background:rgba(0,12,0,.8);padding:3px 7px;border-radius:2px;border:1px solid rgba(0,255,65,.2)">‚úà FlightAware</a>
    </div>
  `;
  document.getElementById('infoP').classList.add('vis');
  showTrail(ac.hex);
}
function closeP(){document.getElementById('infoP').classList.remove('vis');hideTrails();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTERS & SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setCF(f){
  cFilt=f;
  document.querySelectorAll('[id^="bc-"]').forEach(b=>{b.classList.remove('on','iran-on','russia-on','china-on');});
  const btn=document.getElementById('bc-'+f);
  if(f==='iran')btn.classList.add('iran-on');
  else if(f==='russia')btn.classList.add('russia-on');
  else if(f==='china')btn.classList.add('china-on');
  else btn.classList.add('on');
  render();
}
function setTF(f){
  tFilt=f;
  document.querySelectorAll('[id^="bt-"]').forEach(b=>b.classList.remove('on'));
  document.getElementById('bt-'+f).classList.add('on');
  render();
}
function doSearch(){searchQ=document.getElementById('searchBox').value.toUpperCase();render();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function passFilter(ac){
  const g=getGroup(ac.hex);
  const tp=classifyType(ac);
  if(cFilt!=='all'&&g!==cFilt)return false;
  if(tFilt!=='all'&&tp!==tFilt)return false;
  if(searchQ){
    const s=((ac.flight||'')+(ac.t||'')+(ac.hex||'')+(ac.r||'')).toUpperCase();
    if(!s.includes(searchQ))return false;
  }
  return true;
}

function inZone(ac,z){
  return ac.lat&&ac.lon&&
    ac.lat>=z.bounds[0][0]&&ac.lat<=z.bounds[1][0]&&
    ac.lon>=z.bounds[0][1]&&ac.lon<=z.bounds[1][1];
}

function render(){
  Object.values(mkrs).forEach(m=>map.removeLayer(m));
  mkrs={};

  const counts={us:0,iran:0,russia:0,china:0,allied:0};
  const typeCounts={};
  const visible=[];

  acData.forEach(ac=>{
    if(!ac.lat||!ac.lon)return;
    updateTrail(ac);
    if(!passFilter(ac))return;

    const g=getGroup(ac.hex);
    counts[g]=(counts[g]||0)+1;
    const tp=classifyType(ac);
    typeCounts[tp]=(typeCounts[tp]||0)+1;
    visible.push(ac);

    const m=L.marker([ac.lat,ac.lon],{icon:mkIcon(ac)})
      .on('click',()=>showP(ac)).addTo(map);
    const fl=(ac.flight||'').trim();
    const alt=ac.alt_baro==='ground'?'GND':(ac.alt_baro?ac.alt_baro.toLocaleString()+'ft':'?');
    m.bindTooltip(`${getFlag(ac.hex)} ${fl||ac.hex} ¬∑ ${ac.t||'?'} ¬∑ ${alt}`,
      {className:'dark-tooltip',direction:'top',offset:[0,-10]});
    mkrs[ac.hex]=m;
  });

  // Update ticker counts
  const total=visible.length;
  document.title=`OSINT Tracker ‚Äî ${total} aircraft`;

  // Update widget counts
  document.getElementById('ac-count').textContent=total;

  // Update panels
  updateStatsPane(counts,typeCounts,total);
  updateAlertsPane(visible);
  updateActivityPane(visible);
  renderThreat(visible);
  renderAdvPanel(currentAdv);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS PANE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateStatsPane(counts,typeCounts,total){
  const countryData=[
    {key:'us',   flag:'üá∫üá∏',name:'US',     col:'#3b82f6'},
    {key:'iran', flag:'üáÆüá∑',name:'Iran',   col:'#ef4444'},
    {key:'russia',flag:'üá∑üá∫',name:'Russia',col:'#dc2626'},
    {key:'china',flag:'üá®üá≥',name:'China',  col:'#eab308'},
    {key:'allied',flag:'ü§ù',name:'Allied', col:'#8b5cf6'},
  ];
  const maxC=Math.max(...countryData.map(d=>counts[d.key]||0),1);
  let ch='<div class="stat-block"><div class="sb-label">Country Breakdown</div>';
  countryData.forEach(d=>{
    const n=counts[d.key]||0;
    const w=Math.round((n/maxC)*80);
    ch+=`<div class="country-row"><div class="cr-flag">${d.flag}</div><div class="cr-name">${d.name}</div><div class="cr-bar-wrap"><div class="cr-bar" style="width:${w}px;background:${d.col}"></div></div><div class="cr-count">${n}</div></div>`;
  });
  ch+=`</div>`;

  const typeData=Object.entries(typeCounts).sort((a,b)=>b[1]-a[1]);
  const maxT=Math.max(...typeData.map(d=>d[1]),1);
  ch+='<div class="stat-block"><div class="sb-label">Type Breakdown</div>';
  typeData.forEach(([tp,n])=>{
    const w=Math.round((n/maxT)*70);
    ch+=`<div class="type-row"><div class="tr-icon">${TICO[tp]||'‚óÜ'}</div><div class="tr-name">${TLAB[tp]||tp}</div><div class="tr-bar-wrap"><div class="tr-bar" style="width:${w}px;background:${TCOL[tp]||'#64748b'}"></div></div><div class="tr-count">${n}</div></div>`;
  });
  ch+=`</div>`;

  ch+=`<div class="stat-block"><div class="sb-label">Summary</div>
    <div class="country-row"><div class="cr-flag">‚úàÔ∏è</div><div class="cr-name">Total tracked</div><div class="cr-count" style="color:#fff;font-size:16px">${total}</div></div>
    <div class="country-row"><div class="cr-flag">‚è±Ô∏è</div><div class="cr-name">Refresh interval</div><div class="cr-count" style="color:#8892a8">30s</div></div>
  </div>`;

  document.getElementById('pane-stats').innerHTML=ch;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALERTS PANE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAlertsPane(visible){
  let h='<div style="padding:8px 12px 4px;font-size:10px;color:#6b7a9e;text-transform:uppercase;letter-spacing:.5px">Live aircraft in monitored zones</div>';
  ZONES.forEach(z=>{
    const ac_in=visible.filter(ac=>inZone(ac,z));
    const hot=ac_in.length>0;
    const warm=ac_in.length===0&&visible.filter(ac=>inZone(ac,z)).length>0;
    h+=`<div class="zone-card ${hot?'hot':warm?'warm':''}">
      <div>
        <div class="zc-name">${z.icon} ${z.name}</div>
        ${hot?ac_in.slice(0,3).map(ac=>`<div style="font-size:10px;color:#6b7a9e;margin-top:2px">${getFlag(ac.hex)} ${(ac.flight||'').trim()||ac.hex} ¬∑ ${ac.t||'?'}</div>`).join(''):''}
      </div>
      <div class="zc-count" style="color:${hot?z.color:'#3a4560'}">${ac_in.length}</div>
    </div>`;
  });
  document.getElementById('pane-alerts').innerHTML=h;
  const hotCount=ZONES.filter(z=>visible.filter(ac=>['iran','russia','china'].includes(getGroup(ac.hex))&&inZone(ac,z)).length>0).length;
  document.getElementById('zone-hot').textContent=hotCount+' hot';
  document.getElementById('zone-hot').style.color=hotCount>0?'#ef4444':'';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACTIVITY PANE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateActivityPane(visible){
  const sorted=[...visible].sort((a,b)=>(a.seen||999)-(b.seen||999)).slice(0,40);
  let h='<div style="padding:8px 12px 4px;font-size:10px;color:#6b7a9e;text-transform:uppercase;letter-spacing:.5px">Most recently seen</div>';
  sorted.forEach(ac=>{
    const fl=(ac.flight||'').trim()||ac.hex;
    const alt=ac.alt_baro==='ground'?'GND':(ac.alt_baro?Math.round(ac.alt_baro/100)/10+'kft':'?');
    const spd=ac.gs?Math.round(ac.gs)+'kt':'‚Äî';
    const col=getCol(ac.hex);
    h+=`<div class="feed-item" onclick="map.setView([${ac.lat},${ac.lon}],9);showP(acData.find(a=>a.hex==='${ac.hex}'))" style="cursor:pointer">
      <span class="fi-flag" style="color:${col}">${getFlag(ac.hex)}</span>
      <span class="fi-call" style="color:${col}">${fl}</span>
      <span class="fi-type">${ac.t||'?'}</span>
      <span class="fi-alt">${alt} ${spd}</span>
    </div>`;
  });
  document.getElementById('pane-activity').innerHTML=h;
}

// no-op: tabs replaced by widget grid
function switchTab(t){ curTab=t; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEWS / INTEL FEED
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const NEWS_SOURCES=[
  {name:'Defense News',url:'https://www.defensenews.com/arc/outboundfeeds/rss/',label:'DEFNEWS'},
  {name:'Reuters World',url:'https://feeds.reuters.com/Reuters/worldNews',label:'REUTERS'},
  {name:'BBC Middle East',url:'https://feeds.bbci.co.uk/news/world/middle_east/rss.xml',label:'BBC ME'},
  {name:'BBC World',url:'https://feeds.bbci.co.uk/news/world/rss.xml',label:'BBC'},
  {name:'Al Jazeera',url:'https://www.aljazeera.com/xml/rss/all.xml',label:'AL JAZEERA'},
  {name:'Breaking Defense',url:'https://breakingdefense.com/feed/',label:'BREAK DEF'},
];

let allNews=[];

async function fetchRSS(src){
  try{
    const proxy='https://api.allorigins.win/raw?url='+encodeURIComponent(src.url);
    const r=await fetch(proxy,{signal:AbortSignal.timeout(8000)});
    const txt=await r.text();
    const doc=new DOMParser().parseFromString(txt,'text/xml');
    const items=[...doc.querySelectorAll('item')].slice(0,8);
    return items.map(i=>({
      source:src.label,
      title:(i.querySelector('title')?.textContent||'').replace('<![CDATA[','').replace(']]>','').trim(),
      link:i.querySelector('link')?.textContent?.trim()||'#',
      date:new Date(i.querySelector('pubDate')?.textContent||Date.now()),
    })).filter(n=>n.title);
  }catch(e){return[];}
}

async function fetchAllNews(){
  const results=await Promise.allSettled(NEWS_SOURCES.map(s=>fetchRSS(s)));
  const items=results.flatMap(r=>r.status==='fulfilled'?r.value:[]);
  items.sort((a,b)=>b.date-a.date);
  allNews=items;
  renderNews(items);
  updateTicker(items);
}

// Military keywords for highlighting
const MIL_KEYWORDS=['military','missile','strike','iran','russia','china','nato','navy','airforce','army','nuclear','drone','warship','attack','defense','conflict','troops','weapons','sanction','war','bomb','radar','satellite','intercept'];

function isAlert(title){
  const t=title.toLowerCase();
  return MIL_KEYWORDS.some(k=>t.includes(k));
}

function renderNews(items){
  const strip = document.getElementById('newsStrip');
  if(!items.length){
    strip.innerHTML='<div style="padding:20px;color:#6b7a9e;font-size:12px">Loading intel feed...</div>';
    return;
  }
  let h='';
  items.forEach(n=>{
    const alert=isAlert(n.title);
    const ago=getTimeAgo(n.date);
    h+=`<a href="${n.link}" target="_blank" rel="noopener" style="text-decoration:none">
      <div class="news-card ${alert?'alert':''}">
        <div class="nc-src">${alert?'üî¥ ':''} ${n.source}</div>
        <div class="nc-title">${n.title}</div>
        <div class="nc-meta">${ago}</div>
      </div>
    </a>`;
  });
  strip.innerHTML=h;
}

function getTimeAgo(date){
  const mins=Math.round((Date.now()-date)/60000);
  if(mins<60)return`${mins}m ago`;
  const hrs=Math.round(mins/60);
  if(hrs<24)return`${hrs}h ago`;
  return`${Math.round(hrs/24)}d ago`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TICKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateTicker(news){
  // Ticker removed ‚Äî news now in strip. No-op.
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AIRCRAFT FETCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AC_URLS=[
  // working CORS proxies first
  'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent('https://api.adsb.lol/v2/mil'),
  'https://r.jina.ai/http://api.adsb.lol/v2/mil',
  // direct + fallback proxies
  'https://api.adsb.lol/v2/mil',
  'https://corsproxy.io/?url=https://api.adsb.lol/v2/mil',
  'https://api.allorigins.win/raw?url='+encodeURIComponent('https://api.adsb.lol/v2/mil'),
];

async function fetchData(){
  for(const url of AC_URLS){
    try{
      const r=await fetch(url,{signal:AbortSignal.timeout(10000)});
      if(!r.ok)throw new Error(r.status);
      const d=await r.json();
      acData=d.ac||[];
      render();
      document.getElementById('loadOv').style.display='none';
      return;
    }catch(e){console.warn('AC fetch fail',url,e.message);}
  }
  document.getElementById('loadOv').style.display='none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let notifEnabled = false;
let prevZoneSets = {}; // zone -> Set of hex ids

function toggleNotifications(){
  if(!notifEnabled){
    Notification.requestPermission().then(p=>{
      if(p==='granted'){
        notifEnabled=true;
        document.getElementById('btn-notif').classList.add('on');
        document.getElementById('btn-notif').textContent='üîî Alerts ON';
        new Notification('OSINT Tracker', {body:'Zone alerts enabled. You\'ll be notified when adversary aircraft enter monitored zones.'});
      }
    });
  } else {
    notifEnabled=false;
    document.getElementById('btn-notif').classList.remove('on');
    document.getElementById('btn-notif').textContent='üîî Alerts';
  }
}

function checkZoneAlerts(visible){
  if(!notifEnabled) return;
  const adversary=['iran','russia','china'];
  ZONES.forEach(z=>{
    const key=z.name;
    const current=new Set(
      visible.filter(ac=>adversary.includes(getGroup(ac.hex))&&inZone(ac,z)).map(ac=>ac.hex)
    );
    const prev=prevZoneSets[key]||new Set();
    current.forEach(hex=>{
      if(!prev.has(hex)){
        const ac=acData.find(a=>a.hex===hex);
        const fl=(ac?.flight||'').trim()||hex;
        new Notification(`‚ö†Ô∏è ${z.name}`, {
          body:`${getFlag(hex)} ${fl} (${ac?.t||'?'}) entered ${z.name}`,
          icon:'https://rpike623.github.io/mil-tracker/favicon.ico'
        });
      }
    });
    prevZoneSets[key]=current;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVENT LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const eventLog = [];
let prevAcSet = new Set();

function updateEventLog(visible){
  const currentSet = new Set(visible.map(ac=>ac.hex));
  const adversary = ['iran','russia','china'];

  // New adversary detections
  visible.forEach(ac=>{
    if(adversary.includes(getGroup(ac.hex)) && !prevAcSet.has(ac.hex)){
      const fl=(ac.flight||'').trim()||ac.hex;
      eventLog.unshift({
        time: new Date(),
        type: 'new',
        msg: `${getFlag(ac.hex)} NEW: ${fl} (${ac.t||'?'}) detected`,
        col: getCol(ac.hex),
      });
    }
  });

  // Zone entries
  ZONES.forEach(z=>{
    const inNow = visible.filter(ac=>adversary.includes(getGroup(ac.hex))&&inZone(ac,z));
    inNow.forEach(ac=>{
      if(!prevAcSet.has(ac.hex)){
        const fl=(ac.flight||'').trim()||ac.hex;
        eventLog.unshift({
          time: new Date(),
          type: 'zone',
          msg: `${getFlag(ac.hex)} ZONE: ${fl} in ${z.name}`,
          col: z.color,
        });
      }
    });
  });

  if(eventLog.length > 200) eventLog.splice(200);
  prevAcSet = currentSet;
  renderEventLog();
  document.getElementById('log-count').textContent=eventLog.length;
}

function renderEventLog(){
  if(!eventLog.length){
    document.getElementById('pane-log').innerHTML='<div style="padding:20px;color:#6b7a9e;font-size:12px;text-align:center">No events yet.<br>Adversary aircraft detections and zone entries will appear here.</div>';
    return;
  }
  let h='<div style="padding:8px 12px 4px;font-size:10px;color:#6b7a9e;text-transform:uppercase;letter-spacing:.5px">Adversary detection log</div>';
  eventLog.slice(0,60).forEach(e=>{
    const ts=e.time.toLocaleTimeString();
    h+=`<div class="feed-item">
      <span style="color:${e.col};font-size:10px;min-width:55px">${ts}</span>
      <span style="font-size:11px;color:${e.col}">${e.msg}</span>
    </div>`;
  });
  document.getElementById('pane-log').innerHTML=h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PATCH RENDER TO INCLUDE NEW FEATURES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Override render to also run notifications + log
const _render = render;
render = function(){
  _render();
  // Get visible aircraft for post-render hooks
  const visible = acData.filter(ac=>ac.lat&&ac.lon&&passFilter(ac));
  checkZoneAlerts(visible);
  updateEventLog(visible);
};

// switchTab is now a no-op (widget grid replaces tabs)
function switchActTab(t){
  document.getElementById("pane-activity").style.display=t==="activity"?"block":"none";
  document.getElementById("pane-log").style.display=t==="log"?"block":"none";
  const aTab=document.getElementById("act-tab-activity");
  const lTab=document.getElementById("act-tab-log");
  aTab.style.color=t==="activity"?"rgba(0,212,255,.7)":"var(--muted)";
  aTab.style.borderBottom=t==="activity"?"2px solid rgba(0,212,255,.6)":"2px solid transparent";
  lTab.style.color=t==="log"?"rgba(0,212,255,.7)":"var(--muted)";
  lTab.style.borderBottom=t==="log"?"2px solid rgba(0,212,255,.6)":"2px solid transparent";
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POLYMARKET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchPolymarket(){
  const strip = document.getElementById('polyStrip');
  if(!strip) return;
  const queries = ['war military strike','Iran nuclear attack','Russia China Taiwan conflict','missile nuclear weapon'];
  const seen = new Set(); const allMarkets = [];
  for(const q of queries){
    try{
      const url = 'https://gamma-api.polymarket.com/markets?limit=12&active=true&closed=false&order=volume24hr&ascending=false&q='+encodeURIComponent(q);
      const proxied = 'https://corsproxy.io/?url='+encodeURIComponent(url);
      const r = await fetch(proxied,{signal:AbortSignal.timeout(8000)});
      if(!r.ok) continue;
      const data = await r.json();
      if(!Array.isArray(data)) continue;
      data.forEach(m=>{if(!seen.has(m.id)&&!m.closed&&m.active){seen.add(m.id);allMarkets.push(m);}});
    }catch(e){}
  }
  const KW=['strike','nuclear','war','attack','military','missile','iran','russia','china','conflict','invasion','ceasefire','troops','weapon','nato','ukraine','taiwan','bomb','coup','sanctions'];
  const filtered=allMarkets.filter(m=>KW.some(k=>(m.question||'').toLowerCase().includes(k))).sort((a,b)=>(b.volumeNum||0)-(a.volumeNum||0)).slice(0,20);
  if(!filtered.length){strip.innerHTML='<div style="padding:16px;color:#6b7a9e;font-size:11px;align-self:center">No active military markets found</div>';return;}
  let h='';
  filtered.forEach(m=>{
    let pct=0;
    try{const pr=JSON.parse(m.outcomePrices||'[]');const ou=JSON.parse(m.outcomes||'[]');const yi=ou.findIndex(o=>o.toLowerCase()==='yes');pct=Math.round(parseFloat(pr[yi>=0?yi:0]||0)*100);}catch(e){}
    const col=pct>=60?'#ef4444':pct>=35?'#f97316':pct>=15?'#eab308':'#22c55e';
    const vol=m.volumeNum>=1000000?'$'+(m.volumeNum/1000000).toFixed(1)+'M':m.volumeNum>=1000?'$'+(m.volumeNum/1000).toFixed(0)+'K':'$'+Math.round(m.volumeNum||0);
    const url='https://polymarket.com/event/'+(m.slug||m.id);
    h+=`<a class="poly-card" href="${url}" target="_blank" rel="noopener"><div class="pc-q">${m.question}</div><div><div class="pc-odds"><span class="pc-yes" style="color:${col}">${pct}%</span><span class="pc-label">YES</span></div><div class="pc-bar"><div class="pc-fill" style="width:${pct}%;background:${col}"></div></div><div class="pc-vol" style="margin-top:3px">${vol} vol</div></div></a>`;
  });
  strip.innerHTML=h;
  const el=document.getElementById('poly-updated');if(el)el.textContent='Updated '+new Date().toLocaleTimeString();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// X / OSINT ACCOUNTS FEED
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OSINT FEED (RSS-based ‚Äî nitter/X RSS is dead)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const OSINT_FEEDS = [
  { id:'warzone',   label:'The War Zone',    url:'https://www.thedrive.com/the-war-zone/feed' },
  { id:'defnews',   label:'Defense News',    url:'https://www.defensenews.com/arc/outboundfeeds/rss/' },
  { id:'breakdef',  label:'Breaking Defense', url:'https://breakingdefense.com/feed/' },
  { id:'naval',     label:'Naval News',      url:'https://www.navalnews.com/feed/' },
];

let osintCurrentFeed = OSINT_FEEDS[0].id;
let osintCache = {};

function buildXTabs(){
  const tabsEl = document.getElementById('x-account-tabs');
  if(!tabsEl) return;
  tabsEl.innerHTML = OSINT_FEEDS.map(a =>
    `<span class="x-tab${a.id===osintCurrentFeed?' on':''}" onclick="switchXAccount('${a.id}')">${a.label}</span>`
  ).join('');
}

function switchXAccount(id){
  osintCurrentFeed = id;
  buildXTabs();
  if(osintCache[id]) renderXFeed(id, osintCache[id]);
  else fetchOsintFeed(id);
}

async function fetchOsintFeed(id){
  const feed = document.getElementById('xFeed');
  const src = OSINT_FEEDS.find(f=>f.id===id);
  if(!src) return;
  if(!osintCache[id] && id === osintCurrentFeed && feed) feed.innerHTML = `<div style="padding:12px;color:var(--muted);font-size:11px">Loading ${src.label}...</div>`;

  const proxies = [
    'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(src.url),
    'https://api.allorigins.win/raw?url='+encodeURIComponent(src.url),
  ];

  for(const proxied of proxies){
    try {
      const ac = new AbortController();
      const tid = setTimeout(()=>ac.abort(), 10000);
      const r = await fetch(proxied, { signal: ac.signal });
      clearTimeout(tid);
      if(!r.ok) continue;
      const txt = await r.text();
      const doc = new DOMParser().parseFromString(txt, 'text/xml');
      const posts = [...doc.querySelectorAll('item')].slice(0,15).map(i => ({
        text: (i.querySelector('title')?.textContent || '').replace(/<!\[CDATA\[|]]>/g,'').trim(),
        link: (i.querySelector('link')?.textContent || '#').trim(),
        date: new Date(i.querySelector('pubDate')?.textContent || Date.now()),
        desc: (i.querySelector('description')?.textContent || '').replace(/<[^>]*>/g,'').slice(0,120).trim(),
      })).filter(p => p.text);
      if(posts.length){
        osintCache[id] = posts;
        if(id === osintCurrentFeed) renderXFeed(id, posts);
        return;
      }
    } catch(e) { /* try next proxy */ }
  }

  if(id === osintCurrentFeed && feed)
    feed.innerHTML = `<div style="padding:12px;color:var(--muted);font-size:11px">Could not load ${src.label}</div>`;
}

function renderXFeed(id, posts){
  if(id !== osintCurrentFeed) return;
  const feed = document.getElementById('xFeed');
  if(!feed) return;
  if(!posts.length){ feed.innerHTML = '<div style="padding:12px;color:var(--muted);font-size:11px">No posts</div>'; return; }
  const src = OSINT_FEEDS.find(f=>f.id===id);
  feed.innerHTML = posts.map(p => {
    const ago = getTimeAgo(p.date);
    return `<div class="x-post" onclick="window.open('${p.link}','_blank')">
      <div class="xp-meta"><span class="xp-handle">${src?.label||id}</span><span style="margin-left:auto">${ago}</span></div>
      <div class="xp-text">${p.text}</div>
      ${p.desc ? `<div style="color:var(--muted);font-size:10px;margin-top:3px;line-height:1.3">${p.desc}</div>` : ''}
    </div>`;
  }).join('');
}

function initXFeed(){
  buildXTabs();
  fetchOsintFeed(osintCurrentFeed);
  setTimeout(() => {
    OSINT_FEEDS.filter(a => a.id !== osintCurrentFeed).forEach((a,i) => {
      setTimeout(() => fetchOsintFeed(a.id), i * 1500);
    });
  }, 2000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THREAT INDICATOR ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Scores observable signals to estimate likelihood of imminent military action

const THREAT_SIGNALS = [
  // Aircraft-based signals
  { id:'tanker_density',  label:'Aerial refueling activity',       weight:15, desc:'High tanker count = extended range ops being prepped' },
  { id:'isr_density',     label:'ISR/Recon concentration',         weight:20, desc:'Surge in recon = active target acquisition' },
  { id:'adversary_active',label:'Adversary aircraft airborne',     weight:25, desc:'Iran/Russia/China military flights visible' },
  { id:'bomber_activity', label:'Strategic bomber flights',        weight:30, desc:'B-52/B-1/TU-95/H-6 airborne = escalation signal' },
  { id:'zone_intrusion',  label:'Aircraft in alert zones',         weight:20, desc:'Flights in Hormuz/Taiwan Strait/etc.' },
  { id:'transport_surge', label:'Airlift surge (C-17/C-130)',      weight:10, desc:'Rapid troop/equipment movement' },
  { id:'electronic_ops',  label:'EA/EW aircraft active',           weight:15, desc:'Electronic attack = pre-strike jamming prep' },
];

let threatHistory = []; // rolling scores for trend

function computeThreat(visible){
  let score = 0;
  const signals = [];
  const adversary = ['iran','russia','china'];

  const tankers    = visible.filter(ac => classifyType(ac) === 'tanker').length;
  const isr        = visible.filter(ac => classifyType(ac) === 'recon').length;
  const advActive  = visible.filter(ac => adversary.includes(getGroup(ac.hex))).length;
  const bombers    = visible.filter(ac => classifyType(ac) === 'bomber').length;
  const transports = visible.filter(ac => classifyType(ac) === 'transport').length;
  const ea         = visible.filter(ac => (ac.t||'').toUpperCase().match(/^EA|^EC|^EF|^EP/)).length;
  const inZones    = ZONES.reduce((sum, z) => sum + visible.filter(ac => inZone(ac, z)).length, 0);

  const checks = [
    { id:'tanker_density',   active: tankers >= 3,   value: Math.min(tankers, 10),   max: 10 },
    { id:'isr_density',      active: isr >= 2,        value: Math.min(isr, 8),        max: 8  },
    { id:'adversary_active', active: advActive >= 1,  value: Math.min(advActive, 6),  max: 6  },
    { id:'bomber_activity',  active: bombers >= 1,    value: Math.min(bombers, 4),    max: 4  },
    { id:'zone_intrusion',   active: inZones >= 1,    value: Math.min(inZones, 8),    max: 8  },
    { id:'transport_surge',  active: transports >= 8, value: Math.min(transports,20), max: 20 },
    { id:'electronic_ops',   active: ea >= 1,         value: Math.min(ea, 5),         max: 5  },
  ];

  checks.forEach(c => {
    const sig = THREAT_SIGNALS.find(s => s.id === c.id);
    if(!sig) return;
    const contrib = c.active ? Math.round((c.value / c.max) * sig.weight) : 0;
    score += contrib;
    signals.push({ ...sig, active: c.active, contrib, raw: c.value });
  });

  // Normalize to 0-100
  const maxPossible = THREAT_SIGNALS.reduce((s,sig) => s + sig.weight, 0);
  const pct = Math.min(100, Math.round((score / maxPossible) * 100));

  threatHistory.push({ t: Date.now(), pct });
  if(threatHistory.length > 20) threatHistory.shift();

  return { pct, signals, tankers, isr, advActive, bombers };
}

function threatColor(pct){
  if(pct >= 70) return '#ef4444';
  if(pct >= 45) return '#f97316';
  if(pct >= 25) return '#eab308';
  return '#22c55e';
}
function threatLabel(pct){
  if(pct >= 70) return 'HIGH';
  if(pct >= 45) return 'ELEVATED';
  if(pct >= 25) return 'GUARDED';
  return 'LOW';
}

function renderThreat(visible){
  const { pct, signals, tankers, isr, advActive, bombers } = computeThreat(visible);
  const col = threatColor(pct);
  const lbl = threatLabel(pct);

  // Map threat pct to DEFCON level (5=lowest, 1=highest)
  const defcon = pct >= 80 ? 1 : pct >= 60 ? 2 : pct >= 40 ? 3 : pct >= 20 ? 4 : 5;
  const defconLabels = {5:'NORMAL READINESS',4:'INCREASED INTEL',3:'ELEVATED FORCE POSTURE',2:'HIGH ALERT',1:'MAXIMUM READINESS'};

  // Update header badge
  const badge = document.getElementById('threat-level');
  if(badge){ badge.textContent = `DEFCON ${defcon}`; badge.style.color = col; badge.style.borderColor = col; }

  // Trend
  const prev = threatHistory.length >= 2 ? threatHistory[threatHistory.length-2].pct : pct;
  const trend = pct > prev + 3 ? '‚ñ≤ RISING' : pct < prev - 3 ? '‚ñº DECLINING' : '‚ñ∫ STABLE';
  const trendCol = pct > prev + 3 ? '#ef4444' : pct < prev - 3 ? '#22c55e' : 'var(--muted)';

  let h = '';

  // DEFCON meter
  h += `<div style="padding:10px 12px 6px">
    <div class="defcon-meter">
      <div class="defcon-level defcon-5 ${defcon===5?'active':''}">5</div>
      <div class="defcon-level defcon-4 ${defcon===4?'active':''}">4</div>
      <div class="defcon-level defcon-3 ${defcon===3?'active':''}">3</div>
      <div class="defcon-level defcon-2 ${defcon===2?'active':''}">2</div>
      <div class="defcon-level defcon-1 ${defcon===1?'active':''}">1</div>
    </div>
    <div style="text-align:center;margin:4px 0">
      <div style="font-size:11px;font-weight:700;color:${col};font-family:'Orbitron',monospace;letter-spacing:2px">${defconLabels[defcon]}</div>
      <div style="font-size:10px;color:${trendCol};margin-top:2px;font-family:'Share Tech Mono',monospace">${trend}</div>
    </div>
    <div style="height:4px;background:rgba(0,255,65,.06);border-radius:2px;overflow:hidden;margin-top:6px">
      <div style="height:100%;width:${pct}%;background:${col};border-radius:2px;transition:width .5s"></div>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:3px;font-size:9px;color:var(--muted);font-family:'Share Tech Mono',monospace">
      <span>THREAT INDEX: ${pct}/100</span>
      <span>${acData.filter(ac=>ac.lat).length} TRACKED</span>
    </div>
  </div>`;

  // Signal breakdown
  h += `<div class="rp-section">üì° SIGNAL BREAKDOWN</div>`;
  signals.sort((a,b) => b.contrib - a.contrib).forEach(s => {
    const sigCol = s.active ? (s.contrib >= 15 ? '#ef4444' : s.contrib >= 8 ? '#f97316' : '#eab308') : 'var(--muted)';
    const barW = s.active ? Math.min(s.contrib * 5, 100) : 0;
    h += `<div class="threat-row" style="padding:5px 12px">
      <div style="flex:1">
        <span class="tr-label">${s.active?'üî¥':'‚ö´'} ${s.label}</span>
        <div class="threat-bar"><div class="threat-bar-fill" style="width:${barW}%;background:${sigCol}"></div></div>
      </div>
      <span class="tr-value" style="color:${sigCol};min-width:30px;text-align:right">${s.active ? '+'+s.contrib : '‚Äî'}</span>
    </div>`;
  });

  // Quick stats
  h += `<div style="padding:8px 12px;font-size:10px;display:grid;grid-template-columns:1fr 1fr;gap:4px;border-top:1px solid rgba(0,255,65,.06)">
    <span style="color:var(--accent)">‚õΩ ${tankers} TANKERS</span>
    <span style="color:var(--accent)">üîç ${isr} ISR</span>
    <span style="color:${advActive>0?'#ef4444':'var(--muted)'}">‚öîÔ∏è ${advActive} ADVERSARY</span>
    <span style="color:${bombers>0?'#f97316':'var(--muted)'}">üí£ ${bombers} BOMBERS</span>
  </div>`;

  const pane = document.getElementById('pane-threat');
  if(pane) pane.innerHTML = h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MISSILE RANGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MISSILE_SYSTEMS = [
  // Iran
  { name:'Shahab-3 MRBM (Iran)', lat:35.7, lon:51.4, radiusKm:1300, color:'#ef4444', country:'iran' },
  { name:'Khorramshahr IRBM (Iran)', lat:35.7, lon:51.4, radiusKm:2000, color:'#dc2626', country:'iran' },
  { name:'Qadr ICBM-class (Iran)', lat:35.7, lon:51.4, radiusKm:3000, color:'#b91c1c', country:'iran' },
  // Russia
  { name:'RS-28 Sarmat ICBM (Russia)', lat:52.0, lon:37.0, radiusKm:18000, color:'#f97316', country:'russia' },
  { name:'Iskander SRBM (Russia/Syria)', lat:35.4, lon:35.9, radiusKm:500, color:'#fb923c', country:'russia' },
  { name:'Kinzhal hypersonic (Russia)', lat:52.0, lon:37.0, radiusKm:2000, color:'#f97316', country:'russia' },
  // China
  { name:'DF-41 ICBM (China)', lat:35.0, lon:104.0, radiusKm:14000, color:'#eab308', country:'china' },
  { name:'DF-21D ASBM (China)', lat:35.0, lon:104.0, radiusKm:1800, color:'#ca8a04', country:'china' },
  { name:'DF-17 Hypersonic (China)', lat:35.0, lon:104.0, radiusKm:2000, color:'#eab308', country:'china' },
];

let missileVisible = false;
let missileLayers = [];

function toggleMissiles(){
  missileVisible = !missileVisible;
  document.getElementById('btn-missiles').classList.toggle('on', missileVisible);
  if(missileVisible){
    MISSILE_SYSTEMS.forEach(m => {
      // Convert km radius to meters for Leaflet circle
      const circle = L.circle([m.lat, m.lon], {
        radius: m.radiusKm * 1000,
        color: m.color, weight: 1, fillColor: m.color, fillOpacity: 0.04, opacity: 0.5,
        interactive: false, dashArray: '6 4'
      }).addTo(map);
      const label = L.marker([m.lat, m.lon], {
        icon: L.divIcon({
          html: `<div style="color:${m.color};font-size:13px;text-shadow:0 0 5px #000">üöÄ</div>`,
          className:'', iconSize:[13,13], iconAnchor:[6,6]
        })
      }).bindTooltip(`${m.name}<br>${m.radiusKm.toLocaleString()} km range`, {className:'dark-tooltip', direction:'top'}).addTo(map);
      missileLayers.push(circle, label);
    });
  } else {
    missileLayers.forEach(l => map.removeLayer(l));
    missileLayers = [];
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NUCLEAR / WMD SITES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const NUCLEAR_SITES = [
  // Iran
  { name:'Fordow FEP (Enrichment)', lat:34.885, lon:50.996, country:'iran', type:'Enrichment', risk:'HIGH' },
  { name:'Natanz FEP (Enrichment)', lat:33.725, lon:51.727, country:'iran', type:'Enrichment', risk:'HIGH' },
  { name:'Isfahan UCF',             lat:32.625, lon:51.671, country:'iran', type:'Conversion',  risk:'MED'  },
  { name:'Arak Heavy Water',        lat:34.144, lon:49.230, country:'iran', type:'Reactor',     risk:'MED'  },
  { name:'Bushehr Nuclear Plant',   lat:28.829, lon:50.888, country:'iran', type:'Reactor',     risk:'LOW'  },
  { name:'Parchin Military Complex',lat:35.522, lon:51.773, country:'iran', type:'Suspected WMD',risk:'HIGH'},
  // Russia
  { name:'Seversk (Tomsk-7)',       lat:56.585, lon:84.869, country:'russia', type:'Nuclear Facility', risk:'HIGH' },
  { name:'Zheleznogorsk',           lat:56.249, lon:93.529, country:'russia', type:'Nuclear Facility', risk:'HIGH' },
  { name:'Sarov (Arzamas-16)',      lat:54.931, lon:43.321, country:'russia', type:'Weapons Lab',      risk:'HIGH' },
  { name:'Plesetsk Cosmodrome',     lat:62.925, lon:40.577, country:'russia', type:'ICBM Launch',      risk:'HIGH' },
  { name:'Kapustin Yar',            lat:48.578, lon:45.790, country:'russia', type:'Missile Test',     risk:'MED'  },
  // China
  { name:'Lop Nor Test Site',       lat:40.710, lon:88.322, country:'china', type:'Nuclear Test',     risk:'HIGH' },
  { name:'Jiuquan Launch Center',   lat:40.960, lon:100.288,country:'china', type:'ICBM Launch',      risk:'HIGH' },
  { name:'Taiyuan Launch Center',   lat:38.849, lon:111.608,country:'china', type:'ICBM Launch',      risk:'HIGH' },
  { name:'Xichang Launch Center',   lat:28.246, lon:102.027,country:'china', type:'ICBM Launch',      risk:'MED'  },
];

let nuclearVisible = false;
let nuclearMarkers = [];
const RISK_COL = { HIGH:'#ef4444', MED:'#f97316', LOW:'#eab308' };

function toggleNuclear(){
  nuclearVisible = !nuclearVisible;
  document.getElementById('btn-nuclear').classList.toggle('on', nuclearVisible);
  if(nuclearVisible){
    NUCLEAR_SITES.forEach(s => {
      const col = RISK_COL[s.risk] || '#64748b';
      const flag = FLAGS[s.country] || 'üåê';
      const m = L.marker([s.lat, s.lon], {
        icon: L.divIcon({
          html: `<div style="color:${col};font-size:15px;text-shadow:0 0 6px ${col}80">‚ò¢Ô∏è</div>`,
          className:'', iconSize:[15,15], iconAnchor:[7,7]
        })
      }).bindTooltip(`${flag} ${s.name}<br>${s.type} ‚Äî Risk: <b style="color:${col}">${s.risk}</b>`, {className:'dark-tooltip', direction:'top'}).addTo(map);
      nuclearMarkers.push(m);
    });
  } else {
    nuclearMarkers.forEach(m => map.removeLayer(m));
    nuclearMarkers = [];
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AIR DEFENSE SYSTEMS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AIR_DEFENSE = [
  // Iran
  { name:'Bavar-373 (Tehran)',     lat:35.7,  lon:51.4,  country:'iran',   rangeKm:200 },
  { name:'S-300PMU-2 (Khordad)',   lat:34.0,  lon:50.0,  country:'iran',   rangeKm:150 },
  { name:'Bavar-373 (Natanz)',     lat:33.7,  lon:51.7,  country:'iran',   rangeKm:200 },
  { name:'S-300 (Bushehr)',        lat:28.8,  lon:50.9,  country:'iran',   rangeKm:150 },
  // Russia
  { name:'S-400 (Moscow)',         lat:55.75, lon:37.6,  country:'russia', rangeKm:400 },
  { name:'S-400 (Kaliningrad)',    lat:54.71, lon:20.51, country:'russia', rangeKm:400 },
  { name:'S-500 (Central Russia)', lat:52.0,  lon:37.0,  country:'russia', rangeKm:600 },
  { name:'S-400 (Hmeimim Syria)',  lat:35.4,  lon:35.9,  country:'russia', rangeKm:400 },
  { name:'S-400 (Crimea)',         lat:44.95, lon:34.10, country:'russia', rangeKm:400 },
  // China
  { name:'HQ-9B (Beijing)',        lat:39.9,  lon:116.4, country:'china',  rangeKm:200 },
  { name:'HQ-9B (Fiery Cross)',    lat:9.55,  lon:112.9, country:'china',  rangeKm:200 },
  { name:'HQ-9B (Mischief Reef)',  lat:9.91,  lon:115.5, country:'china',  rangeKm:200 },
  { name:'S-400 (Xinjiang)',       lat:43.0,  lon:87.0,  country:'china',  rangeKm:400 },
];

let airDefVisible = false;
let airDefLayers = [];

function toggleAirDef(){
  airDefVisible = !airDefVisible;
  document.getElementById('btn-airdef').classList.toggle('on', airDefVisible);
  if(airDefVisible){
    AIR_DEFENSE.forEach(s => {
      const col = GCOL[s.country] || '#64748b';
      const circle = L.circle([s.lat, s.lon], {
        radius: s.rangeKm * 1000,
        color: col, weight: 1, fillColor: col, fillOpacity: 0.08, opacity: 0.5,
        interactive: false, dashArray: '3 5'
      }).addTo(map);
      const label = L.marker([s.lat, s.lon], {
        icon: L.divIcon({
          html: `<div style="color:${col};font-size:13px;text-shadow:0 0 5px #000">üõ°Ô∏è</div>`,
          className:'', iconSize:[13,13], iconAnchor:[6,6]
        })
      }).bindTooltip(`${FLAGS[s.country]||'üåê'} ${s.name}<br>Range: ${s.rangeKm} km`, {className:'dark-tooltip',direction:'top'}).addTo(map);
      airDefLayers.push(circle, label);
    });
  } else {
    airDefLayers.forEach(l => map.removeLayer(l));
    airDefLayers = [];
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADVERSARY INTEL PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ADV_INTEL = {
  iran: {
    name: 'Islamic Republic of Iran', flag: 'üáÆüá∑', color: '#ef4444',
    oob: [
      { label:'Air Force Aircraft (est.)', val:'~330 fixed-wing' },
      { label:'Key fighters', val:'F-14A Tomcat, F-4E, MiG-29, Su-24' },
      { label:'Drones', val:'Shahed-136/131, Mohajer-6, Arash-2' },
      { label:'Navy surface vessels', val:'~100 (IRIN + IRGCN)' },
      { label:'Submarines', val:'3 Kilo-class + midget subs' },
      { label:'Ballistic missiles', val:'Shahab-3, Khorramshahr, Qadr' },
      { label:'Cruise missiles', val:'Soumar, Ya Ali, Hoveizeh' },
      { label:'Active personnel', val:'~610,000 + 220,000 IRGC' },
    ],
    hotspots: [
      { name:'Strait of Hormuz', status:'ACTIVE', note:'IRGCN patrols ongoing' },
      { name:'Natanz Enrichment', status:'ACTIVE', note:'90% enrichment confirmed' },
      { name:'Fordow Underground', status:'ACTIVE', note:'Deeply buried, air-strike resistant' },
      { name:'Syria/Iraq proxies', status:'ACTIVE', note:'Hezbollah, PMF active' },
    ],
    intel: [
      'Iran enriched uranium to near-weapons-grade (84%) at Fordow',
      'IRGCN fast-boat harassment of US vessels in Arabian Gulf ongoing',
      'Shahed drone exports to Russia confirm production scale-up',
      'Parchin military site expansion detected via satellite imagery',
      'Iran-Russia-China trilateral naval drills held in Indian Ocean',
    ],
    watchFor: [
      'IRIAF tanker aircraft (707/747) suggest extended-range strike prep',
      'Surge in IRGCN small boat activity near Hormuz = chokepoint threat',
      'Iranian ISR drones over Iraq/Syria = target designation ops',
      'Fordow or Natanz air defense activation = strike anticipation',
    ],
  },
  russia: {
    name: 'Russian Federation', flag: 'üá∑üá∫', color: '#dc2626',
    oob: [
      { label:'Air Force Aircraft (est.)', val:'~4,000 total, ~1,500 active' },
      { label:'Key fighters', val:'Su-57, Su-35S, Su-30SM, MiG-31BM' },
      { label:'Bombers', val:'Tu-160M, Tu-95MS, Tu-22M3' },
      { label:'Navy vessels (active)', val:'~350 ships, 1 carrier (laid up)' },
      { label:'Submarines', val:'~60 (11 SSBN nuclear)' },
      { label:'ICBMs deployed', val:'~1,600 strategic warheads' },
      { label:'Hypersonic weapons', val:'Kinzhal, Avangard, Zircon' },
      { label:'Active personnel', val:'~900,000 (est. wartime)' },
    ],
    hotspots: [
      { name:'Ukraine frontline', status:'ACTIVE', note:'Ongoing combined arms offensive' },
      { name:'Black Sea Fleet', status:'WARN',   note:'Fleet degraded by Ukrainian strikes' },
      { name:'Kaliningrad',      status:'WARN',   note:'Iskander SRBM deployment confirmed' },
      { name:'Syria (Hmeimim)', status:'ACTIVE', note:'Russian air operations ongoing' },
    ],
    intel: [
      'Tu-160M strategic bombers conducted long-range patrols over Arctic',
      'Black Sea Fleet relocated assets to Novorossiysk after Sevastopol losses',
      'Kinzhal hypersonic missiles used in Ukraine ‚Äî depleting stockpile',
      'Russian EW aircraft (IL-22PP) active over eastern Ukraine',
      'S-500 Prometheus system reached operational status',
    ],
    watchFor: [
      'Tu-95MS/Tu-160 sorties from Engels AB = nuclear/cruise missile patrol',
      'MiG-31BM with Kinzhal on hardpoints = hypersonic strike ready',
      'IL-20M Coot ELINT surges = pre-strike reconnaissance',
      'Su-34 strike jets + tankers = deep strike package being assembled',
    ],
  },
  china: {
    name: "People's Republic of China", flag: 'üá®üá≥', color: '#eab308',
    oob: [
      { label:'Air Force Aircraft (est.)', val:'~3,000 total combat' },
      { label:'Key fighters', val:'J-20, J-16, J-10C, Su-35' },
      { label:'Bombers', val:'H-6K/J/N (LACM capable)' },
      { label:'Navy vessels', val:'~355 ships (largest fleet by count)' },
      { label:'Aircraft carriers', val:'3 (Liaoning, Shandong, Fujian)' },
      { label:'Submarines', val:'~60 (6 SSBN nuclear)' },
      { label:'ICBMs deployed', val:'~500 warheads, expanding fast' },
      { label:'Active personnel', val:'~2,000,000' },
    ],
    hotspots: [
      { name:'Taiwan Strait',    status:'ACTIVE', note:'Near-daily PLA incursions into ADIZ' },
      { name:'South China Sea',  status:'ACTIVE', note:'Artificial island militarization ongoing' },
      { name:'Senkaku/Diaoyu',   status:'WARN',   note:'CCG vessels conducting regular patrols' },
      { name:'India border (LAC)',status:'WARN',   note:'Infrastructure buildup at multiple points' },
    ],
    intel: [
      'PLAAF J-20 stealth fighters now operational at multiple bases near Taiwan',
      'PLA SSBN patrols in Pacific increasing ‚Äî nuclear deterrent posture shift',
      'DF-17 hypersonic glide vehicle entered full operational service',
      'Fujian carrier completed sea trials ‚Äî first electromagnetic catapult carrier',
      'PLA established third overseas logistics base (Equatorial Guinea suspected)',
    ],
    watchFor: [
      'H-6K/J bomber sorties with air-launched cruise missiles = strike posture',
      'Multiple PLAN carrier strike groups leaving port simultaneously = major op',
      'Y-20 transport surge toward Taiwan Strait area = amphibious prep signal',
      'PLA EW aircraft (Y-8/Y-9) near Taiwan = electronic suppression prep',
    ],
  }
};

let currentAdv = 'iran';

function switchAdv(adv){
  currentAdv = adv;
  document.querySelectorAll('.adv-tab').forEach(t => t.classList.toggle('active', t.dataset.adv === adv));
  renderAdvPanel(adv);
}

function renderAdvPanel(adv){
  const d = ADV_INTEL[adv];
  if(!d) return;
  const pane = document.getElementById('pane-adv');
  if(!pane) return;

  // Count live aircraft for this adversary
  const live = acData.filter(ac => ac.lat && getGroup(ac.hex) === adv);
  const liveTypes = {};
  live.forEach(ac => { const t=classifyType(ac); liveTypes[t]=(liveTypes[t]||0)+1; });

  let h = `<div class="adv-body">`;

  // Col 1: Order of Battle
  h += `<div class="adv-col">
    <h5>‚öîÔ∏è Order of Battle</h5>
    ${d.oob.map(o=>`<div class="adv-row"><span class="ar-label">${o.label}</span><span class="ar-val">${o.val}</span></div>`).join('')}
    <h5 style="margin-top:8px">‚úàÔ∏è Live Aircraft Now</h5>
    ${live.length ? Object.entries(liveTypes).map(([t,n])=>`<div class="adv-row"><span class="ar-label">${TICO[t]||'‚óÜ'} ${TLAB[t]||t}</span><span class="ar-val" style="color:${d.color}">${n}</span></div>`).join('') : `<div style="color:#3a4560;font-size:11px">No ${d.name} aircraft currently tracked</div>`}
  </div>`;

  // Col 2: Hotspots + Intel
  h += `<div class="adv-col">
    <h5>üî• Active Hotspots</h5>
    ${d.hotspots.map(hs=>{
      const scls = hs.status==='ACTIVE'?'hot':hs.status==='WARN'?'warn':'calm';
      return `<div style="margin-bottom:7px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px">
          <span style="font-weight:600;color:var(--text)">${hs.name}</span>
          <span class="adv-status ${scls}">${hs.status}</span>
        </div>
        <div style="color:var(--muted);font-size:10px">${hs.note}</div>
      </div>`;
    }).join('')}
    <h5 style="margin-top:8px">üì° Recent Intel</h5>
    ${d.intel.map(i=>`<div style="margin-bottom:5px;color:var(--muted);font-size:10px;padding-left:6px;border-left:2px solid ${d.color}40">${i}</div>`).join('')}
  </div>`;

  // Col 3: Watch Signals
  h += `<div class="adv-col">
    <h5>üëÅÔ∏è Watch For These Signals</h5>
    ${d.watchFor.map(w=>`<div style="margin-bottom:8px;padding:6px 8px;background:rgba(239,68,68,.06);border:1px solid ${d.color}30;border-radius:4px;font-size:11px;color:var(--text);line-height:1.4">${w}</div>`).join('')}
  </div>`;

  h += `</div>`;
  pane.innerHTML = h;
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVAL DEPLOYMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const NAVAL_CAPS = {
  CSG: {name:'Carrier Strike Group', desc:'The most powerful conventional naval force projection unit. Centers on a nuclear-powered aircraft carrier with an embarked air wing, protected by cruisers, destroyers, and submarines.',
    composition:'1x Aircraft Carrier (CVN), 1-2x Cruiser (CG), 2-3x Destroyer (DDG), 1-2x SSN Attack Sub, 1x Supply Ship',
    airWing:'~75 aircraft: F/A-18E/F Super Hornets, EA-18G Growlers, E-2D Hawkeye, MH-60R/S Seahawks, CMV-22 Osprey',
    capabilities:'Power projection (1,000+ nmi strike radius), air superiority, anti-submarine warfare, cruise missile strike (Tomahawk), ballistic missile defense (Aegis), ISR, humanitarian assistance'},
  ARG: {name:'Amphibious Ready Group', desc:'Expeditionary force designed to project Marine combat power ashore. Carries a Marine Expeditionary Unit (MEU) with ~2,200 Marines.',
    composition:'1x LHD/LHA Amphibious Assault Ship, 1x LPD San Antonio-class, 1x LSD Whidbey Island-class',
    airWing:'AV-8B Harriers or F-35B, MV-22 Osprey, CH-53E Super Stallion, AH-1Z Viper, UH-1Y Venom',
    capabilities:'Amphibious assault, vertical envelopment, special operations, non-combatant evacuation (NEO), humanitarian aid, crisis response'},
  SSBN: {name:'Ballistic Missile Submarine (SSBN)', desc:'Strategic nuclear deterrent. Ohio-class SSBNs carry up to 20 Trident II D5 SLBMs. The most survivable leg of the nuclear triad.',
    composition:'1x Ohio-class SSBN (14 active)',
    airWing:'N/A ‚Äî submarine',
    capabilities:'Strategic nuclear deterrence (each sub carries ~90 nuclear warheads), virtually undetectable when submerged, 70+ day patrols'},
  FLEET: {name:'Naval Fleet / Task Force', desc:'Major naval formation comprising multiple warship classes. Composition varies by nation and mission.',
    composition:'Varies ‚Äî carriers, cruisers, destroyers, frigates, submarines, support ships',
    airWing:'Varies by fleet composition',
    capabilities:'Sea control, power projection, anti-access/area denial, submarine warfare, mine warfare, amphibious operations'},
};

const NAVAL_DEPLOYMENTS = [
  // US Carrier Strike Groups
  {name:'CSG-3 ‚Äî USS Abraham Lincoln (CVN-72)', type:'CSG', country:'us', status:'deployed',
   lat:25.5, lon:57.2, region:'PERSIAN GULF / ARABIAN SEA',
   ships:'CVN-72 Lincoln, CG-52 Bunker Hill, DDG-92 Momsen, DDG-114 Ralph Johnson',
   notes:'Forward deployed ‚Äî 5th Fleet AOR'},
  {name:'CSG-5 ‚Äî USS Ronald Reagan (CVN-76)', type:'CSG', country:'us', status:'deployed',
   lat:22.3, lon:131.5, region:'WESTERN PACIFIC',
   ships:'CVN-76 Reagan, CG-54 Antietam, DDG-85 McCampbell, DDG-89 Mustin',
   notes:'Forward deployed Yokosuka ‚Äî 7th Fleet'},
  {name:'CSG-12 ‚Äî USS Gerald R. Ford (CVN-78)', type:'CSG', country:'us', status:'deployed',
   lat:34.8, lon:28.5, region:'EASTERN MEDITERRANEAN',
   ships:'CVN-78 Ford, CG-66 Hue City, DDG-104 Sterett, DDG-110 William P. Lawrence',
   notes:'Eastern Med deterrence patrol'},
  {name:'CSG-9 ‚Äî USS Nimitz (CVN-68)', type:'CSG', country:'us', status:'transit',
   lat:8.2, lon:73.5, region:'INDIAN OCEAN',
   ships:'CVN-68 Nimitz, CG-57 Lake Champlain, DDG-76 Higgins',
   notes:'Transit to CENTCOM AOR'},

  // Amphibious Ready Groups
  {name:'ARG ‚Äî USS Bataan (LHD-5)', type:'ARG', country:'us', status:'deployed',
   lat:12.5, lon:44.3, region:'RED SEA / GULF OF ADEN',
   ships:'LHD-5 Bataan, LPD-23 Anchorage, LSD-50 Carter Hall + 26th MEU',
   notes:'Houthi threat response ‚Äî force protection'},
  {name:'ARG ‚Äî USS Boxer (LHD-4)', type:'ARG', country:'us', status:'port',
   lat:32.7, lon:-117.2, region:'SAN DIEGO',
   ships:'LHD-4 Boxer, LPD-27 Portland',
   notes:'Maintenance period'},

  // SSBNs (approximate patrol areas ‚Äî not exact)
  {name:'SSBN Patrol ‚Äî Atlantic', type:'SSBN', country:'us', status:'deployed',
   lat:45.0, lon:-30.0, region:'NORTH ATLANTIC',
   ships:'Ohio-class SSBN (undisclosed)',
   notes:'Strategic deterrence patrol'},
  {name:'SSBN Patrol ‚Äî Pacific', type:'SSBN', country:'us', status:'deployed',
   lat:35.0, lon:170.0, region:'PACIFIC',
   ships:'Ohio-class SSBN (undisclosed)',
   notes:'Strategic deterrence patrol'},

  // Adversary Naval
  {name:'üá∑üá∫ Northern Fleet ‚Äî Severomorsk', type:'FLEET', country:'russia', status:'combat',
   lat:69.1, lon:33.4, region:'BARENTS SEA',
   ships:'Adm. Kuznetsov (CV), Pyotr Velikiy (CGN), multiple SSNs',
   notes:'Increased submarine activity ‚Äî NATO monitoring'},
  {name:'üá∑üá∫ Black Sea Fleet', type:'FLEET', country:'russia', status:'combat',
   lat:44.6, lon:33.5, region:'BLACK SEA / SEVASTOPOL',
   ships:'Reduced force ‚Äî losses to Ukrainian strikes',
   notes:'Severely degraded ‚Äî limited ops capability'},
  {name:'üá®üá≥ PLA Navy ‚Äî South Sea Fleet', type:'FLEET', country:'china', status:'deployed',
   lat:18.2, lon:109.5, region:'SOUTH CHINA SEA',
   ships:'Type 003 Fujian (CV), Type 055 destroyers, Type 093 SSN',
   notes:'SCS patrol + Taiwan contingency readiness'},
  {name:'üáÆüá∑ IRIN ‚Äî Bandar Abbas', type:'FLEET', country:'iran', status:'deployed',
   lat:27.2, lon:56.3, region:'STRAIT OF HORMUZ',
   ships:'Frigates, fast attack craft, Ghadir-class submarines',
   notes:'Strait of Hormuz area denial posture'},
];

const CHOKEPOINTS = [
  {name:'Strait of Hormuz', status:'ELEVATED', color:'var(--red)', lat:26.6, lon:56.3,
   note:'Iranian naval posturing ‚Äî IRGCN fast boats active'},
  {name:'Bab el-Mandeb', status:'HIGH RISK', color:'var(--red)', lat:12.6, lon:43.3,
   note:'Houthi anti-ship missile/drone threat ‚Äî coalition patrols active'},
  {name:'Taiwan Strait', status:'WATCH', color:'var(--yellow)', lat:24.5, lon:119.5,
   note:'PLA Navy exercises ‚Äî US transits ongoing'},
  {name:'Suez Canal', status:'NORMAL', color:'var(--accent)', lat:30.5, lon:32.3,
   note:'Operating normally ‚Äî traffic diversions from Red Sea'},
  {name:'GIUK Gap', status:'WATCH', color:'var(--yellow)', lat:62.0, lon:-15.0,
   note:'Russian submarine transit monitoring ‚Äî P-8 patrols'},
  {name:'Malacca Strait', status:'NORMAL', color:'var(--accent)', lat:2.5, lon:101.5,
   note:'Normal commercial traffic'},
];

let navalLayer = L.layerGroup().addTo(map);
let navalVisible = true;

function toggleNavalLayer(){
  navalVisible = !navalVisible;
  const btn = document.getElementById('btn-naval');
  if(navalVisible){
    navalLayer.addTo(map);
    btn.classList.add('on');
    btn.textContent = 'üö¢ Naval';
  } else {
    map.removeLayer(navalLayer);
    btn.classList.remove('on');
    btn.textContent = 'üö¢ Naval';
  }
  renderNaval();
}

function renderNaval(){
  navalLayer.clearLayers();
  const pane = document.getElementById('pane-naval');
  if(!pane) return;

  // Map markers for deployments
  const shipIcon = (country) => {
    const col = country==='us' ? '#00ff41' : country==='russia' ? '#dc2626' : country==='china' ? '#e5ff00' : country==='iran' ? '#ff2040' : '#bf5fff';
    return L.divIcon({
      html:`<div style="color:${col};font-size:16px;text-shadow:0 0 8px ${col}80;cursor:pointer">‚öì</div>`,
      className:'', iconSize:[16,16], iconAnchor:[8,8]
    });
  };

  if(navalVisible){
    NAVAL_DEPLOYMENTS.forEach(d => {
      const m = L.marker([d.lat, d.lon], {icon: shipIcon(d.country)})
        .bindTooltip(d.name, {className:'dark-tooltip', direction:'top', offset:[0,-8]});
      m.on('click', () => {
        document.getElementById('pTitle').textContent = d.name;
        const capInfo = NAVAL_CAPS[d.type] || null;
        let capHtml = '';
        if(capInfo){
          capHtml = `<div style="margin-top:8px;padding:8px;background:rgba(0,255,65,.04);border:1px solid rgba(0,255,65,.12);border-radius:2px">
            <div style="font-size:11px;font-weight:700;color:var(--accent);font-family:'Share Tech Mono',monospace;margin-bottom:4px">${capInfo.name}</div>
            <div style="font-size:10px;color:var(--text);margin-bottom:4px;line-height:1.4">${capInfo.desc}</div>
            <div class="f"><span class="k">Composition: </span><span class="v" style="line-height:1.4">${capInfo.composition}</span></div>
            <div class="f"><span class="k">Air Wing: </span><span class="v" style="line-height:1.4">${capInfo.airWing||'N/A'}</span></div>
            <div class="f"><span class="k">Capabilities: </span><span class="v" style="line-height:1.4">${capInfo.capabilities}</span></div>
          </div>`;
        }
        document.getElementById('pBody').innerHTML = `
          <div class="f"><span class="k">Type: </span><span class="v">${d.type}</span></div>
          <div class="f"><span class="k">Region: </span><span class="v">${d.region}</span></div>
          <div class="f"><span class="k">Ships: </span><span class="v" style="line-height:1.4">${d.ships}</span></div>
          <div class="f"><span class="k">Notes: </span><span class="v">${d.notes}</span></div>
          ${capHtml}
        `;
        document.getElementById('infoP').classList.add('vis');
      });
      navalLayer.addLayer(m);
    });

    // Chokepoint markers
    CHOKEPOINTS.forEach(c => {
      const m = L.circleMarker([c.lat, c.lon], {
        radius: 8, fillColor: c.status==='HIGH RISK'||c.status==='ELEVATED' ? '#ff2040' : c.status==='WATCH' ? '#e5ff00' : '#00ff41',
        fillOpacity: 0.3, color: c.status==='HIGH RISK'||c.status==='ELEVATED' ? '#ff2040' : c.status==='WATCH' ? '#e5ff00' : '#00ff41',
        weight: 2, opacity: 0.6
      }).bindTooltip(`‚ö† ${c.name}: ${c.status}`, {className:'dark-tooltip', direction:'top'});
      navalLayer.addLayer(m);
    });
  }

  // Widget content
  const countEl = document.getElementById('naval-count');
  if(countEl) countEl.textContent = NAVAL_DEPLOYMENTS.length + ' assets';

  let h = '';
  // Chokepoints section
  h += `<div class="rp-section">‚ö†Ô∏è CHOKEPOINTS</div>`;
  CHOKEPOINTS.forEach(c => {
    const scol = c.status==='HIGH RISK'||c.status==='ELEVATED' ? 'var(--red)' : c.status==='WATCH' ? 'var(--yellow)' : 'var(--accent)';
    h += `<div class="naval-chokepoint" onclick="goTo(${c.lat},${c.lon},6)" style="cursor:pointer">
      <span class="nc-name">${c.name}</span>
      <span class="nc-status" style="color:${scol}">${c.status}</span>
    </div>`;
  });

  // Deployments section
  h += `<div class="rp-section">üö¢ CARRIER STRIKE GROUPS & FLEETS</div>`;
  NAVAL_DEPLOYMENTS.forEach(d => {
    const scls = d.status==='combat' ? 'combat' : d.status==='deployed' ? 'deployed' : d.status==='transit' ? 'transit' : 'port';
    h += `<div class="naval-group" onclick="map.setView([${d.lat},${d.lon}],6)">
      <div class="ng-header">
        <span class="ng-name">${d.name}</span>
        <span class="ng-status ${scls}">${d.status.toUpperCase()}</span>
      </div>
      <div class="ng-region">üìç ${d.region}</div>
      <div class="ng-ships">${d.ships}</div>
    </div>`;
  });

  pane.innerHTML = h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ZULU CLOCK BAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateClocks(){
  const now = new Date();
  const fmt = (tz, h24=true) => now.toLocaleTimeString('en-GB',{timeZone:tz,hour:'2-digit',minute:'2-digit',second:h24?'2-digit':undefined,hour12:false});
  const fmtS = (tz) => now.toLocaleTimeString('en-GB',{timeZone:tz,hour:'2-digit',minute:'2-digit',hour12:false});
  document.getElementById('clk-zulu').textContent = fmt('UTC') + 'Z';
  document.getElementById('clk-dc').textContent = fmtS('America/New_York');
  document.getElementById('clk-kyiv').textContent = fmtS('Europe/Kyiv');
  document.getElementById('clk-moscow').textContent = fmtS('Europe/Moscow');
  document.getElementById('clk-tehran').textContent = fmtS('Asia/Tehran');
  document.getElementById('clk-beijing').textContent = fmtS('Asia/Shanghai');
  const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  const days = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
  document.getElementById('clk-date').textContent = `${days[now.getUTCDay()]} ${now.getUTCDate()} ${months[now.getUTCMonth()]} ${now.getUTCFullYear()}`;
}
updateClocks();
setInterval(updateClocks, 1000);

fetchData();
fetchAllNews();
fetchPolymarket();
initXFeed();
renderAdvPanel('iran');
renderNaval();
// Fix Leaflet map size on mobile after layout settles
setTimeout(() => map.invalidateSize(), 300);
setTimeout(() => map.invalidateSize(), 1000);
window.addEventListener('resize', () => map.invalidateSize());

setInterval(fetchData, 30000);
setInterval(fetchAllNews, 300000);
setInterval(fetchPolymarket, 300000);
setInterval(() => { xPostCache={}; initXFeed(); }, 300000);

switchTab('news');
</script>
</body>
</html>
